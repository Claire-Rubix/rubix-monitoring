<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rubix Monitoring</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html{font-size:14px}
body{font-family:'Segoe UI',system-ui,sans-serif;background:#EEF2FF;color:#0F172A;min-height:100vh}

/* Header */
.header{background:#051E50;padding:14px 32px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;box-shadow:0 2px 12px rgba(5,30,80,.3)}
.logo{display:flex;align-items:center;gap:10px}
.logo-icon{width:32px;height:32px;background:#FFD700;border-radius:7px;display:flex;align-items:center;justify-content:center;font-weight:900;color:#051E50;font-size:16px}
.header h1{font-size:17px;font-weight:700;color:#fff}
.header-meta{color:#93C5FD;font-size:11px;text-align:right;line-height:1.6}

/* Nav — Rubix navy + gold */
.nav{background:#051E50;border-bottom:2px solid rgba(255,215,0,.25);position:sticky;top:56px;z-index:99;padding:0 32px;display:flex;overflow-x:auto}
.nav a{padding:11px 16px;font-size:12px;font-weight:600;color:#93C5FD;text-decoration:none;border-bottom:3px solid transparent;white-space:nowrap;transition:all .2s;cursor:pointer;margin-bottom:-2px}
.nav a:hover{color:#fff;border-bottom-color:#FFD700}
.nav a.active{color:#FFD700;border-bottom-color:#FFD700;background:rgba(255,215,0,.1)}

/* Pages */
.page{display:none}
.page.active{display:block}

/* Loading */
.loading{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:80px 20px;gap:14px}
.spinner{width:38px;height:38px;border:3px solid #DBEAFE;border-top-color:#051E50;border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{color:#64748B;font-size:14px}
.error-box{background:#FEE2E2;border:1px solid #FECACA;border-radius:8px;padding:16px 20px;color:#DC2626;font-size:13px;margin:20px auto;max-width:520px;text-align:center}

/* Container */
.container{max-width:1280px;margin:0 auto;padding:20px 24px}

/* Section titles */
.section-title{font-size:15px;font-weight:800;color:#051E50;margin:24px 0 10px;display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.st-bar{width:4px;height:20px;border-radius:3px;flex-shrink:0}

/* Collapsible sections */
.section{background:#fff;border:1px solid #DBEAFE;border-radius:12px;margin-bottom:14px;overflow:hidden;box-shadow:0 1px 6px rgba(5,30,80,.07)}
.section-head{padding:14px 20px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;user-select:none;transition:background .15s}
.section-head:hover{background:#EFF6FF}
.section-head h2{font-size:14px;font-weight:700;color:#051E50;display:flex;align-items:center;gap:8px;margin:0;flex-wrap:wrap}
.chevron{font-size:18px;color:#93C5FD;transition:transform .25s;flex-shrink:0}
.chevron.open{transform:rotate(180deg)}
.section-body{padding:0 20px 16px;display:none}
.section-body.open{display:block}

/* Badges */
.badge{font-size:9px;padding:2px 8px;border-radius:20px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;display:inline-block}
.bv{background:#DBEAFE;color:#1D4ED8}
.bo{background:#ECFDF5;color:#059669}
.bg{background:#DBEAFE;color:#1D4ED8}
.bd{background:#FEE2E2;color:#DC2626}
.bw{background:#FEFCE8;color:#92400E}
.bi{background:#EFF6FF;color:#1D4ED8}

/* Alert grid */
.alert-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:6px}
.alert-block{border-radius:12px;border:1px solid #DBEAFE;overflow:hidden;background:#fff;box-shadow:0 1px 6px rgba(5,30,80,.07)}
.alert-block-head{padding:11px 16px;border-bottom:1px solid #EFF6FF;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.alert-block-head h3{font-size:13px;font-weight:700;color:#051E50;flex:1;white-space:nowrap}
.alert-block-body{padding:10px 14px 12px}
.alert-row{display:flex;align-items:flex-start;gap:8px;padding:6px 10px;border-radius:6px;margin-bottom:4px;font-size:11px;line-height:1.5}
.alert-row:last-of-type{margin-bottom:0}
.alert-icon{font-size:13px;flex-shrink:0;margin-top:1px}
.detail-link{display:block;text-align:right;font-size:11px;font-weight:600;color:#1D4ED8;text-decoration:none;padding:8px 0 0;border-top:1px solid #EFF6FF;margin-top:8px;cursor:pointer}
.detail-link:hover{text-decoration:underline}

/* Capacity cards */
.summary{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px}
.scard{background:#fff;border:1px solid #DBEAFE;border-radius:12px;padding:14px;position:relative;overflow:hidden;box-shadow:0 1px 6px rgba(5,30,80,.07)}
.stop{width:100%;height:4px;position:absolute;top:0;left:0}
.slabel{font-size:9px;text-transform:uppercase;letter-spacing:1.2px;color:#64748B;margin-bottom:2px;font-weight:600;margin-top:6px}
.sval{font-size:22px;font-weight:800;color:#051E50}
.sdetail{font-size:11px;color:#94A3B8;margin-top:1px}
.stop-gold{background:#FFD700}.stop-green{background:#00D26A}.stop-blue{background:#051E50}.stop-purple{background:#8B5CF6}

/* Limit bars */
.limits-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.limit-item{padding:12px;background:#F8FAFF;border-radius:8px;border:1px solid #DBEAFE}
.limit-label{font-size:12px;font-weight:600;color:#334155;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:4px}
.limit-bar{height:7px;background:#DBEAFE;border-radius:4px;overflow:hidden;margin-bottom:4px}
.limit-fill{height:100%;border-radius:4px;transition:width .5s ease}
.fill-ok{background:linear-gradient(90deg,#00D26A,#34D399)}
.fill-warn{background:linear-gradient(90deg,#FFD700,#FCD34D)}
.fill-danger{background:linear-gradient(90deg,#EF4444,#DC2626)}
.limit-detail{font-size:10px;color:#94A3B8}

/* Per-app breakdown */
.per-app-breakdown{margin-top:8px;border-top:1px dashed #DBEAFE;padding-top:6px}
.per-app-row{display:flex;align-items:center;gap:6px;padding:2px 0}
.per-app-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.per-app-name{width:110px;color:#334155;font-weight:600;flex-shrink:0;font-size:10px}
.per-app-bar-wrap{flex:1;height:5px;background:#DBEAFE;border-radius:3px;overflow:hidden}
.per-app-bar{height:100%;border-radius:3px;min-width:2px}
.per-app-val{font-size:10px;color:#64748B;white-space:nowrap;min-width:100px;text-align:right}

/* Projection badges */
.proj-badge{display:inline-block;font-size:9px;padding:2px 7px;border-radius:10px;font-weight:700}
.proj-ok{background:#ECFDF5;color:#059669}
.proj-warn{background:#FEFCE8;color:#92400E}
.proj-danger{background:#FEE2E2;color:#DC2626}

/* Tables */
table{width:100%;border-collapse:collapse}
th,td{text-align:left;padding:7px 12px;border-bottom:1px solid #EFF6FF;font-size:13px}
th{color:#1D4ED8;font-weight:600;font-size:10px;text-transform:uppercase;letter-spacing:.5px;background:#EFF6FF}

/* App meta */
.app-meta{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px}
.meta-card{padding:10px 14px;background:#F8FAFF;border-radius:8px;border:1px solid #DBEAFE}
.meta-label{font-size:10px;color:#94A3B8;text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px}
.meta-val{font-size:13px;font-weight:700;color:#051E50;display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.status-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;background:#94A3B8}

/* Mini metrics */
.mini-metrics{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:14px;padding-top:12px;border-top:1px solid #DBEAFE}
.mini-metric{text-align:center;padding:8px 4px;background:#EFF6FF;border-radius:8px}
.mini-val{font-size:16px;font-weight:800;color:#051E50}
.mini-label{font-size:9px;color:#64748B;text-transform:uppercase;letter-spacing:.5px;margin-top:2px}

/* Threshold blocks */
.thr-d{padding:10px;background:#FEE2E2;border-radius:8px;border:1px solid #FECACA;margin-top:10px}
.thr-w{padding:10px;background:#FEFCE8;border-radius:8px;border:1px solid #FFD700;margin-top:10px}
.thr-i{padding:10px;background:#EFF6FF;border-radius:8px;border:1px solid #BFDBFE;margin-top:10px}
.thr-d h4{font-size:12px;font-weight:700;color:#DC2626;margin-bottom:6px}
.thr-w h4{font-size:12px;font-weight:700;color:#92400E;margin-bottom:6px}
.thr-i h4{font-size:12px;font-weight:700;color:#1D4ED8;margin-bottom:6px}

/* Recommendations */
.reco{margin-top:10px;padding:10px;background:#EFF6FF;border-radius:8px;border:1px solid #BFDBFE}
.reco h4{font-size:11px;font-weight:700;color:#1D4ED8;margin-bottom:5px}
.reco p{font-size:11px;color:#334155;padding:2px 0}

/* Buttons */
.links{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
.btn{font-size:11px;padding:6px 12px;border-radius:6px;text-decoration:none;font-weight:600;display:inline-block;transition:all .2s}
.btn-g{background:#FEFCE8;color:#92400E;border:1px solid #FFD700}
.btn-g:hover{background:#FFD700;color:#051E50}
.btn-o{background:#ECFDF5;color:#059669;border:1px solid #A7F3D0}
.btn-o:hover{background:#059669;color:#fff}
.btn-v{background:#EFF6FF;color:#051E50;border:1px solid #BFDBFE}
.btn-v:hover{background:#051E50;color:#fff}

/* Footer */
.footer{text-align:center;padding:16px;color:#94A3B8;font-size:11px;margin-top:8px}

@media(max-width:900px){
  .alert-grid{grid-template-columns:1fr}
  .limits-grid{grid-template-columns:1fr}
  .summary{grid-template-columns:repeat(2,1fr)}
  .app-meta{grid-template-columns:1fr}
  .mini-metrics{grid-template-columns:repeat(2,1fr)}
  .nav{padding:0 12px}
  .header{padding:12px 16px}
  .container{padding:16px 12px}
}

/* ====================== RÉTROPLANNING ROADMAP ====================== */
.retro-prog-wrap{background:#F8FAFC;border:1px solid #DBEAFE;border-radius:10px;padding:14px 18px;margin-bottom:14px}
.retro-prog-bar-bg{background:#E2E8F0;border-radius:4px;height:8px;margin:8px 0}
.retro-prog-bar-fill{background:linear-gradient(90deg,#051E50,#3B82F6);border-radius:4px;height:8px;transition:width .5s}
.retro-prog-stats{display:flex;gap:16px;flex-wrap:wrap;font-size:11px;color:#64748B}
.retro-filter-btn{font-size:11px;font-weight:600;padding:4px 12px;border-radius:20px;border:1px solid #E2E8F0;cursor:pointer;transition:all .15s;white-space:nowrap}
.retro-filter-btn:hover{border-color:#051E50}
/* Roadmap grid */
.rm-milestones{display:flex;gap:0;overflow-x:auto;margin-bottom:6px;padding-bottom:2px;position:relative}
.rm-ms{font-size:9px;font-weight:700;padding:3px 6px;border-radius:4px;text-align:center;white-space:nowrap;border:1px solid;flex:1;min-width:0}
.rm-grid-wrap{overflow-x:auto;padding-bottom:8px}
.rm-grid{display:grid;gap:0;min-width:600px}
.rm-corner{background:#F8FAFC;border:1px solid #E2E8F0;padding:6px;font-size:10px;font-weight:700;color:#6B7280;text-transform:uppercase;position:sticky;left:0;z-index:2}
.rm-wk-hdr{background:#F8FAFC;border:1px solid #E2E8F0;padding:4px 2px;text-align:center;cursor:pointer;user-select:none;transition:background .15s}
.rm-wk-hdr:hover{background:#EFF6FF}
.rm-wk-hdr.rm-wk-today{background:#FFFBEB;border-color:#FFD700}
.rm-wk-hdr-date{font-size:10px;font-weight:700;color:#051E50}
.rm-wk-hdr-ms{font-size:8px;margin-top:1px;line-height:1.2;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.rm-swim-label{background:#F8FAFC;border:1px solid #E2E8F0;padding:6px 8px;font-size:11px;font-weight:700;writing-mode:horizontal-tb;display:flex;align-items:center;gap:4px;position:sticky;left:0;z-index:2}
.rm-swim-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.rm-cell{border:1px solid #E2E8F0;padding:3px;min-height:32px;vertical-align:top;position:relative}
.rm-cell.rm-phase-1{background:#fff}
.rm-cell.rm-phase-2{background:#F9FAFB}
.rm-cell.rm-phase-3{background:#F3F4F6}
.rm-pill{font-size:9px;line-height:1.3;padding:2px 4px;border-radius:4px;border-left:3px solid;margin-bottom:2px;cursor:pointer;display:flex;align-items:center;gap:3px;background:#fff;transition:all .15s}
.rm-pill:hover{filter:brightness(.95);box-shadow:0 1px 3px rgba(0,0,0,.08)}
.rm-pill.done-card{opacity:.5;text-decoration:line-through}
.rm-pill-text{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:#334155}
.rm-pill-text[contenteditable="true"]{white-space:normal;outline:1px solid #3B82F6;border-radius:2px;padding:1px 2px;background:#fff}
.rm-pill-status{flex-shrink:0;cursor:pointer;font-size:12px;line-height:1}
.rm-pill.hidden{display:none}
.rm-count{font-size:9px;font-weight:700;color:#fff;padding:1px 5px;border-radius:8px;display:inline-block;margin-right:2px}
/* Detail panel (expanded week) */
.rm-detail-overlay{position:fixed;inset:0;background:rgba(0,0,0,.3);z-index:100;display:flex;align-items:center;justify-content:center}
.rm-detail-panel{background:#fff;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.18);max-width:800px;width:95%;max-height:85vh;overflow-y:auto;padding:20px}
.rm-detail-day{margin-bottom:16px}
.rm-detail-day-hdr{font-size:13px;font-weight:800;color:#051E50;margin-bottom:8px;padding-bottom:4px;border-bottom:1px solid #E2E8F0}
.rm-detail-card{background:#fff;border-radius:7px;border:1px solid #E5E7EB;border-left:4px solid;padding:8px 10px 6px;margin-bottom:5px}
.rm-detail-card.done-card{opacity:.55}
.rm-detail-card-text{font-size:12px;color:#374151;line-height:1.4;margin-bottom:5px}
.rm-detail-card-text[contenteditable="true"]{outline:1px solid #3B82F6;border-radius:2px;padding:2px 4px;background:#FEFCE8}
.rm-detail-bottom{display:flex;align-items:center;justify-content:space-between;gap:4px}
.rm-detail-tag{font-size:9px;font-weight:700;padding:2px 7px;border-radius:10px;white-space:nowrap}
.rm-detail-status-btn{width:24px;height:24px;border:none;background:none;cursor:pointer;font-size:16px;line-height:1;padding:0;flex-shrink:0}
@media(max-width:768px){
  .rm-grid{min-width:unset!important}
  .rm-swim-label{writing-mode:horizontal-tb;position:relative;left:auto;z-index:auto}
  .rm-corner{position:relative;left:auto;z-index:auto}
}
/* Sub-tabs (Pitch Generator) */
.sub-tabs-nav{display:flex;gap:0;flex-wrap:wrap;margin-bottom:16px;border-bottom:2px solid #E2E8F0}
.sub-tab-btn{padding:7px 13px;border:1px solid transparent;border-bottom:none;border-radius:6px 6px 0 0;font-size:11px;font-weight:600;cursor:pointer;background:none;color:#64748B;transition:all .15s;margin-bottom:-2px;white-space:nowrap}
.sub-tab-btn.active{background:#fff;color:#051E50;border-color:#E2E8F0;border-bottom-color:#fff}
.sub-tab-btn:hover:not(.active){background:#F8FAFC;color:#334155}
.sub-page{display:none}.sub-page.active{display:block}
.pitch-gs{padding:10px 14px;border-radius:8px;font-size:13px;font-weight:700;text-align:center;margin-bottom:10px}
.pitch-gs-ok{background:#ECFDF5;color:#166534}.pitch-gs-warn{background:#FEFCE8;color:#92400E}.pitch-gs-danger{background:#FEF2F2;color:#DC2626}
.pitch-sc-grid{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px}
.pitch-sc-card{display:flex;align-items:center;gap:6px;padding:8px 12px;border-radius:8px;font-size:12px;font-weight:600;flex:1;min-width:120px;border:1px solid transparent}
.pitch-sc-ok{background:#ECFDF5;color:#166534;border-color:#86EFAC}.pitch-sc-warn{background:#FEFCE8;color:#92400E;border-color:#FCD34D}.pitch-sc-danger{background:#FEF2F2;color:#DC2626;border-color:#FECACA}
.pitch-timeline{border-left:3px solid #E2E8F0;margin-left:14px;padding-left:22px;margin-bottom:20px}
.pitch-tl-item{position:relative;padding-bottom:18px}
.pitch-tl-dot{width:13px;height:13px;border-radius:50%;background:#E2E8F0;border:2px solid #94A3B8;position:absolute;left:-29px;top:3px}
.pitch-tl-item.tl-done .pitch-tl-dot{background:#22C55E;border-color:#16A34A}
.pitch-tl-item.tl-today .pitch-tl-dot{background:#FFD700;border-color:#D97706}
.pitch-tl-date{font-weight:700;color:#051E50;font-size:13px}
.pitch-tl-desc{font-size:12px;color:#334155;margin-top:2px}
.pitch-tl-users{font-size:11px;color:#94A3B8;margin-top:2px}
.pitch-tl-when{font-size:11px;font-weight:600;margin-top:4px}
.pitch-tl-item.tl-done .pitch-tl-when{color:#059669}
.pitch-tl-item.tl-today .pitch-tl-when{color:#D97706}
.pitch-cost-kpis{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px}
.pitch-cost-kpi{flex:1;min-width:130px;padding:12px;background:#F8FAFC;border-radius:8px;border:1px solid #E2E8F0;text-align:center}
.pitch-cost-val{font-size:20px;font-weight:800;color:#051E50}
.pitch-cost-lbl{font-size:10px;color:#64748B;margin-top:4px}
.cl-item{display:flex;align-items:flex-start;gap:10px;padding:8px 10px;border-radius:7px;border:1px solid #E2E8F0;margin-bottom:5px;cursor:pointer;font-size:12px;color:#334155;user-select:none}
.cl-item:hover{background:#F8FAFC}
.cl-item.cl-checked{background:#ECFDF5;border-color:#86EFAC;color:#166534;text-decoration:line-through;opacity:.75}
.cl-cat-title{font-size:10px;font-weight:700;color:#94A3B8;text-transform:uppercase;letter-spacing:.8px;margin:12px 0 5px}
.cl-footer{display:flex;justify-content:space-between;align-items:center;padding-top:10px;border-top:1px solid #E2E8F0;margin-top:8px;font-size:12px}
.cl-reset-btn{padding:4px 10px;border-radius:6px;border:1px solid #E2E8F0;background:#fff;cursor:pointer;font-size:11px;color:#64748B}
.cl-reset-btn:hover{background:#FEE2E2;border-color:#FECACA;color:#DC2626}
.pitch-prog-bar{height:8px;background:#E2E8F0;border-radius:4px;overflow:hidden;margin-top:6px}
.pitch-prog-fill{height:100%;border-radius:4px;background:linear-gradient(90deg,#DC2626,#F59E0B);transition:width .3s}
/* Demandes en attente */
.demandes-wrap{margin-bottom:20px}
.demande-card{background:#fff;border-radius:8px;border:1px solid #EDE9FE;border-left:4px solid #7C3AED;padding:14px 16px;margin-bottom:10px;position:relative}
.demande-header{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;margin-bottom:6px}
.demande-titre{font-size:13px;font-weight:700;color:#051E50;flex:1}
.demande-status-btn{background:none;border:none;font-size:18px;cursor:pointer;padding:0;line-height:1;flex-shrink:0;margin-top:-2px}
.demande-meta{font-size:11px;color:#6B7280;margin-bottom:6px;display:flex;gap:12px;flex-wrap:wrap}
.demande-meta span::before{content:"→ "}
.demande-detail{font-size:11px;color:#334155;margin-bottom:5px;background:#F5F3FF;border-radius:5px;padding:5px 8px}
.demande-pourquoi{font-size:12px;color:#6B7280;font-style:italic;line-height:1.6}
.demande-card.demande-done{opacity:.6}
/* Vercel costs */
.vercel-prog-wrap{margin:12px 0}
.vercel-prog-bar{height:12px;background:#E2E8F0;border-radius:6px;overflow:visible;position:relative;margin-top:4px}
.vercel-prog-fill{height:100%;border-radius:6px;transition:width .3s}
.vercel-proj-bar{height:12px;background:#E2E8F0;border-radius:6px;overflow:hidden;margin-top:6px;position:relative}
.vercel-proj-covered{height:100%;display:inline-block;border-radius:6px 0 0 6px}
.vercel-proj-surplus{height:100%;display:inline-block;border-radius:0 6px 6px 0}
/* Old vertical layout removed — now using rm-* roadmap classes */
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div class="logo">
    <div class="logo-icon">R</div>
    <h1>Rubix Monitoring</h1>
  </div>
  <div class="header-meta">
    <div id="period-label">Chargement...</div>
    <div id="generated-at"></div>
  </div>
</div>

<!-- NAV -->
<nav class="nav" id="nav">
  <a class="active" onclick="showTab('alertes')">Alertes</a>
  <a onclick="showTab('pole')">Pôle Acquisition</a>
  <a onclick="showTab('pitch')">Pitch Generator</a>
  <a onclick="showTab('smart')">Smart Content</a>
  <a onclick="showTab('vercel')">Capacité Vercel</a>
  <a onclick="showTab('couts')">Coûts</a>
  <a onclick="showTab('retro')">📆 Rétroplanning</a>
</nav>

<!-- LOADING -->
<div id="loading" class="loading">
  <div class="spinner"></div>
  <div class="loading-text">Chargement des donnees...</div>
</div>

<!-- MAIN -->
<div id="main" style="display:none">

  <!-- ONGLET ALERTES -->
  <div class="page active" id="page-alertes">
  <div class="container">
    <div class="section-title">
      <div class="st-bar" style="background:#EF4444"></div>
      Alertes et blockers
      <span class="badge bd" id="count-danger">0 CRITIQUE</span>
      <span class="badge bw" id="count-warn">0 ATTENTION</span>
    </div>

    <div class="alert-grid">

      <div class="alert-block" style="border-top:3px solid #FFD700">
        <div class="alert-block-head">
          <div style="width:10px;height:10px;border-radius:50%;background:#FFD700;flex-shrink:0"></div>
          <h3>Pôle Acquisition</h3>
          <span class="badge bg">GEMINI FREE TIER</span>
          <span class="badge bd">BLOCKER #1</span>
        </div>
        <div class="alert-block-body">
          <div class="alert-row" style="background:#FEE2E2">
            <span class="alert-icon" style="color:#DC2626">&#9888;</span>
            <span style="color:#DC2626">FREE TIER bloqué à 5+ users simultanées (15 appels/min). Migrer vers GCP billing pour scaler.</span>
          </div>
          <div class="alert-row" style="background:#F0F4FF">
            <span class="alert-icon" style="color:#3B82F6">&#9432;</span>
            <span style="color:#3B82F6">Quota jour : 1 500 appels/jour = max 150 users/jour (limite fixée à 10 appels/user/jour)</span>
          </div>
          <a class="detail-link" onclick="showTab('pole')">Voir détails Pôle Acquisition</a>
        </div>
      </div>

      <div class="alert-block" style="border-top:3px solid #8B5CF6">
        <div class="alert-block-head">
          <div style="width:10px;height:10px;border-radius:50%;background:#8B5CF6;flex-shrink:0"></div>
          <h3>Pitch Generator</h3>
          <span class="badge bo">OPENAI TIER 1</span>
        </div>
        <div class="alert-block-body">
          <div class="alert-row" style="background:#FEFCE8">
            <span class="alert-icon" style="color:#D97706">&#9888;</span>
            <span style="color:#D97706">6+ appels OpenAI par pitch (5 priorisations + 1 génération) paralléliser avec Promise.all</span>
          </div>
          <div class="alert-row" style="background:#FEFCE8">
            <span class="alert-icon" style="color:#D97706">&#9888;</span>
            <span style="color:#D97706">Polling Assistant API ~55s frôle le timeout 60s Vercel. Risque d'échec sur pitchs complexes.</span>
          </div>
          <a class="detail-link" onclick="showTab('pitch')">Voir détails Pitch Generator</a>
        </div>
      </div>

      <div class="alert-block" style="border-top:3px solid #00D26A">
        <div class="alert-block-head">
          <div style="width:10px;height:10px;border-radius:50%;background:#00D26A;flex-shrink:0"></div>
          <h3>Smart Content</h3>
          <span class="badge bg">GEMINI GCP</span>
        </div>
        <div class="alert-block-body">
          <div class="alert-row" style="background:#FEFCE8">
            <span class="alert-icon" style="color:#D97706">&#9888;</span>
            <span style="color:#D97706">Crédits promo GCP : ~50 contenus couverts. Surveiller la console GCP avant épuisement.</span>
          </div>
          <div class="alert-row" style="background:#ECFDF5">
            <span class="alert-icon" style="color:#059669">&#10003;</span>
            <span style="color:#059669">Streaming + retry/backoff 429 déjà en place pas de risque de timeout Vercel</span>
          </div>
          <a class="detail-link" onclick="showTab('smart')">Voir détails Smart Content</a>
        </div>
      </div>

      <div class="alert-block" style="border-top:3px solid #CBD5E1">
        <div class="alert-block-head">
          <div style="width:10px;height:10px;border-radius:50%;background:#94A3B8;flex-shrink:0"></div>
          <h3>Global Vercel &amp; Claude</h3>
          <span class="badge bv">PARTAGE</span>
        </div>
        <div class="alert-block-body">
          <div id="global-dyn-alerts"></div>
          <div class="alert-row" style="background:#F0F4FF">
            <span class="alert-icon" style="color:#3B82F6">&#9432;</span>
            <span style="color:#3B82F6">Concurrent Builds : 1 seul build à la fois, les 3 apps partagent la queue</span>
          </div>
          <div class="alert-row" style="background:#FEFCE8">
            <span class="alert-icon" style="color:#D97706">&#9432;</span>
            <span style="color:#D97706">Claude Code Max 5x : fenêtre glissante 5h + plafond hebdo non documenté, pas d'API quota</span>
          </div>
          <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
            <a href="https://claude.ai/settings/usage" target="_blank" class="btn btn-g">Vérifier quota Claude</a>
            <a href="https://claude.ai" target="_blank" class="btn btn-v">Claude en ligne (secours)</a>
          </div>
        </div>
      </div>

      <div class="alert-block" style="border-top:3px solid #EF4444;grid-column:1/-1">
        <div class="alert-block-head">
          <div style="width:10px;height:10px;border-radius:50%;background:#EF4444;flex-shrink:0"></div>
          <h3>Bug lié à l'environnement Rubix</h3>
          <span class="badge bd">PROXY ENTREPRISE</span>
          <span class="badge bd">RESEAU</span>
        </div>
        <div class="alert-block-body">
          <div class="alert-row" style="background:#FEE2E2">
            <span class="alert-icon" style="color:#DC2626">&#9888;</span>
            <span style="color:#DC2626"><strong>Claude Code bloqué sur réseau Rubix</strong> : proxy / pare-feu bloque les connexions API (ConnectionRefused, timeout). VS Code fonctionne, mais Claude Code ne peut pas contacter les serveurs Claude. Contournement : utiliser Claude dans le navigateur au bureau.</span>
          </div>
          <div class="alert-row" style="background:#FEE2E2">
            <span class="alert-icon" style="color:#DC2626">&#9888;</span>
            <span style="color:#DC2626"><strong>ERR_CERT_COMMON_NAME_INVALID</strong> : le proxy SSL d'entreprise (Zscaler) intercepte et re-scelle les connexions HTTPS. Le certificat recus ne correspond pas au site contacte.</span>
          </div>
          <div class="alert-row" style="background:#FEE2E2">
            <span class="alert-icon" style="color:#DC2626">&#9888;</span>
            <span style="color:#DC2626"><strong>ERR_NETWORK_CHANGED / ERR_INTERNET_DISCONNECTED</strong> : bascule VPN, changement de WiFi ou mise en veille coupe la connexion en cours de génération (90 a 180s). L'article reste bloqué en PROCESSING dans Google Sheets.</span>
          </div>
          <div class="alert-row" style="background:#FEFCE8">
            <span class="alert-icon" style="color:#D97706">&#9888;</span>
            <span style="color:#D97706">Solution : déplacer la génération côté serveur Vercel. Le navigateur ne fait qu'un seul appel court, Vercel gère les appels Gemini en interne (serveur à serveur, sans proxy).</span>
          </div>
          <a class="detail-link" onclick="showTab('smart')">Voir le plan d'action dans Smart Content</a>
        </div>
      </div>

    </div>
  </div>
  </div>

  <!-- ONGLET POLE ACQUISITION -->
  <div class="page" id="page-pole">
  <div class="container">
    <div class="section-title">
      <div class="st-bar" style="background:#FFD700"></div>
      Pôle Acquisition
      <span class="badge bg">GEMINI FREE TIER</span>
      <span class="badge bd">BLOCKER #1</span>
    </div>

    <div class="section">
      <div class="section-head" onclick="toggle(this)">
        <h2>
          <span class="status-dot" id="pole-dot"></span>
          rubix-pole-acquisition.vercel.app
        </h2>
        <span class="chevron open">&#9662;</span>
      </div>
      <div class="section-body open">
        <div class="app-meta">
          <div class="meta-card">
            <div class="meta-label">Dernier déploiement</div>
            <div class="meta-val" id="pole-last-deploy"></div>
          </div>
          <div class="meta-card">
            <div class="meta-label">Fournisseur IA</div>
            <div class="meta-val"><span class="badge bg">Gemini 2.0 Flash</span>&nbsp;Google AI Studio</div>
          </div>
        </div>

        <table>
          <thead><tr><th>Action utilisateur</th><th>Appels IA</th><th>Tokens estimes</th><th>Grounding</th></tr></thead>
          <tbody>
            <tr><td style="font-weight:600">Recherche infos entreprise</td><td>1 appel Gemini</td><td>1 500 a 4 000</td><td style="color:#D97706;font-weight:600">+ Google Search</td></tr>
            <tr><td style="font-weight:600">Matcher produits / services</td><td>1 appel Gemini</td><td>1 500 a 4 000</td><td style="color:#D97706;font-weight:600">+ Google Search</td></tr>
            <tr><td style="font-weight:600">Trouver fournisseurs</td><td>1 appel Gemini</td><td>1 500 a 4 000</td><td style="color:#D97706;font-weight:600">+ Google Search</td></tr>
            <tr><td style="font-weight:600">Rédiger email</td><td>1 appel Gemini</td><td>1 000 a 2 000</td><td>Non</td></tr>
            <tr><td style="font-weight:600">Orchestrateur (analyse)</td><td>1 appel Gemini</td><td>500 a 1 000</td><td>Non</td></tr>
          </tbody>
        </table>

        <div class="thr-d">
          <h4>Seuils de blocage Free tier AI Studio : 15 appels/min / 1 500 appels/jour</h4>
          <table>
            <thead><tr><th>Users simultanées</th><th>Appels IA/min</th><th>vs Limite 15 appels/min</th><th>Statut</th></tr></thead>
            <tbody>
              <tr><td>1 a 3 users</td><td>3 a 9 appels/min</td><td style="color:#059669">OK (60%)</td><td><span class="proj-badge proj-ok">OK</span></td></tr>
              <tr><td>5 users</td><td>10 a 15 appels/min</td><td style="color:#D97706">Limite (100%)</td><td><span class="proj-badge proj-warn">RISQUE</span></td></tr>
              <tr><td>10+ users</td><td>20 a 30+ appels/min</td><td style="color:#DC2626;font-weight:700">DÉPASSÉ (200%+)</td><td><span class="proj-badge proj-danger">BLOQUÉ</span></td></tr>
            </tbody>
          </table>
          <div style="font-size:11px;color:#DC2626;margin-top:6px">
            <strong>Quota jour :</strong> 1 500 appels/jour. Limite fixée à <strong>10 appels/user/jour</strong> = max 150 users/jour.
          </div>
        </div>

        <div style="margin-top:10px;padding:10px;background:#ECFDF5;border-radius:7px;border:1px solid #A7F3D0">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
            <span style="font-size:12px;font-weight:700;color:#059669">Sécurité timeout Vercel</span>
            <span class="proj-badge proj-ok">HAUTE</span>
          </div>
          <div style="font-size:11px;color:#334155">Chaque appel Gemini repond en 2 a 8s. Largement sous le timeout de 60s.<br>Marge de sécurité : 90%+ — aucune modification nécessaire.</div>
        </div>

        <div class="reco">
          <h4>Recommandations pour scaler</h4>
          <p>1. <strong>Batcher les appels grounding</strong> : combiner infos entreprise + matcher + fournisseur en 1 seul appel multi-tool (divise par 3)</p>
          <p>2. <strong>Cacher les resultats</strong> : même entreprise = meme recherche, cacher 24h (Redis / KV Vercel)</p>
          <p>3. <strong>Migrer vers GCP billing</strong> à partir de 5 users : 1 500 appels/min au lieu de 15 (x100)</p>
          <p>4. <strong>Queue + rate limiter côté serveur</strong> : limiter à 10 appels/min et mettre les requêtes en file d'attente</p>
        </div>

        <div class="mini-metrics">
          <div class="mini-metric"><div class="mini-val" id="pole-build"></div><div class="mini-label">Build min</div></div>
          <div class="mini-metric"><div class="mini-val" id="pole-bw"></div><div class="mini-label">Bandwidth</div></div>
          <div class="mini-metric"><div class="mini-val" id="pole-fninv"></div><div class="mini-label">Fn Invocations</div></div>
          <div class="mini-metric"><div class="mini-val" id="pole-fndur"></div><div class="mini-label">Fn Duration</div></div>
        </div>

        <div class="links">
          <a href="https://aistudio.google.com/app/apikey" target="_blank" class="btn btn-g">AI Studio usage</a>
          <a href="https://console.cloud.google.com/apis/dashboard?project=app-acquisition-487813" target="_blank" class="btn btn-g">GCP Console</a>
        </div>
      </div>
    </div>
  </div>
  </div>

  <!-- ONGLET PITCH GENERATOR -->
  <div class="page" id="page-pitch">
  <div class="container">
    <div class="section-title">
      <div class="st-bar" style="background:#8B5CF6"></div>
      Pitch Generator
      <span class="badge bo">OPENAI TIER 1</span>
    </div>

    <!-- Sous-onglets Pitch Generator -->
    <div class="sub-tabs-nav">
      <button class="sub-tab-btn active" onclick="showPitchTab('overview',this)">Vue d'ensemble</button>
      <button class="sub-tab-btn" onclick="showPitchTab('openai',this)">OpenAI &amp; Tiers</button>
      <button class="sub-tab-btn" onclick="showPitchTab('formations',this)">📅 Formations</button>
      <button class="sub-tab-btn" onclick="showPitchTab('couts',this)">💰 Coûts globaux</button>
      <button class="sub-tab-btn" onclick="showPitchTab('pilote',this)">🏁 Pilote &amp; IT</button>
      <button class="sub-tab-btn" onclick="showPitchTab('checklist',this)">✅ Checklist</button>
      <button class="sub-tab-btn" onclick="showPitchTab('chantiers',this)">⚙️ Chantiers</button>
    </div>

    <!-- SUB-PAGE 1 : Vue d'ensemble -->
    <div class="sub-page active" id="pitch-sub-overview">
      <div id="pitch-status-widget"></div>
      <div class="app-meta">
        <div class="meta-card">
          <div class="meta-label">Statut déploiement</div>
          <div class="meta-val"><span class="status-dot" id="pitch-dot"></span> <span id="pitch-last-deploy">—</span></div>
        </div>
        <div class="meta-card">
          <div class="meta-label">Coût / pitch complet (6 appels)</div>
          <div class="meta-val" id="pitch-cost-per-pitch">—</div>
        </div>
      </div>
      <div class="mini-metrics">
        <div class="mini-metric"><div class="mini-val" id="pitch-build"></div><div class="mini-label">Build min</div></div>
        <div class="mini-metric"><div class="mini-val" id="pitch-bw"></div><div class="mini-label">Bandwidth</div></div>
        <div class="mini-metric"><div class="mini-val" id="pitch-fninv"></div><div class="mini-label">Fn Invocations</div></div>
        <div class="mini-metric"><div class="mini-val" id="pitch-fndur"></div><div class="mini-label">Fn Duration</div></div>
      </div>
      <div class="links">
        <a href="https://platform.openai.com/usage" target="_blank" class="btn btn-o">OpenAI Usage</a>
        <a href="https://platform.openai.com/settings/organization/limits" target="_blank" class="btn btn-o">Rate Limits</a>
        <a href="https://vercel.com/dashboard" target="_blank" class="btn btn-o">Vercel Dashboard</a>
      </div>
    </div><!-- /overview -->

    <!-- SUB-PAGE 2 : OpenAI & Tiers -->
    <div class="sub-page" id="pitch-sub-openai">
      <div style="margin-bottom:14px;padding:12px 14px;background:#FEF2F2;border-radius:8px;border:1px solid #FECACA">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
          <span style="font-size:13px;font-weight:700;color:#DC2626">🔴 Alerte — Compte OpenAI partagé avec Smart Spec</span>
          <span class="proj-badge proj-danger">CRITIQUE</span>
        </div>
        <p style="font-size:12px;color:#78350F;margin:0 0 10px">Rubix Pitch utilise le même compte OpenAI que Smart Spec. Si Smart Spec consomme tous les crédits, <strong>Rubix Pitch tombe en erreur</strong> sans préavis.</p>
        <div style="font-size:12px;font-weight:700;color:#334155;margin-bottom:6px">Actions — Créer un compte OpenAI dédié</div>
        <ol style="margin:0;padding-left:18px;font-size:12px;color:#334155;line-height:2.1">
          <li><strong>Étape 1 :</strong> Créer un compte OpenAI avec une adresse email Rubix dédiée (ex. <code style="background:#F1F5F9;padding:1px 4px;border-radius:3px">ai-pitch@rubix.fr</code>)</li>
          <li><strong>Étape 2 :</strong> platform.openai.com → Billing → Ajouter une carte bancaire</li>
          <li><strong>Étape 3 :</strong> Charger <strong>au moins 50 $ de crédits</strong> (condition pour Tier 2 automatique après 7 jours)</li>
          <li><strong>Étape 4 :</strong> Settings → API Keys → Create new secret key</li>
          <li><strong>Étape 5 :</strong> Mettre à jour <code style="background:#F1F5F9;padding:1px 4px;border-radius:3px">OPENAI_API_KEY</code> dans Vercel → Settings → Environment Variables → Redéployer</li>
        </ol>
      </div>
      <div class="thr-i">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;flex-wrap:wrap">
          <h4 style="margin:0">Capacité OpenAI — Tiers</h4>
          <span class="proj-badge proj-warn">TIER 1 — 500 appels/min</span>
        </div>
        <div style="font-size:11px;color:#334155;margin-bottom:8px">Un pitch complet = <strong>6 appels API</strong>. En pic, le risque de blocage commence dès <strong>40-50 users simultanés</strong>.</div>
        <table>
          <thead><tr><th>Tier</th><th>Limite</th><th>Users simultanés (pic)</th><th>Statut</th></tr></thead>
          <tbody>
            <tr><td><strong>Tier 1</strong> (actuel)</td><td>500 appels/min</td><td>~40 en pic réel</td><td><span class="proj-badge proj-warn">Actif</span></td></tr>
            <tr><td><strong>Tier 2</strong> (cible)</td><td>5 000 appels/min</td><td>~800 users</td><td><span class="proj-badge proj-ok">Objectif</span></td></tr>
          </tbody>
        </table>
        <table style="margin-top:10px">
          <thead><tr><th>Users simultanés</th><th>Appels/min</th><th>vs Limite 500</th><th>Statut</th></tr></thead>
          <tbody>
            <tr><td>1 à 10 users</td><td>6 à 60/min</td><td style="color:#059669">OK (12%)</td><td><span class="proj-badge proj-ok">OK</span></td></tr>
            <tr><td>40-50 users (pic)</td><td>240-300/min</td><td style="color:#D97706;font-weight:700">Risque (60%)</td><td><span class="proj-badge proj-warn">ATTENTION</span></td></tr>
            <tr><td>80+ users</td><td>480+/min</td><td style="color:#DC2626;font-weight:700">Limite (96%+)</td><td><span class="proj-badge proj-danger">BLOQUÉ</span></td></tr>
          </tbody>
        </table>
        <div style="margin-top:10px;padding:8px 12px;background:#DBEAFE;border-radius:7px;border-left:3px solid #051E50;font-size:11px;color:#1D4ED8">
          <strong>Passage Tier 2 automatique :</strong> 50$ dépenses cumulées + 7 jours d'ancienneté sur le compte dédié. Confortable jusqu'à 250+ users simultanés.
        </div>
        <div style="font-size:11px;color:#1D4ED8;margin-top:6px" id="pitch-cost-detail">Chargement des coûts...</div>
      </div>
    </div><!-- /openai -->

    <!-- SUB-PAGE 3 : Formations -->
    <div class="sub-page" id="pitch-sub-formations">
      <div id="pitch-formations-widget"></div>
    </div><!-- /formations -->

    <!-- SUB-PAGE 4 : Coûts -->
    <div class="sub-page" id="pitch-sub-couts">
      <div id="pitch-couts-widget"></div>
    </div><!-- /couts -->

    <!-- SUB-PAGE 5 : Pilote & Transition IT -->
    <div class="sub-page" id="pitch-sub-pilote">
      <div id="pitch-pilote-widget"></div>
    </div><!-- /pilote -->

    <!-- SUB-PAGE 6 : Checklist -->
    <div class="sub-page" id="pitch-sub-checklist">
      <div style="font-size:14px;font-weight:700;color:#051E50;margin-bottom:3px">Checklist pré-formation</div>
      <div style="font-size:11px;color:#64748B;margin-bottom:14px">Cocher chaque item au fil de la préparation. Sauvegardé automatiquement dans le navigateur.</div>
      <div class="cl-cat-title">🛠️ Technique</div>
      <label class="cl-item" id="pitch-cl-c1" onclick="togglePitchCheck('c1')"><input type="checkbox" id="pitch-chk-c1" style="pointer-events:none;flex-shrink:0"><span>Tester la génération d'un pitch complet de bout en bout</span></label>
      <label class="cl-item" id="pitch-cl-c2" onclick="togglePitchCheck('c2')"><input type="checkbox" id="pitch-chk-c2" style="pointer-events:none;flex-shrink:0"><span>Vérifier que le déploiement Vercel est bien actif</span></label>
      <label class="cl-item" id="pitch-cl-c3" onclick="togglePitchCheck('c3')"><input type="checkbox" id="pitch-chk-c3" style="pointer-events:none;flex-shrink:0"><span>Confirmer que le compte OpenAI a assez de crédits</span></label>
      <label class="cl-item" id="pitch-cl-c4" onclick="togglePitchCheck('c4')"><input type="checkbox" id="pitch-chk-c4" style="pointer-events:none;flex-shrink:0"><span>Tester sur mobile (responsive) et sur desktop</span></label>
      <div class="cl-cat-title">🔒 Sécurité</div>
      <label class="cl-item" id="pitch-cl-c5" onclick="togglePitchCheck('c5')"><input type="checkbox" id="pitch-chk-c5" style="pointer-events:none;flex-shrink:0"><span>Confirmer que le mot de passe de connexion fonctionne</span></label>
      <label class="cl-item" id="pitch-cl-c6" onclick="togglePitchCheck('c6')"><input type="checkbox" id="pitch-chk-c6" style="pointer-events:none;flex-shrink:0"><span>Vérifier qu'aucune clé API n'est visible dans le code front</span></label>
      <div class="cl-cat-title">🎓 Formation</div>
      <label class="cl-item" id="pitch-cl-c7" onclick="togglePitchCheck('c7')"><input type="checkbox" id="pitch-chk-c7" style="pointer-events:none;flex-shrink:0"><span>Préparer 2-3 cas d'usage réels pour la démo</span></label>
      <label class="cl-item" id="pitch-cl-c8" onclick="togglePitchCheck('c8')"><input type="checkbox" id="pitch-chk-c8" style="pointer-events:none;flex-shrink:0"><span>Envoyer le lien + mot de passe aux commerciaux J-1</span></label>
      <label class="cl-item" id="pitch-cl-c9" onclick="togglePitchCheck('c9')"><input type="checkbox" id="pitch-chk-c9" style="pointer-events:none;flex-shrink:0"><span>Prévenir l'équipe du quota : 10 pitchs max/jour/user</span></label>
      <label class="cl-item" id="pitch-cl-c10" onclick="togglePitchCheck('c10')"><input type="checkbox" id="pitch-chk-c10" style="pointer-events:none;flex-shrink:0"><span>Préparer un message de secours si OpenAI est indisponible</span></label>
      <div class="cl-footer">
        <span id="pitch-cl-prog" style="color:#334155;font-weight:600"></span>
        <button class="cl-reset-btn" onclick="resetPitchChecklist()">Réinitialiser</button>
      </div>
    </div><!-- /checklist -->

    <!-- SUB-PAGE 6 : Chantiers techniques -->
    <div class="sub-page" id="pitch-sub-chantiers">
      <table style="margin-bottom:16px">
        <thead><tr><th>Action utilisateur</th><th>Appels IA</th><th>Modèle</th><th>Détail pipeline</th></tr></thead>
        <tbody>
          <tr><td style="font-weight:600">Analyser contexte</td><td>1 appel</td><td>gpt-3.5-turbo</td><td>Identification enjeux métier</td></tr>
          <tr style="border-top:2px solid #E2E8F0">
            <td style="font-weight:600" rowspan="3">Générer pitch (3 versions)</td>
            <td style="font-weight:700;color:#D97706">6+ appels</td>
            <td>gpt-3.5-turbo + Assistant</td>
            <td style="font-size:10px;color:#D97706">Pipeline ci-dessous</td>
          </tr>
          <tr><td colspan="3" style="font-size:10px;color:#64748B;padding-left:20px">1. Prioriser solutions &nbsp; 2. Prioriser questions &nbsp; 3. Prioriser tendances &nbsp; 4. Prioriser crédibilité &nbsp; 5. Prioriser pyramide &nbsp; 6. Génération finale (Assistant API)</td></tr>
          <tr><td colspan="3" style="font-size:10px;color:#059669;padding-left:20px">Les 5 priorisations peuvent être parallélisées avec Promise.all()</td></tr>
          <tr><td style="font-weight:600">Générer one-pager</td><td>6+ appels</td><td>Assistant API</td><td>Même pipeline priorisation + fusion</td></tr>
        </tbody>
      </table>
      <div style="margin-bottom:14px;padding:10px;background:#FEE2E2;border-radius:7px;border:1px solid #FECACA">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
          <span style="font-size:12px;font-weight:700;color:#DC2626">Timeout Vercel</span>
          <span class="proj-badge proj-danger">FAIBLE</span>
          <span style="font-size:11px;color:#64748B">55s / 60s = 92% de la limite</span>
        </div>
        <div class="pitch-prog-bar"><div class="pitch-prog-fill" style="width:92%"></div></div>
        <table style="margin-top:10px">
          <thead><tr><th>Situation</th><th>Temps</th><th>Marge</th><th>Sécurité</th></tr></thead>
          <tbody>
            <tr><td>Polling actuel (runs.retrieve)</td><td style="color:#DC2626;font-weight:700">~55s</td><td style="color:#DC2626">5s</td><td><span class="proj-badge proj-danger">FAIBLE</span></td></tr>
            <tr><td>Promise.all() parallèle</td><td style="color:#D97706;font-weight:700">~25-30s</td><td style="color:#D97706">30s</td><td><span class="proj-badge proj-warn">MOYENNE</span></td></tr>
            <tr><td>Streaming natif OpenAI</td><td style="color:#059669">connexion maintenue</td><td style="color:#059669">∞</td><td><span class="proj-badge proj-ok">HAUTE</span></td></tr>
          </tbody>
        </table>
      </div>
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;flex-wrap:wrap">
        <div style="font-size:14px;font-weight:800;color:#051E50">Plan de scaling — 8 chantiers</div>
        <span class="badge bd">3 CRITIQUES</span><span class="badge bw">3 IMPORTANTS</span><span class="badge bv">2 OPTIMISATIONS</span>
      </div>
      <table style="margin-bottom:14px">
        <thead><tr><th>Priorité</th><th>Chantier</th><th>Impact</th><th>Effort</th><th>Statut</th></tr></thead>
        <tbody>
          <tr><td>1</td><td>Gestion d'erreur UX (messages + bouton réessayer)</td><td><span class="proj-badge proj-danger">CRITIQUE</span></td><td>Moyen</td><td><span class="proj-badge proj-warn">À FAIRE</span></td></tr>
          <tr><td>2</td><td>Retry automatique exponential backoff (429/500)</td><td><span class="proj-badge proj-danger">CRITIQUE</span></td><td>Faible</td><td><span class="proj-badge proj-warn">À FAIRE</span></td></tr>
          <tr><td>3</td><td>Compte OpenAI dédié Rubix Pitch</td><td><span class="proj-badge proj-danger">CRITIQUE</span></td><td>Faible</td><td><span class="proj-badge proj-warn">À FAIRE</span></td></tr>
          <tr><td>4</td><td>Timeout : Promise.all() + streaming</td><td><span class="proj-badge proj-warn">IMPORTANT</span></td><td>Moyen</td><td><span class="proj-badge proj-warn">À FAIRE</span></td></tr>
          <tr><td>5</td><td>Logging structuré des erreurs et métriques</td><td><span class="proj-badge proj-warn">IMPORTANT</span></td><td>Faible</td><td><span class="proj-badge proj-warn">À FAIRE</span></td></tr>
          <tr><td>6</td><td>Endpoint health check /api/health</td><td><span class="proj-badge proj-warn">IMPORTANT</span></td><td>Moyen</td><td><span class="proj-badge proj-warn">À FAIRE</span></td></tr>
          <tr><td>7</td><td>Cache priorisations par secteur/fonction (1h)</td><td><span class="proj-badge proj-ok">OPTIMISATION</span></td><td>Moyen</td><td><span class="proj-badge proj-warn">À FAIRE</span></td></tr>
          <tr><td>8</td><td>Mode dégradé si OpenAI est down</td><td><span class="proj-badge proj-ok">OPTIMISATION</span></td><td>Moyen</td><td><span class="proj-badge proj-warn">À FAIRE</span></td></tr>
        </tbody>
      </table>
      <div style="padding:12px;background:#FEE2E2;border-radius:8px;border-left:4px solid #DC2626;margin-bottom:8px">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;flex-wrap:wrap"><span style="font-size:12px;font-weight:800;color:#DC2626">Chantier 1 — Gestion d'erreur côté utilisateur</span><span class="proj-badge proj-danger">CRITIQUE</span></div>
        <div style="font-size:11px;color:#334155;margin-bottom:8px">Quand OpenAI renvoie une erreur, le commercial voit un spinner infini ou un écran blanc. Pas de message d'erreur, pas de bouton réessayer.</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:11px">
          <div style="padding:6px 8px;background:#fff;border-radius:5px;border:1px solid #FECACA"><strong style="color:#DC2626">Timeout</strong><br>→ "La génération prend plus de temps que prévu. Veuillez réessayer."</div>
          <div style="padding:6px 8px;background:#fff;border-radius:5px;border:1px solid #FECACA"><strong style="color:#DC2626">429 (trop de requêtes)</strong><br>→ "Forte affluence. Veuillez patienter quelques secondes puis réessayer."</div>
          <div style="padding:6px 8px;background:#fff;border-radius:5px;border:1px solid #FECACA"><strong style="color:#DC2626">500 (erreur serveur)</strong><br>→ "Service temporairement indisponible. Réessayez dans quelques instants."</div>
          <div style="padding:6px 8px;background:#fff;border-radius:5px;border:1px solid #FECACA"><strong style="color:#DC2626">Règle générale</strong><br>→ Spinner limité à 60s. Bouton "Réessayer" sans perdre les données saisies.</div>
        </div>
        <div style="font-size:10px;color:#64748B;margin-top:6px">Fichier : <code style="background:#F1F5F9;padding:1px 4px;border-radius:3px">useContentGeneration.js</code></div>
      </div>
      <div style="padding:12px;background:#FEE2E2;border-radius:8px;border-left:4px solid #DC2626;margin-bottom:8px">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;flex-wrap:wrap"><span style="font-size:12px;font-weight:800;color:#DC2626">Chantier 2 — Retry automatique (exponential backoff)</span><span class="proj-badge proj-danger">CRITIQUE</span></div>
        <div style="font-size:11px;color:#334155;margin-bottom:6px">Si OpenAI renvoie 429, l'app abandonne immédiatement. À 50 users, les 429 arrivent régulièrement en pic.</div>
        <div style="padding:8px;background:#fff;border-radius:5px;border:1px solid #FECACA;font-size:11px;color:#334155"><strong>Logique :</strong> 429 ou 500/502/503 → attendre 1s → réessayer → 2s → 4s. Max 3 retries.<br><code style="font-size:10px">callOpenAIWithRetry(params, maxRetries=3) — sleep(2^i × 1000ms)</code></div>
        <div style="font-size:10px;color:#64748B;margin-top:6px">Fichiers : <code style="background:#F1F5F9;padding:1px 4px;border-radius:3px">api/generate-pitch.js</code> + <code style="background:#F1F5F9;padding:1px 4px;border-radius:3px">api/generate-fusion.js</code></div>
      </div>
      <div style="padding:12px;background:#FEFCE8;border-radius:8px;border-left:4px solid #FFD700;margin-bottom:8px">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;flex-wrap:wrap"><span style="font-size:12px;font-weight:800;color:#92400E">Chantier 3 — Compte OpenAI dédié</span><span class="proj-badge proj-danger">CRITIQUE</span></div>
        <div style="font-size:11px;color:#334155">Compte partagé avec Smart Spec. <strong>Résolution (15 min) :</strong> voir onglet "OpenAI &amp; Tiers" pour les 5 étapes détaillées.</div>
      </div>
      <div style="padding:12px;background:#FEFCE8;border-radius:8px;border-left:4px solid #FFD700;margin-bottom:8px">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;flex-wrap:wrap"><span style="font-size:12px;font-weight:800;color:#92400E">Chantier 4 — Timeout : paralléliser + streaming</span><span class="proj-badge proj-warn">IMPORTANT</span></div>
        <div style="font-size:11px;color:#334155"><strong style="color:#D97706">Étape 1 :</strong> <code style="background:#F1F5F9;padding:1px 4px;border-radius:3px">Promise.all()</code> dans <strong>useContentGeneration.js</strong> → 55s à 25-30s.<br><strong style="color:#059669">Étape 2 :</strong> Remplacer <code style="background:#F1F5F9;padding:1px 4px;border-radius:3px">runs.retrieve()</code> par <code style="background:#F1F5F9;padding:1px 4px;border-radius:3px">stream()</code> dans <strong>api/generate-pitch.js</strong> → plus aucun timeout.</div>
      </div>
      <div style="padding:12px;background:#EFF6FF;border-radius:8px;border-left:4px solid #1D4ED8;margin-bottom:8px">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;flex-wrap:wrap"><span style="font-size:12px;font-weight:800;color:#1D4ED8">Chantier 5 — Logging structuré</span><span class="proj-badge proj-warn">IMPORTANT</span></div>
        <div style="padding:6px 8px;background:#fff;border-radius:5px;border:1px solid #BFDBFE;font-size:10px;color:#334155;font-family:monospace">&#123; "event": "pitch_generated", "secteur": "agroalimentaire", "duree_ms": 34500, "status": "success" &#125;<br>&#123; "event": "pitch_error", "error_type": "timeout|rate_limit", "retry_count": 2 &#125;</div>
        <div style="font-size:10px;color:#64748B;margin-top:5px">Visible dans Vercel Dashboard → Functions → Logs. Aucune infra supplémentaire.</div>
      </div>
      <div style="padding:12px;background:#EFF6FF;border-radius:8px;border-left:4px solid #1D4ED8;margin-bottom:8px">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;flex-wrap:wrap"><span style="font-size:12px;font-weight:800;color:#1D4ED8">Chantier 6 — Health check /api/health</span><span class="proj-badge proj-warn">IMPORTANT</span></div>
        <div style="font-size:11px;color:#334155">Créer <code style="background:#F1F5F9;padding:1px 4px;border-radius:3px">/api/health</code> → test OpenAI + Blob. Réponse : <code style="background:#F1F5F9;padding:1px 4px;border-radius:3px">&#123; status:"ok"|"degraded", openai:"ok"|"ko", blob:"ok"|"ko" &#125;</code><br>Brancher UptimeRobot (gratuit) → alerte email si KO.</div>
      </div>
      <div style="padding:12px;background:#ECFDF5;border-radius:8px;border-left:4px solid #059669;margin-bottom:8px">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;flex-wrap:wrap"><span style="font-size:12px;font-weight:800;color:#059669">Chantier 7 — Cache priorisations (1h)</span><span class="proj-badge proj-ok">OPTIMISATION</span></div>
        <div style="font-size:11px;color:#334155">Clé : <code style="background:#F1F5F9;padding:1px 4px;border-radius:3px">${secteur}_${fonction}_${langue}</code>. TTL 1h. Stockage Vercel Blob JSON (gratuit).<br><strong>Gain estimé : divise les appels API par 3 à 5x en conditions réelles.</strong></div>
      </div>
      <div style="padding:12px;background:#ECFDF5;border-radius:8px;border-left:4px solid #059669;margin-bottom:8px">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;flex-wrap:wrap"><span style="font-size:12px;font-weight:800;color:#059669">Chantier 8 — Mode dégradé si OpenAI est down</span><span class="proj-badge proj-ok">OPTIMISATION</span></div>
        <div style="font-size:11px;color:#334155">Sauvegarder chaque pitch généré dans Vercel Blob. Si OpenAI échoue après 3 retries → servir le cache avec bandeau : <strong>"⚠️ Service IA indisponible. Pitch basé sur une génération récente."</strong></div>
      </div>
      <div class="reco">
        <h4>Recommandations pour scaler</h4>
        <p>1. <strong>Paralléliser les 5 priorisations</strong> : Promise.all() (divise le temps par ~5, même nombre d'appels)</p>
        <p>2. <strong>Remplacer polling par streaming</strong> : stream() au lieu de runs.retrieve() → sécurité haute</p>
        <p>3. <strong>Monter de Tier OpenAI</strong> : Tier 2 = 5 000 appels/min. Automatique après 50$ + 7 jours</p>
        <p>4. <strong>Cacher les priorisations</strong> : même secteur/fonction → même résultat → économise 3-5x les appels</p>
      </div>
      <div class="links">
        <a href="https://platform.openai.com/usage" target="_blank" class="btn btn-o">OpenAI Usage</a>
        <a href="https://platform.openai.com/settings/organization/limits" target="_blank" class="btn btn-o">Rate Limits</a>
      </div>
    </div><!-- /chantiers -->

    <!-- (ancien contenu supprimé — contenu migré dans les sous-onglets ci-dessus) -->
    <div style="display:none"><!-- dummy pour préserver les IDs dynamiques pitch-build etc. -->
      <div class="section-body open" style="display:none">
        <div class="app-meta">
          <div class="meta-card">
            <div class="meta-label">Dernier déploiement</div>
            <div class="meta-val" id="pitch-last-deploy"></div>
          </div>
          <div class="meta-card">
            <div class="meta-label">Coût / pitch complet (6 appels)</div>
            <div class="meta-val" id="pitch-cost-per-pitch"></div>
          </div>
        </div>

        <div style="margin-bottom:14px;padding:12px 14px;background:#FEFCE8;border-radius:8px;border:1px solid #FFD700">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
            <span style="font-size:13px;font-weight:700;color:#92400E">⚠️ Compte OpenAI partagé — aucun budget dédié</span>
            <span class="proj-badge proj-danger">RISQUE</span>
          </div>
          <div style="font-size:12px;color:#78350F;line-height:1.6">
            Rubix Pitch est rattaché au compte OpenAI de <strong>Smart Spec</strong> (pas de compte séparé).<br>
            Si Smart Spec consomme tous les crédits, <strong>Pitch Generator s'arrête immédiatement</strong> sans préavis.
          </div>
          <div style="margin-top:8px;padding:8px;background:#FEFCE8;border-radius:6px;font-size:11px;color:#334155">
            <strong style="color:#D97706">Action à faire :</strong> Créer un compte OpenAI dédié pour Rubix Pitch avec un budget séparé. Mettre à jour la variable d'environnement <code style="background:#F1F5F9;padding:1px 4px;border-radius:3px">OPENAI_API_KEY</code> dans Vercel.
          </div>
        </div>

        <table>
          <thead><tr><th>Action utilisateur</th><th>Appels IA</th><th>Modele</th><th>Detail pipeline</th></tr></thead>
          <tbody>
            <tr><td style="font-weight:600">Analyser contexte</td><td>1 appel</td><td>gpt-3.5-turbo</td><td>Identification enjeux metier</td></tr>
            <tr style="border-top:2px solid #E2E8F0">
              <td style="font-weight:600" rowspan="3">Générer pitch (3 versions)</td>
              <td style="font-weight:700;color:#D97706">6+ appels</td>
              <td>gpt-3.5-turbo + Assistant</td>
              <td style="font-size:10px;color:#D97706">Pipeline ci-dessous</td>
            </tr>
            <tr><td colspan="3" style="font-size:10px;color:#64748B;padding-left:20px">1. Prioriser solutions &nbsp; 2. Prioriser questions &nbsp; 3. Prioriser tendances &nbsp; 4. Prioriser credibilite &nbsp; 5. Prioriser pyramide &nbsp; 6. Génération finale (Assistant API)</td></tr>
            <tr><td colspan="3" style="font-size:10px;color:#059669;padding-left:20px">Les 5 priorisations peuvent etre parallélisées avec Promise.all()</td></tr>
            <tr><td style="font-weight:600">Générer one-pager</td><td>6+ appels</td><td>Assistant API</td><td>Meme pipeline priorisation + fusion</td></tr>
          </tbody>
        </table>

        <div class="thr-i">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;flex-wrap:wrap">
            <h4 style="margin:0">Capacité OpenAI — Tier actuel</h4>
            <span class="proj-badge proj-warn">TIER 1 — 500 appels/min</span>
          </div>
          <div style="font-size:11px;color:#334155;margin-bottom:8px">Un pitch complet = <strong>6 appels API</strong>. En pic (tout le monde génère en même temps le matin), le risque de blocage commence dès <strong>40-50 users simultanés</strong>.</div>
          <table>
            <thead><tr><th>Users simultanés</th><th>Appels/min</th><th>vs Limite 500</th><th>Statut</th></tr></thead>
            <tbody>
              <tr><td>1 à 10 users</td><td>6 à 60 appels/min</td><td style="color:#059669">OK (12%)</td><td><span class="proj-badge proj-ok">OK</span></td></tr>
              <tr><td>40-50 users (pic)</td><td>240-300 appels/min</td><td style="color:#D97706;font-weight:700">Risque en pic (60%)</td><td><span class="proj-badge proj-warn">ATTENTION</span></td></tr>
              <tr><td>80+ users</td><td>480+ appels/min</td><td style="color:#DC2626;font-weight:700">Limite dépassée (96%+)</td><td><span class="proj-badge proj-danger">BLOQUÉ</span></td></tr>
            </tbody>
          </table>
          <div style="margin-top:10px;padding:8px 12px;background:#DBEAFE;border-radius:7px;border-left:3px solid #051E50;font-size:11px;color:#1D4ED8">
            <strong>Pour scaler à 50 users en toute sécurité → Tier 2 OpenAI (5 000 appels/min)</strong><br>
            Condition : <strong>50$ de dépenses cumulées + 7 jours d'ancienneté</strong> sur le compte. Passage automatique, aucune action manuelle. Tier 2 = confortable jusqu'à 250+ users simultanés.
          </div>
          <div style="font-size:11px;color:#1D4ED8;margin-top:6px" id="pitch-cost-detail">Chargement des coûts...</div>
        </div>

        <div style="margin-top:10px;padding:10px;background:#FEE2E2;border-radius:7px;border:1px solid #FECACA">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
            <span style="font-size:12px;font-weight:700;color:#DC2626">Sécurité timeout Vercel</span>
            <span class="proj-badge proj-danger">FAIBLE</span>
            <span style="font-size:11px;color:#64748B">55s / 60s = 92% de la limite</span>
          </div>
          <table>
            <thead><tr><th>Situation</th><th>Temps</th><th>Limite</th><th>Marge</th><th>Sécurité</th></tr></thead>
            <tbody>
              <tr><td style="font-weight:600">Polling Assistant API (actuel)</td><td style="color:#DC2626;font-weight:700">~55s</td><td>60s</td><td style="color:#DC2626;font-weight:700">5s</td><td><span class="proj-badge proj-danger">FAIBLE</span></td></tr>
              <tr><td style="font-weight:600">Priorisations parallèles (Promise.all)</td><td style="color:#D97706;font-weight:700">~25-30s</td><td>60s</td><td style="color:#D97706">30s</td><td><span class="proj-badge proj-warn">MOYENNE</span></td></tr>
              <tr><td style="font-weight:600">Streaming natif OpenAI (cible)</td><td style="color:#059669;font-weight:700">connexion maintenue</td><td>N/A</td><td style="color:#059669">illimitee</td><td><span class="proj-badge proj-ok">HAUTE</span></td></tr>
            </tbody>
          </table>
          <div style="margin-top:10px;font-size:12px;font-weight:700;color:#051E50;margin-bottom:6px">Modifications a faire pour atteindre sécurité haute</div>
          <div style="padding:8px;background:#FEFCE8;border-radius:6px;margin-bottom:6px;font-size:11px;color:#334155">
            <strong style="color:#D97706">Étape 1 (rapide) :</strong> Paralléliser les 5 priorisations avec <code style="background:#F1F5F9;padding:1px 4px;border-radius:3px">Promise.all()</code> dans <strong>useContentGénération.js</strong>. Passe de 55s à 25-30s. Sécurité moyenne.</div>
          <div style="padding:8px;background:#ECFDF5;border-radius:6px;font-size:11px;color:#334155">
            <strong style="color:#059669">Étape 2 (sécurité haute) :</strong> Remplacer le polling <code style="background:#F1F5F9;padding:1px 4px;border-radius:3px">assistants.runs.retrieve()</code> par <code style="background:#F1F5F9;padding:1px 4px;border-radius:3px">stream()</code> de l'API OpenAI. Le streaming garde la connexion vivante, le timeout de 60s ne s'applique plus. Fichier à modifier : <strong>api/generate-pitch.js</strong> (ou équivalent backend).</div>
        </div>

        <div class="reco">
          <h4>Recommandations pour scaler</h4>
          <p>1. <strong>Paralléliser les 5 priorisations</strong> : Promise.all() au lieu de sequentiel (divise le temps par 5, même nombre d'appels)</p>
          <p>2. <strong>Remplacer polling par streaming</strong> : utiliser stream() de l'API OpenAI Assistants à la place de runs.retrieve() — sécurité haute</p>
          <p>3. <strong>Monter de tier OpenAI</strong> : Tier 2 = 5 000 appels/min (x10). Automatique apres 50$ dépenses + 7 jours</p>
          <p>4. <strong>Cacher la matrice enrichie</strong> : les priorisations pour un même secteur/fonction sont identiques, cacher 1h</p>
        </div>

        <!-- PLAN DE SCALING -->
        <div style="margin-top:16px">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;flex-wrap:wrap">
            <div style="font-size:14px;font-weight:800;color:#051E50">Plan de scaling — 8 chantiers</div>
            <span class="badge bd">2 CRITIQUES</span>
            <span class="badge bw">3 IMPORTANTS</span>
            <span class="badge bv">3 OPTIMISATIONS</span>
          </div>

          <!-- Tableau priorités -->
          <table style="margin-bottom:14px">
            <thead><tr><th>Priorité</th><th>Chantier</th><th>Impact</th><th>Effort</th><th>Statut</th></tr></thead>
            <tbody>
              <tr><td style="font-weight:700">1</td><td>Gestion d'erreur UX (messages + bouton réessayer)</td><td><span class="proj-badge proj-danger">CRITIQUE</span></td><td>Moyen</td><td><span class="proj-badge proj-warn">À FAIRE</span></td></tr>
              <tr><td style="font-weight:700">2</td><td>Retry automatique exponential backoff (429/500)</td><td><span class="proj-badge proj-danger">CRITIQUE</span></td><td>Faible</td><td><span class="proj-badge proj-warn">À FAIRE</span></td></tr>
              <tr><td style="font-weight:700">3</td><td>Compte OpenAI dédié Rubix Pitch</td><td><span class="proj-badge proj-danger">CRITIQUE</span></td><td>Faible</td><td><span class="proj-badge proj-warn">À FAIRE</span></td></tr>
              <tr><td style="font-weight:700">4</td><td>Timeout Vercel : paralléliser + streaming</td><td><span class="proj-badge proj-warn">IMPORTANT</span></td><td>Moyen</td><td><span class="proj-badge proj-warn">À FAIRE</span></td></tr>
              <tr><td style="font-weight:700">5</td><td>Logging structuré des erreurs et métriques</td><td><span class="proj-badge proj-warn">IMPORTANT</span></td><td>Faible</td><td><span class="proj-badge proj-warn">À FAIRE</span></td></tr>
              <tr><td style="font-weight:700">6</td><td>Endpoint health check /api/health</td><td><span class="proj-badge proj-warn">IMPORTANT</span></td><td>Moyen</td><td><span class="proj-badge proj-warn">À FAIRE</span></td></tr>
              <tr><td style="font-weight:700">7</td><td>Cache priorisations par secteur/fonction (1h)</td><td><span class="proj-badge proj-ok">OPTIMISATION</span></td><td>Moyen</td><td><span class="proj-badge proj-warn">À FAIRE</span></td></tr>
              <tr><td style="font-weight:700">8</td><td>Mode dégradé si OpenAI est down</td><td><span class="proj-badge proj-ok">OPTIMISATION</span></td><td>Moyen</td><td><span class="proj-badge proj-warn">À FAIRE</span></td></tr>
            </tbody>
          </table>

          <!-- Chantier 1 -->
          <div style="padding:12px;background:#FEE2E2;border-radius:8px;border-left:4px solid #DC2626;margin-bottom:8px">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;flex-wrap:wrap">
              <span style="font-size:12px;font-weight:800;color:#DC2626">Chantier 1 — Gestion d'erreur côté utilisateur</span>
              <span class="proj-badge proj-danger">CRITIQUE</span><span class="proj-badge proj-warn">À FAIRE</span>
            </div>
            <div style="font-size:11px;color:#334155;margin-bottom:8px">Quand OpenAI renvoie une erreur (timeout, 429, 500), le commercial voit un spinner infini ou un écran blanc. Pas de message d'erreur, pas de bouton réessayer. L'app semble cassée.</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:11px">
              <div style="padding:6px 8px;background:#fff;border-radius:5px;border:1px solid #FECACA"><strong style="color:#DC2626">Timeout</strong><br>→ "La génération prend plus de temps que prévu. Veuillez réessayer."</div>
              <div style="padding:6px 8px;background:#fff;border-radius:5px;border:1px solid #FECACA"><strong style="color:#DC2626">429 (trop de requêtes)</strong><br>→ "Forte affluence. Veuillez patienter quelques secondes puis réessayer."</div>
              <div style="padding:6px 8px;background:#fff;border-radius:5px;border:1px solid #FECACA"><strong style="color:#DC2626">500 (erreur serveur)</strong><br>→ "Service temporairement indisponible. Réessayez dans quelques instants."</div>
              <div style="padding:6px 8px;background:#fff;border-radius:5px;border:1px solid #FECACA"><strong style="color:#DC2626">Règle générale</strong><br>→ Spinner limité à 60s. Bouton "Réessayer" sans perdre les données saisies.</div>
            </div>
            <div style="font-size:10px;color:#64748B;margin-top:6px">Fichier : <code style="background:#F1F5F9;padding:1px 4px;border-radius:3px">useContentGeneration.js</code> (frontend) — Style : fond #FFF9E6, bouton réessayer bleu #051E50</div>
          </div>

          <!-- Chantier 2 -->
          <div style="padding:12px;background:#FEE2E2;border-radius:8px;border-left:4px solid #DC2626;margin-bottom:8px">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;flex-wrap:wrap">
              <span style="font-size:12px;font-weight:800;color:#DC2626">Chantier 2 — Retry automatique (exponential backoff)</span>
              <span class="proj-badge proj-danger">CRITIQUE</span><span class="proj-badge proj-warn">À FAIRE</span>
            </div>
            <div style="font-size:11px;color:#334155;margin-bottom:8px">Si OpenAI renvoie 429, l'app abandonne immédiatement. À 50 users, les 429 arrivent régulièrement en pic. Il faut réessayer automatiquement avant d'afficher une erreur.</div>
            <div style="padding:8px;background:#fff;border-radius:5px;border:1px solid #FECACA;font-size:11px;color:#334155">
              <strong>Logique :</strong> 429 ou 500/502/503 → attendre 1s → réessayer → 2s → réessayer → 4s → réessayer. Max 3 retries. Erreurs 400/401 = ne pas réessayer (problème de requête ou auth).<br>
              <code style="background:#F1F5F9;padding:2px 4px;border-radius:3px;font-size:10px">callOpenAIWithRetry(params, maxRetries=3) — sleep(2^i * 1000ms)</code>
            </div>
            <div style="font-size:10px;color:#64748B;margin-top:6px">Fichiers : <code style="background:#F1F5F9;padding:1px 4px;border-radius:3px">api/generate-pitch.js</code> + <code style="background:#F1F5F9;padding:1px 4px;border-radius:3px">api/generate-fusion.js</code></div>
          </div>

          <!-- Chantier 3 -->
          <div style="padding:12px;background:#FEFCE8;border-radius:8px;border-left:4px solid #FFD700;margin-bottom:8px">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;flex-wrap:wrap">
              <span style="font-size:12px;font-weight:800;color:#92400E">Chantier 3 — Compte OpenAI dédié Rubix Pitch</span>
              <span class="proj-badge proj-danger">CRITIQUE</span><span class="proj-badge proj-warn">À FAIRE</span>
            </div>
            <div style="font-size:11px;color:#334155;margin-bottom:6px">Compte partagé avec Smart Spec. Si Smart Spec consomme tous les crédits, Rubix Pitch s'arrête immédiatement sans préavis. Aucun commercial ne comprendra pourquoi l'app ne répond plus.</div>
            <div style="font-size:11px;color:#334155"><strong>Résolution (15 min) :</strong> 1. Créer un compte OpenAI dédié (email dédié Rubix Pitch) → 2. Ajouter moyen de paiement + budget mensuel → 3. Générer nouvelle clé API → 4. Mettre à jour <code style="background:#F1F5F9;padding:1px 4px;border-radius:3px">OPENAI_API_KEY</code> dans Vercel → 5. Redéployer</div>
          </div>

          <!-- Chantier 4 -->
          <div style="padding:12px;background:#FEFCE8;border-radius:8px;border-left:4px solid #FFD700;margin-bottom:8px">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;flex-wrap:wrap">
              <span style="font-size:12px;font-weight:800;color:#92400E">Chantier 4 — Timeout Vercel : paralléliser + streaming</span>
              <span class="proj-badge proj-warn">IMPORTANT</span><span class="proj-badge proj-warn">À FAIRE</span>
            </div>
            <div style="font-size:11px;color:#334155;margin-bottom:6px">Pipeline actuel = ~55s. Limite Vercel = 60s. Marge = 5s. Si OpenAI ralentit légèrement, le commercial voit un écran blanc.</div>
            <div style="font-size:11px;color:#334155">
              <strong style="color:#D97706">Étape 1 (rapide) :</strong> Paralléliser les 5 priorisations avec <code style="background:#F1F5F9;padding:1px 4px;border-radius:3px">Promise.all()</code> dans <strong>useContentGeneration.js</strong>. Passe de 55s à 25-30s. Marge 30s.<br>
              <strong style="color:#059669">Étape 2 (sécurité haute) :</strong> Remplacer le polling <code style="background:#F1F5F9;padding:1px 4px;border-radius:3px">runs.retrieve()</code> par <code style="background:#F1F5F9;padding:1px 4px;border-radius:3px">stream()</code> dans <strong>api/generate-pitch.js</strong>. Plus aucun timeout.
            </div>
          </div>

          <!-- Chantier 5 -->
          <div style="padding:12px;background:#EFF6FF;border-radius:8px;border-left:4px solid #1D4ED8;margin-bottom:8px">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;flex-wrap:wrap">
              <span style="font-size:12px;font-weight:800;color:#1D4ED8">Chantier 5 — Logging structuré des erreurs et métriques</span>
              <span class="proj-badge proj-warn">IMPORTANT</span><span class="proj-badge proj-warn">À FAIRE</span>
            </div>
            <div style="font-size:11px;color:#334155;margin-bottom:6px">Aujourd'hui on ne sait pas combien de pitchs sont générés, quels secteurs sont populaires, ni combien d'erreurs se produisent. Impossible de mesurer le ROI.</div>
            <div style="padding:6px 8px;background:#fff;border-radius:5px;border:1px solid #BFDBFE;font-size:10px;color:#334155;font-family:monospace">
              &#123; "event": "pitch_generated", "secteur": "agroalimentaire", "fonction": "resp-achats", "duree_ms": 34500, "status": "success", "appels_openai": 6 &#125;<br>
              &#123; "event": "pitch_error", "error_type": "timeout|rate_limit|openai_500", "retry_count": 2 &#125;
            </div>
            <div style="font-size:10px;color:#64748B;margin-top:6px">Lisible dans Vercel Dashboard → Functions → Logs. Aucune infrastructure supplémentaire. Fichiers : <code style="background:#F1F5F9;padding:1px 4px;border-radius:3px">api/generate-pitch.js</code> + <code style="background:#F1F5F9;padding:1px 4px;border-radius:3px">api/generate-fusion.js</code></div>
          </div>

          <!-- Chantier 6 -->
          <div style="padding:12px;background:#EFF6FF;border-radius:8px;border-left:4px solid #1D4ED8;margin-bottom:8px">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;flex-wrap:wrap">
              <span style="font-size:12px;font-weight:800;color:#1D4ED8">Chantier 6 — Endpoint health check /api/health</span>
              <span class="proj-badge proj-warn">IMPORTANT</span><span class="proj-badge proj-warn">À FAIRE</span>
            </div>
            <div style="font-size:11px;color:#334155;margin-bottom:6px">Aujourd'hui personne ne sait si l'app est up ou down avant qu'un commercial se plaigne.</div>
            <div style="font-size:11px;color:#334155;margin-bottom:6px">Créer <code style="background:#F1F5F9;padding:1px 4px;border-radius:3px">/api/health</code> qui teste : connectivité OpenAI (1 appel minimal) + accès Vercel Blob. Réponse JSON : <code style="background:#F1F5F9;padding:1px 4px;border-radius:3px">&#123; status: "ok"|"degraded", openai: "ok"|"ko", blob: "ok"|"ko", timestamp &#125;</code></div>
            <div style="font-size:10px;color:#64748B">Suggestion : brancher UptimeRobot (gratuit) → appelle <code style="background:#F1F5F9;padding:1px 4px;border-radius:3px">/api/health</code> toutes les 5 min → alerte email/Slack si KO</div>
          </div>

          <!-- Chantier 7 -->
          <div style="padding:12px;background:#ECFDF5;border-radius:8px;border-left:4px solid #059669;margin-bottom:8px">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;flex-wrap:wrap">
              <span style="font-size:12px;font-weight:800;color:#059669">Chantier 7 — Cache priorisations par secteur/fonction (1h)</span>
              <span class="proj-badge proj-ok">OPTIMISATION</span><span class="proj-badge proj-warn">À FAIRE</span>
            </div>
            <div style="font-size:11px;color:#334155;margin-bottom:6px">Les 5 priorisations (solutions, questions, tendances, crédibilité, pyramide) donnent le même résultat pour un même secteur + fonction. 10 commerciaux sur le même secteur = 50 appels inutiles.</div>
            <div style="font-size:11px;color:#334155">
              Clé de cache : <code style="background:#F1F5F9;padding:1px 4px;border-radius:3px">${secteur}_${fonction}_${langue}</code> (ex: "agroalimentaire_resp-achats_fr")<br>
              TTL : 1h. Stockage : Vercel KV (Redis, payant) ou Vercel Blob JSON (gratuit, moins rapide).<br>
              Le contexte libre saisi par le commercial n'est PAS inclus dans la clé (envoyé uniquement à la génération finale).<br>
              <strong>Gain estimé : divise les appels API par 3 à 5x en conditions réelles.</strong>
            </div>
          </div>

          <!-- Chantier 8 -->
          <div style="padding:12px;background:#ECFDF5;border-radius:8px;border-left:4px solid #059669;margin-bottom:8px">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;flex-wrap:wrap">
              <span style="font-size:12px;font-weight:800;color:#059669">Chantier 8 — Mode dégradé si OpenAI est down</span>
              <span class="proj-badge proj-ok">OPTIMISATION</span><span class="proj-badge proj-warn">À FAIRE</span>
            </div>
            <div style="font-size:11px;color:#334155;margin-bottom:6px">Si OpenAI tombe (pannes de quelques minutes à quelques heures), l'app est 100% inutilisable. Le commercial devant son client n'a rien.</div>
            <div style="font-size:11px;color:#334155">
              À chaque pitch généré avec succès → sauvegarder dans Vercel Blob : <code style="background:#F1F5F9;padding:1px 4px;border-radius:3px">cache_pitch_${secteur}_${fonction}_${langue}</code>.<br>
              Si OpenAI échoue après 3 retries → servir le pitch en cache avec bandeau : <strong>"⚠️ Service IA indisponible. Ce pitch est basé sur une génération récente."</strong><br>
              Si aucun cache disponible → message d'erreur standard (chantier 1).
            </div>
          </div>

        </div>

        <div class="mini-metrics">
          <div class="mini-metric"><div class="mini-val" id="pitch-build"></div><div class="mini-label">Build min</div></div>
          <div class="mini-metric"><div class="mini-val" id="pitch-bw"></div><div class="mini-label">Bandwidth</div></div>
          <div class="mini-metric"><div class="mini-val" id="pitch-fninv"></div><div class="mini-label">Fn Invocations</div></div>
          <div class="mini-metric"><div class="mini-val" id="pitch-fndur"></div><div class="mini-label">Fn Duration</div></div>
        </div>

        <div class="links">
          <a href="https://platform.openai.com/usage" target="_blank" class="btn btn-o">OpenAI Usage</a>
          <a href="https://platform.openai.com/settings/organization/limits" target="_blank" class="btn btn-o">Rate Limits</a>
        </div>
      </div>
    </div>
  </div>
  </div>

  <!-- ONGLET SMART CONTENT -->
  <div class="page" id="page-smart">
  <div class="container">
    <div class="section-title">
      <div class="st-bar" style="background:#00D26A"></div>
      Smart Content
      <span class="badge bg">GEMINI GCP</span>
    </div>

    <div class="section">
      <div class="section-head" onclick="toggle(this)">
        <h2>
          <span class="status-dot" id="smart-dot"></span>
          rubix-smart-content.vercel.app
        </h2>
        <span class="chevron open">&#9662;</span>
      </div>
      <div class="section-body open">
        <div class="app-meta">
          <div class="meta-card">
            <div class="meta-label">Dernier déploiement</div>
            <div class="meta-val" id="smart-last-deploy"></div>
          </div>
          <div class="meta-card">
            <div class="meta-label">Fournisseur IA</div>
            <div class="meta-val"><span class="badge bg">Gemini Flash</span>&nbsp;Google Cloud Platform</div>
          </div>
        </div>

        <table>
          <thead><tr><th>Action utilisateur</th><th>Appels IA</th><th>Modele</th><th>Streaming</th></tr></thead>
          <tbody>
            <tr><td style="font-weight:600">Planifier intentions (10 sujets)</td><td>2 appels</td><td>Gemini 2.0 Flash</td><td>Non (batch)</td></tr>
            <tr><td style="font-weight:600">Générer 1 article / landing page</td><td>1 appel</td><td>Gemini 2.5 Flash</td><td style="color:#059669;font-weight:600">Oui (stream)</td></tr>
            <tr><td style="font-weight:600">Validation sources / SEO</td><td>1 appel</td><td>Gemini 2.0 Flash</td><td>Non</td></tr>
          </tbody>
        </table>

        <div class="thr-w">
          <h4>Seuils de blocage GCP : 1 500 appels/min mais credits limites</h4>
          <table>
            <thead><tr><th>Users simultanées</th><th>Appels IA/min</th><th>Coût/mois estime</th><th>Statut</th></tr></thead>
            <tbody>
              <tr><td>1 a 5 users</td><td>2 a 10 appels/min</td><td>3 a 15 EUR</td><td><span class="proj-badge proj-ok">OK</span></td></tr>
              <tr><td>10 users</td><td>10 a 20 appels/min</td><td>30 EUR</td><td><span class="proj-badge proj-warn">CREDITS ?</span></td></tr>
              <tr><td>50+ users</td><td>50 a 100 appels/min</td><td>150+ EUR</td><td><span class="proj-badge proj-danger">PAYANT</span></td></tr>
            </tbody>
          </table>
          <div style="font-size:11px;color:#D97706;margin-top:6px">
            <strong>Blocker principal :</strong> pas le nombre d'appels/min (1 500 = large) mais le <strong>cout</strong> quand les credits promo GCP seront épuisés.
            Actuellement 2.98 EUR brut / 50 contenus = 0.06 EUR/contenu.
          </div>
        </div>

        <div class="reco">
          <h4>Recommandations pour scaler</h4>
          <p>1. <strong>Streaming déjà en place</strong> : evite les timeouts Vercel 60s sur contenus longs, ne pas toucher</p>
          <p>2. <strong>Retry + backoff 429 déjà en place</strong> : gestion des rate limits côté serveur, ne pas toucher</p>
          <p>3. <strong>Surveiller les credits GCP</strong> : quand épuisés, 0.06 EUR/contenu en production</p>
          <p>4. <strong>Batching intentions</strong> : générer les 10 intentions en 1 seul appel plutot que 2 (possible vu la taille du prompt)</p>
        </div>

        <div class="mini-metrics">
          <div class="mini-metric"><div class="mini-val" id="smart-build"></div><div class="mini-label">Build min</div></div>
          <div class="mini-metric"><div class="mini-val" id="smart-bw"></div><div class="mini-label">Bandwidth</div></div>
          <div class="mini-metric"><div class="mini-val" id="smart-fninv"></div><div class="mini-label">Fn Invocations</div></div>
          <div class="mini-metric"><div class="mini-val" id="smart-fndur"></div><div class="mini-label">Fn Duration</div></div>
        </div>

        <div class="links">
          <a href="https://console.cloud.google.com/billing?project=n8n-landing-pages" target="_blank" class="btn btn-g">Crédits GCP restants</a>
          <a href="https://console.cloud.google.com/apis/dashboard?project=n8n-landing-pages" target="_blank" class="btn btn-g">GCP Dashboard</a>
        </div>
      </div>
    </div>

    <!-- Section bugs lié à l'environnement Rubix -->
    <div class="section-title" style="margin-top:28px">
      <div class="st-bar" style="background:#EF4444"></div>
      Bug lié à l'environnement Rubix
      <span class="badge bd">EN COURS DE CORRECTION</span>
    </div>

    <div class="section">
      <div class="section-head" onclick="toggle(this)">
        <h2>Proxy SSL et bascules réseau (ERR_CERT / ERR_NETWORK_CHANGED)</h2>
        <span class="chevron open">&#9662;</span>
      </div>
      <div class="section-body open">

        <div class="thr-d">
          <h4>Le probleme : connexions longues cassees par le proxy d'entreprise</h4>
          <div style="font-size:11px;color:#334155;margin-bottom:8px">Générer un article nécessite 90 a 180 secondes de connexion continue. Le proxy entreprise coupe ou perturbe ces connexions longues.</div>
          <table>
            <thead><tr><th>Erreur</th><th>Cause</th><th>Impact</th></tr></thead>
            <tbody>
              <tr>
                <td style="font-weight:700;color:#DC2626">ERR_CERT_COMMON_NAME_INVALID</td>
                <td style="font-size:11px">Le proxy SSL (Zscaler) intercepte le trafic HTTPS et remplace le certificat Google par le sien. Le navigateur détecte que le nom du certificat ne correspond pas.</td>
                <td style="font-size:11px;color:#DC2626">Connexion refusee, génération impossible</td>
              </tr>
              <tr>
                <td style="font-weight:700;color:#DC2626">ERR_NETWORK_CHANGED</td>
                <td style="font-size:11px">La route réseau change en cours de génération : bascule VPN, changement de point WiFi, reconnexion automatique.</td>
                <td style="font-size:11px;color:#DC2626">Connexion coupee, article bloqué en PROCESSING</td>
              </tr>
              <tr>
                <td style="font-weight:700;color:#DC2626">ERR_INTERNET_DISCONNECTED</td>
                <td style="font-size:11px">Coupure réseau breve (mise en veille, instabilite WiFi) pendant les 90 a 180s de génération Gemini.</td>
                <td style="font-size:11px;color:#DC2626">Requete échouée, article bloqué en PROCESSING</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div style="margin-top:14px;padding:12px;background:#F8FAFC;border-radius:7px;border:1px solid #E2E8F0">
          <div style="font-size:12px;font-weight:700;color:#051E50;margin-bottom:8px">Situation actuelle vs situation cible</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;font-size:11px">
            <div style="padding:10px;background:#FEE2E2;border-radius:6px">
              <div style="font-weight:700;color:#DC2626;margin-bottom:6px">Maintenant (fragile)</div>
              <div style="color:#334155;line-height:1.8">Navigateur appelle Vercel (appel 1 : SEO, 30 a 60s)<br>Navigateur appelle Vercel (appel 2 : Article, 60 a 90s)<br>Navigateur appelle Vercel (appel 3 : Enrichissement, 30 a 60s)<br>Chaque appel passe par le proxy SSL d'entreprise</div>
            </div>
            <div style="padding:10px;background:#ECFDF5;border-radius:6px">
              <div style="font-weight:700;color:#059669;margin-bottom:6px">Apres correction (robuste)</div>
              <div style="color:#334155;line-height:1.8">Navigateur fait 1 seul appel court a Vercel<br>Vercel gere les 3 appels Gemini en interne (serveur vers serveur)<br>Le navigateur interroge le statut toutes les 5s<br>Même si le proxy coupe, Vercel continue et sauvegarde dans Sheets</div>
            </div>
          </div>
        </div>

        <div style="margin-top:14px">
          <div style="font-size:12px;font-weight:700;color:#051E50;margin-bottom:8px">Plan d'action (3 chantiers)</div>

          <div style="padding:10px;background:#ECFDF5;border-radius:7px;border:1px solid #A7F3D0;margin-bottom:8px">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
              <span class="badge bo">CHANTIER 1</span>
              <span style="font-size:12px;font-weight:700;color:#059669">Fix immédiat (5 min, zero code)</span>
              <span class="proj-badge proj-ok">FAISABLE MAINTENANT</span>
            </div>
            <div style="font-size:11px;color:#334155">Débloquer les articles coincés en PROCESSING.<br>Dans Google Sheets, onglet <strong>_meta</strong>, colonne L : chercher les cellules contenant <strong>PROCESSING:...</strong> et les remplacer par <strong>QUEUED</strong>. Ils seront re-générés à la prochaine tentative.</div>
          </div>

          <div style="padding:10px;background:#FEFCE8;border-radius:7px;border:1px solid #FFD700;margin-bottom:8px">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
              <span class="badge bw">CHANTIER 2</span>
              <span style="font-size:12px;font-weight:700;color:#D97706">Bouton Annuler dans l'UI (30 min de code)</span>
              <span class="proj-badge proj-warn">A FAIRE</span>
            </div>
            <div style="font-size:11px;color:#334155">La route backend <strong>/cancel-article/:rowId</strong> existe déjà mais n'a aucun bouton dans l'interface. Ajouter un bouton sur les cartes bloquées en PROCESSING pour débloquer sans aller dans Google Sheets.</div>
          </div>

          <div style="padding:10px;background:#F0F4FF;border-radius:7px;border:1px solid #BFDBFE">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
              <span class="badge bi">CHANTIER 3</span>
              <span style="font-size:12px;font-weight:700;color:#3B82F6">Génération côté serveur (2 à 3h de code)</span>
              <span class="proj-badge proj-warn">EN COURS</span>
            </div>
            <div style="font-size:11px;color:#334155">La vraie solution. Créer une nouvelle route dans <strong>api/index.js</strong> qui fait les 3 appels Gemini en interne, et simplifier <strong>useContentGénération.js</strong> côté frontend. Approche : batch 1 par 1 (lancer un article, attendre qu'il finisse, passer au suivant).<br><br><strong>Risque :</strong> Vercel Pro = timeout 300s par fonction. Un article prend 90 à 180s, ça passe normalement. Si Gemini est lent, le backend remet l'article en QUEUED automatiquement.</div>
          </div>
        </div>

      </div>
    </div>

  </div>
  </div>

  <!-- ONGLET CAPACITE VERCEL -->
  <div class="page" id="page-vercel">
  <div class="container">
    <div class="section-title">
      <div class="st-bar" style="background:#FFD700"></div>
      Capacité Vercel
      <span class="badge bv" id="vercel-period"></span>
    </div>

    <div class="summary">
      <div class="scard"><div class="stop stop-gold"></div>
        <div class="slabel">Build Minutes restantes</div>
        <div class="sval" id="build-rem"></div>
        <div class="sdetail" id="build-detail"></div>
      </div>
      <div class="scard"><div class="stop stop-green"></div>
        <div class="slabel">Bandwidth restante</div>
        <div class="sval" id="bw-rem"></div>
        <div class="sdetail" id="bw-detail"></div>
      </div>
      <div class="scard"><div class="stop stop-blue"></div>
        <div class="slabel">Fn Invocations restantes</div>
        <div class="sval" id="fninv-rem"></div>
        <div class="sdetail" id="fninv-detail"></div>
      </div>
      <div class="scard"><div class="stop stop-purple"></div>
        <div class="slabel">Fn Duration restante</div>
        <div class="sval" id="fndur-rem"></div>
        <div class="sdetail" id="fndur-detail"></div>
      </div>
    </div>

    <div class="section">
      <div class="section-head" onclick="toggle(this)">
        <h2>Quotas et projections <span class="badge bv" id="reset-badge"></span></h2>
        <span class="chevron open">&#9662;</span>
      </div>
      <div class="section-body open">
        <div class="limits-grid">
          <div class="limit-item">
            <div class="limit-label"><span>Build Minutes <span class="proj-badge" id="build-pbadge"></span></span><span id="build-used"></span></div>
            <div class="limit-bar"><div class="limit-fill fill-ok" id="build-bar" style="width:.5%"></div></div>
            <div class="limit-detail" id="build-proj"></div>
            <div style="font-size:10px;color:#64748B;margin-top:3px">Combien de minutes Vercel a passé à compiler et déployer les apps</div>
            <div id="build-perapp"></div>
          </div>
          <div class="limit-item">
            <div class="limit-label"><span>Bandwidth <span class="proj-badge" id="bw-pbadge"></span></span><span id="bw-used"></span></div>
            <div class="limit-bar"><div class="limit-fill fill-ok" id="bw-bar" style="width:.5%"></div></div>
            <div class="limit-detail" id="bw-proj"></div>
            <div style="font-size:10px;color:#64748B;margin-top:3px">Combien de données ont été envoyées aux utilisateurs (pages, images, réponses API)</div>
            <div id="bw-perapp"></div>
          </div>
          <div class="limit-item">
            <div class="limit-label"><span>Function Invocations <span class="proj-badge" id="fninv-pbadge"></span></span><span id="fninv-used"></span></div>
            <div class="limit-bar"><div class="limit-fill fill-ok" id="fninv-bar" style="width:.5%"></div></div>
            <div class="limit-detail" id="fninv-proj"></div>
            <div style="font-size:10px;color:#64748B;margin-top:3px">Combien de fois une fonction a été appelée — total tous projets confondus (Pôle + Pitch + Smart Content)</div>
            <div id="fninv-perapp"></div>
          </div>
          <div class="limit-item">
            <div class="limit-label"><span>Function Duration <span class="proj-badge" id="fndur-pbadge"></span></span><span id="fndur-used"></span></div>
            <div class="limit-bar"><div class="limit-fill fill-ok" id="fndur-bar" style="width:.5%"></div></div>
            <div class="limit-detail" id="fndur-proj"></div>
            <div style="font-size:10px;color:#64748B;margin-top:3px">Combien de temps ces fonctions ont tourné au total — <strong>non critique</strong> pour nos apps (limite 1 000 GB-h très difficile à atteindre)</div>
            <div id="fndur-perapp"></div>
          </div>
        </div>
        <div style="margin-top:12px;padding:10px;background:#FEFCE8;border-radius:7px;border:1px solid #FFD700">
          <div style="font-size:11px;font-weight:700;color:#D97706;margin-bottom:4px">Limites hard Vercel Pro (blocage direct, pas de surcharge)</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;font-size:11px;color:#64748B">
            <div><strong>Concurrent Builds :</strong> 1 seul (les autres en queue)</div>
            <div><strong>Serverless Timeout :</strong> 60s par defaut, 300s max (configurer maxDuration dans vercel.json)</div>
            <div><strong>Deployments :</strong> 100/jour (soft limit)</div>
          </div>
          <div style="margin-top:8px;font-size:11px;color:#64748B">
            <strong>Note :</strong> le streaming evite le timeout (Smart Content article). Les appels non-streaming longs (Pitch Generator ~55s, Gemini non-stream) sont limites a 60s par defaut. Pour le Chantier 3 (génération serveur), ajouter <code style="background:#F1F5F9;padding:1px 5px;border-radius:3px">maxDuration: 300</code> dans vercel.json.
          </div>
        </div>
      </div>
    </div>
  </div>
  </div>

  <!-- ONGLET COUTS -->
  <div class="page" id="page-couts">
  <div class="container">
    <div class="section-title">
      <div class="st-bar" style="background:#051E50"></div>
      Coûts (référence)
    </div>

    <div class="section">
      <div class="section-head" onclick="toggle(this)">
        <h2>Résumé coûts <span class="badge bv" id="total-badge"></span></h2>
        <span class="chevron open">&#9662;</span>
      </div>
      <div class="section-body open">
        <table>
          <thead><tr><th>Service</th><th>Coût</th><th>Detail</th></tr></thead>
          <tbody>
            <tr><td style="font-weight:600">Vercel Pro</td><td style="font-weight:700">$20.00/mois</td><td style="color:#64748B">Forfait fixe mutualise 3 apps</td></tr>
            <tr><td style="font-weight:600">OpenAI</td><td style="font-weight:700" id="openai-cost"></td><td style="color:#64748B" id="openai-detail"></td></tr>
            <tr><td style="font-weight:600">Gemini Smart Content</td><td style="font-weight:700">0 EUR</td><td style="color:#64748B">2.98 EUR brut couvert par credits promo GCP</td></tr>
            <tr><td style="font-weight:600">Gemini Pôle Acquisition</td><td style="font-weight:700;color:#00D26A">0 EUR</td><td style="color:#64748B">Free tier Google AI Studio</td></tr>
            <tr style="font-weight:700;border-top:2px solid #E2E8F0"><td>Total réel</td><td style="font-size:16px;color:#051E50" id="total-cost"></td><td style="color:#64748B">Vercel + OpenAI (Gemini = 0)</td></tr>
          </tbody>
        </table>

        <div style="margin-top:14px;padding:10px;background:#F0F4FF;border-radius:7px;border:1px solid #BFDBFE">
          <div style="font-size:11px;font-weight:700;color:#3B82F6;margin-bottom:6px">Enabler</div>
          <table>
            <thead><tr><th>Outil</th><th>Coût</th><th>Role</th></tr></thead>
            <tbody>
              <tr><td style="font-weight:600">Claude Code</td><td style="font-weight:700">$100/mois</td><td style="color:#64748B">Max 5x plan, inclus dans l'abonnement Claude, developpement et iteration rapide sur les 3 apps</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  </div>

  <!-- RETROPLANNING -->
  <div class="page" id="page-retro">
    <div class="container">
      <div class="section-title" style="margin-top:20px"><span class="st-bar" style="background:#051E50"></span>📆 Rétroplanning — Vue Roadmap</div>
      <div style="font-size:12px;color:#64748B;margin:6px 0 14px">Cliquez sur une semaine pour voir le détail jour par jour. Icônes : ⬜ → 🔄 → ✅ → ❌. Double-cliquez sur un texte pour l'éditer.</div>
      <div id="retro-demandes-wrap" class="demandes-wrap"></div>
      <div id="retro-prog-wrap" class="retro-prog-wrap"></div>
      <div id="retro-filters-wrap" style="margin-bottom:14px"></div>
      <div id="retro-calendar"></div>
      <div id="retro-detail-container"></div>
    </div>
  </div>

</div><!-- /main -->

<div class="footer" id="footer">Rubix Monitoring</div>

<script>
// Tab switching
function showTab(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav a').forEach(a => a.classList.remove('active'));
  document.getElementById('page-' + id).classList.add('active');
  const tabs = ['alertes','pole','pitch','smart','vercel','couts','retro'];
  const idx = tabs.indexOf(id);
  if (idx >= 0) document.querySelectorAll('.nav a')[idx].classList.add('active');
  if (id === 'pitch') {
    if (!pitchInitialized) { pitchInitialized = true; initPitchSubTabs(); }
  }
  if (id === 'retro') {
    if (!retroInitialized) { retroInitialized = true; initRetro(); }
    else { updateRetroProgress(); }
    setTimeout(() => { const el = $('retro-today'); if (el) el.scrollIntoView({block:'nearest',inline:'center'}); }, 80);
  }
  window.scrollTo(0, 0);
}
let retroInitialized = false;

// Collapsible sections
function toggle(head) {
  head.nextElementSibling.classList.toggle('open');
  head.querySelector('.chevron').classList.toggle('open');
}

// Helpers
const APP_COLORS = {
  'rubix-pole-acquisition':    '#FFD700',
  'rubix-pitch-generator-dev': '#8B5CF6',
  'rubix-smart-content':       '#00D26A',
  '_other':                    '#94A3B8',
};
const APP_SHORT = {
  'rubix-pole-acquisition':    'pole-acq.',
  'rubix-pitch-generator-dev': 'pitch-gen.',
  'rubix-smart-content':       'smart-cont.',
};

const $ = id => document.getElementById(id);
const html = (id, v) => { const el = $(id); if (el) el.innerHTML  = v; };
const fmtN = n => (n >= 1000 ? n.toLocaleString('fr-FR') : String(n));

function fillBar(id, pct, risk) {
  const el = $(id);
  if (!el) return;
  el.className = `limit-fill fill-${risk}`;
  el.style.width = Math.max(pct, 0.5) + '%';
}

function perAppHtml(perApp, total) {
  const entries = Object.entries(perApp || {}).filter(([,v]) => v > 0).sort((a,b) => b[1]-a[1]);
  if (!entries.length) return '';
  let h = '<div class="per-app-breakdown">';
  for (const [name, qty] of entries) {
    const color = APP_COLORS[name] || '#94A3B8';
    const short = APP_SHORT[name]  || name;
    const pct   = total > 0 ? Math.round(qty / total * 1000) / 10 : 0;
    const qFmt  = qty >= 1000 ? fmtN(Math.round(qty)) : (Math.round(qty * 100) / 100).toLocaleString('fr-FR');
    h += `<div class="per-app-row">
      <span class="per-app-dot" style="background:${color}"></span>
      <span class="per-app-name">${short}</span>
      <span class="per-app-bar-wrap"><span class="per-app-bar" style="width:${Math.max(pct,2)}%;background:${color}"></span></span>
      <span class="per-app-val">${qFmt} (${pct}%)</span>
    </div>`;
  }
  return h + '</div>';
}

// Render
function renderAll(d) {
  const { period, vercel, openai } = d;
  vercelBillingAPI = vercel?.billing ?? null;

  html('period-label', `${period.from} au ${period.to}`);
  html('generated-at', `Mis a jour : ${new Date(d.generatedAt).toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})}`);

  renderDeploys(vercel.deploys);
  renderOpenAI(openai);
  renderVercelCapacity(vercel.proj, period);
  renderMiniMetrics(vercel.proj);
  renderGlobalAlerts(vercel.proj);

  html('footer', `Rubix Monitoring | Période : ${period.from} au ${period.to} | Reset le ${period.reset}`);
}

function renderDeploys(deploys) {
  const map = { pole: 'pole', pitch: 'pitch', smart: 'smart' };
  for (const [key, d] of Object.entries(deploys)) {
    const k = map[key] || key;
    const color = d.state === 'READY' ? '#00D26A' : d.state === 'N/A' ? '#94A3B8' : '#EF4444';
    const dot = $(`${k}-dot`); if (dot) dot.style.background = color;
    const badge = `<span class="badge" style="background:${d.state==='READY'?'#ECFDF5':'#FEE2E2'};color:${d.state==='READY'?'#059669':'#DC2626'}">${d.state}</span>`;
    html(`${k}-last-deploy`, `${badge} ${d.lastDate}`);
  }
}

function renderOpenAI(oa) {
  const cpp6 = Math.round(oa.costPerPrompt * 6 * 1000) / 1000;
  html('pitch-cost-per-pitch', `<strong>~$${cpp6}</strong> &nbsp;(6 x $${oa.costPerPrompt}/appel)`);
  html('pitch-cost-detail', `<strong>Coût/pitch complet :</strong> ~$${oa.costPerPrompt} x 6 appels = ~$${cpp6}/pitch &nbsp;|&nbsp; A $${oa.monthlyProjected}/mois (rythme actuel depuis jan. 2026)`);
  html('openai-cost',   `<strong>$${oa.totalCost}</strong>`);
  html('openai-detail', `${fmtN(oa.requests)} req. | $${oa.costPerPrompt}/prompt | OpenAI Rubix Pitch`);
  const total = Math.round((20 + oa.totalCost) * 100) / 100;
  html('total-cost',  `$${total}`);
  html('total-badge', `$${total} TOTAL`);
}

function renderVercelCapacity(proj, period) {
  const METRICS = [
    { svc:'Build Minutes',        id:'build', fmtV: v => Math.round(v)+' min',   fmtU: v => Math.round(v)+' / 6 000 min',   overage:'$0.02/min'  },
    { svc:'Fast Data Transfer',   id:'bw',    fmtV: v => v.toFixed(1)+' GB',     fmtU: v => v.toFixed(2)+' / 1 000 GB',     overage:'$0.15/GB'   },
    { svc:'Function Invocations', id:'fninv', fmtV: v => fmtN(Math.round(v)),    fmtU: v => fmtN(Math.round(v))+' / 1M',    overage:'$0.60/M'    },
    { svc:'Function Duration',    id:'fndur', fmtV: v => v.toFixed(1)+' GB-h',   fmtU: v => v.toFixed(2)+' / 1 000 GB-h',  overage:'$0.18/GB-h' },
  ];
  // Alertes statiques toujours présentes
  let dangerC = 1; // FREE TIER Pôle bloqué à 5+ users
  let warnC   = 3; // Pitch : 6+ appels + polling ~55s / Smart : crédits promo GCP
  for (const { svc, id, fmtV, fmtU, overage } of METRICS) {
    const p = proj[svc]; if (!p) continue;
    const pct = Math.round(p.used / p.limit * 1000) / 10;
    html(`${id}-rem`,    fmtV(p.remaining));
    html(`${id}-detail`, `${fmtU(p.used)} | ${fmtV(p.dailyRate)}/jour`);
    html(`${id}-used`,   fmtU(p.used));
    html(`${id}-pbadge`, `Proj. ${fmtV(p.projected)}`);
    const pb = $(`${id}-pbadge`); if (pb) pb.className = `proj-badge proj-${p.risk}`;
    html(`${id}-proj`,   `${pct}% | ${fmtV(p.dailyRate)}/jour | Limite dans ${p.daysUntil} j. | Surcharge : ${overage}`);
    fillBar(`${id}-bar`, pct, p.risk);
    html(`${id}-perapp`, perAppHtml(p.perApp, p.used));
    if (p.risk === 'danger') dangerC++;
    else if (p.risk === 'warn') warnC++;
  }
  html('vercel-period', `${period.from} au ${period.to}`);
  html('reset-badge',   `Reset ${period.reset} (dans ${Math.ceil(period.daysRemaining)} j.)`);
  html('count-danger',  `${dangerC} CRITIQUE`);
  html('count-warn',    `${warnC} ATTENTION`);
}

function renderMiniMetrics(proj) {
  const appsMap = { pole:'rubix-pole-acquisition', pitch:'rubix-pitch-generator-dev', smart:'rubix-smart-content' };
  const metMap  = [
    { svc:'Build Minutes',        suf:'build', fmt:v => Math.round(v)+' min'   },
    { svc:'Fast Data Transfer',   suf:'bw',    fmt:v => v.toFixed(2)+' GB'     },
    { svc:'Function Invocations', suf:'fninv', fmt:v => fmtN(Math.round(v))    },
    { svc:'Function Duration',    suf:'fndur', fmt:v => v.toFixed(3)+' GB-h'   },
  ];
  for (const [app, appKey] of Object.entries(appsMap)) {
    for (const { svc, suf, fmt } of metMap) {
      const val = proj[svc]?.perApp?.[appKey] ?? 0;
      html(`${app}-${suf}`, fmt(val));
    }
  }
}

function renderGlobalAlerts(proj) {
  let h = '';
  const build = proj['Build Minutes'];
  const fnInv = proj['Function Invocations'];
  if (build?.risk === 'danger') {
    h += `<div class="alert-row" style="background:#FEE2E2"><span class="alert-icon" style="color:#DC2626">&#9888;</span><span style="color:#DC2626">Build Minutes : projection ${Math.round(build.projected)} / 6 000 min (${build.projPct}%) risque de dépassement</span></div>`;
  } else if (build?.risk === 'warn') {
    h += `<div class="alert-row" style="background:#FEFCE8"><span class="alert-icon" style="color:#D97706">&#9888;</span><span style="color:#D97706">Build Minutes : projection ${Math.round(build.projected)} / 6 000 min (${build.projPct}%) a surveiller</span></div>`;
  }
  if (fnInv?.risk === 'danger') {
    h += `<div class="alert-row" style="background:#FEE2E2"><span class="alert-icon" style="color:#DC2626">&#9888;</span><span style="color:#DC2626">Function Invocations : projection ${fmtN(Math.round(fnInv.projected))} / 1M risque de dépassement</span></div>`;
  } else if (fnInv?.risk === 'warn') {
    h += `<div class="alert-row" style="background:#FEFCE8"><span class="alert-icon" style="color:#D97706">&#9888;</span><span style="color:#D97706">Function Invocations : projection ${fmtN(Math.round(fnInv.projected))} / 1M a surveiller</span></div>`;
  }
  html('global-dyn-alerts', h);
}

// ====================== DEMANDES EN ATTENTE ======================

const DEMANDES = [
  { id:'d1', titre:'Création canal Teams "Rubix Pitch — Retours & Support"', destinataire:'IT', deadline:'28/02',
    pourquoi:'Centraliser les remontées de bugs des commerciaux pendant et après les formations. Sans canal dédié, les retours se perdent dans les emails et les conversations informelles.' },
  { id:'d2', titre:'3 à 5 testeurs commerciaux volontaires', destinataire:'Manager (point du 05/03)', deadline:'06/03',
    detail:'Profils : 2 RVE terrain + 1 DE minimum. Effort : 1h de leur temps entre le 7 et le 10/03.',
    pourquoi:'Valider l\'app en conditions réelles avant la formation. Leurs retours permettent de corriger les derniers bugs sur des vrais cas métier.' },
  { id:'d3', titre:'Liste des 66 participants aux 3 sessions', destinataire:'Organisateurs formation', deadline:'20/03',
    detail:'Données : nom, prénom, profil (RVE/DE), session attribuée (1, 2 ou 3).',
    pourquoi:'Après la session 1, on met en place des accès individuels pour suivre qui utilise l\'app, gérer le déploiement progressif et sauvegarder l\'historique de chaque commercial (multi-device).' },
  { id:'d4', titre:'Validation budget 50$ (46€) pour compte IA dédié', destinataire:'Manager', deadline:'28/02',
    detail:'Paiement unique par carte.',
    pourquoi:'Séparer les crédits IA de Rubix Pitch de ceux de Smart Spec (risque de coupure). Ces 50$ sont aussi la condition pour monter en capacité (Tier 2 = 10× plus d\'utilisateurs simultanés). Les crédits sont consommés progressivement (~5$/mois pour 15 users).' },
  { id:'d5', titre:'Suivre la consommation Vercel (plan Pro 20$/mois)', destinataire:'Claire (auto)', deadline:'Tous les vendredis',
    pourquoi:'Le plan Pro inclut 20$ de crédit mensuel. En phase de développement, les Build Minutes peuvent faire dépasser ce crédit. Surplus actuel estimé : ~14$ ce mois (temporaire). Après le code freeze, la consommation redescend dans le crédit. Mettre à jour la jauge chaque vendredi dans la page monitoring.' },
];

const D_CYCLE = ['todo', 'inprogress', 'done'];
const D_ICONS = { todo:'⬜', inprogress:'🔄', done:'✅' };
const D_LABELS = { todo:'À traiter', inprogress:'En cours', done:'Fait' };

function getDStatus(id)      { return localStorage.getItem('demande_status_' + id) || 'todo'; }
function setDStatus(id, val) { val === 'todo' ? localStorage.removeItem('demande_status_' + id) : localStorage.setItem('demande_status_' + id, val); }

function toggleDemandeStatus(id) {
  const cur  = getDStatus(id);
  const next = D_CYCLE[(D_CYCLE.indexOf(cur) + 1) % D_CYCLE.length];
  setDStatus(id, next);
  const btn  = document.getElementById('db-' + id); if (btn) { btn.textContent = D_ICONS[next]; btn.title = D_LABELS[next]; }
  const card = document.getElementById('dc-' + id); if (card) card.classList.toggle('demande-done', next === 'done');
}

function renderDemandes() {
  const el = $('retro-demandes-wrap'); if (!el) return;
  let h = `<div style="font-size:13px;font-weight:800;color:#7C3AED;margin-bottom:10px;display:flex;align-items:center;gap:8px">
    🟣 Demandes en attente — Ce dont j'ai besoin des autres
    <span style="font-size:11px;font-weight:500;color:#6B7280">(${DEMANDES.length} demandes)</span>
  </div>`;
  for (const d of DEMANDES) {
    const status = getDStatus(d.id);
    h += `<div class="demande-card${status === 'done' ? ' demande-done' : ''}" id="dc-${d.id}">
      <div class="demande-header">
        <div class="demande-titre">${d.titre}</div>
        <button class="demande-status-btn" id="db-${d.id}" onclick="toggleDemandeStatus('${d.id}')" title="${D_LABELS[status]}">${D_ICONS[status]}</button>
      </div>
      <div class="demande-meta">
        <span>Destinataire : <strong>${d.destinataire}</strong></span>
        <span>Deadline : <strong>${d.deadline}</strong></span>
      </div>
      ${d.detail ? `<div class="demande-detail">📋 ${d.detail}</div>` : ''}
      <div class="demande-pourquoi">💬 Pourquoi : ${d.pourquoi}</div>
    </div>`;
  }
  el.innerHTML = h;
}

// ====================== VERCEL COSTS ======================

// À mettre à jour depuis vercel.com → Dashboard → Usage
const VERCEL_USAGE = {
  plan: 'Pro',
  creditIncluded: 20.00,
  cycleStart: '2026-02-20',
  cycleEnd:   '2026-03-20',
  consumed: {
    total:               8.08,
    buildMinutes:        7.43,
    functionInvocations: 0.60,
    fluidMemory:         0.03,
    fluidCPU:            0.01,
    onDemandCharges:     0.00,
  },
  lastChecked: '2026-02-25',
};

const VERCEL_PROJECTIONS = [
  { label:'Maintenant (dev intensif)',    build:30,  functions:2.50, status:'red',    comment:'Surplus ~$14' },
  { label:'Après code freeze (mars)',     build:5,   functions:2.50, status:'green',  comment:'Dans le crédit' },
  { label:'15 users actifs (avril)',      build:3,   functions:5,    status:'green',  comment:'' },
  { label:'66 users actifs (cible)',      build:3,   functions:12,   status:'green',  comment:'' },
];

function renderVercelCosts() {
  if (vercelBillingAPI) return renderVercelCostsAPI(vercelBillingAPI);
  const v = VERCEL_USAGE;
  const today0 = new Date(); today0.setHours(0,0,0,0);
  const cycleStart = new Date(v.cycleStart);
  const cycleEnd   = new Date(v.cycleEnd);
  const joursEcoules = Math.max(1, Math.floor((today0 - cycleStart) / 86400000));
  const totalJours   = Math.floor((cycleEnd - cycleStart) / 86400000);
  const joursRestants = Math.max(0, totalJours - joursEcoules);
  const projection   = Math.round((v.consumed.total / joursEcoules) * totalJours * 100) / 100;
  const surplus      = Math.max(0, Math.round((projection - v.creditIncluded) * 100) / 100);
  const pctConsumed  = Math.min(100, Math.round(v.consumed.total / v.creditIncluded * 1000) / 10);
  const pctProj      = projection / v.creditIncluded;

  const barColor = pctConsumed <= 50 ? '#22C55E' : pctConsumed <= 80 ? '#F59E0B' : pctConsumed <= 100 ? '#F97316' : '#EF4444';
  const borderColor = projection < v.creditIncluded ? '#22C55E' : projection < 30 ? '#F97316' : '#EF4444';
  const statusIcon = projection < v.creditIncluded ? '🟢' : projection < 30 ? '🟠' : '🔴';

  const coveredPct = Math.min(100, Math.round(v.creditIncluded / projection * 100));
  const surplusPct = 100 - coveredPct;

  let h = `<div style="border-left:4px solid ${borderColor};background:#fff;border-radius:8px;border:1px solid #E2E8F0;border-left-width:4px;padding:16px;margin-bottom:16px">`;
  h += `<div style="font-size:14px;font-weight:800;color:#051E50;margin-bottom:4px">${statusIcon} 🖥️ Hébergement Vercel — Suivi des coûts</div>`;
  h += `<div style="font-size:12px;color:#64748B;margin-bottom:12px">Plan Pro · 20$/mois inclus · Mis à jour le ${v.lastChecked}</div>`;
  h += `<div style="font-size:12px;color:#334155;margin-bottom:12px">L'application est hébergée sur Vercel (plan Pro, 20$/mois). Le plan inclut un crédit de 20$. Au-delà, les frais supplémentaires sont facturés automatiquement.</div>`;

  // Cycle info
  h += `<div style="font-size:11px;color:#64748B;margin-bottom:10px">Cycle : ${v.cycleStart} → ${v.cycleEnd} &nbsp;|&nbsp; Jours écoulés : <strong>${joursEcoules} / ${totalJours}</strong> &nbsp;|&nbsp; Restants : <strong>${joursRestants}</strong></div>`;

  // Crédit consommé
  h += `<div style="font-size:12px;font-weight:700;color:#051E50;margin-bottom:4px">Crédit inclus consommé : $${v.consumed.total.toFixed(2)} / $${v.creditIncluded.toFixed(2)}</div>`;
  h += `<div class="vercel-prog-bar"><div class="vercel-prog-fill" style="width:${pctConsumed}%;background:${barColor}"></div></div>`;
  h += `<div style="font-size:11px;color:${barColor};font-weight:700;margin-bottom:10px">${pctConsumed}% du crédit utilisé</div>`;
  if (v.consumed.onDemandCharges > 0) h += `<div style="font-size:11px;color:#DC2626;font-weight:700;margin-bottom:8px">⚠️ Surplus facturé (On-Demand) : $${v.consumed.onDemandCharges.toFixed(2)}</div>`;

  // Détail par poste
  h += `<div style="font-size:11px;font-weight:700;color:#051E50;margin:12px 0 6px;text-transform:uppercase;letter-spacing:.6px">Détail par poste</div>`;
  h += `<table style="margin-bottom:12px"><thead><tr><th>Poste</th><th>Consommé</th><th>Proj. fin cycle</th><th>Commentaire</th></tr></thead><tbody>`;
  const postes = [
    { l:'Build Minutes',        v:v.consumed.buildMinutes,        pct: v.consumed.buildMinutes / v.consumed.total },
    { l:'Function Invocations', v:v.consumed.functionInvocations, pct: v.consumed.functionInvocations / v.consumed.total },
    { l:'Memory + CPU',         v:v.consumed.fluidMemory + v.consumed.fluidCPU, pct: (v.consumed.fluidMemory + v.consumed.fluidCPU) / v.consumed.total },
  ];
  let totalConsumed = 0; let totalProj = 0;
  for (const p of postes) {
    const pv = Math.round(p.v * 100) / 100;
    const pp = Math.round((p.v / joursEcoules) * totalJours * 100) / 100;
    totalConsumed += pv; totalProj += pp;
    const isHigh = pp > v.creditIncluded * 0.5;
    h += `<tr><td>${p.l}</td><td>$${pv.toFixed(2)}</td><td>~$${pp.toFixed(2)}</td><td>${isHigh ? '🔴 Élevé (dev intensif)' : '🟢 Normal'}</td></tr>`;
  }
  h += `<tr style="font-weight:700;border-top:2px solid #E2E8F0"><td>TOTAL</td><td>$${totalConsumed.toFixed(2)}</td><td>~$${projection.toFixed(2)}</td><td>${surplus > 0 ? `🟠 Surplus ~$${surplus.toFixed(2)}` : '🟢 OK'}</td></tr>`;
  h += '</tbody></table>';

  // Jauge de projection
  h += `<div style="font-size:11px;font-weight:700;color:#051E50;margin:10px 0 4px">Projection fin de cycle</div>`;
  if (surplus > 0) {
    const projTotal = v.creditIncluded + surplus;
    h += `<div class="vercel-proj-bar">
      <div class="vercel-proj-covered" style="width:${coveredPct}%;background:#22C55E"></div>
      <div class="vercel-proj-surplus" style="width:${surplusPct}%;background:#F97316"></div>
    </div>`;
    h += `<div style="font-size:11px;color:#64748B;margin-top:4px;display:flex;gap:12px"><span style="color:#22C55E">■ Couvert ($${v.creditIncluded})</span><span style="color:#F97316">■ Surplus estimé ($${surplus.toFixed(2)})</span></div>`;
  } else {
    h += `<div class="vercel-proj-bar"><div class="vercel-proj-covered" style="width:${Math.min(100,Math.round(projection/v.creditIncluded*100))}%;background:#22C55E"></div></div>`;
    h += `<div style="font-size:11px;color:#22C55E;margin-top:4px">Dans le crédit inclus ✅</div>`;
  }

  // Pourquoi élevé
  h += `<div style="font-size:11px;color:#334155;margin-top:12px;padding:8px;background:#FEFCE8;border-radius:6px;border-left:3px solid #F59E0B">
    <strong>Pourquoi c'est élevé ce mois :</strong> Les Build Minutes représentent ${Math.round(v.consumed.buildMinutes/v.consumed.total*100)}% de la consommation. C'est le coût de chaque déploiement en phase de dev intensif. Après le code freeze du 10/03, les déploiements deviennent rares et le coût redescend naturellement.
  </div>`;

  // Projections par scénario
  h += `<div style="font-size:11px;font-weight:700;color:#051E50;margin:12px 0 6px;text-transform:uppercase;letter-spacing:.6px">Prévisions par période</div>`;
  h += `<table style="margin-bottom:10px"><thead><tr><th>Période</th><th>Build Minutes</th><th>Fonctions</th><th>Total/mois</th></tr></thead><tbody>`;
  for (const row of VERCEL_PROJECTIONS) {
    const total = row.build + row.functions;
    const surplus2 = Math.max(0, total - v.creditIncluded);
    const icon = row.status === 'red' ? '🔴' : row.status === 'green' ? '🟢' : '🟠';
    const comment = row.comment ? ` — ${row.comment}` : (surplus2 > 0 ? ` — surplus $${surplus2.toFixed(0)}` : ' — dans le crédit');
    h += `<tr><td>${row.label}</td><td>~$${row.build}</td><td>~$${row.functions}</td><td>${icon} ~$${total}${comment}</td></tr>`;
  }
  h += '</tbody></table>';

  // Seuils d'alerte
  h += `<div style="font-size:11px;color:#334155;padding:8px 10px;background:#F8FAFC;border-radius:6px;border:1px solid #E2E8F0">
    <strong>Seuils d'alerte :</strong>&nbsp;
    🟢 &lt;50% du crédit = OK &nbsp;|&nbsp;
    🟡 50-80% = surveiller &nbsp;|&nbsp;
    🟠 80-100% = ralentir les déploiements &nbsp;|&nbsp;
    🔴 &gt;100% = surplus facturé
    <br><strong>Statut actuel :</strong> ${pctConsumed <= 50 ? '🟢' : pctConsumed <= 80 ? '🟡' : '🟠'} ${pctConsumed}% &nbsp;|&nbsp;
    Alerte projection &gt;$${v.creditIncluded} : ${surplus > 0 ? `🟠 OUI (~$${projection.toFixed(2)})` : '🟢 NON'}
  </div>`;
  h += `<div style="font-size:11px;color:#64748B;margin-top:8px;font-style:italic">💡 Le surplus actuel est temporaire et lié à la phase de développement. Dès le code freeze, la consommation rentre dans les $20/mois. Aucun changement de plan nécessaire.</div>`;
  h += '</div>';
  return h;
}

// ── Vercel Costs depuis API (données automatiques) ────────────────────────────
function renderVercelCostsAPI(api) {
  const joursRestants = Math.max(0, Math.round(api.totalJours - api.joursEcoules));
  const surplus       = api.currentOverage;
  const projSurplus   = api.projectedOverage;
  const borderColor   = api.projectedTotal <= api.creditIncluded ? '#22C55E'
                      : api.projectedTotal < api.creditIncluded + 5 ? '#F97316' : '#EF4444';
  const statusIcon    = api.projectedTotal <= api.creditIncluded ? '🟢'
                      : api.projectedTotal < api.creditIncluded + 5 ? '🟠' : '🔴';
  const barColor      = surplus === 0 ? '#22C55E' : surplus < 5 ? '#F59E0B' : '#EF4444';

  let h = `<div style="border-left:4px solid ${borderColor};background:#fff;border-radius:8px;border:1px solid #E2E8F0;border-left-width:4px;padding:16px;margin-bottom:16px">`;
  h += `<div style="font-size:14px;font-weight:800;color:#051E50;margin-bottom:4px">${statusIcon} 🖥️ Hébergement Vercel — Suivi des coûts</div>`;
  h += `<div style="font-size:12px;color:#64748B;margin-bottom:12px">Plan Pro · $${api.planFee}/mois inclus · <span style="color:#059669;font-weight:700">⚡ Données en temps réel</span></div>`;
  h += `<div style="font-size:12px;color:#334155;margin-bottom:12px">L'application est hébergée sur Vercel (plan Pro, $20/mois). Le plan inclut un crédit de $20. Au-delà, les frais supplémentaires sont facturés automatiquement.</div>`;

  h += `<div style="font-size:11px;color:#64748B;margin-bottom:10px">Cycle : ${api.cycleStart} → ${api.cycleEnd} &nbsp;|&nbsp; Jours écoulés : <strong>${api.joursEcoules} / ${api.totalJours}</strong> &nbsp;|&nbsp; Restants : <strong>${joursRestants}</strong></div>`;

  h += `<div style="font-size:12px;font-weight:700;color:#051E50;margin-bottom:4px">Facture cycle actuelle : $${api.currentTotal.toFixed(2)} ($${api.planFee} plan${surplus > 0 ? ` + $${surplus.toFixed(2)} surplus` : ' — dans le crédit'})</div>`;
  h += `<div class="vercel-prog-bar"><div class="vercel-prog-fill" style="width:${Math.min(100, Math.round(api.currentTotal / (api.creditIncluded * 2) * 100))}%;background:${barColor}"></div></div>`;
  if (surplus > 0) {
    h += `<div style="font-size:11px;color:#EF4444;font-weight:700;margin-bottom:10px">⚠️ Dépassement actuel : +$${surplus.toFixed(2)}</div>`;
  } else {
    h += `<div style="font-size:11px;color:#22C55E;font-weight:700;margin-bottom:10px">✅ Aucun dépassement — dans le crédit inclus</div>`;
  }

  const UNIT_LABELS = { 'Build Minutes':'min', 'Fast Data Transfer':'GB', 'Function Invocations':'invoc.', 'Function Duration':'GB-h' };
  h += `<div style="font-size:11px;font-weight:700;color:#051E50;margin:12px 0 6px;text-transform:uppercase;letter-spacing:.6px">Détail par poste</div>`;
  h += `<table style="margin-bottom:12px"><thead><tr><th>Service</th><th>Utilisé</th><th>Seuil inclus</th><th>Surplus actuel</th><th>Proj. surplus</th></tr></thead><tbody>`;
  for (const [svc, b] of Object.entries(api.breakdown)) {
    const isOver     = b.currentCost > 0;
    const isProjOver = b.projectedCost > 0;
    const freeFmt    = svc === 'Function Invocations' ? (b.free / 1e6) + 'M' : b.free.toLocaleString('fr-FR');
    h += `<tr>
      <td>${svc}</td>
      <td>${b.used.toLocaleString('fr-FR')} ${UNIT_LABELS[svc] || ''}</td>
      <td>${freeFmt} ${UNIT_LABELS[svc] || ''}</td>
      <td>${isOver ? `🔴 $${b.currentCost.toFixed(4)}` : '🟢 —'}</td>
      <td>${isProjOver ? `~$${b.projectedCost.toFixed(4)}` : '—'}</td>
    </tr>`;
  }
  h += `<tr style="font-weight:700;border-top:2px solid #E2E8F0"><td>TOTAL</td><td colspan="2">—</td><td>$${surplus.toFixed(2)}</td><td>~$${projSurplus.toFixed(2)}</td></tr>`;
  h += '</tbody></table>';

  h += `<div style="font-size:11px;font-weight:700;color:#051E50;margin:10px 0 4px">Projection fin de cycle</div>`;
  if (projSurplus > 0) {
    const projTotal  = api.creditIncluded + projSurplus;
    const coveredPct = Math.min(100, Math.round(api.creditIncluded / projTotal * 100));
    const surplusPct = 100 - coveredPct;
    h += `<div class="vercel-proj-bar">
      <div class="vercel-proj-covered" style="width:${coveredPct}%;background:#22C55E"></div>
      <div class="vercel-proj-surplus" style="width:${surplusPct}%;background:#F97316"></div>
    </div>`;
    h += `<div style="font-size:11px;color:#64748B;margin-top:4px;display:flex;gap:12px"><span style="color:#22C55E">■ Plan inclus ($${api.creditIncluded})</span><span style="color:#F97316">■ Surplus estimé ($${projSurplus.toFixed(2)})</span></div>`;
    h += `<div style="font-size:11px;color:#F97316;font-weight:700;margin-top:4px">Total projeté fin de cycle : ~$${api.projectedTotal.toFixed(2)}</div>`;
  } else {
    h += `<div class="vercel-proj-bar"><div class="vercel-proj-covered" style="width:${Math.min(100, Math.round(api.projectedTotal / api.creditIncluded * 100))}%;background:#22C55E"></div></div>`;
    h += `<div style="font-size:11px;color:#22C55E;margin-top:4px">✅ Projection dans le crédit inclus (~$${api.projectedTotal.toFixed(2)} total)</div>`;
  }

  h += `<div style="font-size:11px;font-weight:700;color:#051E50;margin:12px 0 6px;text-transform:uppercase;letter-spacing:.6px">Prévisions par période</div>`;
  h += `<table style="margin-bottom:10px"><thead><tr><th>Période</th><th>Build Minutes</th><th>Fonctions</th><th>Total/mois</th></tr></thead><tbody>`;
  for (const row of VERCEL_PROJECTIONS) {
    const total    = row.build + row.functions;
    const surplus2 = Math.max(0, total - api.creditIncluded);
    const icon     = row.status === 'red' ? '🔴' : row.status === 'green' ? '🟢' : '🟠';
    const comment  = row.comment ? ` — ${row.comment}` : (surplus2 > 0 ? ` — surplus $${surplus2.toFixed(0)}` : ' — dans le crédit');
    h += `<tr><td>${row.label}</td><td>~$${row.build}</td><td>~$${row.functions}</td><td>${icon} ~$${total}${comment}</td></tr>`;
  }
  h += '</tbody></table>';

  h += `<div style="font-size:11px;color:#334155;padding:8px 10px;background:#F8FAFC;border-radius:6px;border:1px solid #E2E8F0">
    <strong>Seuils d'alerte :</strong>&nbsp;
    🟢 Aucun surplus = OK &nbsp;|&nbsp;
    🟠 Surplus &lt;$5 = surveiller &nbsp;|&nbsp;
    🔴 Surplus &gt;$5 = ralentir les déploiements
    <br><strong>Statut actuel :</strong> ${surplus === 0 ? '🟢 OK — aucun surplus' : surplus < 5 ? `🟠 Surplus $${surplus.toFixed(2)}` : `🔴 Surplus $${surplus.toFixed(2)}`}
    &nbsp;|&nbsp; Projection fin de cycle : ${projSurplus === 0 ? '🟢 OK' : `🟠 ~$${projSurplus.toFixed(2)} surplus`}
  </div>`;
  h += `<div style="font-size:11px;color:#64748B;margin-top:8px;font-style:italic">💡 Données calculées automatiquement depuis l'API Vercel à chaque chargement. Seul l'excédent au-delà des seuils inclus génère un coût supplémentaire.</div>`;
  h += '</div>';
  return h;
}

// ====================== PITCH GENERATOR SUB-TABS ======================

// ---- Constantes modifiables ----
const PITCH_STATUSES = {
  compteOpenAI: 'critical',  // 'ok' | 'warning' | 'critical'
  timeout:      'warning',
  formations:   'ok',
  couts:        'ok',
};
const PITCH_STATUS_LABELS = { compteOpenAI:'Compte OpenAI', timeout:'Timeout Vercel', formations:'Formations', couts:'Coûts API' };
const PITCH_STATUS_META   = { ok:{icon:'🟢',label:'OK',cls:'ok'}, warning:{icon:'🟡',label:'ATTENTION',cls:'warn'}, critical:{icon:'🔴',label:'CRITIQUE',cls:'danger'} };

const PITCH_FORMATION_DATES = [
  { date:'2026-02-25', label:'25 fév',   desc:'Test solo Claire',               users:1,  done:true  },
  { date:'2026-03-17', label:'17 mars',  desc:'Session 1 — Pilote réduit',      users:22, done:false },
  { date:'2026-03-25', label:'25 mars',  desc:'Session 2 — Pilote élargi',      users:22, done:false },
  { date:'2026-04-08', label:'8 avr',    desc:'Session 3 — Déploiement final',  users:22, done:false },
];
const PITCH_PRICE_CALL  = 0.00623; // $ par appel OpenAI
const PITCH_CALLS_PITCH = 6;       // appels par pitch complet
const PITCH_EUR_USD     = 0.92;    // taux de change approximatif
const PITCH_CL_IDS      = ['c1','c2','c3','c4','c5','c6','c7','c8','c9','c10'];

// ---- Navigation sous-onglets ----
function showPitchTab(id, btn) {
  document.querySelectorAll('#page-pitch .sub-page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('#page-pitch .sub-tab-btn').forEach(b => b.classList.remove('active'));
  const page = document.getElementById('pitch-sub-' + id);
  if (page) page.classList.add('active');
  if (btn) btn.classList.add('active');
}

// ---- Statut global ----
function renderPitchStatusWidget() {
  const vals = Object.values(PITCH_STATUSES);
  const global = vals.includes('critical') ? 'critical' : vals.includes('warning') ? 'warning' : 'ok';
  const sm = PITCH_STATUS_META[global];
  let h = `<div class="pitch-gs pitch-gs-${sm.cls}">${sm.icon} Statut global Pitch Generator : <strong>${sm.label}</strong></div>`;
  h += '<div class="pitch-sc-grid">';
  for (const [key, val] of Object.entries(PITCH_STATUSES)) {
    const m = PITCH_STATUS_META[val];
    h += `<div class="pitch-sc-card pitch-sc-${m.cls}"><span>${m.icon}</span><span>${PITCH_STATUS_LABELS[key]}</span></div>`;
  }
  h += '</div>';
  html('pitch-status-widget', h);
}

// ---- Formations ----
function renderPitchFormations() {
  const today0 = new Date(); today0.setHours(0,0,0,0);
  const OPENAI_COSTS = { pricePerCall: PITCH_PRICE_CALL, callsPerPitch: PITCH_CALLS_PITCH, eurUsd: PITCH_EUR_USD };

  let tlH = '<div class="pitch-timeline">';
  for (const f of PITCH_FORMATION_DATES) {
    const target = new Date(f.date); target.setHours(0,0,0,0);
    const days = Math.ceil((target - today0) / 86400000);
    const isPast = days < 0; const isToday = days === 0;
    let cls = 'pitch-tl-item';
    if (f.done || isPast) cls += ' tl-done';
    if (isToday) cls += ' tl-today';
    const when = (f.done || isPast) ? '✅ Fait' : isToday ? "📅 Aujourd'hui" : `Dans ${days} jour${days > 1 ? 's' : ''}`;
    const whenColor = (f.done || isPast) ? '#059669' : isToday ? '#D97706' : '#64748B';
    tlH += `<div class="${cls}">
      <div class="pitch-tl-dot"></div>
      <div class="pitch-tl-date">${f.label}</div>
      <div class="pitch-tl-desc">${f.desc}</div>
      <div class="pitch-tl-users">${f.users} participant${f.users > 1 ? 's' : ''}</div>
      <div class="pitch-tl-when" style="color:${whenColor}">${when}</div>
    </div>`;
  }
  tlH += '</div>';

  let tableH = `<table style="margin-top:16px"><thead><tr><th>Session</th><th>Participants</th><th>Pitchs/jour (est.)</th><th>Appels OpenAI</th><th>Coût estimé/jour</th></tr></thead><tbody>`;
  for (const f of PITCH_FORMATION_DATES) {
    const pitchs = f.users * 3;
    const calls  = pitchs * OPENAI_COSTS.callsPerPitch;
    const cost   = (calls * OPENAI_COSTS.pricePerCall * OPENAI_COSTS.eurUsd).toFixed(2);
    tableH += `<tr><td>${f.label} — ${f.desc}</td><td>${f.users}</td><td>${pitchs}</td><td>${calls}</td><td>${cost} €</td></tr>`;
  }
  tableH += '</tbody></table>';
  tableH += `<div class="note" style="margin-top:10px">Base : ${OPENAI_COSTS.callsPerPitch} appels × ${OPENAI_COSTS.pricePerCall}$ × ${OPENAI_COSTS.eurUsd} EUR/USD. Coûts réels visibles dans le dashboard OpenAI.</div>`;
  html('pitch-formations-widget', tlH + tableH);
}

// ---- Coûts globaux ----
const COSTS = {
  setup: [
    { label:'Vercel Pro — Février 2026',  sub:'(phase de dev intensif)',    cost:34, detail:'Hébergement pendant le développement. Élevé à cause des déploiements fréquents.' },
    { label:'Vercel Pro — Mars 2026',     sub:'(stabilisation)',            cost:20, detail:'Dev + formations. Retour à la normale après code freeze.' },
    { label:'OpenAI API — Dev & tests',   sub:'(jan.–mars 2026)',           cost:1,  detail:'Tous les appels IA pendant le développement et les tests.' },
    { label:'OpenAI — Crédits Tier 2',    sub:'(paiement unique)',          cost:50, detail:'Prépayé pour monter en capacité. Consommé progressivement par l\'usage.' },
  ],
  running: {
    vercelPro:      15,
    openaiPer15:    0.60,
    openaiPer66:    2.64,
    costPerPitch:   0.008,
  },
  openaiCredits: {
    loaded:      50,
    consumed:    1.25,
    lastChecked: '2026-02-25',
  },
  testBudget: [
    { label:'Tests unitaires (matrice)',     pitchs:3,  cost:0.024 },
    { label:'Tests petit groupe',            pitchs:10, cost:0.08  },
    { label:'Simulation formation (22)',     pitchs:22, cost:0.18  },
    { label:'Simulation stress (35)',        pitchs:35, cost:0.28  },
    { label:'Testeurs réels (5 pers.)',      pitchs:25, cost:0.20  },
    { label:'Retests après debug',           pitchs:22, cost:0.18  },
    { label:'Tests quotidiens (7 jours)',    pitchs:7,  cost:0.056 },
  ],
  oaiScenarios: [
    { label:'5 users (pilote)',   pitchs:25  },
    { label:'15 users',           pitchs:75  },
    { label:'50 users',           pitchs:250 },
    { label:'66 users (cible)',   pitchs:330 },
    { label:'100 users',          pitchs:500 },
  ],
  EUR_USD: 0.92,
};

function sectionSep(title, sub) {
  return `<div style="border-top:2px solid #E5E7EB;margin:20px 0 12px;padding-top:12px">
    <div style="font-size:12px;font-weight:800;color:#6B7280;letter-spacing:.8px;text-transform:uppercase">${title}</div>
    ${sub ? `<div style="font-size:11px;color:#9CA3AF;margin-top:2px">${sub}</div>` : ''}
  </div>`;
}

function renderPitchCouts() {
  const C   = COSTS;
  const EUR = C.EUR_USD;

  // SET-UP totaux
  const setupUSD = C.setup.reduce((s, r) => s + r.cost, 0);          // 105
  const setupEUR = Math.round(setupUSD * EUR);                        // ~97

  // FONCTIONNEMENT totaux
  const t15 = C.running.vercelPro + C.running.openaiPer15;            // 15.60
  const t66 = C.running.vercelPro + C.running.openaiPer66;            // 17.64

  // CRÉDITS OPENAI
  const oaiRem    = C.openaiCredits.loaded - C.openaiCredits.consumed; // 48.75
  const oaiPct    = Math.round(C.openaiCredits.consumed / C.openaiCredits.loaded * 1000) / 10; // 2.5
  const monthsRem = Math.round(oaiRem / C.running.openaiPer15);       // ~81 mois

  let h = '';

  // ── Vercel temps réel (section existante) ──────────────────────────────
  h += renderVercelCosts();

  // ── Carte principale ───────────────────────────────────────────────────
  h += `<div style="border-left:4px solid #22C55E;background:#fff;border-radius:8px;border:1px solid #E2E8F0;padding:16px;margin-bottom:16px">`;
  h += `<div style="font-size:14px;font-weight:800;color:#051E50;margin-bottom:4px">💰 Coûts Rubix Pitch Generator</div>`;

  // ── 1. COÛTS DE CONSTRUCTION ───────────────────────────────────────────
  h += sectionSep('COÛTS DE CONSTRUCTION (SET-UP)', 'Phase temporaire — terminée après le code freeze du 10/03');
  h += `<p style="font-size:12px;color:#334155;margin:8px 0 12px">Le set-up de l'application comprend l'hébergement pendant la phase de développement et les crédits IA nécessaires au lancement.</p>`;
  h += `<table style="margin-bottom:12px"><thead><tr><th>Poste</th><th>Coût</th><th>Détail</th></tr></thead><tbody>`;
  for (const row of C.setup) {
    h += `<tr>
      <td><strong>${row.label}</strong><br><span style="color:#9CA3AF;font-size:10px">${row.sub}</span></td>
      <td style="font-weight:700;white-space:nowrap;color:#051E50">~$${row.cost}</td>
      <td style="font-size:11px;color:#334155">${row.detail}</td>
    </tr>`;
  }
  h += `<tr style="font-weight:700;background:#F0FDF4;border-top:2px solid #E2E8F0">
    <td>TOTAL SET-UP</td>
    <td style="color:#166534">~$${setupUSD}</td>
    <td style="color:#166534">≈ ${setupEUR}€</td>
  </tr>`;
  h += '</tbody></table>';

  // ── 2. COÛTS DE FONCTIONNEMENT ─────────────────────────────────────────
  h += sectionSep('COÛTS DE FONCTIONNEMENT (RÉCURRENT)', 'À partir d\'avril 2026 — budget mensuel prévisible');
  h += `<p style="font-size:12px;color:#334155;margin:8px 0 12px">Une fois l'application stabilisée, les coûts mensuels sont faibles et prévisibles.</p>`;
  h += `<table style="margin-bottom:12px"><thead><tr><th>Poste</th><th>15 users</th><th>66 users</th><th>Détail</th></tr></thead><tbody>`;
  h += `<tr>
    <td>Vercel Pro</td>
    <td>~$${C.running.vercelPro}</td>
    <td>~$${C.running.vercelPro}</td>
    <td style="font-size:11px;color:#334155">Coût stable, peu de builds en production</td>
  </tr>`;
  h += `<tr>
    <td>OpenAI API</td>
    <td>~$${C.running.openaiPer15.toFixed(2)}</td>
    <td>~$${C.running.openaiPer66.toFixed(2)}</td>
    <td style="font-size:11px;color:#334155">~$${C.running.costPerPitch} / pitch<br>Base : 5 pitchs/mois / commercial</td>
  </tr>`;
  h += `<tr style="font-weight:700;border-top:2px solid #E2E8F0">
    <td>TOTAL / mois</td>
    <td>~$${Math.round(t15)}/mois<br><span style="font-size:11px;color:#9CA3AF">(${Math.ceil(t15 * EUR)}€)</span></td>
    <td>~$${Math.round(t66)}/mois<br><span style="font-size:11px;color:#9CA3AF">(${Math.ceil(t66 * EUR)}€)</span></td>
    <td></td>
  </tr>`;
  h += `<tr>
    <td style="color:#6B7280">Par commercial</td>
    <td style="color:#6B7280">~${Math.round(t15 / 15 * EUR * 100) / 100}€</td>
    <td style="color:#059669;font-weight:700">~0,27€ <span style="font-size:10px">(≈ 0,30€)</span></td>
    <td></td>
  </tr>`;
  h += '</tbody></table>';

  // ── 3. LE CHIFFRE CLÉ ─────────────────────────────────────────────────
  h += sectionSep('LE CHIFFRE CLÉ', '');
  h += `<div style="background:#051E50;color:#fff;border-radius:12px;padding:32px 24px;margin:12px 0 20px;text-align:center">
    <div style="font-size:24px;font-weight:800;margin-bottom:8px">~${setupEUR}€ de set-up</div>
    <div style="font-size:16px;font-weight:400;margin-bottom:8px">+</div>
    <div style="font-size:28px;font-weight:800">0,30€ / commercial / mois</div>
    <div style="font-size:13px;font-weight:400;opacity:.75;margin-top:8px">(base 5 pitchs/mois par commercial)</div>
  </div>`;

  // ── 4. DÉTAIL OPENAI ──────────────────────────────────────────────────
  h += sectionSep('DÉTAIL OPENAI', '');
  h += `<p style="font-size:12px;color:#334155;margin:8px 0 12px">Coût par pitch complet : <strong>~$${C.running.costPerPitch}</strong> (6 appels API) — soit moins de 1 centime par pitch généré.</p>`;
  h += `<table style="margin-bottom:6px"><thead><tr><th>Scénario</th><th>Pitchs/mois</th><th>Coût OpenAI/mois</th></tr></thead><tbody>`;
  for (const sc of C.oaiScenarios) {
    const cost = (sc.pitchs * C.running.costPerPitch).toFixed(2);
    h += `<tr><td>${sc.label}</td><td>${sc.pitchs}</td><td>~$${cost}</td></tr>`;
  }
  h += '</tbody></table>';
  h += `<div style="font-size:11px;color:#9CA3AF;margin-bottom:12px">Base : 5 pitchs/mois par commercial.</div>`;

  // ── 5. BUDGET PHASE DE TEST ────────────────────────────────────────────
  h += sectionSep('BUDGET PHASE DE TEST', '');
  const testTotal  = C.testBudget.reduce((s, r) => s + r.cost, 0);
  const testPitchs = C.testBudget.reduce((s, r) => s + r.pitchs, 0);
  h += `<table style="margin-bottom:8px"><thead><tr><th>Action</th><th>Pitchs</th><th>Coût</th></tr></thead><tbody>`;
  for (const row of C.testBudget) {
    h += `<tr><td>${row.label}</td><td>${row.pitchs}</td><td>$${row.cost}</td></tr>`;
  }
  h += `<tr style="font-weight:700;border-top:2px solid #E2E8F0">
    <td>TOTAL phase de test</td><td>${testPitchs}</td><td>$${Math.round(testTotal * 1000) / 1000}</td>
  </tr>`;
  h += '</tbody></table>';
  h += `<div style="font-size:11px;color:#9CA3AF;margin-bottom:12px">(inclus dans le set-up, déjà comptabilisé)</div>`;

  // ── 6. CRÉDITS OPENAI ─────────────────────────────────────────────────
  h += sectionSep('CRÉDITS OPENAI', '');
  h += `<div style="font-size:12px;color:#334155;margin-bottom:8px">
    Crédits chargés : <strong>$${C.openaiCredits.loaded}</strong> (plan Tier 2) &nbsp;|&nbsp;
    Consommé à date : <strong>~$${C.openaiCredits.consumed}</strong> &nbsp;|&nbsp;
    Restant : <strong>~$${oaiRem.toFixed(2)}</strong>
  </div>`;
  h += `<div class="vercel-prog-bar" style="margin-bottom:4px"><div class="vercel-prog-fill" style="width:${Math.max(1, Math.round(oaiPct))}%;background:#22C55E"></div></div>`;
  h += `<div style="display:flex;justify-content:space-between;font-size:11px;color:#9CA3AF;margin-bottom:10px">
    <span>$${C.openaiCredits.consumed} consommé</span>
    <span>$${C.openaiCredits.loaded}</span>
  </div>`;
  h += `<div style="background:#F0FDF4;border-radius:8px;padding:12px;border:1px solid #BBF7D0;font-size:12px;color:#166534">
    ${oaiPct}% consommé &nbsp;|&nbsp;
    Au rythme actuel (~$${C.running.openaiPer15}/mois avec 15 users),
    ces crédits durent <strong>${monthsRem > 24 ? 'plus de ' + Math.floor(monthsRem / 12) + ' ans' : monthsRem + ' mois'}</strong>.
  </div>`;

  h += '</div>'; // fin carte principale
  html('pitch-couts-widget', h);
}

// ---- Checklist ----
function getPitchChecklist() {
  try { return JSON.parse(localStorage.getItem('pitch_checklist') || '{}'); } catch { return {}; }
}
function togglePitchCheck(id) {
  const stored = getPitchChecklist();
  stored[id] = !stored[id];
  localStorage.setItem('pitch_checklist', JSON.stringify(stored));
  const el  = document.getElementById('pitch-cl-' + id);
  const chk = document.getElementById('pitch-chk-' + id);
  if (el)  el.classList.toggle('cl-checked', !!stored[id]);
  if (chk) chk.checked = !!stored[id];
  updatePitchClProgress();
}
function resetPitchChecklist() {
  localStorage.removeItem('pitch_checklist');
  PITCH_CL_IDS.forEach(id => {
    const el  = document.getElementById('pitch-cl-' + id);
    const chk = document.getElementById('pitch-chk-' + id);
    if (el)  el.classList.remove('cl-checked');
    if (chk) chk.checked = false;
  });
  updatePitchClProgress();
}
function updatePitchClProgress() {
  const stored = getPitchChecklist();
  const done = PITCH_CL_IDS.filter(id => stored[id]).length;
  const total = PITCH_CL_IDS.length;
  const prog = document.getElementById('pitch-cl-prog');
  if (prog) prog.textContent = `${done} / ${total} complétés${done === total ? ' — Tout est prêt ! 🎉' : ''}`;
}
function initPitchChecklist() {
  const stored = getPitchChecklist();
  PITCH_CL_IDS.forEach(id => {
    const el  = document.getElementById('pitch-cl-' + id);
    const chk = document.getElementById('pitch-chk-' + id);
    if (el)  el.classList.toggle('cl-checked', !!stored[id]);
    if (chk) chk.checked = !!stored[id];
  });
  updatePitchClProgress();
}

// ---- Pilote & Transition IT ----
function renderPitchPilote() {
  const CRITERES = [
    { critere:'Adoption',   comment:'% d\'ambassadeurs ayant généré ≥1 pitch', cible:'> 80%' },
    { critere:'Usage',      comment:'Nombre total de pitchs générés',           cible:'> 100' },
    { critere:'Stabilité',  comment:'Erreurs 429 ou timeout en production',     cible:'< 5'   },
    { critere:'Coût réel',  comment:'Facture Vercel + OpenAI sur la période',   cible:'< 50€' },
    { critere:'Satisfaction', comment:'Feedback qualitatif canal Teams',        cible:'Positif' },
  ];
  const TRANSITION = [
    { composant:'Hébergement',    pilote:'Vercel (compte Claire)',          cible:'URL groupe ou hébergement interne' },
    { composant:'Compte IA',      pilote:'OpenAI dédié Rubix Digital',      cible:'Azure OpenAI entreprise' },
    { composant:'Authentification', pilote:'Mot de passe simple → login JSON', cible:'SSO Microsoft' },
    { composant:'Données matrice', pilote:'Vercel Blob',                   cible:'SharePoint Rubix' },
    { composant:'Monitoring',     pilote:'Page monitoring manuelle',        cible:'Alertes automatiques IT' },
    { composant:'Support',        pilote:'Claire seule',                    cible:'IT niveau 1 + Claire niveau 2' },
  ];

  let h = `<div style="border-left:4px solid #3B82F6;background:#fff;border-radius:8px;border:1px solid #E2E8F0;padding:16px;margin-bottom:16px">`;
  h += `<div style="font-size:14px;font-weight:800;color:#051E50;margin-bottom:4px">🏁 Pilote & Transition IT</div>`;

  // ── 1. Périmètre pilote ────────────────────────────────────────────────
  h += sectionSep('PÉRIMÈTRE PILOTE', '');
  h += `<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:12px">
    <div style="background:#EFF6FF;border-radius:8px;padding:12px;text-align:center">
      <div style="font-size:11px;color:#6B7280;margin-bottom:4px">Début pilote</div>
      <div style="font-size:16px;font-weight:800;color:#1D4ED8">17/03/2026</div>
      <div style="font-size:11px;color:#6B7280">Session 1</div>
    </div>
    <div style="background:#EFF6FF;border-radius:8px;padding:12px;text-align:center">
      <div style="font-size:11px;color:#6B7280;margin-bottom:4px">Fin pilote</div>
      <div style="font-size:16px;font-weight:800;color:#1D4ED8">30/04/2026</div>
      <div style="font-size:11px;color:#6B7280">Bilan GO/NO GO</div>
    </div>
    <div style="background:#EFF6FF;border-radius:8px;padding:12px;text-align:center">
      <div style="font-size:11px;color:#6B7280;margin-bottom:4px">Durée</div>
      <div style="font-size:16px;font-weight:800;color:#1D4ED8">6 semaines</div>
      <div style="font-size:11px;color:#6B7280">22 ambassadeurs</div>
    </div>
  </div>`;
  h += `<p style="font-size:12px;color:#334155;margin:0 0 12px;line-height:1.6">L'objectif du pilote est de prouver que l'application fonctionne en conditions réelles, que les commerciaux l'adoptent, et que les coûts sont maîtrisés.</p>`;

  // ── 2. Critères de succès ──────────────────────────────────────────────
  h += sectionSep('CRITÈRES DE SUCCÈS DU PILOTE', '');
  h += `<table style="margin-bottom:12px"><thead><tr><th>Critère</th><th>Comment on mesure</th><th>Cible</th></tr></thead><tbody>`;
  for (const r of CRITERES) {
    h += `<tr><td style="font-weight:700">${r.critere}</td><td style="font-size:11px;color:#334155">${r.comment}</td><td style="font-weight:700;color:#1D4ED8">${r.cible}</td></tr>`;
  }
  h += '</tbody></table>';

  // ── 3. Timeline transition IT ──────────────────────────────────────────
  h += sectionSep('TIMELINE TRANSITION IT', '');
  const TL = [
    { date:'17/03', label:'Session 1', sub:'5 users',      color:'#1D4ED8' },
    { date:'08/04', label:'Session 3', sub:'15 users',     color:'#1D4ED8' },
    { date:'30/04', label:'Bilan pilote', sub:'Décision GO/NO GO', color:'#166534' },
    { date:'Mai',   label:'Cadrage IT',  sub:'',           color:'#6B7280' },
    { date:'Juin',  label:'Migration infra', sub:'',       color:'#6B7280' },
    { date:'Juillet', label:'Bascule IT', sub:'',          color:'#6B7280' },
  ];
  h += `<div style="overflow-x:auto;margin-bottom:12px"><div style="display:flex;align-items:flex-start;gap:0;min-width:480px;padding:8px 0 4px">`;
  for (let i = 0; i < TL.length; i++) {
    const t = TL[i];
    const isLast = i === TL.length - 1;
    h += `<div style="display:flex;flex-direction:column;align-items:center;flex:1;position:relative">`;
    h += `<div style="display:flex;align-items:center;width:100%">`;
    h += `<div style="width:14px;height:14px;border-radius:50%;background:${t.color};flex-shrink:0;border:2px solid #fff;box-shadow:0 0 0 2px ${t.color}"></div>`;
    if (!isLast) h += `<div style="flex:1;height:2px;background:#D1D5DB"></div>`;
    h += `</div>`;
    h += `<div style="margin-top:6px;text-align:center;padding:0 2px">`;
    h += `<div style="font-size:11px;font-weight:800;color:${t.color}">${t.date}</div>`;
    h += `<div style="font-size:11px;font-weight:700;color:#051E50;margin-top:2px">${t.label}</div>`;
    if (t.sub) h += `<div style="font-size:10px;color:#9CA3AF">${t.sub}</div>`;
    h += `</div></div>`;
  }
  h += `</div></div>`;

  // ── 4. Ce qui change avec l'IT ─────────────────────────────────────────
  h += sectionSep('CE QUI CHANGE AVEC L\'IT', '');
  h += `<table style="margin-bottom:12px"><thead><tr><th>Composant</th><th>Pilote (aujourd\'hui)</th><th>Cible IT (industrialisé)</th></tr></thead><tbody>`;
  for (const r of TRANSITION) {
    h += `<tr>
      <td style="font-weight:700">${r.composant}</td>
      <td style="font-size:11px;color:#6B7280">${r.pilote}</td>
      <td style="font-size:11px;color:#166534;font-weight:600">${r.cible}</td>
    </tr>`;
  }
  h += '</tbody></table>';

  // ── 5. Statut ──────────────────────────────────────────────────────────
  h += sectionSep('STATUT', '');
  h += `<div style="display:flex;gap:16px;align-items:center;flex-wrap:wrap">
    <div style="background:#EFF6FF;border-radius:8px;padding:10px 16px;border:1px solid #BFDBFE">
      <span style="font-size:11px;color:#6B7280">Statut pilote : </span>
      <span style="font-size:12px;font-weight:800;color:#1D4ED8">● EN COURS</span>
    </div>
    <div style="background:#F8FAFC;border-radius:8px;padding:10px 16px;border:1px solid #E2E8F0">
      <span style="font-size:11px;color:#6B7280">Date de bilan : </span>
      <span style="font-size:12px;font-weight:800;color:#051E50">30/04/2026</span>
    </div>
  </div>`;

  h += '</div>'; // fin carte
  html('pitch-pilote-widget', h);
}

// ---- Init ----
let pitchInitialized = false;
let vercelBillingAPI = null;
function initPitchSubTabs() {
  renderPitchStatusWidget();
  renderPitchFormations();
  renderPitchCouts();
  renderPitchPilote();
  initPitchChecklist();
}

// ====================== RÉTROPLANNING ======================

const RETRO_DATA = [
  // ===== PHASE 1 — Prêt pour la formation (25/02 → 17/03) =====
  { date:'2026-02-25', phaseHeader:{ label:'⚡ Phase 1 — Prêt pour la formation  ·  25/02 → 17/03', color:'#1D4ED8', bg:'#DBEAFE' }, milestone:null, actions:[
    { id:'s1-1', text:'Créer compte OpenAI dédié Rubix Pitch', responsable:'CLAIRE', priority:'red' },
    { id:'s1-2', text:'Charger 50$ de crédits sur le nouveau compte', responsable:'CLAIRE', priority:'red' },
    { id:'s1-3', text:'Mettre à jour OPENAI_API_KEY dans Vercel', responsable:'CLAIRE', priority:'red' },
    { id:'s1-4', text:'Tester que l\'app fonctionne avec la nouvelle clé', responsable:'CLAIRE', priority:'red' },
    { id:'s1-5', text:'Créer canal Teams "Rubix Pitch — Retours & Support"', responsable:'CLAIRE', priority:'blue' },
    { id:'s1-20', text:'Demander à l\'IT la création du canal Teams "Rubix Pitch — Retours & Support"', responsable:'CLAIRE', priority:'blue' },
    { id:'s1-21', text:'Demander validation budget 50$ (46€) pour compte OpenAI dédié au manager', responsable:'CLAIRE', priority:'blue' },
  ]},
  { date:'2026-02-26', milestone:null, actions:[
    { id:'s1-6', text:'Corriger bug API Fusion (solutions_selectionnees = [])', responsable:'CLAUDE CODE', priority:'red' },
    { id:'s1-7', text:'Corriger bug API Fusion (tendances_selectionnees = [])', responsable:'CLAUDE CODE', priority:'red' },
    { id:'s1-8', text:'Corriger tendances disparues étape 3', responsable:'CLAUDE CODE', priority:'red' },
    { id:'s1-9', text:'Corriger crédibilité incomplète étape 3', responsable:'CLAUDE CODE', priority:'red' },
  ]},
  // 27/02 (Ven) — fusionné avec 28/02 (Samedi → déplacé)
  { date:'2026-02-27', milestone:null, actions:[
    { id:'s1-10', text:'Implémenter messages d\'erreur UX (timeout, 429, 500, JSON)', responsable:'CLAUDE CODE', priority:'red' },
    { id:'s1-11', text:'Implémenter bouton "Réessayer" sans perte de données saisies', responsable:'CLAUDE CODE', priority:'red' },
    { id:'s1-12', text:'Implémenter timeout frontend 58s (couper avant le 60s Vercel)', responsable:'CLAUDE CODE', priority:'red' },
    { id:'s1-13', text:'Implémenter retry exponential backoff (api/generate-pitch.js)', responsable:'CLAUDE CODE', priority:'red' },
    { id:'s1-14', text:'Implémenter retry exponential backoff (api/generate-fusion.js)', responsable:'CLAUDE CODE', priority:'red' },
    { id:'s1-15', text:'Ajouter bouton "Signaler un problème" → lien canal Teams', responsable:'CLAUDE CODE', priority:'orange' },
    { id:'s1-16', text:'Implémenter login individuel (identifiant + code) → remplacer le mot de passe unique', responsable:'CLAUDE CODE', priority:'orange' },
    { id:'s1-17', text:'Créer fichier users.json sur Vercel Blob (liste utilisateurs avec champ "actif")', responsable:'CLAUDE CODE', priority:'orange' },
    { id:'s1-18', text:'Tester parcours complet — vérifier corrections bugs', responsable:'CLAIRE', priority:'green' },
  ]},
  // Semaine 2 — Matrice + Stabilisation (02/03 → 06/03)
  { date:'2026-03-02', milestone:'📦 Réception nouvelle matrice', actions:[
    { id:'s2-1', text:'Réceptionner la nouvelle matrice', responsable:'CLAIRE', priority:'red' },
    { id:'s2-2', text:'Vérifier les 7 onglets (format, colonnes, données cohérentes)', responsable:'CLAIRE', priority:'red' },
    { id:'s2-3', text:'Uploader nouvelle matrice sur Vercel Blob', responsable:'CLAUDE CODE', priority:'red' },
    { id:'s2-4', text:'Garder ancienne matrice en backup (ne pas supprimer)', responsable:'CLAUDE CODE', priority:'red' },
    { id:'s2-5', text:'Si Tier 2 pas automatique → contacter support OpenAI', responsable:'CLAIRE', priority:'blue' },
  ]},
  { date:'2026-03-03', milestone:null, actions:[
    { id:'s2-6', text:'🧪 Simulation unitaire × 3 combos avec nouvelle matrice (Coût : $0.024)', responsable:'CLAIRE', priority:'green' },
    { id:'s2-7', text:'Corriger régressions si nouvelle matrice casse quelque chose', responsable:'CLAUDE CODE', priority:'red' },
    { id:'s2-8', text:'Implémenter sauvegarde historique multi-device (Vercel Blob par utilisateur)', responsable:'CLAUDE CODE', priority:'orange' },
  ]},
  { date:'2026-03-04', milestone:null, actions:[
    { id:'s2-9', text:'Implémenter parallélisation Promise.all() (useContentGeneration.js)', responsable:'CLAUDE CODE', priority:'orange' },
    { id:'s2-10', text:'🧪 Simulation petit groupe × 5 pitchs ($0.04) — vérifier Promise.all()', responsable:'CLAIRE', priority:'green' },
    { id:'s2-11', text:'Implémenter logging structuré des appels API (console.log JSON)', responsable:'CLAUDE CODE', priority:'orange' },
  ]},
  { date:'2026-03-05', milestone:'💜 Point manager', actions:[
    { id:'s2-12', text:'Point manager : présenter la page /monitoring', responsable:'CLAIRE', priority:'blue' },
    { id:'s2-13', text:'Demander 3-5 testeurs commerciaux volontaires (2 RVE + 1 DE + 1 non-tech) — montrer la page /monitoring en support', responsable:'CLAIRE', priority:'blue' },
    { id:'s2-14', text:'Créer endpoint /api/health (test OpenAI + Blob)', responsable:'CLAUDE CODE', priority:'orange' },
  ]},
  { date:'2026-03-06', milestone:'📋 Point d\'étape', actions:[
    { id:'s2-15', text:'Point d\'étape : démo parcours complet sans bug', responsable:'CLAIRE', priority:'green' },
    { id:'s2-16', text:'Vérifier statut Tier 2 (automatique ? réponse support ?)', responsable:'CLAIRE', priority:'green' },
    { id:'s2-17', text:'Décision : plan 5+5+5 (Tier 1) ou ouverture totale (Tier 2)', responsable:'CLAIRE', priority:'green' },
    { id:'s2-18', text:'Confirmer liste testeurs (noms reçus du point manager)', responsable:'CLAIRE', priority:'blue' },
    { id:'s2-19', text:'Préparer users.json avec les 66 participants', responsable:'CLAIRE', priority:'blue' },
    { id:'s2-20', text:'Décider quota pitchs/jour par utilisateur : 5 (~€72/mois, recommandé) ou 10 (~€146/mois)', responsable:'CLAIRE', priority:'orange' },
    { id:'s2-22', text:'Mettre à jour les métriques Vercel dans la page /monitoring (vercel.com → Dashboard → Usage → copier les chiffres dans VERCEL_USAGE)', responsable:'CLAIRE', priority:'green' },
  ]},
  // Semaine 3 — Bêta test + Simulations (09/03 → 13/03)
  // 07/03 (Sam) + 08/03 (Dim) → déplacés semaine du 09/03
  { date:'2026-03-09', milestone:null, actions:[
    { id:'s3-1', text:'Envoyer accès app aux testeurs + consignes canal Teams', responsable:'CLAIRE', priority:'blue' },
    { id:'s3-2', text:'Corriger bugs remontés par testeurs (au fil de l\'eau)', responsable:'CLAUDE CODE', priority:'orange' },
    { id:'s3-6', text:'🧪 Simulation formation : 22 pitchs / 5 vagues / 3s — Coût : $0.18', responsable:'CLAIRE', priority:'green' },
  ]},
  { date:'2026-03-10', milestone:'🔒 Code freeze', actions:[
    { id:'s3-3', text:'Corrections bugs testeurs', responsable:'CLAUDE CODE', priority:'orange' },
    { id:'s3-4', text:'Vérifier logs Vercel + retours canal Teams', responsable:'CLAIRE', priority:'green' },
    { id:'s3-7', text:'🧪 Simulation stress : 35 pitchs / 7 vagues / 3s — Coût : $0.28', responsable:'CLAIRE', priority:'green' },
    { id:'s3-8', text:'Analyser résultats simulations : taux succès, temps moyen, erreurs', responsable:'CLAIRE', priority:'green' },
    { id:'s3-11', text:'DÉCISION : code freeze si tests OK (reporté 11/03 max si debug)', responsable:'CLAIRE', priority:'green' },
  ]},
  { date:'2026-03-11', milestone:null, actions:[
    { id:'s3-5', text:'Dernières corrections bugs testeurs', responsable:'CLAUDE CODE', priority:'orange' },
    { id:'s3-9', text:'Fix critique uniquement si simulation révèle un problème bloquant', responsable:'CLAUDE CODE', priority:'red' },
    { id:'s3-10', text:'🧪 Retest formation (22 pitchs) si debug effectué — Coût : $0.18', responsable:'CLAIRE', priority:'green' },
  ]},
  { date:'2026-03-12', milestone:null, actions:[
    { id:'s3-12', text:'Uploader fichier users.json final sur Vercel Blob', responsable:'CLAIRE', priority:'blue' },
    { id:'s3-13', text:'Générer 3 pitchs de démo PDF (Agro/Achats, Industrie/Maint, Élec/Prod)', responsable:'CLAIRE', priority:'green' },
    { id:'s3-14', text:'Préparer document "Guide formateur" pour le créneau app', responsable:'CLAIRE', priority:'blue' },
    { id:'s3-15', text:'Bilan testeurs : recueillir feedback final', responsable:'CLAIRE', priority:'green' },
  ]},
  // 13/03 (Ven) — fusionné avec 14/03 (Sam) + 15/03 (Dim)
  { date:'2026-03-13', milestone:null, actions:[
    { id:'s4-1', text:'Test quotidien : générer 1 pitch, vérifier résultat — Coût : $0.008', responsable:'CLAIRE', priority:'green' },
    { id:'s4-2', text:'Confirmer salle + matériel formation 17/03', responsable:'CLAIRE', priority:'blue' },
    { id:'s4-3', text:'Relire guide formateur, valider déroulé créneau app', responsable:'FORMATEUR', priority:'blue' },
    { id:'s4-4', text:'Test quotidien — Coût : $0.008', responsable:'CLAIRE', priority:'green' },
    { id:'s4-5', text:'Identifier les 5 ambassadeurs session 1 (parmi les 22 participants)', responsable:'CLAIRE', priority:'blue' },
    { id:'s4-6', text:'Activer les 5 ambassadeurs dans users.json (actif: true)', responsable:'CLAIRE', priority:'blue' },
  ]},
  { date:'2026-03-16', milestone:'📋 Veille formation', actions:[
    { id:'s4-7', text:'/api/health → tout vert', responsable:'CLAIRE', priority:'green' },
    { id:'s4-8', text:'Vérifier solde crédits OpenAI (platform.openai.com)', responsable:'CLAIRE', priority:'green' },
    { id:'s4-9', text:'Générer 1 pitch test complet → résultat cohérent — Coût : $0.008', responsable:'CLAIRE', priority:'green' },
    { id:'s4-10', text:'Tester depuis un téléphone en 4G (backup wifi)', responsable:'CLAIRE', priority:'green' },
    { id:'s4-11', text:'Vérifier pitchs PDF fallback prêts et accessibles', responsable:'CLAIRE', priority:'green' },
    { id:'s4-12', text:'Vérifier canal Teams accessible par les participants', responsable:'CLAIRE', priority:'green' },
    { id:'s4-13', text:'Vérifier page /monitoring → connaître les points orange/rouge restants', responsable:'CLAIRE', priority:'green' },
  ]},
  { date:'2026-03-17', milestone:'🎯 SESSION 1', actions:[
    { id:'s4-14', text:'8h00 : Ouvrir l\'app + générer 1 pitch pour chauffer', responsable:'CLAIRE', priority:'green' },
    { id:'s4-15', text:'8h00 : Ouvrir logs Vercel dans un onglet', responsable:'CLAIRE', priority:'green' },
    { id:'s4-16', text:'Créneau app (~1h) : guider les 22 participants', responsable:'FORMATEUR', priority:'blue' },
    { id:'s4-17', text:'Si bug en live → montrer le pitch PDF de fallback', responsable:'FORMATEUR', priority:'blue' },
    { id:'s4-18', text:'17h30 : Vérifier les logs — erreurs 429 ? Timeouts ?', responsable:'CLAIRE', priority:'green' },
    { id:'s4-19', text:'17h30 : Confirmer les 5 ambassadeurs → leur partager lien + canal Teams', responsable:'CLAIRE', priority:'blue' },
  ]},
  // ===== PHASE 2 — App solide pour 10 utilisateurs (18/03 → 25/03) =====
  { date:'2026-03-18', phaseHeader:{ label:'🌱 Phase 2 — App solide pour 10 utilisateurs  ·  18/03 → 25/03', color:'#166534', bg:'#DCFCE7' }, milestone:null, actions:[
    { id:'s5-1', text:'Vérifier logs Vercel : les ambassadeurs utilisent l\'app ?', responsable:'CLAIRE', priority:'green' },
    { id:'s5-2', text:'Vérifier canal Teams : bugs remontés ?', responsable:'CLAIRE', priority:'green' },
  ]},
  { date:'2026-03-19', milestone:null, actions:[
    { id:'s5-3', text:'Point rapide ambassadeurs : "Ça marche ? Des soucis ?"', responsable:'CLAIRE', priority:'green' },
    { id:'s5-4', text:'Corriger bugs remontés si besoin', responsable:'CLAUDE CODE', priority:'orange' },
  ]},
  // 20/03 (Ven) — fusionné avec 21/03 (Samedi → déplacé)
  { date:'2026-03-20', milestone:null, actions:[
    { id:'s5-5', text:'Bilan semaine pilote : logs, feedback ambassadeurs, décision suite', responsable:'CLAIRE', priority:'green' },
    { id:'s5-6', text:'Si KO → identifier et corriger avant le 25/03', responsable:'CLAIRE', priority:'green' },
    { id:'s5-7', text:'Relancer les organisateurs formation pour la liste des 66 participants si pas encore reçue (deadline 20/03)', responsable:'CLAIRE', priority:'blue' },
  ]},
  { date:'2026-03-24', milestone:'📋 Veille formation 2', actions:[
    { id:'s6-1', text:'Checklist veille complète (même que 16/03)', responsable:'CLAIRE', priority:'green' },
    { id:'s6-2', text:'Vérifier corrections post-session 1 en place', responsable:'CLAIRE', priority:'green' },
    { id:'s6-3', text:'Activer 5 nouveaux ambassadeurs dans users.json', responsable:'CLAIRE', priority:'blue' },
  ]},
  { date:'2026-03-25', milestone:'🎯 SESSION 2', actions:[
    { id:'s6-4', text:'8h00 : Chauffer l\'app + logs ouverts', responsable:'CLAIRE', priority:'green' },
    { id:'s6-5', text:'Créneau app avec 22 participants', responsable:'FORMATEUR', priority:'blue' },
    { id:'s6-6', text:'17h30 : Vérifier logs', responsable:'CLAIRE', priority:'green' },
    { id:'s6-7', text:'17h30 : Confirmer 5 nouveaux ambassadeurs (total : 10 actifs)', responsable:'CLAIRE', priority:'blue' },
  ]},
  // ===== PHASE 3 — Robustesse + ouverture progressive (30/03 → 08/04+) =====
  { date:'2026-03-30', phaseHeader:{ label:'🚀 Phase 3 — Robustesse + ouverture progressive  ·  30/03 → 08/04+', color:'#92400E', bg:'#FEF9C3' }, milestone:null, actions:[
    { id:'s7-1', text:'Vérifier logs 2×/semaine (lundi + jeudi)', responsable:'CLAIRE', priority:'green' },
    { id:'s7-2', text:'Surveiller canal Teams', responsable:'CLAIRE', priority:'green' },
    { id:'s7-3', text:'Implémenter cache priorisations (préparer ouverture large)', responsable:'CLAUDE CODE', priority:'orange' },
  ]},
  { date:'2026-04-03', milestone:null, actions:[
    { id:'s7-4', text:'Bilan 10 users : stable ? erreurs ? temps de génération ?', responsable:'CLAIRE', priority:'green' },
    { id:'s7-5', text:'Vérifier statut Tier 2', responsable:'CLAIRE', priority:'green' },
    { id:'s7-6', text:'Si Tier 2 → planifier ouverture large après session 3', responsable:'CLAIRE', priority:'blue' },
    { id:'s7-7', text:'Si Tier 1 → rester sur +5 users après session 3', responsable:'CLAIRE', priority:'blue' },
  ]},
  { date:'2026-04-07', milestone:'📋 Veille formation 3', actions:[
    { id:'s9-1', text:'Checklist veille complète', responsable:'CLAIRE', priority:'green' },
    { id:'s9-2', text:'Activer 5 nouveaux ambassadeurs dans users.json', responsable:'CLAIRE', priority:'blue' },
  ]},
  { date:'2026-04-08', milestone:'🎯 SESSION 3', actions:[
    { id:'s9-3', text:'8h00 : Chauffer l\'app + logs', responsable:'CLAIRE', priority:'green' },
    { id:'s9-4', text:'Créneau app avec 22 participants', responsable:'FORMATEUR', priority:'blue' },
    { id:'s9-5', text:'17h30 : Vérifier logs + confirmer 5 ambassadeurs (total : 15 actifs)', responsable:'CLAIRE', priority:'green' },
    { id:'s9-6', text:'Bilan global : 15 users actifs, Tier 1 ou 2, erreurs cumulées', responsable:'CLAIRE', priority:'green' },
  ]},
  // Post-formation
  { date:'2026-04-14', milestone:null, actions:[
    { id:'s10-1', text:'Bilan 15 users → décision ouverture 30 users', responsable:'CLAIRE', priority:'green' },
  ]},
  { date:'2026-04-21', milestone:null, actions:[
    { id:'s10-2', text:'Si Tier 2 → ouverture 66 users', responsable:'CLAIRE', priority:'green' },
    { id:'s10-3', text:'Si Tier 1 → relancer support OpenAI', responsable:'CLAIRE', priority:'blue' },
    { id:'s10-4', text:'Implémenter mode dégradé, monitoring alertes, métriques d\'usage', responsable:'CLAUDE CODE', priority:'orange' },
  ]},
  // ===== BILAN PILOTE =====
  { date:'2026-04-30', milestone:'📋 JALON : Bilan pilote', actions:[
    { id:'s11-1', text:'Bilan pilote : préparer les métriques (adoption, usage, coûts, stabilité)', responsable:'CLAIRE', priority:'blue' },
    { id:'s11-2', text:'Présenter les résultats au manager + IT', responsable:'CLAIRE', priority:'blue' },
    { id:'s11-3', text:'Décision GO/NO GO pour la transition IT', responsable:'CLAIRE', priority:'blue' },
  ]},
];

const PRIO_COLORS  = { red:'#EF4444', orange:'#F59E0B', blue:'#3B82F6', green:'#22C55E' };
const PRIO_LABELS  = { red:'🔴 Bloquant', orange:'🟠 Important', blue:'🔵 Préparation', green:'🟢 Validation' };
const RESP_STYLES  = {
  'CLAIRE':     { bg:'#FFF9E6', color:'#051E50' },
  'CLAUDE CODE':{ bg:'#EFF6FF', color:'#1E40AF' },
  'FORMATEUR':  { bg:'#F0FDF4', color:'#166534' },
};
const S_CYCLE  = ['', 'inprogress', 'done', 'blocked'];
const S_ICONS  = { '':'⬜', inprogress:'🔄', done:'✅', blocked:'❌' };
const S_LABELS = { '':'À faire', inprogress:'En cours', done:'Fait', blocked:'Bloqué' };

let retroFilterResp = 'all';
let retroFilterPrio = 'all';

function getRS(id)      { return localStorage.getItem('retro_' + id) || ''; }
function setRS(id, val) { val === '' ? localStorage.removeItem('retro_' + id) : localStorage.setItem('retro_' + id, val); }

function clickRetroStatus(id) {
  const cur  = getRS(id);
  const next = S_CYCLE[(S_CYCLE.indexOf(cur) + 1) % S_CYCLE.length];
  setRS(id, next);
  // Update pills in roadmap
  document.querySelectorAll(`[data-aid="${id}"] .rm-pill-status`).forEach(b => { b.textContent = S_ICONS[next]; b.title = S_LABELS[next]; });
  document.querySelectorAll(`[data-aid="${id}"]`).forEach(el => { next === 'done' ? el.classList.add('done-card') : el.classList.remove('done-card'); });
  // Update detail panel buttons
  const db = $('rb-' + id); if (db) { db.textContent = S_ICONS[next]; db.title = S_LABELS[next]; }
  const dc = $('rc-' + id); if (dc) { next === 'done' ? dc.classList.add('done-card') : dc.classList.remove('done-card'); }
  updateRetroProgress();
}

function getMilestoneStyle(m) {
  if (!m) return null;
  if (m.includes('SESSION'))  return { bg:'#FFF9E6', border:'#FFD500', color:'#92400E' };
  if (m.includes('freeze'))   return { bg:'#FEF2F2', border:'#EF4444', color:'#DC2626' };
  if (m.includes('manager'))  return { bg:'#F5F3FF', border:'#7C3AED', color:'#6D28D9' };
  if (m.includes('matrice'))  return { bg:'#F0FDF4', border:'#22C55E', color:'#166534' };
  if (m.includes('Bilan'))    return { bg:'#EFF6FF', border:'#3B82F6', color:'#1D4ED8' };
  return { bg:'#EFF6FF', border:'#3B82F6', color:'#1D4ED8' };
}

function getMonday(date) {
  const d = new Date(date); const day = d.getDay();
  d.setDate(d.getDate() + (day === 0 ? -6 : 1 - day)); d.setHours(0,0,0,0); return d;
}

// ── Build weeks data structure ──────────────────────────────────────────────
function buildWeeks() {
  const dateMap = {};
  for (const entry of RETRO_DATA) dateMap[entry.date] = entry;
  const allDates = RETRO_DATA.map(e => new Date(e.date));
  const startMon = getMonday(new Date(Math.min(...allDates)));
  const endMon   = getMonday(new Date(Math.max(...allDates)));
  const phaseDates = RETRO_DATA.filter(e => e.phaseHeader).map(e => e.date);

  const weeks = [];
  let cur = new Date(startMon);
  while (cur <= endMon) {
    const days = [];
    for (let i = 0; i < 5; i++) { const d = new Date(cur); d.setDate(cur.getDate() + i); days.push(d); }
    const entries = days.map(d => dateMap[d.toISOString().split('T')[0]]).filter(Boolean);
    if (entries.length > 0) {
      const mon = new Date(cur);
      const fri = days[4];
      const label = mon.toLocaleDateString('fr-FR',{day:'2-digit',month:'short'}) + '–' + fri.toLocaleDateString('fr-FR',{day:'2-digit',month:'short'});

      // Determine phase for this week
      let phase = 0;
      for (let p = phaseDates.length - 1; p >= 0; p--) {
        if (mon >= new Date(phaseDates[p])) { phase = p; break; }
      }

      // Collect milestones and actions by responsable
      const milestones = entries.filter(e => e.milestone).map(e => e.milestone);
      const actionsByResp = { 'CLAIRE':[], 'CLAUDE CODE':[], 'FORMATEUR':[] };
      for (const entry of entries) {
        for (const a of entry.actions) {
          if (actionsByResp[a.responsable]) actionsByResp[a.responsable].push(a);
          else actionsByResp[a.responsable] = [a];
        }
      }
      weeks.push({ mon, fri, label, phase, milestones, actionsByResp, entries, days });
    }
    cur.setDate(cur.getDate() + 7);
  }
  return weeks;
}

// ── Build horizontal roadmap grid ───────────────────────────────────────────
function buildRetroCalendar() {
  const weeks = buildWeeks();
  if (!weeks.length) return '';
  const today0  = new Date(); today0.setHours(0,0,0,0);
  const resps   = ['CLAIRE','CLAUDE CODE','FORMATEUR'];
  const respLbl = { 'CLAIRE':'Claire', 'CLAUDE CODE':'Claude Code', 'FORMATEUR':'Formateur' };
  const respDot = { 'CLAIRE':'#051E50', 'CLAUDE CODE':'#1E40AF', 'FORMATEUR':'#166534' };
  const nWeeks  = weeks.length;
  const colW    = `minmax(80px,1fr)`;

  let h = '';

  // Grid: columns = label + weeks
  h += `<div class="rm-grid-wrap"><div class="rm-grid" style="grid-template-columns:100px repeat(${nWeeks},${colW})">`;

  // ── Row 0: Header (corner + week labels) ──────────────────────────────
  h += `<div class="rm-corner">Semaine →</div>`;
  for (let w = 0; w < nWeeks; w++) {
    const wk = weeks[w];
    const isNow = today0 >= wk.mon && today0 <= wk.fri;
    const nowCls = isNow ? ' rm-wk-today' : '';
    const msHtml = wk.milestones.map(m => {
      const ms = getMilestoneStyle(m);
      return `<div class="rm-wk-hdr-ms" style="color:${ms.color}">${m}</div>`;
    }).join('');
    h += `<div class="rm-wk-hdr${nowCls}" onclick="openWeekDetail(${w})">
      <div class="rm-wk-hdr-date">${wk.label}</div>${msHtml}
    </div>`;
  }

  // ── Rows 1-3: Swimlanes ──────────────────────────────────────────────
  for (const resp of resps) {
    // Swimlane label
    h += `<div class="rm-swim-label"><span class="rm-swim-dot" style="background:${respDot[resp]}"></span>${respLbl[resp]}</div>`;

    for (let w = 0; w < nWeeks; w++) {
      const wk = weeks[w];
      const phaseCls = `rm-phase-${wk.phase + 1}`;
      const actions = (wk.actionsByResp[resp] || []).filter(a => isRetroVisible(a));
      const total   = actions.length;
      const done    = actions.filter(a => getRS(a.id) === 'done').length;

      h += `<div class="rm-cell ${phaseCls}" onclick="openWeekDetail(${w})">`;
      if (total > 0) {
        // Show condensed pills (max 3, then count)
        const show = actions.slice(0, 3);
        for (const a of show) {
          const status  = getRS(a.id);
          const bc      = PRIO_COLORS[a.priority] || '#94A3B8';
          const doneCls = status === 'done' ? ' done-card' : '';
          const hidCls  = !isRetroVisible(a) ? ' hidden' : '';
          h += `<div class="rm-pill${doneCls}${hidCls}" data-aid="${a.id}" style="border-left-color:${bc}" data-resp="${a.responsable}" data-prio="${a.priority}">
            <span class="rm-pill-text" title="${a.text.replace(/"/g,'&quot;')}">${a.text}</span>
            <span class="rm-pill-status" onclick="event.stopPropagation();clickRetroStatus('${a.id}')" title="${S_LABELS[status]}">${S_ICONS[status]}</span>
          </div>`;
        }
        if (total > 3) {
          h += `<div style="font-size:9px;color:#94A3B8;text-align:center;padding:1px 0">+${total - 3} de plus…</div>`;
        }
        // Count badge
        if (done > 0) {
          h += `<div style="text-align:right;margin-top:1px"><span class="rm-count" style="background:${done === total ? '#22C55E' : '#94A3B8'}">${done}/${total}</span></div>`;
        }
      }
      h += `</div>`;
    }
  }

  h += `</div></div>`; // close grid + wrap
  return h;
}

// ── Week detail panel (modal) ───────────────────────────────────────────────
let _weeksCache = null;
function openWeekDetail(wIdx) {
  if (!_weeksCache) _weeksCache = buildWeeks();
  const wk = _weeksCache[wIdx];
  if (!wk) return;
  const container = $('retro-detail-container');
  if (!container) return;

  let h = `<div class="rm-detail-overlay" onclick="if(event.target===this)closeWeekDetail()">`;
  h += `<div class="rm-detail-panel">`;
  h += `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
    <div>
      <div style="font-size:16px;font-weight:800;color:#051E50">Semaine du ${wk.label}</div>
      ${wk.milestones.length ? `<div style="font-size:11px;margin-top:4px">${wk.milestones.map(m => { const ms = getMilestoneStyle(m); return `<span style="display:inline-block;background:${ms.bg};color:${ms.color};border:1px solid ${ms.border};padding:2px 8px;border-radius:12px;font-weight:700;font-size:10px;margin-right:4px">${m}</span>`; }).join('')}</div>` : ''}
    </div>
    <div style="display:flex;gap:6px;align-items:center">
      ${wIdx > 0 ? `<button onclick="openWeekDetail(${wIdx-1})" style="padding:4px 10px;border-radius:6px;border:1px solid #E2E8F0;background:#fff;cursor:pointer;font-size:13px" title="Semaine précédente">◀</button>` : ''}
      ${wIdx < (_weeksCache.length-1) ? `<button onclick="openWeekDetail(${wIdx+1})" style="padding:4px 10px;border-radius:6px;border:1px solid #E2E8F0;background:#fff;cursor:pointer;font-size:13px" title="Semaine suivante">▶</button>` : ''}
      <button onclick="closeWeekDetail()" style="padding:4px 10px;border-radius:6px;border:1px solid #E2E8F0;background:#fff;cursor:pointer;font-size:13px;font-weight:700" title="Fermer">✕</button>
    </div>
  </div>`;

  // Group by day
  for (const day of wk.days) {
    const ds = day.toISOString().split('T')[0];
    const entry = wk.entries.find(e => e.date === ds);
    if (!entry) continue;

    const dn = day.toLocaleDateString('fr-FR', { weekday:'long', day:'2-digit', month:'long' });
    const today0 = new Date(); today0.setHours(0,0,0,0);
    const isToday = ds === today0.toISOString().split('T')[0];
    const todayBadge = isToday ? ' <span style="background:#FFD700;color:#92400E;padding:1px 8px;border-radius:10px;font-size:10px;font-weight:700;margin-left:6px">AUJOURD\'HUI</span>' : '';
    const msBadge = entry.milestone ? (() => { const ms = getMilestoneStyle(entry.milestone); return ` <span style="background:${ms.bg};color:${ms.color};border:1px solid ${ms.border};padding:1px 8px;border-radius:10px;font-size:10px;font-weight:700;margin-left:6px">${entry.milestone}</span>`; })() : '';

    h += `<div class="rm-detail-day">`;
    h += `<div class="rm-detail-day-hdr">${dn}${todayBadge}${msBadge}</div>`;

    for (const a of entry.actions) {
      if (!isRetroVisible(a)) continue;
      const status  = getRS(a.id);
      const bc      = PRIO_COLORS[a.priority] || '#94A3B8';
      const rs      = RESP_STYLES[a.responsable] || { bg:'#F1F5F9', color:'#334155' };
      const doneCls = status === 'done' ? ' done-card' : '';
      h += `<div class="rm-detail-card${doneCls}" id="rc-${a.id}" style="border-left-color:${bc}">`;
      h += `<div class="rm-detail-card-text" contenteditable="false" ondblclick="this.contentEditable='true';this.focus()" onblur="saveRetroEdit(this,'${a.id}')" data-aid="${a.id}">${a.text}</div>`;
      h += `<div class="rm-detail-bottom">`;
      h += `<span class="rm-detail-tag" style="background:${rs.bg};color:${rs.color}">${a.responsable}</span>`;
      h += `<button class="rm-detail-status-btn" id="rb-${a.id}" onclick="clickRetroStatus('${a.id}')" title="${S_LABELS[status]}">${S_ICONS[status]}</button>`;
      h += `</div></div>`;
    }
    h += `</div>`;
  }

  h += `</div></div>`;
  container.innerHTML = h;
}

function closeWeekDetail() {
  const c = $('retro-detail-container'); if (c) c.innerHTML = '';
  // Refresh roadmap to reflect status changes
  _weeksCache = null;
  $('retro-calendar').innerHTML = buildRetroCalendar();
}

// ── Inline edit ─────────────────────────────────────────────────────────────
function saveRetroEdit(el, actionId) {
  el.contentEditable = 'false';
  const newText = el.textContent.trim();
  if (!newText) return;
  // Update RETRO_DATA in memory
  for (const entry of RETRO_DATA) {
    const a = entry.actions.find(x => x.id === actionId);
    if (a && a.text !== newText) {
      a.text = newText;
      // Save edits to localStorage
      const edits = JSON.parse(localStorage.getItem('retro_edits') || '{}');
      edits[actionId] = newText;
      localStorage.setItem('retro_edits', JSON.stringify(edits));
      // Update pill text in roadmap
      document.querySelectorAll(`[data-aid="${actionId}"] .rm-pill-text`).forEach(p => { p.textContent = newText; p.title = newText; });
      break;
    }
  }
}

// Restore edits on load
function restoreRetroEdits() {
  const edits = JSON.parse(localStorage.getItem('retro_edits') || '{}');
  for (const [id, text] of Object.entries(edits)) {
    for (const entry of RETRO_DATA) {
      const a = entry.actions.find(x => x.id === id);
      if (a) { a.text = text; break; }
    }
  }
}

function isRetroVisible(a) {
  return (retroFilterResp === 'all' || a.responsable === retroFilterResp) &&
         (retroFilterPrio === 'all' || a.priority === retroFilterPrio);
}

function applyRetroFilters() {
  _weeksCache = null;
  $('retro-calendar').innerHTML = buildRetroCalendar();
}

function updateRetroProgress() {
  let total = 0, done = 0, redRem = 0, orangeRem = 0;
  let nextMilestone = null;
  const today0 = new Date(); today0.setHours(0,0,0,0);
  for (const entry of RETRO_DATA) {
    for (const a of entry.actions) {
      total++;
      if (getRS(a.id) === 'done') done++;
      else { if (a.priority === 'red') redRem++; if (a.priority === 'orange') orangeRem++; }
    }
    if (entry.milestone && !nextMilestone && new Date(entry.date) >= today0)
      nextMilestone = { label: entry.milestone, date: entry.date };
  }
  const pct  = total > 0 ? Math.round(done / total * 100) : 0;
  const nxt  = nextMilestone
    ? `Prochain jalon : <strong>${nextMilestone.label}</strong> (${new Date(nextMilestone.date).toLocaleDateString('fr-FR',{day:'2-digit',month:'short'})})`
    : 'Tous les jalons passés';
  const el = $('retro-prog-wrap'); if (!el) return;
  el.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:6px;margin-bottom:6px">
      <span style="font-weight:700;color:#051E50;font-size:13px">Progression : ${done} / ${total} actions (${pct}%)</span>
      <span style="font-size:11px;color:#64748B">${nxt}</span>
    </div>
    <div class="retro-prog-bar-bg"><div class="retro-prog-bar-fill" style="width:${pct}%"></div></div>
    <div class="retro-prog-stats">
      <span>🔴 Bloquants : <strong>${redRem}</strong></span>
      <span>🟠 Importants : <strong>${orangeRem}</strong></span>
      <span>✅ Terminés : <strong>${done}</strong></span>
    </div>`;
}

function renderRetroFilters() {
  const respOpts = ['all','CLAIRE','CLAUDE CODE','FORMATEUR'];
  const respLbls = { all:'Tous', 'CLAIRE':'Claire', 'CLAUDE CODE':'Claude Code', 'FORMATEUR':'Formateur' };
  const prioOpts = ['all','red','orange','blue','green'];
  const prioLbls = { all:'Toutes priorités', red:'🔴 Bloquant', orange:'🟠 Important', blue:'🔵 Préparation', green:'🟢 Validation' };

  let h = `<div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center;margin-bottom:6px">
    <span style="font-size:10px;font-weight:700;color:#94A3B8;text-transform:uppercase;letter-spacing:.5px;min-width:80px">Responsable</span>`;
  for (const r of respOpts) {
    const act = retroFilterResp === r;
    h += `<button class="retro-filter-btn" onclick="setRetroResp('${r}')" style="background:${act?'#051E50':'#F1F5F9'};color:${act?'#FFD700':'#374151'};border-color:${act?'#051E50':'#E2E8F0'}">${respLbls[r]}</button>`;
  }
  h += `</div><div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center">
    <span style="font-size:10px;font-weight:700;color:#94A3B8;text-transform:uppercase;letter-spacing:.5px;min-width:80px">Priorité</span>`;
  for (const p of prioOpts) {
    const act = retroFilterPrio === p;
    h += `<button class="retro-filter-btn" onclick="setRetroPrio('${p}')" style="background:${act?'#051E50':'#F1F5F9'};color:${act?'#FFD700':'#374151'};border-color:${act?'#051E50':'#E2E8F0'}">${prioLbls[p]}</button>`;
  }
  h += `</div>`;
  const el = $('retro-filters-wrap'); if (el) el.innerHTML = h;
}

function setRetroResp(val) { retroFilterResp = val; renderRetroFilters(); applyRetroFilters(); }
function setRetroPrio(val) { retroFilterPrio = val; renderRetroFilters(); applyRetroFilters(); }

function initRetro() {
  restoreRetroEdits();
  renderDemandes();
  _weeksCache = null;
  $('retro-calendar').innerHTML = buildRetroCalendar();
  renderRetroFilters();
  updateRetroProgress();
}

// Bootstrap
(async () => {
  try {
    const resp = await fetch('/api/data');
    if (!resp.ok) throw new Error(`Erreur API ${resp.status}`);
    const d = await resp.json();
    if (d.error) throw new Error(d.error);
    renderAll(d);
    $('loading').style.display = 'none';
    $('main').style.display    = 'block';
  } catch (err) {
    $('loading').innerHTML = `
      <div class="error-box">
        <strong>Erreur de chargement</strong><br><br>${err.message}<br><br>
        <button onclick="location.reload()" style="padding:7px 16px;border-radius:6px;border:none;background:#051E50;color:#FFD700;font-weight:700;cursor:pointer">
          Reessayer
        </button>
      </div>`;
  }
})();
</script>
</body>
</html>

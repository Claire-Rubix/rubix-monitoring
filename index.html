<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rubix Monitoring</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html{font-size:14px}
body{font-family:'Segoe UI',system-ui,sans-serif;background:#EEF2FF;color:#0F172A;min-height:100vh}

/* Header */
.header{background:#051E50;padding:14px 32px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;box-shadow:0 2px 12px rgba(5,30,80,.3)}
.logo{display:flex;align-items:center;gap:10px}
.logo-icon{width:32px;height:32px;background:#FFD700;border-radius:7px;display:flex;align-items:center;justify-content:center;font-weight:900;color:#051E50;font-size:16px}
.header h1{font-size:17px;font-weight:700;color:#fff}
.header-meta{color:#93C5FD;font-size:11px;text-align:right;line-height:1.6}

/* Nav — Rubix navy + gold */
.nav{background:#051E50;border-bottom:2px solid rgba(255,215,0,.25);position:sticky;top:56px;z-index:99;padding:0 32px;display:flex;overflow-x:auto}
.nav a{padding:11px 16px;font-size:12px;font-weight:600;color:#93C5FD;text-decoration:none;border-bottom:3px solid transparent;white-space:nowrap;transition:all .2s;cursor:pointer;margin-bottom:-2px}
.nav a:hover{color:#fff;border-bottom-color:#FFD700}
.nav a.active{color:#FFD700;border-bottom-color:#FFD700;background:rgba(255,215,0,.1)}

/* Pages */
.page{display:none}
.page.active{display:block}

/* Loading */
.loading{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:80px 20px;gap:14px}
.spinner{width:38px;height:38px;border:3px solid #DBEAFE;border-top-color:#051E50;border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{color:#64748B;font-size:14px}
.error-box{background:#FEE2E2;border:1px solid #FECACA;border-radius:8px;padding:16px 20px;color:#DC2626;font-size:13px;margin:20px auto;max-width:520px;text-align:center}

/* Container */
.container{max-width:1280px;margin:0 auto;padding:20px 24px}

/* Section titles */
.section-title{font-size:15px;font-weight:800;color:#051E50;margin:24px 0 10px;display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.st-bar{width:4px;height:20px;border-radius:3px;flex-shrink:0}

/* Collapsible sections */
.section{background:#fff;border:1px solid #DBEAFE;border-radius:12px;margin-bottom:14px;overflow:hidden;box-shadow:0 1px 6px rgba(5,30,80,.07)}
.section-head{padding:14px 20px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;user-select:none;transition:background .15s}
.section-head:hover{background:#EFF6FF}
.section-head h2{font-size:14px;font-weight:700;color:#051E50;display:flex;align-items:center;gap:8px;margin:0;flex-wrap:wrap}
.chevron{font-size:18px;color:#93C5FD;transition:transform .25s;flex-shrink:0}
.chevron.open{transform:rotate(180deg)}
.section-body{padding:0 20px 16px;display:none}
.section-body.open{display:block}

/* Badges — all neutral gray, only .bd-crit for critical */
.badge{font-size:9px;padding:2px 8px;border-radius:20px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;display:inline-block;background:#F1F5F9;color:#64748B}
.bd-crit{background:#FEE2E2;color:#DC2626}
/* keep legacy aliases pointing to neutral */
.bv,.bo,.bg,.bi,.bw{background:#F1F5F9;color:#64748B}
.bd{background:#FEE2E2;color:#DC2626}

/* Alert grid */
.alert-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:6px}
.alert-block{border-radius:10px;border:1px solid #E2E8F0;overflow:hidden;background:#fff}
.alert-block-head{padding:10px 16px;border-bottom:1px solid #F1F5F9;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.alert-block-head h3{font-size:13px;font-weight:700;color:#051E50;flex:1;white-space:nowrap}
.alert-block-body{padding:10px 14px 12px}
.alert-row{display:flex;align-items:flex-start;gap:8px;padding:6px 10px;border-radius:6px;margin-bottom:4px;font-size:11px;line-height:1.5;color:#334155}
.alert-row.ar-crit{background:#FEF2F2;color:#991B1B}
.alert-row.ar-warn{background:#FFFBEB;color:#92400E}
.alert-row.ar-info{background:#F8FAFC;color:#475569}
.alert-row.ar-ok{background:#F8FAFC;color:#475569}
.alert-row:last-of-type{margin-bottom:0}
.alert-icon{font-size:13px;flex-shrink:0;margin-top:1px}
.detail-link{display:block;text-align:right;font-size:11px;font-weight:600;color:#64748B;text-decoration:none;padding:8px 0 0;border-top:1px solid #F1F5F9;margin-top:8px;cursor:pointer}
.detail-link:hover{color:#051E50;text-decoration:underline}

/* Capacity cards */
.summary{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px}
.scard{background:#fff;border:1px solid #DBEAFE;border-radius:12px;padding:14px;position:relative;overflow:hidden;box-shadow:0 1px 6px rgba(5,30,80,.07)}
.stop{width:100%;height:4px;position:absolute;top:0;left:0}
.slabel{font-size:9px;text-transform:uppercase;letter-spacing:1.2px;color:#64748B;margin-bottom:2px;font-weight:600;margin-top:6px}
.sval{font-size:22px;font-weight:800;color:#051E50}
.sdetail{font-size:11px;color:#94A3B8;margin-top:1px}
.stop-gold{background:#FFD700}.stop-green{background:#00D26A}.stop-blue{background:#051E50}.stop-purple{background:#8B5CF6}

/* Limit bars */
.limits-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.limit-item{padding:12px;background:#F8FAFF;border-radius:8px;border:1px solid #DBEAFE}
.limit-label{font-size:12px;font-weight:600;color:#334155;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:4px}
.limit-bar{height:7px;background:#DBEAFE;border-radius:4px;overflow:hidden;margin-bottom:4px}
.limit-fill{height:100%;border-radius:4px;transition:width .5s ease}
.fill-ok{background:linear-gradient(90deg,#00D26A,#34D399)}
.fill-warn{background:linear-gradient(90deg,#FFD700,#FCD34D)}
.fill-danger{background:linear-gradient(90deg,#EF4444,#DC2626)}
.limit-detail{font-size:10px;color:#94A3B8}

/* Per-app breakdown */
.per-app-breakdown{margin-top:8px;border-top:1px dashed #DBEAFE;padding-top:6px}
.per-app-row{display:flex;align-items:center;gap:6px;padding:2px 0}
.per-app-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.per-app-name{width:110px;color:#334155;font-weight:600;flex-shrink:0;font-size:10px}
.per-app-bar-wrap{flex:1;height:5px;background:#DBEAFE;border-radius:3px;overflow:hidden}
.per-app-bar{height:100%;border-radius:3px;min-width:2px}
.per-app-val{font-size:10px;color:#64748B;white-space:nowrap;min-width:100px;text-align:right}

/* Projection badges */
.proj-badge{display:inline-block;font-size:9px;padding:2px 7px;border-radius:10px;font-weight:700}
.proj-ok{background:#ECFDF5;color:#059669}
.proj-warn{background:#FEFCE8;color:#92400E}
.proj-danger{background:#FEE2E2;color:#DC2626}

/* Tables */
table{width:100%;border-collapse:collapse}
th,td{text-align:left;padding:7px 12px;border-bottom:1px solid #EFF6FF;font-size:13px}
th{color:#1D4ED8;font-weight:600;font-size:10px;text-transform:uppercase;letter-spacing:.5px;background:#EFF6FF}

/* App meta */
.app-meta{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px}
.meta-card{padding:10px 14px;background:#F8FAFF;border-radius:8px;border:1px solid #DBEAFE}
.meta-label{font-size:10px;color:#94A3B8;text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px}
.meta-val{font-size:13px;font-weight:700;color:#051E50;display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.status-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;background:#94A3B8}

/* Mini metrics */
.mini-metrics{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:14px;padding-top:12px;border-top:1px solid #DBEAFE}
.mini-metric{text-align:center;padding:8px 4px;background:#EFF6FF;border-radius:8px}
.mini-val{font-size:16px;font-weight:800;color:#051E50}
.mini-label{font-size:9px;color:#64748B;text-transform:uppercase;letter-spacing:.5px;margin-top:2px}

/* Threshold blocks */
.thr-d{padding:10px;background:#FEE2E2;border-radius:8px;border:1px solid #FECACA;margin-top:10px}
.thr-w{padding:10px;background:#FEFCE8;border-radius:8px;border:1px solid #FFD700;margin-top:10px}
.thr-i{padding:10px;background:#EFF6FF;border-radius:8px;border:1px solid #BFDBFE;margin-top:10px}
.thr-d h4{font-size:12px;font-weight:700;color:#DC2626;margin-bottom:6px}
.thr-w h4{font-size:12px;font-weight:700;color:#92400E;margin-bottom:6px}
.thr-i h4{font-size:12px;font-weight:700;color:#1D4ED8;margin-bottom:6px}

/* Recommendations */
.reco{margin-top:10px;padding:10px;background:#EFF6FF;border-radius:8px;border:1px solid #BFDBFE}
.reco h4{font-size:11px;font-weight:700;color:#1D4ED8;margin-bottom:5px}
.reco p{font-size:11px;color:#334155;padding:2px 0}

/* Buttons */
.links{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
.btn{font-size:11px;padding:6px 12px;border-radius:6px;text-decoration:none;font-weight:600;display:inline-block;transition:all .2s}
.btn-g{background:#FEFCE8;color:#92400E;border:1px solid #FFD700}
.btn-g:hover{background:#FFD700;color:#051E50}
.btn-o{background:#ECFDF5;color:#059669;border:1px solid #A7F3D0}
.btn-o:hover{background:#059669;color:#fff}
.btn-v{background:#EFF6FF;color:#051E50;border:1px solid #BFDBFE}
.btn-v:hover{background:#051E50;color:#fff}

/* Footer */
.footer{text-align:center;padding:16px;color:#94A3B8;font-size:11px;margin-top:8px}

@media(max-width:900px){
  .alert-grid{grid-template-columns:1fr}
  .limits-grid{grid-template-columns:1fr}
  .summary{grid-template-columns:repeat(2,1fr)}
  .app-meta{grid-template-columns:1fr}
  .mini-metrics{grid-template-columns:repeat(2,1fr)}
  .nav{padding:0 12px}
  .header{padding:12px 16px}
  .container{padding:16px 12px}
}

/* ====================== RÉTROPLANNING ROADMAP ====================== */
.retro-prog-wrap{background:#F8FAFC;border:1px solid #DBEAFE;border-radius:10px;padding:14px 18px;margin-bottom:14px}
.retro-prog-bar-bg{background:#E2E8F0;border-radius:4px;height:8px;margin:8px 0}
.retro-prog-bar-fill{background:linear-gradient(90deg,#051E50,#3B82F6);border-radius:4px;height:8px;transition:width .5s}
.retro-prog-stats{display:flex;gap:16px;flex-wrap:wrap;font-size:11px;color:#64748B}
.retro-filter-btn{font-size:11px;font-weight:600;padding:4px 12px;border-radius:20px;border:1px solid #E2E8F0;cursor:pointer;transition:all .15s;white-space:nowrap}
.retro-filter-btn:hover{border-color:#051E50}
/* Roadmap grid */
.rm-milestones{display:flex;gap:0;overflow-x:auto;margin-bottom:6px;padding-bottom:2px;position:relative}
.rm-ms{font-size:9px;font-weight:700;padding:3px 6px;border-radius:4px;text-align:center;white-space:nowrap;border:1px solid;flex:1;min-width:0}
.rm-grid-wrap{overflow-x:auto;padding-bottom:8px}
.rm-grid{display:grid;gap:0;min-width:600px}
.rm-corner{background:#F8FAFC;border:1px solid #E2E8F0;padding:6px;font-size:10px;font-weight:700;color:#6B7280;text-transform:uppercase;position:sticky;left:0;z-index:2}
.rm-wk-hdr{background:#F8FAFC;border:1px solid #E2E8F0;padding:4px 2px;text-align:center;cursor:pointer;user-select:none;transition:background .15s}
.rm-wk-hdr:hover{background:#EFF6FF}
.rm-wk-hdr.rm-wk-today{background:#FFFBEB;border-color:#FFD700}
.rm-wk-hdr-date{font-size:10px;font-weight:700;color:#051E50}
.rm-wk-hdr-ms{font-size:8px;margin-top:1px;line-height:1.2;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.rm-swim-label{background:#F8FAFC;border:1px solid #E2E8F0;padding:6px 8px;font-size:11px;font-weight:700;writing-mode:horizontal-tb;display:flex;align-items:center;gap:4px;position:sticky;left:0;z-index:2}
.rm-swim-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.rm-cell{border:1px solid #E2E8F0;padding:3px;min-height:32px;vertical-align:top;position:relative}
.rm-cell.rm-phase-1{background:#fff}
.rm-cell.rm-phase-2{background:#F9FAFB}
.rm-cell.rm-phase-3{background:#F3F4F6}
.rm-pill{font-size:9px;line-height:1.3;padding:2px 4px;border-radius:4px;border-left:3px solid;margin-bottom:2px;cursor:pointer;display:flex;align-items:center;gap:3px;background:#fff;transition:all .15s}
.rm-pill:hover{filter:brightness(.95);box-shadow:0 1px 3px rgba(0,0,0,.08)}
.rm-pill.done-card{opacity:.5;text-decoration:line-through}
.rm-pill-text{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:#334155}
.rm-pill-text[contenteditable="true"]{white-space:normal;outline:1px solid #3B82F6;border-radius:2px;padding:1px 2px;background:#fff}
.rm-pill-status{flex-shrink:0;cursor:pointer;font-size:12px;line-height:1}
.rm-pill.hidden{display:none}
.rm-count{font-size:9px;font-weight:700;color:#fff;padding:1px 5px;border-radius:8px;display:inline-block;margin-right:2px}
/* Detail panel (expanded week) */
.rm-detail-overlay{position:fixed;inset:0;background:rgba(0,0,0,.3);z-index:100;display:flex;align-items:center;justify-content:center}
.rm-detail-panel{background:#fff;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.18);max-width:800px;width:95%;max-height:85vh;overflow-y:auto;padding:20px}
.rm-detail-day{margin-bottom:16px}
.rm-detail-day-hdr{font-size:13px;font-weight:800;color:#051E50;margin-bottom:8px;padding-bottom:4px;border-bottom:1px solid #E2E8F0}
.rm-detail-card{background:#fff;border-radius:7px;border:1px solid #E5E7EB;border-left:4px solid;padding:8px 10px 6px;margin-bottom:5px}
.rm-detail-card.done-card{opacity:.55}
.rm-detail-card-text{font-size:12px;color:#374151;line-height:1.4;margin-bottom:5px}
.rm-detail-card-text[contenteditable="true"]{outline:1px solid #3B82F6;border-radius:2px;padding:2px 4px;background:#FEFCE8}
.rm-detail-bottom{display:flex;align-items:center;justify-content:space-between;gap:4px}
.rm-detail-tag{font-size:9px;font-weight:700;padding:2px 7px;border-radius:10px;white-space:nowrap}
.rm-detail-status-btn{width:24px;height:24px;border:none;background:none;cursor:pointer;font-size:16px;line-height:1;padding:0;flex-shrink:0}
@media(max-width:768px){
  .rm-grid{min-width:unset!important}
  .rm-swim-label{writing-mode:horizontal-tb;position:relative;left:auto;z-index:auto}
  .rm-corner{position:relative;left:auto;z-index:auto}
}
/* Sub-tabs (Rubix Pitch) */
.sub-tabs-nav{display:flex;gap:0;flex-wrap:wrap;margin-bottom:16px;border-bottom:2px solid #E2E8F0}
.sub-tab-btn{padding:8px 16px;border:1px solid transparent;border-bottom:none;border-radius:6px 6px 0 0;font-size:13px;font-weight:600;cursor:pointer;background:none;color:#64748B;transition:all .15s;margin-bottom:-2px;white-space:nowrap}
.sub-tab-btn.active{background:#fff;color:#051E50;border-color:#E2E8F0;border-bottom-color:#fff}
.sub-tab-btn:hover:not(.active){background:#F8FAFC;color:#334155}
.sub-page{display:none}.sub-page.active{display:block}
#page-pitch .sub-page{font-size:14px;color:#1E293B}
#page-pitch .sub-page div,#page-pitch .sub-page span,#page-pitch .sub-page td,#page-pitch .sub-page li{min-height:auto}
.pitch-gs{padding:10px 14px;border-radius:8px;font-size:13px;font-weight:700;text-align:center;margin-bottom:10px}
.pitch-gs-ok{background:#ECFDF5;color:#166534}.pitch-gs-warn{background:#FEFCE8;color:#92400E}.pitch-gs-danger{background:#FEF2F2;color:#DC2626}
.pitch-sc-grid{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px}
.pitch-sc-card{display:flex;align-items:center;gap:6px;padding:8px 12px;border-radius:8px;font-size:12px;font-weight:600;flex:1;min-width:120px;border:1px solid transparent}
.pitch-sc-ok{background:#ECFDF5;color:#166534;border-color:#86EFAC}.pitch-sc-warn{background:#FEFCE8;color:#92400E;border-color:#FCD34D}.pitch-sc-danger{background:#FEF2F2;color:#DC2626;border-color:#FECACA}
.pitch-timeline{border-left:3px solid #E2E8F0;margin-left:14px;padding-left:22px;margin-bottom:20px}
.pitch-tl-item{position:relative;padding-bottom:18px}
.pitch-tl-dot{width:13px;height:13px;border-radius:50%;background:#E2E8F0;border:2px solid #94A3B8;position:absolute;left:-29px;top:3px}
.pitch-tl-item.tl-done .pitch-tl-dot{background:#22C55E;border-color:#16A34A}
.pitch-tl-item.tl-today .pitch-tl-dot{background:#FFD700;border-color:#D97706}
.pitch-tl-date{font-weight:700;color:#051E50;font-size:13px}
.pitch-tl-desc{font-size:12px;color:#334155;margin-top:2px}
.pitch-tl-users{font-size:11px;color:#94A3B8;margin-top:2px}
.pitch-tl-when{font-size:11px;font-weight:600;margin-top:4px}
.pitch-tl-item.tl-done .pitch-tl-when{color:#059669}
.pitch-tl-item.tl-today .pitch-tl-when{color:#D97706}
.pitch-cost-kpis{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px}
.pitch-cost-kpi{flex:1;min-width:130px;padding:12px;background:#F8FAFC;border-radius:8px;border:1px solid #E2E8F0;text-align:center}
.pitch-cost-val{font-size:20px;font-weight:800;color:#051E50}
.pitch-cost-lbl{font-size:10px;color:#64748B;margin-top:4px}
.cl-item{display:flex;align-items:flex-start;gap:10px;padding:8px 10px;border-radius:7px;border:1px solid #E2E8F0;margin-bottom:5px;cursor:pointer;font-size:12px;color:#334155;user-select:none}
.cl-item:hover{background:#F8FAFC}
.cl-item.cl-checked{background:#ECFDF5;border-color:#86EFAC;color:#166534;text-decoration:line-through;opacity:.75}
.cl-cat-title{font-size:10px;font-weight:700;color:#94A3B8;text-transform:uppercase;letter-spacing:.8px;margin:12px 0 5px}
.cl-footer{display:flex;justify-content:space-between;align-items:center;padding-top:10px;border-top:1px solid #E2E8F0;margin-top:8px;font-size:12px}
.cl-reset-btn{padding:4px 10px;border-radius:6px;border:1px solid #E2E8F0;background:#fff;cursor:pointer;font-size:11px;color:#64748B}
.cl-reset-btn:hover{background:#FEE2E2;border-color:#FECACA;color:#DC2626}
.pitch-prog-bar{height:8px;background:#E2E8F0;border-radius:4px;overflow:hidden;margin-top:6px}
.pitch-prog-fill{height:100%;border-radius:4px;background:linear-gradient(90deg,#DC2626,#F59E0B);transition:width .3s}
/* Inline edit system */
.edit-val{outline:none;transition:background .15s;cursor:text;border-radius:3px}
.edit-val:hover{background:#F1F5F9}
.edit-val[contenteditable="true"]{background:#FEFCE8;padding:0 3px;outline:1px solid #FCD34D;cursor:text}
.edit-val.edited{color:#7C3AED}
/* Demandes en attente */
.demandes-wrap{margin-bottom:20px}
.dem-header{display:flex;align-items:center;gap:10px;margin-bottom:8px;flex-wrap:wrap}
.dem-header-title{font-size:13px;font-weight:800;color:#7C3AED}
.dem-header-count{font-size:11px;color:#6B7280;font-weight:500}
.dem-prog{display:flex;align-items:center;gap:6px;margin-left:auto}
.dem-prog-bar{width:80px;height:6px;background:#EDE9FE;border-radius:3px;overflow:hidden}
.dem-prog-fill{height:100%;background:#7C3AED;border-radius:3px;transition:width .3s}
.dem-prog-lbl{font-size:10px;color:#6B7280;font-weight:600}
.dem-list{display:flex;flex-direction:column;gap:0}
.dem-row{background:#fff;border:1px solid #EDE9FE;border-left:3px solid #7C3AED;padding:0;transition:all .15s}
.dem-row:first-child{border-radius:8px 8px 0 0}
.dem-row:last-child{border-radius:0 0 8px 8px}
.dem-row:only-child{border-radius:8px}
.dem-row+.dem-row{border-top:none}
.dem-row.dem-done{opacity:.5;border-left-color:#A78BFA}
.dem-row-main{display:flex;align-items:center;gap:8px;padding:8px 12px;cursor:pointer;user-select:none}
.dem-row-main:hover{background:#FAFAFE}
.dem-chevron{font-size:10px;color:#A78BFA;transition:transform .2s;flex-shrink:0;width:14px;text-align:center}
.dem-row.dem-open .dem-chevron{transform:rotate(90deg)}
.dem-row-titre{font-size:12px;font-weight:600;color:#051E50;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.dem-badge{font-size:9px;font-weight:700;padding:2px 7px;border-radius:10px;white-space:nowrap;text-transform:uppercase;letter-spacing:.3px}
.dem-badge-it{background:#DBEAFE;color:#1E40AF}
.dem-badge-manager{background:#FEF3C7;color:#92400E}
.dem-badge-orga{background:#D1FAE5;color:#065F46}
.dem-badge-claire{background:#F3E8FF;color:#6B21A8}
.dem-deadline{font-size:10px;color:#6B7280;white-space:nowrap;font-weight:500}
.dem-status-btn{background:none;border:none;font-size:16px;cursor:pointer;padding:0;line-height:1;flex-shrink:0}
.dem-expand{max-height:0;overflow:hidden;transition:max-height .25s ease}
.dem-row.dem-open .dem-expand{max-height:200px}
.dem-expand-inner{padding:4px 12px 10px 34px;font-size:11px;color:#6B7280;line-height:1.5}
.dem-expand-inner .dem-detail{color:#334155;background:#F5F3FF;border-radius:4px;padding:4px 8px;margin-bottom:4px}
.dem-expand-inner .dem-why{font-style:italic}
/* Vercel costs */
.vercel-prog-wrap{margin:12px 0}
.vercel-prog-bar{height:12px;background:#E2E8F0;border-radius:6px;overflow:visible;position:relative;margin-top:4px}
.vercel-prog-fill{height:100%;border-radius:6px;transition:width .3s}
.vercel-proj-bar{height:12px;background:#E2E8F0;border-radius:6px;overflow:hidden;margin-top:6px;position:relative}
.vercel-proj-covered{height:100%;display:inline-block;border-radius:6px 0 0 6px}
.vercel-proj-surplus{height:100%;display:inline-block;border-radius:0 6px 6px 0}
/* Old vertical layout removed — now using rm-* roadmap classes */
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div class="logo">
    <div class="logo-icon">R</div>
    <h1>Rubix Monitoring</h1>
  </div>
  <div class="header-meta">
    <div id="period-label">Chargement...</div>
    <div id="generated-at"></div>
  </div>
</div>

<!-- NAV -->
<nav class="nav" id="nav">
  <a class="active" onclick="showTab('alertes')">Alertes</a>
  <a onclick="showTab('pole')">Pôle Acquisition</a>
  <a onclick="showTab('pitch')">Rubix Pitch</a>
  <a onclick="showTab('smart')">Smart Content</a>
  <a onclick="showTab('vercel')">Capacité Vercel</a>
  <a onclick="showTab('couts')">Coûts</a>
</nav>

<!-- LOADING -->
<div id="loading" class="loading">
  <div class="spinner"></div>
  <div class="loading-text">Chargement des donnees...</div>
</div>

<!-- MAIN -->
<div id="main" style="display:none">

  <!-- ONGLET ALERTES -->
  <div class="page active" id="page-alertes">
  <div class="container">
    <div class="section-title">
      <div class="st-bar" style="background:#051E50"></div>
      Alertes et blockers
      <span class="badge bd-crit" id="count-danger">0 CRITIQUE</span>
      <span class="badge" id="count-warn">0 ATTENTION</span>
    </div>

    <div class="alert-grid">

      <div class="alert-block">
        <div class="alert-block-head">
          <h3>Pole Acquisition</h3>
          <span class="badge">GEMINI FREE TIER</span>
          <span class="badge bd-crit">BLOCKER</span>
        </div>
        <div class="alert-block-body">
          <div class="alert-row ar-crit">
            <span class="alert-icon">&#9888;</span>
            <span>FREE TIER bloque a 5+ users simultanees (15 appels/min). Migrer vers GCP billing pour scaler.</span>
          </div>
          <div class="alert-row ar-info">
            <span class="alert-icon">&#9432;</span>
            <span>Quota jour : 1 500 appels/jour = max 150 users/jour (limite fixee a 10 appels/user/jour)</span>
          </div>
          <a class="detail-link" onclick="showTab('pole')">Voir details &rarr;</a>
        </div>
      </div>

      <div class="alert-block">
        <div class="alert-block-head">
          <h3>Rubix Pitch</h3>
          <span class="badge">OPENAI TIER 1</span>
        </div>
        <div class="alert-block-body">
          <div class="alert-row ar-warn">
            <span class="alert-icon">&#9888;</span>
            <span>6+ appels OpenAI par pitch (5 priorisations + 1 generation) paralleliser avec Promise.all</span>
          </div>
          <div class="alert-row ar-warn">
            <span class="alert-icon">&#9888;</span>
            <span>Polling Assistant API ~55s frole le timeout 60s Vercel. Risque d'echec sur pitchs complexes.</span>
          </div>
          <a class="detail-link" onclick="showTab('pitch')">Voir details &rarr;</a>
        </div>
      </div>

      <div class="alert-block">
        <div class="alert-block-head">
          <h3>Smart Content</h3>
          <span class="badge">GEMINI GCP</span>
        </div>
        <div class="alert-block-body">
          <div class="alert-row ar-warn">
            <span class="alert-icon">&#9888;</span>
            <span>Credits promo GCP : ~50 contenus couverts. Surveiller la console GCP avant epuisement.</span>
          </div>
          <div class="alert-row ar-ok">
            <span class="alert-icon">&#10003;</span>
            <span>Streaming + retry/backoff 429 deja en place, pas de risque de timeout Vercel</span>
          </div>
          <a class="detail-link" onclick="showTab('smart')">Voir details &rarr;</a>
        </div>
      </div>

      <div class="alert-block">
        <div class="alert-block-head">
          <h3>Global Vercel &amp; Claude</h3>
          <span class="badge">PARTAGE</span>
        </div>
        <div class="alert-block-body">
          <div id="global-dyn-alerts"></div>
          <div class="alert-row ar-info">
            <span class="alert-icon">&#9432;</span>
            <span>Concurrent Builds : 1 seul build a la fois, les 3 apps partagent la queue</span>
          </div>
          <div class="alert-row ar-warn">
            <span class="alert-icon">&#9432;</span>
            <span>Claude Code Max 5x : fenetre glissante 5h + plafond hebdo non documente, pas d'API quota</span>
          </div>
          <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
            <a href="https://claude.ai/settings/usage" target="_blank" class="btn btn-g">Verifier quota Claude</a>
            <a href="https://claude.ai" target="_blank" class="btn btn-v">Claude en ligne (secours)</a>
          </div>
        </div>
      </div>

      <div class="alert-block" style="grid-column:1/-1">
        <div class="alert-block-head">
          <h3>Bug lie a l'environnement Rubix</h3>
          <span class="badge bd-crit">PROXY</span>
          <span class="badge bd-crit">RESEAU</span>
        </div>
        <div class="alert-block-body">
          <div class="alert-row ar-crit">
            <span class="alert-icon">&#9888;</span>
            <span><strong>Claude Code bloque sur reseau Rubix</strong> : proxy / pare-feu bloque les connexions API (ConnectionRefused, timeout). Contournement : utiliser Claude dans le navigateur au bureau.</span>
          </div>
          <div class="alert-row ar-crit">
            <span class="alert-icon">&#9888;</span>
            <span><strong>ERR_CERT_COMMON_NAME_INVALID</strong> : le proxy SSL d'entreprise (Zscaler) intercepte et re-scelle les connexions HTTPS.</span>
          </div>
          <div class="alert-row ar-crit">
            <span class="alert-icon">&#9888;</span>
            <span><strong>ERR_NETWORK_CHANGED</strong> : bascule VPN / WiFi / mise en veille coupe la connexion en cours de generation.</span>
          </div>
          <div class="alert-row ar-info">
            <span class="alert-icon">&#10140;</span>
            <span>Solution : deplacer la generation cote serveur Vercel (serveur a serveur, sans proxy).</span>
          </div>
          <a class="detail-link" onclick="showTab('smart')">Voir le plan d'action &rarr;</a>
        </div>
      </div>

    </div>
  </div>
  </div>

  <!-- ONGLET POLE ACQUISITION -->
  <div class="page" id="page-pole">
  <div class="container">
    <div class="section-title">
      <div class="st-bar" style="background:#FFD700"></div>
      Pôle Acquisition
      <span class="badge bg">GEMINI FREE TIER</span>
      <span class="badge bd">BLOCKER #1</span>
    </div>

    <div class="section">
      <div class="section-head" onclick="toggle(this)">
        <h2>
          <span class="status-dot" id="pole-dot"></span>
          rubix-pole-acquisition.vercel.app
        </h2>
        <span class="chevron open">&#9662;</span>
      </div>
      <div class="section-body open">
        <div class="app-meta">
          <div class="meta-card">
            <div class="meta-label">Dernier déploiement</div>
            <div class="meta-val" id="pole-last-deploy"></div>
          </div>
          <div class="meta-card">
            <div class="meta-label">Fournisseur IA</div>
            <div class="meta-val"><span class="badge bg">Gemini 2.0 Flash</span>&nbsp;Google AI Studio</div>
          </div>
        </div>

        <table>
          <thead><tr><th>Action utilisateur</th><th>Appels IA</th><th>Tokens estimes</th><th>Grounding</th></tr></thead>
          <tbody>
            <tr><td style="font-weight:600">Recherche infos entreprise</td><td>1 appel Gemini</td><td>1 500 a 4 000</td><td style="color:#D97706;font-weight:600">+ Google Search</td></tr>
            <tr><td style="font-weight:600">Matcher produits / services</td><td>1 appel Gemini</td><td>1 500 a 4 000</td><td style="color:#D97706;font-weight:600">+ Google Search</td></tr>
            <tr><td style="font-weight:600">Trouver fournisseurs</td><td>1 appel Gemini</td><td>1 500 a 4 000</td><td style="color:#D97706;font-weight:600">+ Google Search</td></tr>
            <tr><td style="font-weight:600">Rédiger email</td><td>1 appel Gemini</td><td>1 000 a 2 000</td><td>Non</td></tr>
            <tr><td style="font-weight:600">Orchestrateur (analyse)</td><td>1 appel Gemini</td><td>500 a 1 000</td><td>Non</td></tr>
          </tbody>
        </table>

        <div class="thr-d">
          <h4>Seuils de blocage Free tier AI Studio : 15 appels/min / 1 500 appels/jour</h4>
          <table>
            <thead><tr><th>Users simultanées</th><th>Appels IA/min</th><th>vs Limite 15 appels/min</th><th>Statut</th></tr></thead>
            <tbody>
              <tr><td>1 a 3 users</td><td>3 a 9 appels/min</td><td style="color:#059669">OK (60%)</td><td><span class="proj-badge proj-ok">OK</span></td></tr>
              <tr><td>5 users</td><td>10 a 15 appels/min</td><td style="color:#D97706">Limite (100%)</td><td><span class="proj-badge proj-warn">RISQUE</span></td></tr>
              <tr><td>10+ users</td><td>20 a 30+ appels/min</td><td style="color:#DC2626;font-weight:700">DÉPASSÉ (200%+)</td><td><span class="proj-badge proj-danger">BLOQUÉ</span></td></tr>
            </tbody>
          </table>
          <div style="font-size:11px;color:#DC2626;margin-top:6px">
            <strong>Quota jour :</strong> 1 500 appels/jour. Limite fixée à <strong>10 appels/user/jour</strong> = max 150 users/jour.
          </div>
        </div>

        <div style="margin-top:10px;padding:10px;background:#ECFDF5;border-radius:7px;border:1px solid #A7F3D0">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
            <span style="font-size:12px;font-weight:700;color:#059669">Sécurité timeout Vercel</span>
            <span class="proj-badge proj-ok">HAUTE</span>
          </div>
          <div style="font-size:11px;color:#334155">Chaque appel Gemini repond en 2 a 8s. Largement sous le timeout de 60s.<br>Marge de sécurité : 90%+ — aucune modification nécessaire.</div>
        </div>

        <div class="reco">
          <h4>Recommandations pour scaler</h4>
          <p>1. <strong>Batcher les appels grounding</strong> : combiner infos entreprise + matcher + fournisseur en 1 seul appel multi-tool (divise par 3)</p>
          <p>2. <strong>Cacher les resultats</strong> : même entreprise = meme recherche, cacher 24h (Redis / KV Vercel)</p>
          <p>3. <strong>Migrer vers GCP billing</strong> à partir de 5 users : 1 500 appels/min au lieu de 15 (x100)</p>
          <p>4. <strong>Queue + rate limiter côté serveur</strong> : limiter à 10 appels/min et mettre les requêtes en file d'attente</p>
        </div>

        <div class="mini-metrics">
          <div class="mini-metric"><div class="mini-val" id="pole-build"></div><div class="mini-label">Build min</div></div>
          <div class="mini-metric"><div class="mini-val" id="pole-bw"></div><div class="mini-label">Bandwidth</div></div>
          <div class="mini-metric"><div class="mini-val" id="pole-fninv"></div><div class="mini-label">Fn Invocations</div></div>
          <div class="mini-metric"><div class="mini-val" id="pole-fndur"></div><div class="mini-label">Fn Duration</div></div>
        </div>

        <div class="links">
          <a href="https://aistudio.google.com/app/apikey" target="_blank" class="btn btn-g">AI Studio usage</a>
          <a href="https://console.cloud.google.com/apis/dashboard?project=app-acquisition-487813" target="_blank" class="btn btn-g">GCP Console</a>
        </div>
      </div>
    </div>
  </div>
  </div>

  <!-- ONGLET PITCH GENERATOR -->
  <div class="page" id="page-pitch">
  <div class="container">
    <div class="section-title">
      <div class="st-bar" style="background:#051E50"></div>
      Rubix Pitch
    </div>

    <!-- Sous-onglets Rubix Pitch -->
    <div class="sub-tabs-nav">
      <button class="sub-tab-btn active" onclick="showPitchTab('synthese',this)">Synthèse</button>
      <button class="sub-tab-btn" onclick="showPitchTab('ameliorations',this)">Améliorations techniques</button>
      <button class="sub-tab-btn" onclick="showPitchTab('pilote',this)">Pilote</button>
      <button class="sub-tab-btn" onclick="showPitchTab('programme',this)">Programme</button>
      <button class="sub-tab-btn" onclick="showPitchTab('couts',this)">Coûts</button>
      <button class="sub-tab-btn" onclick="showPitchTab('avalider',this)">À valider</button>
    </div>

    <!-- ===== RÉUNION : ce qu'ils voient ===== -->

    <!-- Synthèse -->
    <div class="sub-page active" id="pitch-sub-synthese">
      <div id="pitch-synthese-hero"></div>
      <!-- preserve hidden IDs for renderAll -->
      <div style="display:none"><span id="pitch-dot"></span><span id="pitch-last-deploy"></span><span id="pitch-build"></span><span id="pitch-bw"></span><span id="pitch-fninv"></span><span id="pitch-fndur"></span><span id="pitch-cost-per-pitch"></span></div>
    </div>

    <!-- À valider -->
    <div class="sub-page" id="pitch-sub-avalider">
      <div id="pitch-avalider-widget"></div>
    </div>


    <!-- ===== MON PROGRAMME : ce que je garde pour bosser ===== -->

    <!-- Programme (ex-Rétroplanning) -->
    <div class="sub-page" id="pitch-sub-programme">
      <div id="programme-synth"></div>
      <div style="margin-top:20px;text-align:center">
        <button onclick="const w=document.getElementById('retro-detail-full');w.style.display=w.style.display==='none'?'block':'none'" style="background:none;border:none;color:#64748B;font-size:13px;cursor:pointer;padding:6px 12px;border-radius:6px;transition:all .15s" onmouseover="this.style.color='#051E50';this.style.background='#F1F5F9'" onmouseout="this.style.color='#64748B';this.style.background='none'">Voir le planning détaillé ▾</button>
      </div>
      <div id="retro-detail-full" style="display:none;margin-top:16px">
        <div id="retro-prog-wrap" class="retro-prog-wrap"></div>
        <div id="retro-filters-wrap" style="margin-bottom:14px"></div>
        <div id="retro-calendar"></div>
        <div id="retro-detail-container"></div>
      </div>
    </div>

    <!-- Coûts -->
    <div class="sub-page" id="pitch-sub-couts">
      <div id="pitch-couts-widget"></div>
    </div>

    <!-- Améliorations -->
    <div class="sub-page" id="pitch-sub-ameliorations">
      <div id="pitch-ameliorations-widget"></div>
    </div>

    <!-- Pilote -->
    <div class="sub-page" id="pitch-sub-pilote">
      <div id="pitch-pilote-widget"></div>
      <details style="margin-top:16px">
        <summary style="font-size:13px;font-weight:700;color:#051E50;cursor:pointer">Checklist pré-formation <span id="pitch-cl-prog" style="color:#64748B;font-weight:600;font-size:11px"></span></summary>
        <div style="margin-top:10px">
          <div class="cl-cat-title">Technique</div>
          <label class="cl-item" id="pitch-cl-c1" onclick="togglePitchCheck('c1')"><input type="checkbox" id="pitch-chk-c1" style="pointer-events:none;flex-shrink:0"><span>Tester la génération d'un pitch complet de bout en bout</span></label>
          <label class="cl-item" id="pitch-cl-c2" onclick="togglePitchCheck('c2')"><input type="checkbox" id="pitch-chk-c2" style="pointer-events:none;flex-shrink:0"><span>Vérifier que l'application est bien en ligne</span></label>
          <label class="cl-item" id="pitch-cl-c3" onclick="togglePitchCheck('c3')"><input type="checkbox" id="pitch-chk-c3" style="pointer-events:none;flex-shrink:0"><span>Confirmer que le compte IA a assez de crédits</span></label>
          <label class="cl-item" id="pitch-cl-c4" onclick="togglePitchCheck('c4')"><input type="checkbox" id="pitch-chk-c4" style="pointer-events:none;flex-shrink:0"><span>Tester sur mobile et sur desktop</span></label>
          <div class="cl-cat-title">Sécurité</div>
          <label class="cl-item" id="pitch-cl-c5" onclick="togglePitchCheck('c5')"><input type="checkbox" id="pitch-chk-c5" style="pointer-events:none;flex-shrink:0"><span>Confirmer que le mot de passe de connexion fonctionne</span></label>
          <label class="cl-item" id="pitch-cl-c6" onclick="togglePitchCheck('c6')"><input type="checkbox" id="pitch-chk-c6" style="pointer-events:none;flex-shrink:0"><span>Vérifier qu'aucune information sensible n'est visible</span></label>
          <div class="cl-cat-title">Formation</div>
          <label class="cl-item" id="pitch-cl-c7" onclick="togglePitchCheck('c7')"><input type="checkbox" id="pitch-chk-c7" style="pointer-events:none;flex-shrink:0"><span>Préparer 2-3 cas d'usage réels pour la démo</span></label>
          <label class="cl-item" id="pitch-cl-c8" onclick="togglePitchCheck('c8')"><input type="checkbox" id="pitch-chk-c8" style="pointer-events:none;flex-shrink:0"><span>Envoyer le lien + mot de passe aux commerciaux J-1</span></label>
          <label class="cl-item" id="pitch-cl-c9" onclick="togglePitchCheck('c9')"><input type="checkbox" id="pitch-chk-c9" style="pointer-events:none;flex-shrink:0"><span>Prévenir l'équipe du quota : 10 pitchs max/jour/user</span></label>
          <label class="cl-item" id="pitch-cl-c10" onclick="togglePitchCheck('c10')"><input type="checkbox" id="pitch-chk-c10" style="pointer-events:none;flex-shrink:0"><span>Préparer un message de secours si le service IA est indisponible</span></label>
          <div class="cl-footer">
            <button class="cl-reset-btn" onclick="resetPitchChecklist()">Réinitialiser</button>
          </div>
        </div>
      </details>
      <!-- IDs cachés pour renderAll -->
      <div style="display:none"><div id="pitch-status-widget"></div><div id="pitch-formations-widget"></div></div>
      <details style="margin-top:12px">
        <summary style="font-size:11px;color:#64748B;cursor:pointer">Liens techniques</summary>
        <div class="links" style="margin-top:8px">
          <a href="https://platform.openai.com/usage" target="_blank" class="btn btn-o">OpenAI Usage</a>
          <a href="https://platform.openai.com/settings/organization/limits" target="_blank" class="btn btn-o">Rate Limits</a>
          <a href="https://vercel.com/dashboard" target="_blank" class="btn btn-o">Vercel Dashboard</a>
        </div>
      </details>
    </div><!-- /pilote -->

  </div>
  </div>

  <!-- ONGLET SMART CONTENT -->
  <div class="page" id="page-smart">
  <div class="container">
    <div class="section-title">
      <div class="st-bar" style="background:#00D26A"></div>
      Smart Content
      <span class="badge bg">GEMINI GCP</span>
    </div>

    <div class="section">
      <div class="section-head" onclick="toggle(this)">
        <h2>
          <span class="status-dot" id="smart-dot"></span>
          rubix-smart-content.vercel.app
        </h2>
        <span class="chevron open">&#9662;</span>
      </div>
      <div class="section-body open">
        <div class="app-meta">
          <div class="meta-card">
            <div class="meta-label">Dernier déploiement</div>
            <div class="meta-val" id="smart-last-deploy"></div>
          </div>
          <div class="meta-card">
            <div class="meta-label">Fournisseur IA</div>
            <div class="meta-val"><span class="badge bg">Gemini Flash</span>&nbsp;Google Cloud Platform</div>
          </div>
        </div>

        <table>
          <thead><tr><th>Action utilisateur</th><th>Appels IA</th><th>Modele</th><th>Streaming</th></tr></thead>
          <tbody>
            <tr><td style="font-weight:600">Planifier intentions (10 sujets)</td><td>2 appels</td><td>Gemini 2.0 Flash</td><td>Non (batch)</td></tr>
            <tr><td style="font-weight:600">Générer 1 article / landing page</td><td>1 appel</td><td>Gemini 2.5 Flash</td><td style="color:#059669;font-weight:600">Oui (stream)</td></tr>
            <tr><td style="font-weight:600">Validation sources / SEO</td><td>1 appel</td><td>Gemini 2.0 Flash</td><td>Non</td></tr>
          </tbody>
        </table>

        <div class="thr-w">
          <h4>Seuils de blocage GCP : 1 500 appels/min mais credits limites</h4>
          <table>
            <thead><tr><th>Users simultanées</th><th>Appels IA/min</th><th>Coût/mois estime</th><th>Statut</th></tr></thead>
            <tbody>
              <tr><td>1 a 5 users</td><td>2 a 10 appels/min</td><td>3 a 15 EUR</td><td><span class="proj-badge proj-ok">OK</span></td></tr>
              <tr><td>10 users</td><td>10 a 20 appels/min</td><td>30 EUR</td><td><span class="proj-badge proj-warn">CREDITS ?</span></td></tr>
              <tr><td>50+ users</td><td>50 a 100 appels/min</td><td>150+ EUR</td><td><span class="proj-badge proj-danger">PAYANT</span></td></tr>
            </tbody>
          </table>
          <div style="font-size:11px;color:#D97706;margin-top:6px">
            <strong>Blocker principal :</strong> pas le nombre d'appels/min (1 500 = large) mais le <strong>cout</strong> quand les credits promo GCP seront épuisés.
            Actuellement 2.98 EUR brut / 50 contenus = 0.06 EUR/contenu.
          </div>
        </div>

        <div class="reco">
          <h4>Recommandations pour scaler</h4>
          <p>1. <strong>Streaming déjà en place</strong> : evite les timeouts Vercel 60s sur contenus longs, ne pas toucher</p>
          <p>2. <strong>Retry + backoff 429 déjà en place</strong> : gestion des rate limits côté serveur, ne pas toucher</p>
          <p>3. <strong>Surveiller les credits GCP</strong> : quand épuisés, 0.06 EUR/contenu en production</p>
          <p>4. <strong>Batching intentions</strong> : générer les 10 intentions en 1 seul appel plutot que 2 (possible vu la taille du prompt)</p>
        </div>

        <div class="mini-metrics">
          <div class="mini-metric"><div class="mini-val" id="smart-build"></div><div class="mini-label">Build min</div></div>
          <div class="mini-metric"><div class="mini-val" id="smart-bw"></div><div class="mini-label">Bandwidth</div></div>
          <div class="mini-metric"><div class="mini-val" id="smart-fninv"></div><div class="mini-label">Fn Invocations</div></div>
          <div class="mini-metric"><div class="mini-val" id="smart-fndur"></div><div class="mini-label">Fn Duration</div></div>
        </div>

        <div class="links">
          <a href="https://console.cloud.google.com/billing?project=n8n-landing-pages" target="_blank" class="btn btn-g">Crédits GCP restants</a>
          <a href="https://console.cloud.google.com/apis/dashboard?project=n8n-landing-pages" target="_blank" class="btn btn-g">GCP Dashboard</a>
        </div>
      </div>
    </div>

    <!-- Section bugs lié à l'environnement Rubix -->
    <div class="section-title" style="margin-top:28px">
      <div class="st-bar" style="background:#EF4444"></div>
      Bug lié à l'environnement Rubix
      <span class="badge bd">EN COURS DE CORRECTION</span>
    </div>

    <div class="section">
      <div class="section-head" onclick="toggle(this)">
        <h2>Proxy SSL et bascules réseau (ERR_CERT / ERR_NETWORK_CHANGED)</h2>
        <span class="chevron open">&#9662;</span>
      </div>
      <div class="section-body open">

        <div class="thr-d">
          <h4>Le probleme : connexions longues cassees par le proxy d'entreprise</h4>
          <div style="font-size:11px;color:#334155;margin-bottom:8px">Générer un article nécessite 90 a 180 secondes de connexion continue. Le proxy entreprise coupe ou perturbe ces connexions longues.</div>
          <table>
            <thead><tr><th>Erreur</th><th>Cause</th><th>Impact</th></tr></thead>
            <tbody>
              <tr>
                <td style="font-weight:700;color:#DC2626">ERR_CERT_COMMON_NAME_INVALID</td>
                <td style="font-size:11px">Le proxy SSL (Zscaler) intercepte le trafic HTTPS et remplace le certificat Google par le sien. Le navigateur détecte que le nom du certificat ne correspond pas.</td>
                <td style="font-size:11px;color:#DC2626">Connexion refusee, génération impossible</td>
              </tr>
              <tr>
                <td style="font-weight:700;color:#DC2626">ERR_NETWORK_CHANGED</td>
                <td style="font-size:11px">La route réseau change en cours de génération : bascule VPN, changement de point WiFi, reconnexion automatique.</td>
                <td style="font-size:11px;color:#DC2626">Connexion coupee, article bloqué en PROCESSING</td>
              </tr>
              <tr>
                <td style="font-weight:700;color:#DC2626">ERR_INTERNET_DISCONNECTED</td>
                <td style="font-size:11px">Coupure réseau breve (mise en veille, instabilite WiFi) pendant les 90 a 180s de génération Gemini.</td>
                <td style="font-size:11px;color:#DC2626">Requete échouée, article bloqué en PROCESSING</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div style="margin-top:14px;padding:12px;background:#F8FAFC;border-radius:7px;border:1px solid #E2E8F0">
          <div style="font-size:12px;font-weight:700;color:#051E50;margin-bottom:8px">Situation actuelle vs situation cible</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;font-size:11px">
            <div style="padding:10px;background:#FEE2E2;border-radius:6px">
              <div style="font-weight:700;color:#DC2626;margin-bottom:6px">Maintenant (fragile)</div>
              <div style="color:#334155;line-height:1.8">Navigateur appelle Vercel (appel 1 : SEO, 30 a 60s)<br>Navigateur appelle Vercel (appel 2 : Article, 60 a 90s)<br>Navigateur appelle Vercel (appel 3 : Enrichissement, 30 a 60s)<br>Chaque appel passe par le proxy SSL d'entreprise</div>
            </div>
            <div style="padding:10px;background:#ECFDF5;border-radius:6px">
              <div style="font-weight:700;color:#059669;margin-bottom:6px">Apres correction (robuste)</div>
              <div style="color:#334155;line-height:1.8">Navigateur fait 1 seul appel court a Vercel<br>Vercel gere les 3 appels Gemini en interne (serveur vers serveur)<br>Le navigateur interroge le statut toutes les 5s<br>Même si le proxy coupe, Vercel continue et sauvegarde dans Sheets</div>
            </div>
          </div>
        </div>

        <div style="margin-top:14px">
          <div style="font-size:12px;font-weight:700;color:#051E50;margin-bottom:8px">Plan d'action (3 chantiers)</div>

          <div style="padding:10px;background:#ECFDF5;border-radius:7px;border:1px solid #A7F3D0;margin-bottom:8px">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
              <span class="badge bo">CHANTIER 1</span>
              <span style="font-size:12px;font-weight:700;color:#059669">Fix immédiat (5 min, zero code)</span>
              <span class="proj-badge proj-ok">FAISABLE MAINTENANT</span>
            </div>
            <div style="font-size:11px;color:#334155">Débloquer les articles coincés en PROCESSING.<br>Dans Google Sheets, onglet <strong>_meta</strong>, colonne L : chercher les cellules contenant <strong>PROCESSING:...</strong> et les remplacer par <strong>QUEUED</strong>. Ils seront re-générés à la prochaine tentative.</div>
          </div>

          <div style="padding:10px;background:#FEFCE8;border-radius:7px;border:1px solid #FFD700;margin-bottom:8px">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
              <span class="badge bw">CHANTIER 2</span>
              <span style="font-size:12px;font-weight:700;color:#D97706">Bouton Annuler dans l'UI (30 min de code)</span>
              <span class="proj-badge proj-warn">A FAIRE</span>
            </div>
            <div style="font-size:11px;color:#334155">La route backend <strong>/cancel-article/:rowId</strong> existe déjà mais n'a aucun bouton dans l'interface. Ajouter un bouton sur les cartes bloquées en PROCESSING pour débloquer sans aller dans Google Sheets.</div>
          </div>

          <div style="padding:10px;background:#F0F4FF;border-radius:7px;border:1px solid #BFDBFE">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
              <span class="badge bi">CHANTIER 3</span>
              <span style="font-size:12px;font-weight:700;color:#3B82F6">Génération côté serveur (2 à 3h de code)</span>
              <span class="proj-badge proj-warn">EN COURS</span>
            </div>
            <div style="font-size:11px;color:#334155">La vraie solution. Créer une nouvelle route dans <strong>api/index.js</strong> qui fait les 3 appels Gemini en interne, et simplifier <strong>useContentGénération.js</strong> côté frontend. Approche : batch 1 par 1 (lancer un article, attendre qu'il finisse, passer au suivant).<br><br><strong>Risque :</strong> Vercel Pro = timeout 300s par fonction. Un article prend 90 à 180s, ça passe normalement. Si Gemini est lent, le backend remet l'article en QUEUED automatiquement.</div>
          </div>
        </div>

      </div>
    </div>

  </div>
  </div>

  <!-- ONGLET CAPACITE VERCEL -->
  <div class="page" id="page-vercel">
  <div class="container">
    <div class="section-title">
      <div class="st-bar" style="background:#FFD700"></div>
      Capacité Vercel
      <span class="badge bv" id="vercel-period"></span>
    </div>

    <div class="summary">
      <div class="scard"><div class="stop stop-gold"></div>
        <div class="slabel">Build Minutes restantes</div>
        <div class="sval" id="build-rem"></div>
        <div class="sdetail" id="build-detail"></div>
      </div>
      <div class="scard"><div class="stop stop-green"></div>
        <div class="slabel">Bandwidth restante</div>
        <div class="sval" id="bw-rem"></div>
        <div class="sdetail" id="bw-detail"></div>
      </div>
      <div class="scard"><div class="stop stop-blue"></div>
        <div class="slabel">Fn Invocations restantes</div>
        <div class="sval" id="fninv-rem"></div>
        <div class="sdetail" id="fninv-detail"></div>
      </div>
      <div class="scard"><div class="stop stop-purple"></div>
        <div class="slabel">Fn Duration restante</div>
        <div class="sval" id="fndur-rem"></div>
        <div class="sdetail" id="fndur-detail"></div>
      </div>
    </div>

    <div class="section">
      <div class="section-head" onclick="toggle(this)">
        <h2>Quotas et projections <span class="badge bv" id="reset-badge"></span></h2>
        <span class="chevron open">&#9662;</span>
      </div>
      <div class="section-body open">
        <div class="limits-grid">
          <div class="limit-item">
            <div class="limit-label"><span>Build Minutes <span class="proj-badge" id="build-pbadge"></span></span><span id="build-used"></span></div>
            <div class="limit-bar"><div class="limit-fill fill-ok" id="build-bar" style="width:.5%"></div></div>
            <div class="limit-detail" id="build-proj"></div>
            <div style="font-size:10px;color:#64748B;margin-top:3px">Combien de minutes Vercel a passé à compiler et déployer les apps</div>
            <div id="build-perapp"></div>
          </div>
          <div class="limit-item">
            <div class="limit-label"><span>Bandwidth <span class="proj-badge" id="bw-pbadge"></span></span><span id="bw-used"></span></div>
            <div class="limit-bar"><div class="limit-fill fill-ok" id="bw-bar" style="width:.5%"></div></div>
            <div class="limit-detail" id="bw-proj"></div>
            <div style="font-size:10px;color:#64748B;margin-top:3px">Combien de données ont été envoyées aux utilisateurs (pages, images, réponses API)</div>
            <div id="bw-perapp"></div>
          </div>
          <div class="limit-item">
            <div class="limit-label"><span>Function Invocations <span class="proj-badge" id="fninv-pbadge"></span></span><span id="fninv-used"></span></div>
            <div class="limit-bar"><div class="limit-fill fill-ok" id="fninv-bar" style="width:.5%"></div></div>
            <div class="limit-detail" id="fninv-proj"></div>
            <div style="font-size:10px;color:#64748B;margin-top:3px">Combien de fois une fonction a été appelée — total tous projets confondus (Pôle + Pitch + Smart Content)</div>
            <div id="fninv-perapp"></div>
          </div>
          <div class="limit-item">
            <div class="limit-label"><span>Function Duration <span class="proj-badge" id="fndur-pbadge"></span></span><span id="fndur-used"></span></div>
            <div class="limit-bar"><div class="limit-fill fill-ok" id="fndur-bar" style="width:.5%"></div></div>
            <div class="limit-detail" id="fndur-proj"></div>
            <div style="font-size:10px;color:#64748B;margin-top:3px">Combien de temps ces fonctions ont tourné au total — <strong>non critique</strong> pour nos apps (limite 1 000 GB-h très difficile à atteindre)</div>
            <div id="fndur-perapp"></div>
          </div>
        </div>
        <div style="margin-top:12px;padding:10px;background:#FEFCE8;border-radius:7px;border:1px solid #FFD700">
          <div style="font-size:11px;font-weight:700;color:#D97706;margin-bottom:4px">Limites hard Vercel Pro (blocage direct, pas de surcharge)</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;font-size:11px;color:#64748B">
            <div><strong>Concurrent Builds :</strong> 1 seul (les autres en queue)</div>
            <div><strong>Serverless Timeout :</strong> 60s par defaut, 300s max (configurer maxDuration dans vercel.json)</div>
            <div><strong>Deployments :</strong> 100/jour (soft limit)</div>
          </div>
          <div style="margin-top:8px;font-size:11px;color:#64748B">
            <strong>Note :</strong> le streaming evite le timeout (Smart Content article). Les appels non-streaming longs (Rubix Pitch ~55s, Gemini non-stream) sont limites a 60s par defaut. Pour le Chantier 3 (génération serveur), ajouter <code style="background:#F1F5F9;padding:1px 5px;border-radius:3px">maxDuration: 300</code> dans vercel.json.
          </div>
        </div>
      </div>
    </div>
  </div>
  </div>

  <!-- ONGLET COUTS -->
  <div class="page" id="page-couts">
  <div class="container">
    <div class="section-title">
      <div class="st-bar" style="background:#051E50"></div>
      Coûts (référence)
    </div>

    <div class="section">
      <div class="section-head" onclick="toggle(this)">
        <h2>Résumé coûts <span class="badge bv" id="total-badge"></span></h2>
        <span class="chevron open">&#9662;</span>
      </div>
      <div class="section-body open">
        <table>
          <thead><tr><th>Service</th><th>Coût</th><th>Detail</th></tr></thead>
          <tbody>
            <tr><td style="font-weight:600">Vercel Pro</td><td style="font-weight:700">$20.00/mois</td><td style="color:#64748B">Forfait fixe mutualise 3 apps</td></tr>
            <tr><td style="font-weight:600">OpenAI</td><td style="font-weight:700" id="openai-cost"></td><td style="color:#64748B" id="openai-detail"></td></tr>
            <tr><td style="font-weight:600">Gemini Smart Content</td><td style="font-weight:700">0 EUR</td><td style="color:#64748B">2.98 EUR brut couvert par credits promo GCP</td></tr>
            <tr><td style="font-weight:600">Gemini Pôle Acquisition</td><td style="font-weight:700;color:#00D26A">0 EUR</td><td style="color:#64748B">Free tier Google AI Studio</td></tr>
            <tr style="font-weight:700;border-top:2px solid #E2E8F0"><td>Total réel</td><td style="font-size:16px;color:#051E50" id="total-cost"></td><td style="color:#64748B">Vercel + OpenAI (Gemini = 0)</td></tr>
          </tbody>
        </table>

        <div style="margin-top:14px;padding:10px;background:#F0F4FF;border-radius:7px;border:1px solid #BFDBFE">
          <div style="font-size:11px;font-weight:700;color:#3B82F6;margin-bottom:6px">Enabler</div>
          <table>
            <thead><tr><th>Outil</th><th>Coût</th><th>Role</th></tr></thead>
            <tbody>
              <tr><td style="font-weight:600">Claude Code</td><td style="font-weight:700">$100/mois</td><td style="color:#64748B">Max 5x plan, inclus dans l'abonnement Claude, developpement et iteration rapide sur les 3 apps</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  </div>

</div><!-- /main -->

<div class="footer" id="footer">Rubix Monitoring</div>

<script>
// Tab switching
function showTab(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav a').forEach(a => a.classList.remove('active'));
  document.getElementById('page-' + id).classList.add('active');
  const tabs = ['alertes','pole','pitch','smart','vercel','couts'];
  const idx = tabs.indexOf(id);
  if (idx >= 0) document.querySelectorAll('.nav a')[idx].classList.add('active');
  if (id === 'pitch') {
    if (!pitchInitialized) { pitchInitialized = true; initPitchSubTabs(); }
  }
  window.scrollTo(0, 0);
}
let retroInitialized = false;

// Collapsible sections
function toggle(head) {
  head.nextElementSibling.classList.toggle('open');
  head.querySelector('.chevron').classList.toggle('open');
}

// Helpers
const APP_COLORS = {
  'rubix-pole-acquisition':    '#FFD700',
  'rubix-pitch-generator-dev': '#8B5CF6',
  'rubix-smart-content':       '#00D26A',
  '_other':                    '#94A3B8',
};
const APP_SHORT = {
  'rubix-pole-acquisition':    'pole-acq.',
  'rubix-pitch-generator-dev': 'pitch-gen.',
  'rubix-smart-content':       'smart-cont.',
};

const $ = id => document.getElementById(id);
const html = (id, v) => { const el = $(id); if (el) el.innerHTML  = v; };
const fmtN = n => (n >= 1000 ? n.toLocaleString('fr-FR') : String(n));

function fillBar(id, pct, risk) {
  const el = $(id);
  if (!el) return;
  el.className = `limit-fill fill-${risk}`;
  el.style.width = Math.max(pct, 0.5) + '%';
}

function perAppHtml(perApp, total) {
  const entries = Object.entries(perApp || {}).filter(([,v]) => v > 0).sort((a,b) => b[1]-a[1]);
  if (!entries.length) return '';
  let h = '<div class="per-app-breakdown">';
  for (const [name, qty] of entries) {
    const color = APP_COLORS[name] || '#94A3B8';
    const short = APP_SHORT[name]  || name;
    const pct   = total > 0 ? Math.round(qty / total * 1000) / 10 : 0;
    const qFmt  = qty >= 1000 ? fmtN(Math.round(qty)) : (Math.round(qty * 100) / 100).toLocaleString('fr-FR');
    h += `<div class="per-app-row">
      <span class="per-app-dot" style="background:${color}"></span>
      <span class="per-app-name">${short}</span>
      <span class="per-app-bar-wrap"><span class="per-app-bar" style="width:${Math.max(pct,2)}%;background:${color}"></span></span>
      <span class="per-app-val">${qFmt} (${pct}%)</span>
    </div>`;
  }
  return h + '</div>';
}

// Render
function renderAll(d) {
  const { period, vercel, openai } = d;
  vercelBillingAPI = vercel?.billing ?? null;

  html('period-label', `${period.from} au ${period.to}`);
  html('generated-at', `Mis a jour : ${new Date(d.generatedAt).toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})}`);

  renderDeploys(vercel.deploys);
  renderOpenAI(openai);
  renderVercelCapacity(vercel.proj, period);
  renderMiniMetrics(vercel.proj);
  renderGlobalAlerts(vercel.proj);

  html('footer', `Rubix Monitoring | Période : ${period.from} au ${period.to} | Reset le ${period.reset}`);
}

function renderDeploys(deploys) {
  const map = { pole: 'pole', pitch: 'pitch', smart: 'smart' };
  for (const [key, d] of Object.entries(deploys)) {
    const k = map[key] || key;
    const color = d.state === 'READY' ? '#00D26A' : d.state === 'N/A' ? '#94A3B8' : '#EF4444';
    const dot = $(`${k}-dot`); if (dot) dot.style.background = color;
    const badge = `<span class="badge" style="background:${d.state==='READY'?'#ECFDF5':'#FEE2E2'};color:${d.state==='READY'?'#059669':'#DC2626'}">${d.state}</span>`;
    html(`${k}-last-deploy`, `${badge} ${d.lastDate}`);
  }
}

function renderOpenAI(oa) {
  const cpp6 = Math.round(oa.costPerPrompt * 6 * 1000) / 1000;
  html('pitch-cost-per-pitch', `<strong>~$${cpp6}</strong> &nbsp;(6 x $${oa.costPerPrompt}/appel)`);
  html('pitch-cost-detail', `<strong>Coût/pitch complet :</strong> ~$${oa.costPerPrompt} x 6 appels = ~$${cpp6}/pitch &nbsp;|&nbsp; A $${oa.monthlyProjected}/mois (rythme actuel depuis jan. 2026)`);
  html('openai-cost',   `<strong>$${oa.totalCost}</strong>`);
  html('openai-detail', `${fmtN(oa.requests)} req. | $${oa.costPerPrompt}/prompt | OpenAI Rubix Pitch`);
  const total = Math.round((20 + oa.totalCost) * 100) / 100;
  html('total-cost',  `$${total}`);
  html('total-badge', `$${total} TOTAL`);
}

function renderVercelCapacity(proj, period) {
  const METRICS = [
    { svc:'Build Minutes',        id:'build', fmtV: v => Math.round(v)+' min',   fmtU: v => Math.round(v)+' / 6 000 min',   overage:'$0.02/min'  },
    { svc:'Fast Data Transfer',   id:'bw',    fmtV: v => v.toFixed(1)+' GB',     fmtU: v => v.toFixed(2)+' / 1 000 GB',     overage:'$0.15/GB'   },
    { svc:'Function Invocations', id:'fninv', fmtV: v => fmtN(Math.round(v)),    fmtU: v => fmtN(Math.round(v))+' / 1M',    overage:'$0.60/M'    },
    { svc:'Function Duration',    id:'fndur', fmtV: v => v.toFixed(1)+' GB-h',   fmtU: v => v.toFixed(2)+' / 1 000 GB-h',  overage:'$0.18/GB-h' },
  ];
  // Alertes statiques toujours présentes
  let dangerC = 1; // FREE TIER Pôle bloqué à 5+ users
  let warnC   = 3; // Pitch : 6+ appels + polling ~55s / Smart : crédits promo GCP
  for (const { svc, id, fmtV, fmtU, overage } of METRICS) {
    const p = proj[svc]; if (!p) continue;
    const pct = Math.round(p.used / p.limit * 1000) / 10;
    html(`${id}-rem`,    fmtV(p.remaining));
    html(`${id}-detail`, `${fmtU(p.used)} | ${fmtV(p.dailyRate)}/jour`);
    html(`${id}-used`,   fmtU(p.used));
    html(`${id}-pbadge`, `Proj. ${fmtV(p.projected)}`);
    const pb = $(`${id}-pbadge`); if (pb) pb.className = `proj-badge proj-${p.risk}`;
    html(`${id}-proj`,   `${pct}% | ${fmtV(p.dailyRate)}/jour | Limite dans ${p.daysUntil} j. | Surcharge : ${overage}`);
    fillBar(`${id}-bar`, pct, p.risk);
    html(`${id}-perapp`, perAppHtml(p.perApp, p.used));
    if (p.risk === 'danger') dangerC++;
    else if (p.risk === 'warn') warnC++;
  }
  html('vercel-period', `${period.from} au ${period.to}`);
  html('reset-badge',   `Reset ${period.reset} (dans ${Math.ceil(period.daysRemaining)} j.)`);
  html('count-danger',  `${dangerC} CRITIQUE`);
  html('count-warn',    `${warnC} ATTENTION`);
}

function renderMiniMetrics(proj) {
  const appsMap = { pole:'rubix-pole-acquisition', pitch:'rubix-pitch-generator-dev', smart:'rubix-smart-content' };
  const metMap  = [
    { svc:'Build Minutes',        suf:'build', fmt:v => Math.round(v)+' min'   },
    { svc:'Fast Data Transfer',   suf:'bw',    fmt:v => v.toFixed(2)+' GB'     },
    { svc:'Function Invocations', suf:'fninv', fmt:v => fmtN(Math.round(v))    },
    { svc:'Function Duration',    suf:'fndur', fmt:v => v.toFixed(3)+' GB-h'   },
  ];
  for (const [app, appKey] of Object.entries(appsMap)) {
    for (const { svc, suf, fmt } of metMap) {
      const val = proj[svc]?.perApp?.[appKey] ?? 0;
      html(`${app}-${suf}`, fmt(val));
    }
  }
}

function renderGlobalAlerts(proj) {
  let h = '';
  const build = proj['Build Minutes'];
  const fnInv = proj['Function Invocations'];
  if (build?.risk === 'danger') {
    h += `<div class="alert-row ar-crit"><span class="alert-icon">&#9888;</span><span>Build Minutes : projection ${Math.round(build.projected)} / 6 000 min (${build.projPct}%) risque de depassement</span></div>`;
  } else if (build?.risk === 'warn') {
    h += `<div class="alert-row ar-warn"><span class="alert-icon">&#9888;</span><span>Build Minutes : projection ${Math.round(build.projected)} / 6 000 min (${build.projPct}%) a surveiller</span></div>`;
  }
  if (fnInv?.risk === 'danger') {
    h += `<div class="alert-row ar-crit"><span class="alert-icon">&#9888;</span><span>Function Invocations : projection ${fmtN(Math.round(fnInv.projected))} / 1M risque de depassement</span></div>`;
  } else if (fnInv?.risk === 'warn') {
    h += `<div class="alert-row ar-warn"><span class="alert-icon">&#9888;</span><span>Function Invocations : projection ${fmtN(Math.round(fnInv.projected))} / 1M a surveiller</span></div>`;
  }
  html('global-dyn-alerts', h);
}

// ====================== DEMANDES EN ATTENTE ======================

const DEMANDES = [
  { id:'d1', titre:'Création canal Teams "Rubix Pitch — Retours & Support"', destinataire:'IT', deadline:'28/02',
    pourquoi:'Centraliser les remontées de bugs des commerciaux pendant et après les formations.' },
  { id:'d2', titre:'1 personne pour tester l\'app avant les formations (vérification bugs)', destinataire:'À désigner', deadline:'10/03',
    detail:'Quelqu\'un qui parcourt l\'app, teste les fonctionnalités et remonte les problèmes. Effort : ~1h.',
    pourquoi:'Vérifier que l\'application fonctionne correctement avant de la mettre dans les mains de 22 personnes.' },
  { id:'d3', titre:'Liste des 66 participants aux 3 sessions (options B, C, D)', destinataire:'Organisateurs formation', deadline:'20/03',
    detail:'Nom, prénom, profil (RVE/DE), session attribuée (1, 2 ou 3).',
    pourquoi:'Permet de créer les accès individuels et gérer le déploiement progressif.' },
];

const D_CYCLE = ['todo', 'inprogress', 'done'];
const D_ICONS = { todo:'⬜', inprogress:'🔄', done:'✅' };
const D_LABELS = { todo:'À traiter', inprogress:'En cours', done:'Fait' };

function getDStatus(id)      { return localStorage.getItem('demande_status_' + id) || 'todo'; }
function setDStatus(id, val) { val === 'todo' ? localStorage.removeItem('demande_status_' + id) : localStorage.setItem('demande_status_' + id, val); }

function toggleAVCheck(id, el) {
  const cur = localStorage.getItem('av_check_' + id) || '';
  const next = cur === 'done' ? '' : 'done';
  next ? localStorage.setItem('av_check_' + id, next) : localStorage.removeItem('av_check_' + id);
  renderPitchAValider();
}

function toggleDemandeStatus(id) {
  const cur  = getDStatus(id);
  const next = D_CYCLE[(D_CYCLE.indexOf(cur) + 1) % D_CYCLE.length];
  setDStatus(id, next);
  const btn  = document.getElementById('db-' + id); if (btn) { btn.textContent = D_ICONS[next]; btn.title = D_LABELS[next]; }
  const card = document.getElementById('dc-' + id); if (card) card.classList.toggle('dem-done', next === 'done');
  /* update progress bar */
  const doneCount = DEMANDES.filter(d => getDStatus(d.id) === 'done').length;
  const pct = Math.round(doneCount / DEMANDES.length * 100);
  const fill = document.querySelector('.dem-prog-fill'); if (fill) fill.style.width = pct + '%';
  const lbl  = document.querySelector('.dem-prog-lbl');  if (lbl)  lbl.textContent = pct + '%';
  const cnt  = document.querySelector('.dem-header-count'); if (cnt) cnt.textContent = `${doneCount}/${DEMANDES.length} traitées`;
}

function demBadgeClass(dest) {
  const d = dest.toLowerCase();
  if (d.includes('it')) return 'dem-badge-it';
  if (d.includes('manager')) return 'dem-badge-manager';
  if (d.includes('orga') || d.includes('formation')) return 'dem-badge-orga';
  return 'dem-badge-claire';
}

function toggleDemRow(id) {
  const row = document.getElementById('dc-' + id);
  if (row) row.classList.toggle('dem-open');
}

function renderDemandes() {
  const el = $('avalider-demandes-wrap'); if (!el) return;
  const doneCount = DEMANDES.filter(d => getDStatus(d.id) === 'done').length;
  const pct = Math.round(doneCount / DEMANDES.length * 100);

  let h = `<div class="dem-header">
    <span class="dem-header-title">🟣 Demandes en attente de validation</span>
    <span class="dem-header-count">${doneCount}/${DEMANDES.length} traitées</span>
    <div class="dem-prog"><div class="dem-prog-bar"><div class="dem-prog-fill" style="width:${pct}%"></div></div><span class="dem-prog-lbl">${pct}%</span></div>
  </div>`;

  h += `<div class="dem-list">`;
  for (const d of DEMANDES) {
    const status = getDStatus(d.id);
    const done = status === 'done';
    h += `<div class="dem-row${done ? ' dem-done' : ''}" id="dc-${d.id}">
      <div class="dem-row-main" onclick="toggleDemRow('${d.id}')">
        <span class="dem-chevron">▶</span>
        <span class="dem-row-titre">${d.titre}</span>
        <span class="dem-badge ${demBadgeClass(d.destinataire)}">${d.destinataire}</span>
        <span class="dem-deadline">${d.deadline}</span>
        <button class="dem-status-btn" id="db-${d.id}" onclick="event.stopPropagation();toggleDemandeStatus('${d.id}')" title="${D_LABELS[status]}">${D_ICONS[status]}</button>
      </div>
      <div class="dem-expand"><div class="dem-expand-inner">
        ${d.detail ? `<div class="dem-detail">📋 ${d.detail}</div>` : ''}
        <div class="dem-why">💬 ${d.pourquoi}</div>
      </div></div>
    </div>`;
  }
  h += `</div>`;
  el.innerHTML = h;
}

// ====================== VERCEL COSTS ======================

// À mettre à jour depuis vercel.com → Dashboard → Usage
const VERCEL_USAGE = {
  plan: 'Pro',
  creditIncluded: 20.00,
  cycleStart: '2026-02-20',
  cycleEnd:   '2026-03-20',
  consumed: {
    total:               8.08,
    buildMinutes:        7.43,
    functionInvocations: 0.60,
    fluidMemory:         0.03,
    fluidCPU:            0.01,
    onDemandCharges:     0.00,
  },
  lastChecked: '2026-02-25',
};

const VERCEL_PROJECTIONS = [
  { label:'Maintenant (dev intensif)',    build:30,  functions:2.50, status:'red',    comment:'Surplus ~$14' },
  { label:'Après code freeze (mars)',     build:5,   functions:2.50, status:'green',  comment:'Dans le crédit' },
  { label:'15 users actifs (avril)',      build:3,   functions:5,    status:'green',  comment:'' },
  { label:'66 users actifs (cible)',      build:3,   functions:12,   status:'green',  comment:'' },
];

function renderVercelCosts() {
  if (vercelBillingAPI) return renderVercelCostsAPI(vercelBillingAPI);
  const v = VERCEL_USAGE;
  const today0 = new Date(); today0.setHours(0,0,0,0);
  const cycleStart = new Date(v.cycleStart);
  const cycleEnd   = new Date(v.cycleEnd);
  const joursEcoules = Math.max(1, Math.floor((today0 - cycleStart) / 86400000));
  const totalJours   = Math.floor((cycleEnd - cycleStart) / 86400000);
  const joursRestants = Math.max(0, totalJours - joursEcoules);
  const projection   = Math.round((v.consumed.total / joursEcoules) * totalJours * 100) / 100;
  const surplus      = Math.max(0, Math.round((projection - v.creditIncluded) * 100) / 100);
  const pctConsumed  = Math.min(100, Math.round(v.consumed.total / v.creditIncluded * 1000) / 10);
  const pctProj      = projection / v.creditIncluded;

  const barColor = pctConsumed <= 50 ? '#22C55E' : pctConsumed <= 80 ? '#F59E0B' : pctConsumed <= 100 ? '#F97316' : '#EF4444';
  const borderColor = projection < v.creditIncluded ? '#22C55E' : projection < 30 ? '#F97316' : '#EF4444';
  const statusIcon = projection < v.creditIncluded ? '🟢' : projection < 30 ? '🟠' : '🔴';

  const coveredPct = Math.min(100, Math.round(v.creditIncluded / projection * 100));
  const surplusPct = 100 - coveredPct;

  let h = `<div style="border-left:4px solid ${borderColor};background:#fff;border-radius:8px;border:1px solid #E2E8F0;border-left-width:4px;padding:16px;margin-bottom:16px">`;
  h += `<div style="font-size:14px;font-weight:800;color:#051E50;margin-bottom:4px">${statusIcon} 🖥️ Hébergement Vercel — Suivi des coûts</div>`;
  h += `<div style="font-size:12px;color:#64748B;margin-bottom:12px">Plan Pro · 20$/mois inclus · Mis à jour le ${v.lastChecked}</div>`;
  h += `<div style="font-size:12px;color:#334155;margin-bottom:12px">L'application est hébergée sur Vercel (plan Pro, 20$/mois). Le plan inclut un crédit de 20$. Au-delà, les frais supplémentaires sont facturés automatiquement.</div>`;

  // Cycle info
  h += `<div style="font-size:11px;color:#64748B;margin-bottom:10px">Cycle : ${v.cycleStart} → ${v.cycleEnd} &nbsp;|&nbsp; Jours écoulés : <strong>${joursEcoules} / ${totalJours}</strong> &nbsp;|&nbsp; Restants : <strong>${joursRestants}</strong></div>`;

  // Crédit consommé
  h += `<div style="font-size:12px;font-weight:700;color:#051E50;margin-bottom:4px">Crédit inclus consommé : $${v.consumed.total.toFixed(2)} / $${v.creditIncluded.toFixed(2)}</div>`;
  h += `<div class="vercel-prog-bar"><div class="vercel-prog-fill" style="width:${pctConsumed}%;background:${barColor}"></div></div>`;
  h += `<div style="font-size:11px;color:${barColor};font-weight:700;margin-bottom:10px">${pctConsumed}% du crédit utilisé</div>`;
  if (v.consumed.onDemandCharges > 0) h += `<div style="font-size:11px;color:#DC2626;font-weight:700;margin-bottom:8px">⚠️ Surplus facturé (On-Demand) : $${v.consumed.onDemandCharges.toFixed(2)}</div>`;

  // Détail par poste
  h += `<div style="font-size:11px;font-weight:700;color:#051E50;margin:12px 0 6px;text-transform:uppercase;letter-spacing:.6px">Détail par poste</div>`;
  h += `<table style="margin-bottom:12px"><thead><tr><th>Poste</th><th>Consommé</th><th>Proj. fin cycle</th><th>Commentaire</th></tr></thead><tbody>`;
  const postes = [
    { l:'Build Minutes',        v:v.consumed.buildMinutes,        pct: v.consumed.buildMinutes / v.consumed.total },
    { l:'Function Invocations', v:v.consumed.functionInvocations, pct: v.consumed.functionInvocations / v.consumed.total },
    { l:'Memory + CPU',         v:v.consumed.fluidMemory + v.consumed.fluidCPU, pct: (v.consumed.fluidMemory + v.consumed.fluidCPU) / v.consumed.total },
  ];
  let totalConsumed = 0; let totalProj = 0;
  for (const p of postes) {
    const pv = Math.round(p.v * 100) / 100;
    const pp = Math.round((p.v / joursEcoules) * totalJours * 100) / 100;
    totalConsumed += pv; totalProj += pp;
    const isHigh = pp > v.creditIncluded * 0.5;
    h += `<tr><td>${p.l}</td><td>$${pv.toFixed(2)}</td><td>~$${pp.toFixed(2)}</td><td>${isHigh ? '🔴 Élevé (dev intensif)' : '🟢 Normal'}</td></tr>`;
  }
  h += `<tr style="font-weight:700;border-top:2px solid #E2E8F0"><td>TOTAL</td><td>$${totalConsumed.toFixed(2)}</td><td>~$${projection.toFixed(2)}</td><td>${surplus > 0 ? `🟠 Surplus ~$${surplus.toFixed(2)}` : '🟢 OK'}</td></tr>`;
  h += '</tbody></table>';

  // Jauge de projection
  h += `<div style="font-size:11px;font-weight:700;color:#051E50;margin:10px 0 4px">Projection fin de cycle</div>`;
  if (surplus > 0) {
    const projTotal = v.creditIncluded + surplus;
    h += `<div class="vercel-proj-bar">
      <div class="vercel-proj-covered" style="width:${coveredPct}%;background:#22C55E"></div>
      <div class="vercel-proj-surplus" style="width:${surplusPct}%;background:#F97316"></div>
    </div>`;
    h += `<div style="font-size:11px;color:#64748B;margin-top:4px;display:flex;gap:12px"><span style="color:#22C55E">■ Couvert ($${v.creditIncluded})</span><span style="color:#F97316">■ Surplus estimé ($${surplus.toFixed(2)})</span></div>`;
  } else {
    h += `<div class="vercel-proj-bar"><div class="vercel-proj-covered" style="width:${Math.min(100,Math.round(projection/v.creditIncluded*100))}%;background:#22C55E"></div></div>`;
    h += `<div style="font-size:11px;color:#22C55E;margin-top:4px">Dans le crédit inclus ✅</div>`;
  }

  // Pourquoi élevé
  h += `<div style="font-size:11px;color:#334155;margin-top:12px;padding:8px;background:#FEFCE8;border-radius:6px;border-left:3px solid #F59E0B">
    <strong>Pourquoi c'est élevé ce mois :</strong> Les Build Minutes représentent ${Math.round(v.consumed.buildMinutes/v.consumed.total*100)}% de la consommation. C'est le coût de chaque déploiement en phase de dev intensif. Après le code freeze du 10/03, les déploiements deviennent rares et le coût redescend naturellement.
  </div>`;

  // Projections par scénario
  h += `<div style="font-size:11px;font-weight:700;color:#051E50;margin:12px 0 6px;text-transform:uppercase;letter-spacing:.6px">Prévisions par période</div>`;
  h += `<table style="margin-bottom:10px"><thead><tr><th>Période</th><th>Build Minutes</th><th>Fonctions</th><th>Total/mois</th></tr></thead><tbody>`;
  for (const row of VERCEL_PROJECTIONS) {
    const total = row.build + row.functions;
    const surplus2 = Math.max(0, total - v.creditIncluded);
    const icon = row.status === 'red' ? '🔴' : row.status === 'green' ? '🟢' : '🟠';
    const comment = row.comment ? ` — ${row.comment}` : (surplus2 > 0 ? ` — surplus $${surplus2.toFixed(0)}` : ' — dans le crédit');
    h += `<tr><td>${row.label}</td><td>~$${row.build}</td><td>~$${row.functions}</td><td>${icon} ~$${total}${comment}</td></tr>`;
  }
  h += '</tbody></table>';

  // Seuils d'alerte
  h += `<div style="font-size:11px;color:#334155;padding:8px 10px;background:#F8FAFC;border-radius:6px;border:1px solid #E2E8F0">
    <strong>Seuils d'alerte :</strong>&nbsp;
    🟢 &lt;50% du crédit = OK &nbsp;|&nbsp;
    🟡 50-80% = surveiller &nbsp;|&nbsp;
    🟠 80-100% = ralentir les déploiements &nbsp;|&nbsp;
    🔴 &gt;100% = surplus facturé
    <br><strong>Statut actuel :</strong> ${pctConsumed <= 50 ? '🟢' : pctConsumed <= 80 ? '🟡' : '🟠'} ${pctConsumed}% &nbsp;|&nbsp;
    Alerte projection &gt;$${v.creditIncluded} : ${surplus > 0 ? `🟠 OUI (~$${projection.toFixed(2)})` : '🟢 NON'}
  </div>`;
  h += `<div style="font-size:11px;color:#64748B;margin-top:8px;font-style:italic">💡 Le surplus actuel est temporaire et lié à la phase de développement. Dès le code freeze, la consommation rentre dans les $20/mois. Aucun changement de plan nécessaire.</div>`;
  h += '</div>';
  return h;
}

// ── Vercel Costs depuis API (données automatiques) ────────────────────────────
function renderVercelCostsAPI(api) {
  const joursRestants = Math.max(0, Math.round(api.totalJours - api.joursEcoules));
  const surplus       = api.currentOverage;
  const projSurplus   = api.projectedOverage;
  const borderColor   = api.projectedTotal <= api.creditIncluded ? '#22C55E'
                      : api.projectedTotal < api.creditIncluded + 5 ? '#F97316' : '#EF4444';
  const statusIcon    = api.projectedTotal <= api.creditIncluded ? '🟢'
                      : api.projectedTotal < api.creditIncluded + 5 ? '🟠' : '🔴';
  const barColor      = surplus === 0 ? '#22C55E' : surplus < 5 ? '#F59E0B' : '#EF4444';

  let h = `<div style="border-left:4px solid ${borderColor};background:#fff;border-radius:8px;border:1px solid #E2E8F0;border-left-width:4px;padding:16px;margin-bottom:16px">`;
  h += `<div style="font-size:14px;font-weight:800;color:#051E50;margin-bottom:4px">${statusIcon} 🖥️ Hébergement Vercel — Suivi des coûts</div>`;
  h += `<div style="font-size:12px;color:#64748B;margin-bottom:12px">Plan Pro · $${api.planFee}/mois inclus · <span style="color:#059669;font-weight:700">⚡ Données en temps réel</span></div>`;
  h += `<div style="font-size:12px;color:#334155;margin-bottom:12px">L'application est hébergée sur Vercel (plan Pro, $20/mois). Le plan inclut un crédit de $20. Au-delà, les frais supplémentaires sont facturés automatiquement.</div>`;

  h += `<div style="font-size:11px;color:#64748B;margin-bottom:10px">Cycle : ${api.cycleStart} → ${api.cycleEnd} &nbsp;|&nbsp; Jours écoulés : <strong>${api.joursEcoules} / ${api.totalJours}</strong> &nbsp;|&nbsp; Restants : <strong>${joursRestants}</strong></div>`;

  h += `<div style="font-size:12px;font-weight:700;color:#051E50;margin-bottom:4px">Facture cycle actuelle : $${api.currentTotal.toFixed(2)} ($${api.planFee} plan${surplus > 0 ? ` + $${surplus.toFixed(2)} surplus` : ' — dans le crédit'})</div>`;
  h += `<div class="vercel-prog-bar"><div class="vercel-prog-fill" style="width:${Math.min(100, Math.round(api.currentTotal / (api.creditIncluded * 2) * 100))}%;background:${barColor}"></div></div>`;
  if (surplus > 0) {
    h += `<div style="font-size:11px;color:#EF4444;font-weight:700;margin-bottom:10px">⚠️ Dépassement actuel : +$${surplus.toFixed(2)}</div>`;
  } else {
    h += `<div style="font-size:11px;color:#22C55E;font-weight:700;margin-bottom:10px">✅ Aucun dépassement — dans le crédit inclus</div>`;
  }

  const UNIT_LABELS = { 'Build Minutes':'min', 'Fast Data Transfer':'GB', 'Function Invocations':'invoc.', 'Function Duration':'GB-h' };
  h += `<div style="font-size:11px;font-weight:700;color:#051E50;margin:12px 0 6px;text-transform:uppercase;letter-spacing:.6px">Détail par poste</div>`;
  h += `<table style="margin-bottom:12px"><thead><tr><th>Service</th><th>Utilisé</th><th>Seuil inclus</th><th>Surplus actuel</th><th>Proj. surplus</th></tr></thead><tbody>`;
  for (const [svc, b] of Object.entries(api.breakdown)) {
    const isOver     = b.currentCost > 0;
    const isProjOver = b.projectedCost > 0;
    const freeFmt    = svc === 'Function Invocations' ? (b.free / 1e6) + 'M' : b.free.toLocaleString('fr-FR');
    h += `<tr>
      <td>${svc}</td>
      <td>${b.used.toLocaleString('fr-FR')} ${UNIT_LABELS[svc] || ''}</td>
      <td>${freeFmt} ${UNIT_LABELS[svc] || ''}</td>
      <td>${isOver ? `🔴 $${b.currentCost.toFixed(4)}` : '🟢 —'}</td>
      <td>${isProjOver ? `~$${b.projectedCost.toFixed(4)}` : '—'}</td>
    </tr>`;
  }
  h += `<tr style="font-weight:700;border-top:2px solid #E2E8F0"><td>TOTAL</td><td colspan="2">—</td><td>$${surplus.toFixed(2)}</td><td>~$${projSurplus.toFixed(2)}</td></tr>`;
  h += '</tbody></table>';

  h += `<div style="font-size:11px;font-weight:700;color:#051E50;margin:10px 0 4px">Projection fin de cycle</div>`;
  if (projSurplus > 0) {
    const projTotal  = api.creditIncluded + projSurplus;
    const coveredPct = Math.min(100, Math.round(api.creditIncluded / projTotal * 100));
    const surplusPct = 100 - coveredPct;
    h += `<div class="vercel-proj-bar">
      <div class="vercel-proj-covered" style="width:${coveredPct}%;background:#22C55E"></div>
      <div class="vercel-proj-surplus" style="width:${surplusPct}%;background:#F97316"></div>
    </div>`;
    h += `<div style="font-size:11px;color:#64748B;margin-top:4px;display:flex;gap:12px"><span style="color:#22C55E">■ Plan inclus ($${api.creditIncluded})</span><span style="color:#F97316">■ Surplus estimé ($${projSurplus.toFixed(2)})</span></div>`;
    h += `<div style="font-size:11px;color:#F97316;font-weight:700;margin-top:4px">Total projeté fin de cycle : ~$${api.projectedTotal.toFixed(2)}</div>`;
  } else {
    h += `<div class="vercel-proj-bar"><div class="vercel-proj-covered" style="width:${Math.min(100, Math.round(api.projectedTotal / api.creditIncluded * 100))}%;background:#22C55E"></div></div>`;
    h += `<div style="font-size:11px;color:#22C55E;margin-top:4px">✅ Projection dans le crédit inclus (~$${api.projectedTotal.toFixed(2)} total)</div>`;
  }

  h += `<div style="font-size:11px;font-weight:700;color:#051E50;margin:12px 0 6px;text-transform:uppercase;letter-spacing:.6px">Prévisions par période</div>`;
  h += `<table style="margin-bottom:10px"><thead><tr><th>Période</th><th>Build Minutes</th><th>Fonctions</th><th>Total/mois</th></tr></thead><tbody>`;
  for (const row of VERCEL_PROJECTIONS) {
    const total    = row.build + row.functions;
    const surplus2 = Math.max(0, total - api.creditIncluded);
    const icon     = row.status === 'red' ? '🔴' : row.status === 'green' ? '🟢' : '🟠';
    const comment  = row.comment ? ` — ${row.comment}` : (surplus2 > 0 ? ` — surplus $${surplus2.toFixed(0)}` : ' — dans le crédit');
    h += `<tr><td>${row.label}</td><td>~$${row.build}</td><td>~$${row.functions}</td><td>${icon} ~$${total}${comment}</td></tr>`;
  }
  h += '</tbody></table>';

  h += `<div style="font-size:11px;color:#334155;padding:8px 10px;background:#F8FAFC;border-radius:6px;border:1px solid #E2E8F0">
    <strong>Seuils d'alerte :</strong>&nbsp;
    🟢 Aucun surplus = OK &nbsp;|&nbsp;
    🟠 Surplus &lt;$5 = surveiller &nbsp;|&nbsp;
    🔴 Surplus &gt;$5 = ralentir les déploiements
    <br><strong>Statut actuel :</strong> ${surplus === 0 ? '🟢 OK — aucun surplus' : surplus < 5 ? `🟠 Surplus $${surplus.toFixed(2)}` : `🔴 Surplus $${surplus.toFixed(2)}`}
    &nbsp;|&nbsp; Projection fin de cycle : ${projSurplus === 0 ? '🟢 OK' : `🟠 ~$${projSurplus.toFixed(2)} surplus`}
  </div>`;
  h += `<div style="font-size:11px;color:#64748B;margin-top:8px;font-style:italic">💡 Données calculées automatiquement depuis l'API Vercel à chaque chargement. Seul l'excédent au-delà des seuils inclus génère un coût supplémentaire.</div>`;
  h += '</div>';
  return h;
}

// ====================== PITCH GENERATOR SUB-TABS ======================

// ---- Constantes modifiables ----
const PITCH_STATUSES = {
  compteOpenAI: 'critical',  // 'ok' | 'warning' | 'critical'
  timeout:      'warning',
  formations:   'ok',
  couts:        'ok',
};
const PITCH_STATUS_LABELS = { compteOpenAI:'Compte IA', timeout:'Disponibilité', formations:'Formations', couts:'Budget' };
const PITCH_STATUS_META   = { ok:{icon:'🟢',label:'OK',cls:'ok'}, warning:{icon:'🟡',label:'ATTENTION',cls:'warn'}, critical:{icon:'🔴',label:'CRITIQUE',cls:'danger'} };

const PITCH_FORMATION_DATES = [
  { date:'2026-02-25', label:'25 fév',   desc:'Test solo Claire',               users:1,  done:true  },
  { date:'2026-03-17', label:'17 mars',  desc:'Session 1 — Pilote réduit',      users:22, done:false },
  { date:'2026-03-25', label:'25 mars',  desc:'Session 2 — Pilote élargi',      users:22, done:false },
  { date:'2026-04-08', label:'8 avr',    desc:'Session 3 — Déploiement final',  users:22, done:false },
];
const PITCH_PRICE_CALL  = 0.00623; // $ par appel OpenAI
const PITCH_CALLS_PITCH = 6;       // appels par pitch complet
const PITCH_EUR_USD     = 0.92;    // taux de change approximatif
const PITCH_CL_IDS      = ['c1','c2','c3','c4','c5','c6','c7','c8','c9','c10'];

// ---- Navigation sous-onglets ----
function showPitchTab(id, btn) {
  document.querySelectorAll('#page-pitch .sub-page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('#page-pitch .sub-tab-btn').forEach(b => b.classList.remove('active'));
  const page = document.getElementById('pitch-sub-' + id);
  if (page) page.classList.add('active');
  if (btn) btn.classList.add('active');
  if (id === 'programme') {
    if (!retroInitialized) { retroInitialized = true; initRetro(); }
    else { updateRetroProgress(); }
    setTimeout(() => { const el = $('retro-today'); if (el) el.scrollIntoView({block:'nearest',inline:'center'}); }, 80);
  }
}

// ---- Statut global ----
function renderPitchStatusWidget() {
  const vals = Object.values(PITCH_STATUSES);
  const global = vals.includes('critical') ? 'critical' : vals.includes('warning') ? 'warning' : 'ok';
  const sm = PITCH_STATUS_META[global];
  let h = `<div class="pitch-gs pitch-gs-${sm.cls}">${sm.icon} Statut global Rubix Pitch : <strong>${sm.label}</strong></div>`;
  h += '<div class="pitch-sc-grid">';
  for (const [key, val] of Object.entries(PITCH_STATUSES)) {
    const m = PITCH_STATUS_META[val];
    h += `<div class="pitch-sc-card pitch-sc-${m.cls}"><span>${m.icon}</span><span>${PITCH_STATUS_LABELS[key]}</span></div>`;
  }
  h += '</div>';
  html('pitch-status-widget', h);
}

// ---- Formations ----
function renderPitchFormations() {
  const today0 = new Date(); today0.setHours(0,0,0,0);
  const OPENAI_COSTS = { pricePerCall: PITCH_PRICE_CALL, callsPerPitch: PITCH_CALLS_PITCH, eurUsd: PITCH_EUR_USD };

  let tlH = '<div class="pitch-timeline">';
  PITCH_FORMATION_DATES.forEach((f, i) => {
    const target = new Date(f.date); target.setHours(0,0,0,0);
    const days = Math.ceil((target - today0) / 86400000);
    const isPast = days < 0; const isToday = days === 0;
    let cls = 'pitch-tl-item';
    if (f.done || isPast) cls += ' tl-done';
    if (isToday) cls += ' tl-today';
    const when = (f.done || isPast) ? '✅ Fait' : isToday ? "📅 Aujourd'hui" : `Dans ${days} jour${days > 1 ? 's' : ''}`;
    const whenColor = (f.done || isPast) ? '#059669' : isToday ? '#D97706' : '#64748B';
    tlH += `<div class="${cls}">
      <div class="pitch-tl-dot"></div>
      <div class="pitch-tl-date">${peSpan('form_date_'+i, f.label)}</div>
      <div class="pitch-tl-desc">${peSpan('form_desc_'+i, f.desc)}</div>
      <div class="pitch-tl-users">${peSpan('form_users_'+i, f.users+' participant'+(f.users>1?'s':''))}</div>
      <div class="pitch-tl-when" style="color:${whenColor}">${when}</div>
    </div>`;
  });
  tlH += '</div>';

  let tableH = `<table style="margin-top:16px"><thead><tr><th>Session</th><th>Participants</th><th>Pitchs/jour (est.)</th><th>Appels OpenAI</th><th>Coût estimé/jour</th></tr></thead><tbody>`;
  PITCH_FORMATION_DATES.forEach((f, i) => {
    const pitchs = f.users * 3;
    const calls  = pitchs * OPENAI_COSTS.callsPerPitch;
    const cost   = (calls * OPENAI_COSTS.pricePerCall * OPENAI_COSTS.eurUsd).toFixed(2);
    tableH += `<tr><td>${peSpan('form_t_session_'+i, f.label+' — '+f.desc)}</td><td>${peSpan('form_t_users_'+i, f.users)}</td><td>${pitchs}</td><td>${calls}</td><td>${peSpan('form_t_cost_'+i, cost+' €')}</td></tr>`;
  });
  tableH += '</tbody></table>';
  tableH += `<div class="note" style="margin-top:10px">Base : ${OPENAI_COSTS.callsPerPitch} appels × ${OPENAI_COSTS.pricePerCall}$ × ${OPENAI_COSTS.eurUsd} EUR/USD. Coûts réels visibles dans le dashboard OpenAI.</div>`;
  html('pitch-formations-widget', tlH + tableH);
}

// ---- Coûts globaux ----
const COSTS = {
  setup: [
    { label:'Vercel Pro — Février 2026',  sub:'(phase de dev intensif)',    cost:34, detail:'Hébergement pendant le développement. Élevé à cause des déploiements fréquents.' },
    { label:'Vercel Pro — Mars 2026',     sub:'(stabilisation)',            cost:20, detail:'Dev + formations. Retour à la normale après code freeze.' },
    { label:'OpenAI API — Dev & tests',   sub:'(jan.–mars 2026)',           cost:1,  detail:'Tous les appels IA pendant le développement et les tests.' },
    { label:'OpenAI — Crédits Tier 2',    sub:'(paiement unique)',          cost:50, detail:'Prépayé pour monter en capacité. Consommé progressivement par l\'usage.' },
  ],
  running: {
    vercelPro:      15,
    openaiPer15:    0.60,
    openaiPer66:    2.64,
    costPerPitch:   0.008,
  },
  openaiCredits: {
    loaded:      50,
    consumed:    1.25,
    lastChecked: '2026-02-25',
  },
  testBudget: [
    { label:'Tests unitaires (matrice)',     pitchs:3,  cost:0.024 },
    { label:'Tests petit groupe',            pitchs:10, cost:0.08  },
    { label:'Simulation formation (22)',     pitchs:22, cost:0.18  },
    { label:'Simulation stress (35)',        pitchs:35, cost:0.28  },
    { label:'Testeurs réels (5 pers.)',      pitchs:25, cost:0.20  },
    { label:'Retests après debug',           pitchs:22, cost:0.18  },
    { label:'Tests quotidiens (7 jours)',    pitchs:7,  cost:0.056 },
  ],
  oaiScenarios: [
    { label:'5 users (pilote)',   pitchs:25  },
    { label:'15 users',           pitchs:75  },
    { label:'50 users',           pitchs:250 },
    { label:'66 users (cible)',   pitchs:330 },
    { label:'100 users',          pitchs:500 },
  ],
  EUR_USD: 0.92,
};

function sectionSep(title, sub) {
  return `<div style="border-top:2px solid #E5E7EB;margin:20px 0 12px;padding-top:12px">
    <div style="font-size:12px;font-weight:800;color:#6B7280;letter-spacing:.8px;text-transform:uppercase">${title}</div>
    ${sub ? `<div style="font-size:11px;color:#9CA3AF;margin-top:2px">${sub}</div>` : ''}
  </div>`;
}

function renderPitchCouts() {
  const C = COSTS;
  const EUR = C.EUR_USD;
  const cppEUR = C.running.costPerPitch * EUR; // coût par pitch en EUR
  const oaiRem = C.openaiCredits.loaded - C.openaiCredits.consumed;
  const oaiPct = Math.round(C.openaiCredits.consumed / C.openaiCredits.loaded * 1000) / 10;

  const OPTS = [
    { id:'A', titre:'On attend l\'IT', color:'#64748B', bg:'#F8FAFC', border:'#CBD5E1',
      openai_setup:'0€', vercel_surcout:'0€', ia_mois:'0€', total_pilote:'0€',
      detail:'Aucun coût additionnel. Le projet est en pause.' },
    { id:'B', titre:'Progressif (5 → 25)', color:'#166534', bg:'#F0FDF4', border:'#22C55E',
      openai_setup:'~46€', vercel_surcout:'~13€ (temporaire)', ia_mois:'~3€', total_pilote:'~65€',
      detail:'<strong>Crédits IA :</strong> 46€ prépayés (durée ~2 ans au rythme pilote).<br><strong>Surcoût Vercel :</strong> chaque amélioration déclenche une reconstruction. Pendant la phase de préparation (~1 mois), les builds augmentent → surcoût ~13€. <strong>Ce surcoût disparaît après stabilisation.</strong><br><strong>Consommation IA :</strong> ~0,06€/pitch, soit ~3€/mois pour 5-25 utilisateurs actifs.' },
    { id:'C', titre:'Tous en live (25+)', color:'#991B1B', bg:'#FEF2F2', border:'#EF4444',
      openai_setup:'~55€', vercel_surcout:'~15€', ia_mois:'~5€', total_pilote:'~85€',
      detail:'<strong>Crédits IA :</strong> 46€ + provision ~10€ pour les sessions jour J (25+ pitchs en quelques heures).<br><strong>Surcoût Vercel :</strong> ~13€ de builds (préparation) + pic de consommation serveur les jours de formation (25+ utilisateurs simultanés).<br><strong>Consommation IA :</strong> ~5€/mois si tout le monde utilise régulièrement.' },
    { id:'D', titre:'Hybride', color:'#92400E', bg:'#FFFBEB', border:'#F59E0B',
      openai_setup:'~55€', vercel_surcout:'~15€', ia_mois:'~3€', total_pilote:'~80€',
      detail:'<strong>Crédits IA :</strong> identique à C (même risque le jour J).<br><strong>Surcoût Vercel :</strong> identique à C pendant la préparation. Après : retour au niveau de B (5-10 utilisateurs actifs seulement).<br><strong>Consommation IA :</strong> après le jour J, seuls 5-10 utilisateurs restent → ~3€/mois.' },
  ];

  let h = `<div style="font-size:18px;font-weight:800;color:#051E50;margin-bottom:6px">${peSpan('c_titre','Coûts additionnels par option')}</div>`;
  h += `<div style="font-size:13px;color:#64748B;margin-bottom:18px">Hors abonnement Vercel Pro (20€/mois) déjà en place pour toutes les applications.</div>`;

  for (const o of OPTS) {
    h += `<div style="background:${o.bg};border:2px solid ${o.border};border-radius:12px;padding:20px;margin-bottom:16px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px">
        <div style="display:flex;align-items:center;gap:10px">
          <span style="font-size:15px;font-weight:800;color:${o.color};background:#fff;border:2px solid ${o.border};border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center">${o.id}</span>
          <span style="font-size:16px;font-weight:800;color:${o.color}">${peSpan('c_'+o.id+'_titre', o.titre)}</span>
        </div>
        <div style="background:${o.color};color:#fff;padding:6px 14px;border-radius:20px;font-size:14px;font-weight:800">Coût total : ${peSpan('c_'+o.id+'_total_pilote', o.total_pilote)}</div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:14px">
        <div style="background:#fff;border-radius:8px;padding:12px;text-align:center">
          <div style="font-size:11px;color:#64748B;margin-bottom:4px">Crédits IA (set-up)</div>
          <div style="font-size:16px;font-weight:800;color:${o.color}">${peSpan('c_'+o.id+'_openai', o.openai_setup)}</div>
        </div>
        <div style="background:#fff;border-radius:8px;padding:12px;text-align:center">
          <div style="font-size:11px;color:#64748B;margin-bottom:4px">Surcoût Vercel</div>
          <div style="font-size:14px;font-weight:800;color:#334155">${peSpan('c_'+o.id+'_vercel', o.vercel_surcout)}</div>
        </div>
        <div style="background:#fff;border-radius:8px;padding:12px;text-align:center">
          <div style="font-size:11px;color:#64748B;margin-bottom:4px">Consommation IA / mois</div>
          <div style="font-size:14px;font-weight:800;color:#334155">${peSpan('c_'+o.id+'_ia_mois', o.ia_mois)}</div>
        </div>
      </div>
      <div style="font-size:13px;color:#334155;line-height:1.7">${peSpan('c_'+o.id+'_detail', o.detail)}</div>
    </div>`;
  }

  html('pitch-couts-widget', h);
}

// ---- Checklist ----
function getPitchChecklist() {
  try { return JSON.parse(localStorage.getItem('pitch_checklist') || '{}'); } catch { return {}; }
}
function togglePitchCheck(id) {
  const stored = getPitchChecklist();
  stored[id] = !stored[id];
  localStorage.setItem('pitch_checklist', JSON.stringify(stored));
  const el  = document.getElementById('pitch-cl-' + id);
  const chk = document.getElementById('pitch-chk-' + id);
  if (el)  el.classList.toggle('cl-checked', !!stored[id]);
  if (chk) chk.checked = !!stored[id];
  updatePitchClProgress();
}
function resetPitchChecklist() {
  localStorage.removeItem('pitch_checklist');
  PITCH_CL_IDS.forEach(id => {
    const el  = document.getElementById('pitch-cl-' + id);
    const chk = document.getElementById('pitch-chk-' + id);
    if (el)  el.classList.remove('cl-checked');
    if (chk) chk.checked = false;
  });
  updatePitchClProgress();
}
function updatePitchClProgress() {
  const stored = getPitchChecklist();
  const done = PITCH_CL_IDS.filter(id => stored[id]).length;
  const total = PITCH_CL_IDS.length;
  const prog = document.getElementById('pitch-cl-prog');
  if (prog) prog.textContent = `${done} / ${total} complétés${done === total ? ' — Tout est prêt ! 🎉' : ''}`;
}
function initPitchChecklist() {
  const stored = getPitchChecklist();
  PITCH_CL_IDS.forEach(id => {
    const el  = document.getElementById('pitch-cl-' + id);
    const chk = document.getElementById('pitch-chk-' + id);
    if (el)  el.classList.toggle('cl-checked', !!stored[id]);
    if (chk) chk.checked = !!stored[id];
  });
  updatePitchClProgress();
}

// ---- Pilote & Transition IT ----
function renderPitchPilote() {
  let h = '';

  /* --- Périmètre pilote --- */
  h += `<div style="font-size:18px;font-weight:800;color:#051E50;margin-bottom:14px">${peSpan('pil_header','Pilote')}</div>`;
  h += `<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:14px">
    <div style="background:#051E50;border-radius:8px;padding:14px;text-align:center">
      <div style="font-size:12px;color:#FFD700;margin-bottom:4px">Début pilote</div>
      <div style="font-size:18px;font-weight:800;color:#fff">${peSpan('pil_debut','17/03/2026','color:#fff')}</div>
      <div style="font-size:12px;color:#94A3B8">${peSpan('pil_debut_sub','Session 1')}</div>
    </div>
    <div style="background:#051E50;border-radius:8px;padding:14px;text-align:center">
      <div style="font-size:12px;color:#FFD700;margin-bottom:4px">Fin pilote</div>
      <div style="font-size:18px;font-weight:800;color:#fff">${peSpan('pil_fin','30/04/2026','color:#fff')}</div>
      <div style="font-size:12px;color:#94A3B8">${peSpan('pil_fin_sub','Bilan GO/NO GO')}</div>
    </div>
    <div style="background:#051E50;border-radius:8px;padding:14px;text-align:center">
      <div style="font-size:12px;color:#FFD700;margin-bottom:4px">Durée</div>
      <div style="font-size:18px;font-weight:800;color:#fff">${peSpan('pil_duree','6 semaines','color:#fff')}</div>
    </div>
  </div>`;
  h += `<p style="font-size:14px;color:#334155;margin:0 0 18px;line-height:1.7">${peSpan('pil_objectif','L\'objectif du pilote est de prouver que l\'application fonctionne en conditions réelles, que les commerciaux l\'adoptent, et que les coûts sont maîtrisés.')}</p>`;

  /* --- Set-up par option --- */
  h += `<div style="font-size:16px;font-weight:800;color:#051E50;margin-bottom:14px">${peSpan('pil_titre','Set-up par option')}</div>`;

  const SETUPS = [
    { id:'A', titre:'On attend l\'IT', color:'#64748B', bg:'#F8FAFC', border:'#CBD5E1', items:[
      { label:'Préparation', val:'Aucune' },
      { label:'Compte IA', val:'Pas de changement' },
      { label:'Formations', val:'Reportées' },
      { label:'Infrastructure', val:'En attente IT' },
      { label:'Support', val:'Aucun' },
    ]},
    { id:'B', titre:'Progressif (5 → 25)', color:'#166534', bg:'#F0FDF4', border:'#22C55E', items:[
      { label:'Préparation', val:'Créer un compte IA dédié (7 jours) + tester la génération avec 5 users' },
      { label:'Compte IA', val:'Compte OpenAI dédié Rubix Pitch — carte bancaire + 46€ crédits' },
      { label:'Formations', val:'Vague 1 : 5 users → Vague 2 : 10 users → Vague 3 : 25 users' },
      { label:'Gestion d\'erreurs', val:'Messages clairs + relance automatique (à déployer avant vague 2)' },
      { label:'Monitoring', val:'Surveillance manuelle entre chaque vague, ajustements au fil de l\'eau' },
      { label:'Support', val:'Claire seule — charge estimée : 2-3h/semaine' },
    ]},
    { id:'C', titre:'Tous en live (25+)', color:'#991B1B', bg:'#FEF2F2', border:'#EF4444', items:[
      { label:'Préparation', val:'Compte IA dédié + gestion d\'erreurs + relance automatique + test de charge — 2 à 3 semaines minimum' },
      { label:'Compte IA', val:'Compte OpenAI dédié — quota augmenté pour 25+ users simultanés (7 jours d\'activation)' },
      { label:'Formations', val:'Session unique : tous les commerciaux testent le même jour et repartent avec l\'app' },
      { label:'Gestion d\'erreurs', val:'Indispensable — sinon l\'app plante devant 25 personnes' },
      { label:'Crédits IA', val:'Provisionner 5-15€ de crédits pour la session' },
      { label:'Support', val:'Claire temps plein pendant la préparation + jour J' },
    ]},
    { id:'D', titre:'Hybride (test live → accès restreint)', color:'#92400E', bg:'#FFFBEB', border:'#F59E0B', items:[
      { label:'Préparation', val:'Identique à l\'option C — 2 à 3 semaines' },
      { label:'Compte IA', val:'Identique à l\'option C' },
      { label:'Formations', val:'Tout le monde teste le jour J, mais seuls 5-10 commerciaux gardent l\'accès ensuite' },
      { label:'Gestion des accès', val:'Retirer l\'accès à une partie des commerciaux après la session — communication à prévoir' },
      { label:'Risque humain', val:'Frustration des commerciaux qui perdent l\'accès après avoir testé' },
      { label:'Support', val:'Claire temps plein + gestion post-formation' },
    ]},
  ];

  for (const s of SETUPS) {
    h += `<div style="background:${s.bg};border:2px solid ${s.border};border-radius:12px;padding:18px;margin-bottom:12px">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
        <span style="font-size:13px;font-weight:800;color:${s.color};background:#fff;border:2px solid ${s.border};border-radius:50%;width:26px;height:26px;display:flex;align-items:center;justify-content:center">${s.id}</span>
        <span style="font-size:14px;font-weight:800;color:${s.color}">${peSpan('pil_'+s.id+'_titre', s.titre)}</span>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px">`;
    for (let i = 0; i < s.items.length; i++) {
      const it = s.items[i];
      h += `<div style="display:flex;gap:10px;font-size:14px;line-height:1.6">
        <div style="font-weight:700;color:#334155;min-width:130px;flex-shrink:0">${peSpan('pil_'+s.id+'_l'+i, it.label)}</div>
        <div style="color:#64748B">${peSpan('pil_'+s.id+'_v'+i, it.val)}</div>
      </div>`;
    }
    h += `</div></div>`;
  }

  // ── Critères de succès (pour le suivi après) ──
  h += `<details open style="margin-top:20px"><summary style="font-size:16px;font-weight:800;color:#051E50;cursor:pointer">Critères de succès du pilote</summary><div style="margin-top:14px">`;
  const CRITERES = [
    { critere:'Adoption', comment:'% d\'utilisateurs ayant généré au moins 1 pitch', cible:'> 80%' },
    { critere:'Usage', comment:'Nombre total de pitchs générés', cible:'> 100' },
    { critere:'Stabilité', comment:'Erreurs ou lenteurs en production', cible:'< 5' },
    { critere:'Coût réel', comment:'Coûts additionnels IA + surcoût Vercel sur la période', cible:'< 90€' },
    { critere:'Satisfaction', comment:'Retour qualitatif des commerciaux', cible:'Positif' },
  ];
  h += `<table><thead><tr><th>Critère</th><th>Mesure</th><th>Cible</th></tr></thead><tbody>`;
  CRITERES.forEach((r, i) => {
    h += `<tr><td style="font-weight:700">${peSpan('crit_name_'+i, r.critere)}</td><td style="font-size:11px;color:#334155">${peSpan('crit_comment_'+i, r.comment)}</td><td style="font-weight:700;color:#1D4ED8">${peSpan('crit_cible_'+i, r.cible,'color:#1D4ED8')}</td></tr>`;
  });
  h += '</tbody></table></div></details>';

  h += '</div>'; // fin carte
  html('pitch-pilote-widget', h);
}

// ---- Init ----
let pitchInitialized = false;
let vercelBillingAPI = null;
function initPitchSubTabs() {
  renderPitchSynthese();
  renderPitchAValider();
  renderPitchStatusWidget();
  renderPitchFormations();
  renderPitchCouts();
  renderPitchPilote();
  initPitchChecklist();
  renderPitchAmeliorations();
}

/* ---- Synthèse hero (chiffre clé) ---- */
/* ====================== INLINE EDIT SYSTEM ====================== */
const _pitchEdits = JSON.parse(localStorage.getItem('pitch_edits') || '{}');

function pe(key, defaultVal) {
  /* return stored edit or default */
  return _pitchEdits[key] !== undefined ? _pitchEdits[key] : defaultVal;
}

function peSpan(key, defaultVal, extraStyle) {
  /* return an editable span — click text to edit */
  const val = pe(key, defaultVal);
  const edited = _pitchEdits[key] !== undefined ? ' edited' : '';
  const st = extraStyle ? ` style="${extraStyle}"` : '';
  return `<span class="edit-val${edited}" id="pe-${key}"${st} onclick="peStart('${key}')">${val}</span>`;
}

function peStart(key) {
  const el = document.getElementById('pe-' + key);
  if (!el) return;
  el.contentEditable = 'true';
  el.focus();
  /* select all text */
  const range = document.createRange(); range.selectNodeContents(el);
  const sel = window.getSelection(); sel.removeAllRanges(); sel.addRange(range);
  const handler = () => { peSave(key, el); el.removeEventListener('blur', handler); };
  el.addEventListener('blur', handler);
  el.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); el.blur(); }});
}

function peSave(key, el) {
  el.contentEditable = 'false';
  const val = el.textContent.trim();
  _pitchEdits[key] = val;
  el.classList.add('edited');
  localStorage.setItem('pitch_edits', JSON.stringify(_pitchEdits));
}

function peReset() {
  if (!confirm('Réinitialiser toutes les modifications ?')) return;
  localStorage.removeItem('pitch_edits');
  Object.keys(_pitchEdits).forEach(k => delete _pitchEdits[k]);
  initPitchSubTabs();
}

function renderPitchSynthese() {
  const el = $('pitch-synthese-hero');
  if (!el) return;
  let h = '';

  /* --- Situation --- */
  h += `<div style="background:#F8FAFC;border:1px solid #E2E8F0;border-radius:12px;padding:20px;margin-bottom:16px">
    <div style="font-size:18px;font-weight:800;color:#051E50;margin-bottom:14px">${peSpan('s_titre','Situation')}</div>
    <div style="display:flex;flex-direction:column;gap:10px;font-size:14px;color:#334155;line-height:1.7">
      <div>${peSpan('s_1','L\'application Rubix Pitch est <strong>développée et fonctionnelle</strong>.')}</div>
      <div>${peSpan('s_2','3 demandes de support IT ont été faites depuis le 6 février. <strong>Aucune n\'a abouti.</strong>')}</div>
      <div>${peSpan('s_3','Les dates de formation sont fixées. Les commerciaux attendent de tester l\'outil.')}</div>
      <div>${peSpan('s_4','L\'environnement actuel permet de lancer un test, mais il a des <strong>limites de capacité</strong>.')}</div>
    </div>
  </div>`;

  /* --- 4 options --- */
  h += `<div style="font-size:18px;font-weight:800;color:#051E50;margin-bottom:14px">${peSpan('s_opt_titre','4 options possibles')}</div>`;

  const opts = [
    { id:'A', color:'#64748B', bg:'#F8FAFC', border:'#CBD5E1',
      titre: 'On attend l\'IT',
      desc: 'Pas de test tant que l\'IT n\'a pas mis en place l\'infrastructure.',
      testeurs: '0', delai: 'Indéterminé',
      cout: '0€', charge: 'Aucune', limites: 'Aucun risque technique',
      risque: 'Les formations sont repoussées. La crédibilité du projet baisse.',
      verdict: 'Aucun risque technique, mais le projet est bloqué' },
    { id:'B', color:'#166534', bg:'#F0FDF4', border:'#22C55E',
      titre: 'Scalabilité progressive',
      desc: 'On ouvre l\'app par vagues : 5, puis 10, puis 25 utilisateurs.',
      testeurs: '5 → 25', delai: 'Immédiat',
      cout: '~65€ sur 6 semaines', charge: '2-3 h/semaine pendant 6 semaines',
      limites: 'Max 5-10 utilisateurs simultanés au départ. Ajustement entre chaque vague.',
      risque: 'Faible. Les problèmes sont détectés et corrigés entre chaque vague.',
      verdict: 'Recommandé — risque maîtrisé, résultats rapides' },
    { id:'C', color:'#991B1B', bg:'#FEF2F2', border:'#EF4444',
      titre: 'Tout le monde en live',
      desc: 'Tous les commerciaux testent l\'app le même jour et repartent avec.',
      testeurs: '25+', delai: '2-3 semaines de préparation',
      cout: '~85€ sur 6 semaines',
      charge: 'Temps plein pendant 2-3 semaines (compte dédié, fiabilisation, tests de charge)',
      limites: 'Si la préparation n\'est pas terminée : lenteurs, erreurs, app qui plante devant les commerciaux.',
      risque: 'Élevé sans préparation complète. L\'image du projet est en jeu.',
      verdict: 'Ambitieux — faisable uniquement si le calendrier le permet' },
    { id:'D', color:'#92400E', bg:'#FFFBEB', border:'#F59E0B',
      titre: 'Hybride',
      desc: 'Tout le monde teste le jour J, mais seul un petit groupe repart avec l\'app.',
      testeurs: '25+ le jour J → 5-10 ensuite', delai: '2-3 semaines de préparation',
      cout: '~80€ sur 6 semaines',
      charge: 'Temps plein 2-3 semaines + gestion accès post-formation',
      limites: 'Mêmes risques que l\'option C le jour J. Frustration possible des commerciaux qui n\'ont plus accès ensuite.',
      risque: 'Élevé le jour J + risque d\'incompréhension sur le périmètre.',
      verdict: 'Risqué — cumule les contraintes de C avec une communication complexe' },
  ];

  for (const o of opts) {
    h += `<div style="background:${o.bg};border:2px solid ${o.border};border-radius:12px;padding:20px;margin-bottom:14px">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px">
        <span style="font-size:15px;font-weight:800;color:${o.color};background:#fff;border:2px solid ${o.border};border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center">${o.id}</span>
        <span style="font-size:16px;font-weight:800;color:${o.color}">${peSpan('opt_'+o.id+'_titre', o.titre)}</span>
      </div>
      <div style="font-size:14px;color:#334155;margin-bottom:14px">${peSpan('opt_'+o.id+'_desc', o.desc)}</div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:12px">
        <div style="background:#fff;border-radius:8px;padding:12px;text-align:center">
          <div style="font-size:12px;color:#64748B;margin-bottom:4px">Testeurs</div>
          <div style="font-size:16px;font-weight:800;color:${o.color}">${peSpan('opt_'+o.id+'_testeurs', o.testeurs)}</div>
        </div>
        <div style="background:#fff;border-radius:8px;padding:12px;text-align:center">
          <div style="font-size:12px;color:#64748B;margin-bottom:4px">Délai</div>
          <div style="font-size:14px;font-weight:700;color:#334155">${peSpan('opt_'+o.id+'_delai', o.delai)}</div>
        </div>
        <div style="background:#fff;border-radius:8px;padding:12px;text-align:center">
          <div style="font-size:12px;color:#64748B;margin-bottom:4px">Coût</div>
          <div style="font-size:14px;font-weight:700;color:#334155">${peSpan('opt_'+o.id+'_cout', o.cout)}</div>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px;font-size:14px;color:#334155;line-height:1.6">
        <div><strong>Charge :</strong> ${peSpan('opt_'+o.id+'_charge', o.charge)}</div>
        <div><strong>Limites :</strong> ${peSpan('opt_'+o.id+'_limites', o.limites)}</div>
        <div><strong>Risque :</strong> ${peSpan('opt_'+o.id+'_risque', o.risque)}</div>
      </div>
      <div style="margin-top:12px;padding:10px 14px;background:#051E50;border-radius:8px;font-size:14px;font-weight:700;color:#FFD700;text-align:center">
        ${peSpan('opt_'+o.id+'_verdict', o.verdict)}
      </div>
    </div>`;
  }

  h += `<div style="text-align:right;margin-top:4px;margin-bottom:8px">
    <button onclick="peReset()" style="font-size:10px;background:none;border:1px solid #E2E8F0;border-radius:4px;padding:2px 8px;color:#94A3B8;cursor:pointer">Réinitialiser les modifications</button>
  </div>`;

  el.innerHTML = h;
}

/* ---- À valider ---- */
function renderPitchAValider() {
  const el = $('pitch-avalider-widget');
  if (!el) return;
  let h = '';

  h += `<div style="font-size:18px;font-weight:800;color:#051E50;margin-bottom:18px">${peSpan('av_titre','Ce qu\'il faut valider pour avancer')}</div>`;

  const AV_ITEMS = [
    { id:'av1', label:'Budget validé', desc:'De ~65€ (option B) à ~85€ (option C) sur 6 semaines. Inclut crédits IA + surcoût Vercel temporaire. Détail dans l\'onglet Coûts.' },
    { id:'av2', label:'Charge de travail acceptée', desc:'2-3 h/semaine pendant 6 semaines : préparation technique, fiabilisation, accompagnement formations.' },
    { id:'av3', label:'Exclusivité projet', desc:'Pas de développement d\'autres applications pendant cette période. Le temps est dédié à la fiabilisation et au déploiement de Rubix Pitch.' },
    { id:'av4', label:'Télétravail nécessaire', desc:'Le réseau Rubix bloque l\'accès aux outils de développement et d\'hébergement (Vercel, GitHub, API OpenAI). Le travail technique ne peut se faire qu\'en télétravail.' },
    { id:'av5', label:'Limites de capacité acceptées', desc:'L\'environnement actuel supporte un nombre limité d\'utilisateurs simultanés. En progressif c\'est gérable. Si tout le monde se connecte en même temps, il y aura des lenteurs ou des plantages.' },
    { id:'av6', label:'Pas de sauvegarde multi-appareil', desc:'L\'historique des pitchs générés est stocké dans le navigateur. Si un commercial change de poste, il perd son historique. Amélioration prévue mais pas disponible au lancement.' },
    { id:'av7', label:'Incidents possibles le jour J', desc:'C\'est un outil en phase pilote, pas un produit fini. Des lenteurs ou erreurs sont possibles lors d\'une utilisation intensive.' },
    { id:'av8', label:'Suivi des bugs via Teams pendant tout le pilote', desc:'Un canal Teams dédié est nécessaire pour centraliser les remontées d\'incidents. Claire assure le suivi et les corrections tout au long des 6 semaines.' },
    { id:'av9', label:'1 personne pour tester l\'app avant les formations', desc:'Quelqu\'un qui parcourt l\'app et remonte les problèmes. Effort : ~1h. Échéance : 10/03.' },
    { id:'av10', label:'Canal Teams "Rubix Pitch — Retours & Support"', desc:'Demande à l\'IT. Nécessaire avant la 1re formation. Échéance : 28/02.' },
    { id:'av11', label:'Liste des 66 participants (options B, C, D)', desc:'Nom, prénom, profil, session attribuée. À demander aux organisateurs formation. Échéance : 20/03.' },
  ];

  function getAVStatus(id) { return localStorage.getItem('av_check_' + id) || ''; }

  h += `<div style="display:flex;flex-direction:column;gap:6px">`;
  for (const item of AV_ITEMS) {
    const checked = getAVStatus(item.id) === 'done';
    h += `<div style="background:${checked?'#F0FDF4':'#F8FAFC'};border:1px solid ${checked?'#86EFAC':'#E2E8F0'};border-radius:10px;padding:14px 18px;display:flex;gap:14px;align-items:flex-start;cursor:pointer;transition:all .15s" onclick="toggleAVCheck('${item.id}',this)">
      <div style="width:22px;height:22px;border-radius:6px;border:2px solid ${checked?'#22C55E':'#CBD5E1'};background:${checked?'#22C55E':'#fff'};display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px;transition:all .15s">
        ${checked ? '<span style="color:#fff;font-size:14px;font-weight:800">✓</span>' : ''}
      </div>
      <div style="flex:1">
        <div style="font-size:14px;font-weight:700;color:${checked?'#059669':'#051E50'};${checked?'text-decoration:line-through':''}">${peSpan('av_l_'+item.id, item.label)}</div>
        <div style="font-size:13px;color:#64748B;line-height:1.6;margin-top:4px">${peSpan('av_d_'+item.id, item.desc)}</div>
      </div>
    </div>`;
  }
  h += `</div>`;

  el.innerHTML = h;
}

/* ---- Demandes IT ---- */
function renderPitchDemandes() {
  const el = $('pitch-demandes-widget');
  if (!el) return;

  const DEMANDES = [
    { date:'06/02/2026', type:'Call', objet:'Demande initiale de support IT', statut:'sans_suite', detail:'Présentation du besoin : hébergement, domaine, accès serveur. Pas de retour.' },
    { date:'13/02/2026', type:'Call', objet:'Relance', statut:'sans_suite', detail:'Relance sur les accès. Discussion contraintes sécurité. Toujours en attente.' },
    { date:'20/02/2026', type:'Call', objet:'3e relance', statut:'sans_suite', detail:'Aucune avancée. Proposition de lancer en autonomie en attendant.' },
  ];

  const statutMeta = {
    sans_suite: { icon:'🔴', label:'Sans suite', bg:'#FEF2F2', border:'#FECACA', color:'#991B1B' },
    en_cours: { icon:'🟡', label:'En cours', bg:'#FFFBEB', border:'#FDE68A', color:'#92400E' },
    resolu: { icon:'🟢', label:'Résolu', bg:'#F0FDF4', border:'#BBF7D0', color:'#166534' },
  };

  let h = `<div style="display:flex;align-items:center;gap:14px;background:#FEF2F2;border:1px solid #FECACA;border-radius:10px;padding:16px;margin-bottom:16px">
    <div style="font-size:36px;font-weight:800;color:#DC2626;line-height:1">${DEMANDES.length}</div>
    <div>
      <div style="font-size:14px;font-weight:700;color:#991B1B">demandes IT depuis le 6 février</div>
      <div style="font-size:12px;color:#64748B;margin-top:2px">Aucune n'a abouti.</div>
    </div>
  </div>`;

  for (const d of DEMANDES) {
    const sm = statutMeta[d.statut];
    h += `<div style="background:${sm.bg};border:1px solid ${sm.border};border-radius:10px;padding:14px 16px;margin-bottom:8px">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
        <span style="font-size:14px">${sm.icon}</span>
        <span style="font-size:12px;font-weight:700;color:${sm.color}">${d.date}</span>
        <span style="font-size:12px;font-weight:600;color:#334155;flex:1">${d.objet}</span>
        <span style="font-size:10px;padding:2px 8px;border-radius:20px;background:${sm.border};color:${sm.color};font-weight:600">${sm.label}</span>
      </div>
      <div style="font-size:11px;color:#64748B;padding-left:28px">${d.detail}</div>
    </div>`;
  }

  el.innerHTML = h;
}

/* ---- Améliorations prévues (ex-Chantiers) ---- */
const PITCH_AMELIORATIONS = [
  { id:1, label:'Ouverture d\'un compte OpenAI dédié', detail:'Séparer le compte IA de Rubix Pitch de celui de Smart Spec pour éviter les conflits et lever les limites de capacité', impact:'critique', status:'a_faire', retroIds:['s1-1','s1-2','s1-3','s1-4'] },
  { id:2, label:'Meilleure expérience en cas de problème', detail:'Messages clairs et bouton réessayer quand le service est lent ou indisponible', impact:'critique', status:'a_faire', retroIds:['s1-10','s1-11'] },
  { id:3, label:'Relance automatique en cas de surcharge', detail:'Le système réessaye automatiquement au lieu d\'abandonner', impact:'critique', status:'a_faire', retroIds:['s1-12','s1-13','s1-14'] },
  { id:4, label:'Accélération de la génération', detail:'Temps de génération divisé par 2 grâce à l\'exécution en parallèle', impact:'important', status:'a_faire', retroIds:['s2-9'] },
  { id:5, label:'Suivi automatique des incidents', detail:'Journalisation automatique pour détecter et corriger les problèmes rapidement', impact:'important', status:'a_faire', retroIds:['s2-11'] },
  { id:6, label:'Surveillance de la disponibilité', detail:'Alerte automatique par email si le service tombe en panne', impact:'important', status:'a_faire', retroIds:['s2-14'] },
  { id:7, label:'Mise en cache intelligente', detail:'Réutilisation des analyses précédentes pour le même secteur (économie de coûts)', impact:'optimisation', status:'a_faire', retroIds:['s7-3'] },
  { id:8, label:'Mode secours', detail:'Si le service IA est indisponible, l\'app propose le dernier pitch généré', impact:'optimisation', status:'a_faire', retroIds:['s10-4'] },
];

// Compute amélioration status from linked retro actions
function getAmelRetroStatus(amelId) {
  const amel = PITCH_AMELIORATIONS.find(a => a.id === amelId);
  if (!amel || !amel.retroIds || !amel.retroIds.length) return null;
  const statuses = amel.retroIds.map(id => getRS(id));
  const allDone = statuses.every(s => s === 'done');
  const anyStarted = statuses.some(s => s === 'done' || s === 'inprogress');
  if (allDone) return 'fait';
  if (anyStarted) return 'en_cours';
  return 'a_faire';
}

function renderPitchAmeliorations() {
  const el = $('pitch-ameliorations-widget'); if (!el) return;
  const impactLabel = { critique:'Critique', important:'Important', optimisation:'Optimisation' };
  const statusCycle = ['a_faire','en_cours','fait'];
  const statusIcons = { a_faire:'⬜', en_cours:'🔄', fait:'✅' };
  const statusLabels = { a_faire:'À faire', en_cours:'En cours', fait:'Fait' };

  let h = `<div style="font-size:18px;font-weight:800;color:#051E50;margin-bottom:6px">Améliorations prévues</div>`;
  h += `<div style="font-size:13px;color:#64748B;margin-bottom:14px">8 améliorations techniques planifiées pour renforcer la fiabilité et les performances.</div>`;

  h += `<div style="display:flex;flex-direction:column;gap:6px">`;
  for (const a of PITCH_AMELIORATIONS) {
    // Status from retro actions (auto) or manual override
    const retroSt = getAmelRetroStatus(a.id);
    const st = retroSt || pe('amel_status_'+a.id, a.status);
    // Retro progress
    const retroDone = a.retroIds ? a.retroIds.filter(id => getRS(id) === 'done').length : 0;
    const retroTotal = a.retroIds ? a.retroIds.length : 0;
    const retroPct = retroTotal > 0 ? Math.round(retroDone / retroTotal * 100) : 0;

    h += `<div style="background:#fff;border:1px solid ${st==='fait'?'#BBF7D0':st==='en_cours'?'#FDE68A':'#E2E8F0'};border-radius:8px;padding:12px 16px${st==='fait'?';opacity:.7':''}">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">
        <span style="font-size:16px">${statusIcons[st]}</span>
        <span style="font-size:14px;font-weight:700;color:#051E50;flex:1">${a.id}. ${a.label}</span>
        <span class="badge ${a.impact === 'critique' ? 'bd-crit' : ''}" style="font-size:11px">${impactLabel[a.impact]}</span>
      </div>
      <div style="font-size:13px;color:#64748B;padding-left:30px">${a.detail}</div>`;
    // Retro progress bar
    if (retroTotal > 0) {
      h += `<div style="padding-left:28px;margin-top:6px;display:flex;align-items:center;gap:8px">
        <div style="flex:1;height:4px;background:#E5E7EB;border-radius:2px;overflow:hidden;max-width:120px"><div style="width:${retroPct}%;height:100%;background:${retroPct===100?'#22C55E':'#3B82F6'};border-radius:2px"></div></div>
        <span style="font-size:10px;color:${retroPct===100?'#059669':'#64748B'};font-weight:600">${retroDone}/${retroTotal} actions</span>
      </div>`;
    }
    h += `</div>`;
  }
  h += `</div>`;

  h += `<div style="margin-top:18px;padding:16px;background:#EFF6FF;border-radius:10px;border:1px solid #BFDBFE">
    <div style="font-size:14px;font-weight:700;color:#051E50;margin-bottom:6px">Action en cours : création d'un compte IA dédié</div>
    <div style="font-size:13px;color:#334155;line-height:1.6">Actuellement Rubix Pitch partage son compte IA avec Smart Spec. Un compte séparé est en cours de création pour éviter tout risque de coupure.</div>
    <details style="margin-top:10px"><summary style="font-size:12px;color:#64748B;cursor:pointer">Détail technique</summary>
      <div style="font-size:13px;color:#334155;margin-top:8px;line-height:1.8">
        <strong>Capacité actuelle :</strong> ~40 utilisateurs simultanés.<br><strong>Objectif :</strong> ~800 utilisateurs (montée automatique après 46€ + 7 jours).<br><strong>Procédure :</strong> Créer un compte dédié → Carte bancaire → 46€ crédits → Clé API → Mise à jour serveur.
      </div>
    </details>
  </div>`;

  el.innerHTML = h;
}

function peToggleAmel(id) {
  const cycle = ['a_faire','en_cours','fait'];
  const cur = pe('amel_status_'+id, 'a_faire');
  const next = cycle[(cycle.indexOf(cur) + 1) % cycle.length];
  _pitchEdits['amel_status_'+id] = next;
  localStorage.setItem('pitch_edits', JSON.stringify(_pitchEdits));
  renderPitchAmeliorations();
}

// ====================== RÉTROPLANNING ======================

const RETRO_DATA = [
  // ===== PHASE 1 — Prêt pour la formation (25/02 → 17/03) =====
  { date:'2026-02-25', phaseHeader:{ label:'⚡ Phase 1 — Prêt pour la formation  ·  25/02 → 17/03', color:'#1D4ED8', bg:'#DBEAFE' }, milestone:null, actions:[
    { id:'s1-1', text:'Créer compte OpenAI dédié Rubix Pitch', responsable:'CLAIRE', priority:'red' },
    { id:'s1-2', text:'Charger 50$ de crédits sur le nouveau compte', responsable:'CLAIRE', priority:'red' },
    { id:'s1-3', text:'Mettre à jour OPENAI_API_KEY dans Vercel', responsable:'CLAIRE', priority:'red' },
    { id:'s1-4', text:'Tester que l\'app fonctionne avec la nouvelle clé', responsable:'CLAIRE', priority:'red' },
    { id:'s1-5', text:'Créer canal Teams "Rubix Pitch — Retours & Support"', responsable:'CLAIRE', priority:'blue' },
    { id:'s1-20', text:'Demander à l\'IT la création du canal Teams "Rubix Pitch — Retours & Support"', responsable:'CLAIRE', priority:'blue' },
    { id:'s1-21', text:'Demander validation budget 50$ (46€) pour compte OpenAI dédié au manager', responsable:'CLAIRE', priority:'blue' },
  ]},
  { date:'2026-02-26', milestone:null, actions:[
    { id:'s1-6', text:'Corriger bug API Fusion (solutions_selectionnees = [])', responsable:'CLAUDE CODE', priority:'red' },
    { id:'s1-7', text:'Corriger bug API Fusion (tendances_selectionnees = [])', responsable:'CLAUDE CODE', priority:'red' },
    { id:'s1-8', text:'Corriger tendances disparues étape 3', responsable:'CLAUDE CODE', priority:'red' },
    { id:'s1-9', text:'Corriger crédibilité incomplète étape 3', responsable:'CLAUDE CODE', priority:'red' },
  ]},
  // 27/02 (Ven) — fusionné avec 28/02 (Samedi → déplacé)
  { date:'2026-02-27', milestone:null, actions:[
    { id:'s1-10', text:'Implémenter messages d\'erreur UX (timeout, 429, 500, JSON)', responsable:'CLAUDE CODE', priority:'red' },
    { id:'s1-11', text:'Implémenter bouton "Réessayer" sans perte de données saisies', responsable:'CLAUDE CODE', priority:'red' },
    { id:'s1-12', text:'Implémenter timeout frontend 58s (couper avant le 60s Vercel)', responsable:'CLAUDE CODE', priority:'red' },
    { id:'s1-13', text:'Implémenter retry exponential backoff (api/generate-pitch.js)', responsable:'CLAUDE CODE', priority:'red' },
    { id:'s1-14', text:'Implémenter retry exponential backoff (api/generate-fusion.js)', responsable:'CLAUDE CODE', priority:'red' },
    { id:'s1-15', text:'Ajouter bouton "Signaler un problème" → lien canal Teams', responsable:'CLAUDE CODE', priority:'orange' },
    { id:'s1-16', text:'Implémenter login individuel (identifiant + code) → remplacer le mot de passe unique', responsable:'CLAUDE CODE', priority:'orange' },
    { id:'s1-17', text:'Créer fichier users.json sur Vercel Blob (liste utilisateurs avec champ "actif")', responsable:'CLAUDE CODE', priority:'orange' },
    { id:'s1-18', text:'Tester parcours complet — vérifier corrections bugs', responsable:'CLAIRE', priority:'green' },
  ]},
  // Semaine 2 — Matrice + Stabilisation (02/03 → 06/03)
  { date:'2026-03-02', milestone:'📦 Réception nouvelle matrice', actions:[
    { id:'s2-1', text:'Réceptionner la nouvelle matrice', responsable:'CLAIRE', priority:'red' },
    { id:'s2-2', text:'Vérifier les 7 onglets (format, colonnes, données cohérentes)', responsable:'CLAIRE', priority:'red' },
    { id:'s2-3', text:'Uploader nouvelle matrice sur Vercel Blob', responsable:'CLAUDE CODE', priority:'red' },
    { id:'s2-4', text:'Garder ancienne matrice en backup (ne pas supprimer)', responsable:'CLAUDE CODE', priority:'red' },
    { id:'s2-5', text:'Si Tier 2 pas automatique → contacter support OpenAI', responsable:'CLAIRE', priority:'blue' },
  ]},
  { date:'2026-03-03', milestone:null, actions:[
    { id:'s2-6', text:'🧪 Simulation unitaire × 3 combos avec nouvelle matrice (Coût : $0.024)', responsable:'CLAIRE', priority:'green' },
    { id:'s2-7', text:'Corriger régressions si nouvelle matrice casse quelque chose', responsable:'CLAUDE CODE', priority:'red' },
    { id:'s2-8', text:'Implémenter sauvegarde historique multi-device (Vercel Blob par utilisateur)', responsable:'CLAUDE CODE', priority:'orange' },
  ]},
  { date:'2026-03-04', milestone:null, actions:[
    { id:'s2-9', text:'Implémenter parallélisation Promise.all() (useContentGeneration.js)', responsable:'CLAUDE CODE', priority:'orange' },
    { id:'s2-10', text:'🧪 Simulation petit groupe × 5 pitchs ($0.04) — vérifier Promise.all()', responsable:'CLAIRE', priority:'green' },
    { id:'s2-11', text:'Implémenter logging structuré des appels API (console.log JSON)', responsable:'CLAUDE CODE', priority:'orange' },
  ]},
  { date:'2026-03-05', milestone:'💜 Point manager', actions:[
    { id:'s2-12', text:'Point manager : présenter la page /monitoring', responsable:'CLAIRE', priority:'blue' },
    { id:'s2-13', text:'Demander 3-5 testeurs commerciaux volontaires (2 RVE + 1 DE + 1 non-tech) — montrer la page /monitoring en support', responsable:'CLAIRE', priority:'blue' },
    { id:'s2-14', text:'Créer endpoint /api/health (test OpenAI + Blob)', responsable:'CLAUDE CODE', priority:'orange' },
  ]},
  { date:'2026-03-06', milestone:'📋 Point d\'étape', actions:[
    { id:'s2-15', text:'Point d\'étape : démo parcours complet sans bug', responsable:'CLAIRE', priority:'green' },
    { id:'s2-16', text:'Vérifier statut Tier 2 (automatique ? réponse support ?)', responsable:'CLAIRE', priority:'green' },
    { id:'s2-17', text:'Décision : plan 5+5+5 (Tier 1) ou ouverture totale (Tier 2)', responsable:'CLAIRE', priority:'green' },
    { id:'s2-18', text:'Confirmer liste testeurs (noms reçus du point manager)', responsable:'CLAIRE', priority:'blue' },
    { id:'s2-19', text:'Préparer users.json avec les 66 participants', responsable:'CLAIRE', priority:'blue' },
    { id:'s2-20', text:'Décider quota pitchs/jour par utilisateur : 5 (~€72/mois, recommandé) ou 10 (~€146/mois)', responsable:'CLAIRE', priority:'orange' },
    { id:'s2-22', text:'Mettre à jour les métriques Vercel dans la page /monitoring (vercel.com → Dashboard → Usage → copier les chiffres dans VERCEL_USAGE)', responsable:'CLAIRE', priority:'green' },
  ]},
  // Semaine 3 — Bêta test + Simulations (09/03 → 13/03)
  // 07/03 (Sam) + 08/03 (Dim) → déplacés semaine du 09/03
  { date:'2026-03-09', milestone:null, actions:[
    { id:'s3-1', text:'Envoyer accès app aux testeurs + consignes canal Teams', responsable:'CLAIRE', priority:'blue' },
    { id:'s3-2', text:'Corriger bugs remontés par testeurs (au fil de l\'eau)', responsable:'CLAUDE CODE', priority:'orange' },
    { id:'s3-6', text:'🧪 Simulation formation : 22 pitchs / 5 vagues / 3s — Coût : $0.18', responsable:'CLAIRE', priority:'green' },
  ]},
  { date:'2026-03-10', milestone:'🔒 Code freeze', actions:[
    { id:'s3-3', text:'Corrections bugs testeurs', responsable:'CLAUDE CODE', priority:'orange' },
    { id:'s3-4', text:'Vérifier logs Vercel + retours canal Teams', responsable:'CLAIRE', priority:'green' },
    { id:'s3-7', text:'🧪 Simulation stress : 35 pitchs / 7 vagues / 3s — Coût : $0.28', responsable:'CLAIRE', priority:'green' },
    { id:'s3-8', text:'Analyser résultats simulations : taux succès, temps moyen, erreurs', responsable:'CLAIRE', priority:'green' },
    { id:'s3-11', text:'DÉCISION : code freeze si tests OK (reporté 11/03 max si debug)', responsable:'CLAIRE', priority:'green' },
  ]},
  { date:'2026-03-11', milestone:null, actions:[
    { id:'s3-5', text:'Dernières corrections bugs testeurs', responsable:'CLAUDE CODE', priority:'orange' },
    { id:'s3-9', text:'Fix critique uniquement si simulation révèle un problème bloquant', responsable:'CLAUDE CODE', priority:'red' },
    { id:'s3-10', text:'🧪 Retest formation (22 pitchs) si debug effectué — Coût : $0.18', responsable:'CLAIRE', priority:'green' },
  ]},
  { date:'2026-03-12', milestone:null, actions:[
    { id:'s3-12', text:'Uploader fichier users.json final sur Vercel Blob', responsable:'CLAIRE', priority:'blue' },
    { id:'s3-13', text:'Générer 3 pitchs de démo PDF (Agro/Achats, Industrie/Maint, Élec/Prod)', responsable:'CLAIRE', priority:'green' },
    { id:'s3-14', text:'Préparer document "Guide formateur" pour le créneau app', responsable:'CLAIRE', priority:'blue' },
    { id:'s3-15', text:'Bilan testeurs : recueillir feedback final', responsable:'CLAIRE', priority:'green' },
  ]},
  // 13/03 (Ven) — fusionné avec 14/03 (Sam) + 15/03 (Dim)
  { date:'2026-03-13', milestone:null, actions:[
    { id:'s4-1', text:'Test quotidien : générer 1 pitch, vérifier résultat — Coût : $0.008', responsable:'CLAIRE', priority:'green' },
    { id:'s4-2', text:'Confirmer salle + matériel formation 17/03', responsable:'CLAIRE', priority:'blue' },
    { id:'s4-3', text:'Relire guide formateur, valider déroulé créneau app', responsable:'FORMATEUR', priority:'blue' },
    { id:'s4-4', text:'Test quotidien — Coût : $0.008', responsable:'CLAIRE', priority:'green' },
    { id:'s4-5', text:'Identifier les 5 ambassadeurs session 1 (parmi les 22 participants)', responsable:'CLAIRE', priority:'blue' },
    { id:'s4-6', text:'Activer les 5 ambassadeurs dans users.json (actif: true)', responsable:'CLAIRE', priority:'blue' },
  ]},
  { date:'2026-03-16', milestone:'📋 Veille formation', actions:[
    { id:'s4-7', text:'/api/health → tout vert', responsable:'CLAIRE', priority:'green' },
    { id:'s4-8', text:'Vérifier solde crédits OpenAI (platform.openai.com)', responsable:'CLAIRE', priority:'green' },
    { id:'s4-9', text:'Générer 1 pitch test complet → résultat cohérent — Coût : $0.008', responsable:'CLAIRE', priority:'green' },
    { id:'s4-10', text:'Tester depuis un téléphone en 4G (backup wifi)', responsable:'CLAIRE', priority:'green' },
    { id:'s4-11', text:'Vérifier pitchs PDF fallback prêts et accessibles', responsable:'CLAIRE', priority:'green' },
    { id:'s4-12', text:'Vérifier canal Teams accessible par les participants', responsable:'CLAIRE', priority:'green' },
    { id:'s4-13', text:'Vérifier page /monitoring → connaître les points orange/rouge restants', responsable:'CLAIRE', priority:'green' },
  ]},
  { date:'2026-03-17', milestone:'🎯 SESSION 1', actions:[
    { id:'s4-14', text:'8h00 : Ouvrir l\'app + générer 1 pitch pour chauffer', responsable:'CLAIRE', priority:'green' },
    { id:'s4-15', text:'8h00 : Ouvrir logs Vercel dans un onglet', responsable:'CLAIRE', priority:'green' },
    { id:'s4-16', text:'Créneau app (~1h) : guider les 22 participants', responsable:'FORMATEUR', priority:'blue' },
    { id:'s4-17', text:'Si bug en live → montrer le pitch PDF de fallback', responsable:'FORMATEUR', priority:'blue' },
    { id:'s4-18', text:'17h30 : Vérifier les logs — erreurs 429 ? Timeouts ?', responsable:'CLAIRE', priority:'green' },
    { id:'s4-19', text:'17h30 : Confirmer les 5 ambassadeurs → leur partager lien + canal Teams', responsable:'CLAIRE', priority:'blue' },
  ]},
  // ===== PHASE 2 — App solide pour 10 utilisateurs (18/03 → 25/03) =====
  { date:'2026-03-18', phaseHeader:{ label:'🌱 Phase 2 — App solide pour 10 utilisateurs  ·  18/03 → 25/03', color:'#166534', bg:'#DCFCE7' }, milestone:null, actions:[
    { id:'s5-1', text:'Vérifier logs Vercel : les ambassadeurs utilisent l\'app ?', responsable:'CLAIRE', priority:'green' },
    { id:'s5-2', text:'Vérifier canal Teams : bugs remontés ?', responsable:'CLAIRE', priority:'green' },
  ]},
  { date:'2026-03-19', milestone:null, actions:[
    { id:'s5-3', text:'Point rapide ambassadeurs : "Ça marche ? Des soucis ?"', responsable:'CLAIRE', priority:'green' },
    { id:'s5-4', text:'Corriger bugs remontés si besoin', responsable:'CLAUDE CODE', priority:'orange' },
  ]},
  // 20/03 (Ven) — fusionné avec 21/03 (Samedi → déplacé)
  { date:'2026-03-20', milestone:null, actions:[
    { id:'s5-5', text:'Bilan semaine pilote : logs, feedback ambassadeurs, décision suite', responsable:'CLAIRE', priority:'green' },
    { id:'s5-6', text:'Si KO → identifier et corriger avant le 25/03', responsable:'CLAIRE', priority:'green' },
    { id:'s5-7', text:'Relancer les organisateurs formation pour la liste des 66 participants si pas encore reçue (deadline 20/03)', responsable:'CLAIRE', priority:'blue' },
  ]},
  { date:'2026-03-24', milestone:'📋 Veille formation 2', actions:[
    { id:'s6-1', text:'Checklist veille complète (même que 16/03)', responsable:'CLAIRE', priority:'green' },
    { id:'s6-2', text:'Vérifier corrections post-session 1 en place', responsable:'CLAIRE', priority:'green' },
    { id:'s6-3', text:'Activer 5 nouveaux ambassadeurs dans users.json', responsable:'CLAIRE', priority:'blue' },
  ]},
  { date:'2026-03-25', milestone:'🎯 SESSION 2', actions:[
    { id:'s6-4', text:'8h00 : Chauffer l\'app + logs ouverts', responsable:'CLAIRE', priority:'green' },
    { id:'s6-5', text:'Créneau app avec 22 participants', responsable:'FORMATEUR', priority:'blue' },
    { id:'s6-6', text:'17h30 : Vérifier logs', responsable:'CLAIRE', priority:'green' },
    { id:'s6-7', text:'17h30 : Confirmer 5 nouveaux ambassadeurs (total : 10 actifs)', responsable:'CLAIRE', priority:'blue' },
  ]},
  // ===== PHASE 3 — Robustesse + ouverture progressive (30/03 → 08/04+) =====
  { date:'2026-03-30', phaseHeader:{ label:'🚀 Phase 3 — Robustesse + ouverture progressive  ·  30/03 → 08/04+', color:'#92400E', bg:'#FEF9C3' }, milestone:null, actions:[
    { id:'s7-1', text:'Vérifier logs 2×/semaine (lundi + jeudi)', responsable:'CLAIRE', priority:'green' },
    { id:'s7-2', text:'Surveiller canal Teams', responsable:'CLAIRE', priority:'green' },
    { id:'s7-3', text:'Implémenter cache priorisations (préparer ouverture large)', responsable:'CLAUDE CODE', priority:'orange' },
  ]},
  { date:'2026-04-03', milestone:null, actions:[
    { id:'s7-4', text:'Bilan 10 users : stable ? erreurs ? temps de génération ?', responsable:'CLAIRE', priority:'green' },
    { id:'s7-5', text:'Vérifier statut Tier 2', responsable:'CLAIRE', priority:'green' },
    { id:'s7-6', text:'Si Tier 2 → planifier ouverture large après session 3', responsable:'CLAIRE', priority:'blue' },
    { id:'s7-7', text:'Si Tier 1 → rester sur +5 users après session 3', responsable:'CLAIRE', priority:'blue' },
  ]},
  { date:'2026-04-07', milestone:'📋 Veille formation 3', actions:[
    { id:'s9-1', text:'Checklist veille complète', responsable:'CLAIRE', priority:'green' },
    { id:'s9-2', text:'Activer 5 nouveaux ambassadeurs dans users.json', responsable:'CLAIRE', priority:'blue' },
  ]},
  { date:'2026-04-08', milestone:'🎯 SESSION 3', actions:[
    { id:'s9-3', text:'8h00 : Chauffer l\'app + logs', responsable:'CLAIRE', priority:'green' },
    { id:'s9-4', text:'Créneau app avec 22 participants', responsable:'FORMATEUR', priority:'blue' },
    { id:'s9-5', text:'17h30 : Vérifier logs + confirmer 5 ambassadeurs (total : 15 actifs)', responsable:'CLAIRE', priority:'green' },
    { id:'s9-6', text:'Bilan global : 15 users actifs, Tier 1 ou 2, erreurs cumulées', responsable:'CLAIRE', priority:'green' },
  ]},
  // Post-formation
  { date:'2026-04-14', milestone:null, actions:[
    { id:'s10-1', text:'Bilan 15 users → décision ouverture 30 users', responsable:'CLAIRE', priority:'green' },
  ]},
  { date:'2026-04-21', milestone:null, actions:[
    { id:'s10-2', text:'Si Tier 2 → ouverture 66 users', responsable:'CLAIRE', priority:'green' },
    { id:'s10-3', text:'Si Tier 1 → relancer support OpenAI', responsable:'CLAIRE', priority:'blue' },
    { id:'s10-4', text:'Implémenter mode dégradé, monitoring alertes, métriques d\'usage', responsable:'CLAUDE CODE', priority:'orange' },
  ]},
  // ===== BILAN PILOTE =====
  { date:'2026-04-30', milestone:'📋 JALON : Bilan pilote', actions:[
    { id:'s11-1', text:'Bilan pilote : préparer les métriques (adoption, usage, coûts, stabilité)', responsable:'CLAIRE', priority:'blue' },
    { id:'s11-2', text:'Présenter les résultats au manager + IT', responsable:'CLAIRE', priority:'blue' },
    { id:'s11-3', text:'Décision GO/NO GO pour la transition IT', responsable:'CLAIRE', priority:'blue' },
  ]},
];

const PRIO_COLORS  = { red:'#EF4444', orange:'#F59E0B', blue:'#3B82F6', green:'#22C55E' };
const PRIO_LABELS  = { red:'🔴 Bloquant', orange:'🟠 Important', blue:'🔵 Préparation', green:'🟢 Validation' };
const RESP_STYLES  = {
  'CLAIRE':     { bg:'#FFF9E6', color:'#051E50' },
  'CLAUDE CODE':{ bg:'#EFF6FF', color:'#1E40AF' },
  'FORMATEUR':  { bg:'#F0FDF4', color:'#166534' },
};
const S_CYCLE  = ['', 'inprogress', 'done', 'blocked'];
const S_ICONS  = { '':'⬜', inprogress:'🔄', done:'✅', blocked:'❌' };
const S_LABELS = { '':'À faire', inprogress:'En cours', done:'Fait', blocked:'Bloqué' };

let retroFilterResp = 'all';
let retroFilterPrio = 'all';

function getRS(id)      { return localStorage.getItem('retro_' + id) || ''; }
function setRS(id, val) { val === '' ? localStorage.removeItem('retro_' + id) : localStorage.setItem('retro_' + id, val); }

function clickRetroStatus(id) {
  const cur  = getRS(id);
  const next = S_CYCLE[(S_CYCLE.indexOf(cur) + 1) % S_CYCLE.length];
  setRS(id, next);
  // Update pills in roadmap
  document.querySelectorAll(`[data-aid="${id}"] .rm-pill-status`).forEach(b => { b.textContent = S_ICONS[next]; b.title = S_LABELS[next]; });
  document.querySelectorAll(`[data-aid="${id}"]`).forEach(el => { next === 'done' ? el.classList.add('done-card') : el.classList.remove('done-card'); });
  // Update detail panel buttons
  const db = $('rb-' + id); if (db) { db.textContent = S_ICONS[next]; db.title = S_LABELS[next]; }
  const dc = $('rc-' + id); if (dc) { next === 'done' ? dc.classList.add('done-card') : dc.classList.remove('done-card'); }
  updateRetroProgress();
}

function getMilestoneStyle(m) {
  if (!m) return null;
  if (m.includes('SESSION'))  return { bg:'#FFF9E6', border:'#FFD500', color:'#92400E' };
  if (m.includes('freeze'))   return { bg:'#FEF2F2', border:'#EF4444', color:'#DC2626' };
  if (m.includes('manager'))  return { bg:'#F5F3FF', border:'#7C3AED', color:'#6D28D9' };
  if (m.includes('matrice'))  return { bg:'#F0FDF4', border:'#22C55E', color:'#166534' };
  if (m.includes('Bilan'))    return { bg:'#EFF6FF', border:'#3B82F6', color:'#1D4ED8' };
  return { bg:'#EFF6FF', border:'#3B82F6', color:'#1D4ED8' };
}

function getMonday(date) {
  const d = new Date(date); const day = d.getDay();
  d.setDate(d.getDate() + (day === 0 ? -6 : 1 - day)); d.setHours(0,0,0,0); return d;
}

// ── Build weeks data structure ──────────────────────────────────────────────
function buildWeeks() {
  const dateMap = {};
  for (const entry of RETRO_DATA) dateMap[entry.date] = entry;
  const allDates = RETRO_DATA.map(e => new Date(e.date));
  const startMon = getMonday(new Date(Math.min(...allDates)));
  const endMon   = getMonday(new Date(Math.max(...allDates)));
  const phaseDates = RETRO_DATA.filter(e => e.phaseHeader).map(e => e.date);

  const weeks = [];
  let cur = new Date(startMon);
  while (cur <= endMon) {
    const days = [];
    for (let i = 0; i < 5; i++) { const d = new Date(cur); d.setDate(cur.getDate() + i); days.push(d); }
    const entries = days.map(d => dateMap[d.toISOString().split('T')[0]]).filter(Boolean);
    if (entries.length > 0) {
      const mon = new Date(cur);
      const fri = days[4];
      const label = mon.toLocaleDateString('fr-FR',{day:'2-digit',month:'short'}) + '–' + fri.toLocaleDateString('fr-FR',{day:'2-digit',month:'short'});

      // Determine phase for this week
      let phase = 0;
      for (let p = phaseDates.length - 1; p >= 0; p--) {
        if (mon >= new Date(phaseDates[p])) { phase = p; break; }
      }

      // Collect milestones and actions by responsable
      const milestones = entries.filter(e => e.milestone).map(e => e.milestone);
      const actionsByResp = { 'CLAIRE':[], 'CLAUDE CODE':[], 'FORMATEUR':[] };
      for (const entry of entries) {
        for (const a of entry.actions) {
          if (actionsByResp[a.responsable]) actionsByResp[a.responsable].push(a);
          else actionsByResp[a.responsable] = [a];
        }
      }
      weeks.push({ mon, fri, label, phase, milestones, actionsByResp, entries, days });
    }
    cur.setDate(cur.getDate() + 7);
  }
  return weeks;
}

// ── Build week-by-week view with horizontal days ─────────────────────────────
function buildRetroCalendar() {
  const weeks = buildWeeks();
  if (!weeks.length) return '';
  const today0 = new Date(); today0.setHours(0,0,0,0);
  const dayNames = ['Lun','Mar','Mer','Jeu','Ven'];
  const respDot = { 'CLAIRE':'#051E50', 'CLAUDE CODE':'#1E40AF', 'FORMATEUR':'#166534' };

  // Detect formation dates for "evolution" banners
  const formationDates = ['2026-03-17','2026-03-25','2026-04-08'];
  let lastFormation = null;

  let h = '';
  for (let w = 0; w < weeks.length; w++) {
    const wk = weeks[w];
    const isNow = today0 >= wk.mon && today0 <= wk.fri;
    const isPast = wk.fri < today0;

    // Check if a formation happened this week
    const formationThisWeek = wk.entries.find(e => formationDates.includes(e.date));

    // Evolution banner between formations
    if (lastFormation && !formationThisWeek) {
      const nextForm = formationDates.find(d => new Date(d) > new Date(lastFormation));
      if (nextForm && wk.mon <= new Date(nextForm)) {
        // We're between formations — show only on first week after
        const prevDate = new Date(lastFormation).toLocaleDateString('fr-FR',{day:'2-digit',month:'short'});
        const nextDate = new Date(nextForm).toLocaleDateString('fr-FR',{day:'2-digit',month:'short'});
        if (wk.entries[0] && new Date(wk.entries[0].date) > new Date(lastFormation) && !wk._evoBannerShown) {
          h += `<div style="background:linear-gradient(90deg,#EFF6FF,#DBEAFE);border-radius:8px;padding:10px 16px;margin:16px 0;display:flex;align-items:center;gap:10px">
            <span style="font-size:16px">📈</span>
            <div><span style="font-size:12px;font-weight:700;color:#1D4ED8">Evolution entre les formations</span>
            <span style="font-size:11px;color:#64748B;margin-left:8px">${prevDate} → ${nextDate}</span></div>
          </div>`;
        }
      }
    }
    if (formationThisWeek) lastFormation = formationThisWeek.date;

    // Phase header
    const phaseEntry = wk.entries.find(e => e.phaseHeader);
    if (phaseEntry) {
      const ph = phaseEntry.phaseHeader;
      h += `<div style="background:${ph.bg};border-left:4px solid ${ph.color};border-radius:6px;padding:10px 14px;margin:20px 0 8px">
        <span style="font-size:13px;font-weight:800;color:${ph.color}">${ph.label}</span>
      </div>`;
    }

    // All actions count
    const allActions = wk.entries.flatMap(e => e.actions).filter(a => isRetroVisible(a));
    const total = allActions.length;
    const done = allActions.filter(a => getRS(a.id) === 'done').length;
    const pct = total > 0 ? Math.round(done / total * 100) : 0;

    // Week card
    const border = isNow ? '2px solid #FFD700' : isPast ? '1px solid #E5E7EB' : '1px solid #E2E8F0';
    const bg = isNow ? '#FFFBEB' : '#fff';
    h += `<div style="background:${bg};border:${border};border-radius:10px;margin-bottom:10px;overflow:hidden">`;

    // Week header
    h += `<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:${isNow?'#FEF3C7':'#F8FAFC'};border-bottom:1px solid #E5E7EB">`;
    h += `<div style="display:flex;align-items:center;gap:8px">`;
    h += `<span style="font-size:13px;font-weight:800;color:#051E50">Semaine ${wk.label}</span>`;
    if (isNow) h += `<span style="background:#FFD700;color:#92400E;padding:1px 8px;border-radius:10px;font-size:10px;font-weight:700">EN COURS</span>`;
    // Milestones inline
    for (const m of wk.milestones) {
      const ms = getMilestoneStyle(m);
      h += `<span style="background:${ms.bg};color:${ms.color};border:1px solid ${ms.border};padding:1px 8px;border-radius:10px;font-size:10px;font-weight:700">${m}</span>`;
    }
    h += `</div>`;
    h += `<div style="display:flex;align-items:center;gap:6px">
      <span style="font-size:11px;font-weight:700;color:${pct===100?'#059669':'#64748B'}">${done}/${total}</span>
      <div style="width:50px;height:5px;background:#E5E7EB;border-radius:3px;overflow:hidden"><div style="width:${pct}%;height:100%;background:${pct===100?'#22C55E':'#3B82F6'};border-radius:3px"></div></div>
    </div>`;
    h += `</div>`;

    // Days grid (horizontal)
    h += `<div style="display:grid;grid-template-columns:repeat(5,1fr);gap:0">`;
    for (let d = 0; d < 5; d++) {
      const day = wk.days[d];
      const ds = day.toISOString().split('T')[0];
      const entry = wk.entries.find(e => e.date === ds);
      const isToday = ds === today0.toISOString().split('T')[0];
      const dayBg = isToday ? '#FEF9C3' : d % 2 === 0 ? '#FAFAFA' : '#fff';
      const dayBorder = d < 4 ? 'border-right:1px solid #F1F5F9;' : '';

      h += `<div style="padding:8px 6px;min-height:60px;${dayBorder}background:${dayBg}">`;
      h += `<div style="font-size:10px;font-weight:700;color:${isToday?'#92400E':'#94A3B8'};text-transform:uppercase;margin-bottom:4px">${dayNames[d]} ${day.getDate()}/${day.getMonth()+1}</div>`;

      if (entry) {
        // Milestone badge
        if (entry.milestone) {
          const ms = getMilestoneStyle(entry.milestone);
          h += `<div style="background:${ms.bg};color:${ms.color};border:1px solid ${ms.border};border-radius:4px;padding:2px 4px;font-size:9px;font-weight:700;margin-bottom:4px;text-align:center">${entry.milestone}</div>`;
        }
        // Actions (compact list)
        for (const a of entry.actions) {
          if (!isRetroVisible(a)) continue;
          const status = getRS(a.id);
          const bc = PRIO_COLORS[a.priority] || '#94A3B8';
          const isDone = status === 'done';
          const txtSt = isDone ? 'text-decoration:line-through;color:#B0B0B0' : 'color:#334155';
          h += `<div style="display:flex;align-items:flex-start;gap:3px;margin-bottom:2px;font-size:10px;line-height:1.3">`;
          h += `<span style="cursor:pointer;flex-shrink:0" onclick="clickRetroStatus('${a.id}');_weeksCache=null;$('retro-calendar').innerHTML=buildRetroCalendar();updateRetroProgress()" title="${S_LABELS[status]}">${S_ICONS[status]}</span>`;
          h += `<span style="width:4px;height:4px;border-radius:50%;background:${bc};flex-shrink:0;margin-top:4px"></span>`;
          h += `<span style="${txtSt}">${a.text}</span>`;
          h += `</div>`;
        }
      }
      h += `</div>`;
    }
    h += `</div>`; // fin days grid
    h += `</div>`; // fin week card
  }
  return h;
}

// ── Week detail panel (modal) ───────────────────────────────────────────────
let _weeksCache = null;
function openWeekDetail(wIdx) {
  if (!_weeksCache) _weeksCache = buildWeeks();
  const wk = _weeksCache[wIdx];
  if (!wk) return;
  const container = $('retro-detail-container');
  if (!container) return;

  let h = `<div class="rm-detail-overlay" onclick="if(event.target===this)closeWeekDetail()">`;
  h += `<div class="rm-detail-panel">`;
  h += `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
    <div>
      <div style="font-size:16px;font-weight:800;color:#051E50">Semaine du ${wk.label}</div>
      ${wk.milestones.length ? `<div style="font-size:11px;margin-top:4px">${wk.milestones.map(m => { const ms = getMilestoneStyle(m); return `<span style="display:inline-block;background:${ms.bg};color:${ms.color};border:1px solid ${ms.border};padding:2px 8px;border-radius:12px;font-weight:700;font-size:10px;margin-right:4px">${m}</span>`; }).join('')}</div>` : ''}
    </div>
    <div style="display:flex;gap:6px;align-items:center">
      ${wIdx > 0 ? `<button onclick="openWeekDetail(${wIdx-1})" style="padding:4px 10px;border-radius:6px;border:1px solid #E2E8F0;background:#fff;cursor:pointer;font-size:13px" title="Semaine précédente">◀</button>` : ''}
      ${wIdx < (_weeksCache.length-1) ? `<button onclick="openWeekDetail(${wIdx+1})" style="padding:4px 10px;border-radius:6px;border:1px solid #E2E8F0;background:#fff;cursor:pointer;font-size:13px" title="Semaine suivante">▶</button>` : ''}
      <button onclick="closeWeekDetail()" style="padding:4px 10px;border-radius:6px;border:1px solid #E2E8F0;background:#fff;cursor:pointer;font-size:13px;font-weight:700" title="Fermer">✕</button>
    </div>
  </div>`;

  // Group by day
  for (const day of wk.days) {
    const ds = day.toISOString().split('T')[0];
    const entry = wk.entries.find(e => e.date === ds);
    if (!entry) continue;

    const dn = day.toLocaleDateString('fr-FR', { weekday:'long', day:'2-digit', month:'long' });
    const today0 = new Date(); today0.setHours(0,0,0,0);
    const isToday = ds === today0.toISOString().split('T')[0];
    const todayBadge = isToday ? ' <span style="background:#FFD700;color:#92400E;padding:1px 8px;border-radius:10px;font-size:10px;font-weight:700;margin-left:6px">AUJOURD\'HUI</span>' : '';
    const msBadge = entry.milestone ? (() => { const ms = getMilestoneStyle(entry.milestone); return ` <span style="background:${ms.bg};color:${ms.color};border:1px solid ${ms.border};padding:1px 8px;border-radius:10px;font-size:10px;font-weight:700;margin-left:6px">${entry.milestone}</span>`; })() : '';

    h += `<div class="rm-detail-day">`;
    h += `<div class="rm-detail-day-hdr">${dn}${todayBadge}${msBadge}</div>`;

    for (const a of entry.actions) {
      if (!isRetroVisible(a)) continue;
      const status  = getRS(a.id);
      const bc      = PRIO_COLORS[a.priority] || '#94A3B8';
      const rs      = RESP_STYLES[a.responsable] || { bg:'#F1F5F9', color:'#334155' };
      const doneCls = status === 'done' ? ' done-card' : '';
      h += `<div class="rm-detail-card${doneCls}" id="rc-${a.id}" style="border-left-color:${bc}">`;
      h += `<div class="rm-detail-card-text" contenteditable="false" ondblclick="this.contentEditable='true';this.focus()" onblur="saveRetroEdit(this,'${a.id}')" data-aid="${a.id}">${a.text}</div>`;
      h += `<div class="rm-detail-bottom">`;
      h += `<span class="rm-detail-tag" style="background:${rs.bg};color:${rs.color}">${a.responsable}</span>`;
      h += `<button class="rm-detail-status-btn" id="rb-${a.id}" onclick="clickRetroStatus('${a.id}')" title="${S_LABELS[status]}">${S_ICONS[status]}</button>`;
      h += `</div></div>`;
    }
    h += `</div>`;
  }

  h += `</div></div>`;
  container.innerHTML = h;
}

function closeWeekDetail() {
  const c = $('retro-detail-container'); if (c) c.innerHTML = '';
  // Refresh roadmap to reflect status changes
  _weeksCache = null;
  $('retro-calendar').innerHTML = buildRetroCalendar();
}

// ── Inline edit ─────────────────────────────────────────────────────────────
function saveRetroEdit(el, actionId) {
  el.contentEditable = 'false';
  const newText = el.textContent.trim();
  if (!newText) return;
  // Update RETRO_DATA in memory
  for (const entry of RETRO_DATA) {
    const a = entry.actions.find(x => x.id === actionId);
    if (a && a.text !== newText) {
      a.text = newText;
      // Save edits to localStorage
      const edits = JSON.parse(localStorage.getItem('retro_edits') || '{}');
      edits[actionId] = newText;
      localStorage.setItem('retro_edits', JSON.stringify(edits));
      // Update pill text in roadmap
      document.querySelectorAll(`[data-aid="${actionId}"] .rm-pill-text`).forEach(p => { p.textContent = newText; p.title = newText; });
      break;
    }
  }
}

// Restore edits on load
function restoreRetroEdits() {
  const edits = JSON.parse(localStorage.getItem('retro_edits') || '{}');
  for (const [id, text] of Object.entries(edits)) {
    for (const entry of RETRO_DATA) {
      const a = entry.actions.find(x => x.id === id);
      if (a) { a.text = text; break; }
    }
  }
}

function isRetroVisible(a) {
  return (retroFilterResp === 'all' || a.responsable === retroFilterResp) &&
         (retroFilterPrio === 'all' || a.priority === retroFilterPrio);
}

function applyRetroFilters() {
  _weeksCache = null;
  $('retro-calendar').innerHTML = buildRetroCalendar();
}

function updateRetroProgress() {
  let total = 0, done = 0, redRem = 0, orangeRem = 0;
  let nextMilestone = null;
  const today0 = new Date(); today0.setHours(0,0,0,0);
  for (const entry of RETRO_DATA) {
    for (const a of entry.actions) {
      total++;
      if (getRS(a.id) === 'done') done++;
      else { if (a.priority === 'red') redRem++; if (a.priority === 'orange') orangeRem++; }
    }
    if (entry.milestone && !nextMilestone && new Date(entry.date) >= today0)
      nextMilestone = { label: entry.milestone, date: entry.date };
  }
  const pct  = total > 0 ? Math.round(done / total * 100) : 0;
  const nxt  = nextMilestone
    ? `Prochain jalon : <strong>${nextMilestone.label}</strong> (${new Date(nextMilestone.date).toLocaleDateString('fr-FR',{day:'2-digit',month:'short'})})`
    : 'Tous les jalons passés';
  const el = $('retro-prog-wrap'); if (!el) return;
  el.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:6px;margin-bottom:6px">
      <span style="font-weight:700;color:#051E50;font-size:13px">Progression : ${done} / ${total} actions (${pct}%)</span>
      <span style="font-size:11px;color:#64748B">${nxt}</span>
    </div>
    <div class="retro-prog-bar-bg"><div class="retro-prog-bar-fill" style="width:${pct}%"></div></div>
    <div class="retro-prog-stats">
      <span>🔴 Bloquants : <strong>${redRem}</strong></span>
      <span>🟠 Importants : <strong>${orangeRem}</strong></span>
      <span>✅ Terminés : <strong>${done}</strong></span>
    </div>`;
}

function renderRetroFilters() {
  const respOpts = ['all','CLAIRE','CLAUDE CODE','FORMATEUR'];
  const respLbls = { all:'Tous', 'CLAIRE':'Claire', 'CLAUDE CODE':'Claude Code', 'FORMATEUR':'Formateur' };
  const prioOpts = ['all','red','orange','blue','green'];
  const prioLbls = { all:'Toutes priorités', red:'🔴 Bloquant', orange:'🟠 Important', blue:'🔵 Préparation', green:'🟢 Validation' };

  let h = `<div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center;margin-bottom:6px">
    <span style="font-size:10px;font-weight:700;color:#94A3B8;text-transform:uppercase;letter-spacing:.5px;min-width:80px">Responsable</span>`;
  for (const r of respOpts) {
    const act = retroFilterResp === r;
    h += `<button class="retro-filter-btn" onclick="setRetroResp('${r}')" style="background:${act?'#051E50':'#F1F5F9'};color:${act?'#FFD700':'#374151'};border-color:${act?'#051E50':'#E2E8F0'}">${respLbls[r]}</button>`;
  }
  h += `</div><div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center">
    <span style="font-size:10px;font-weight:700;color:#94A3B8;text-transform:uppercase;letter-spacing:.5px;min-width:80px">Priorité</span>`;
  for (const p of prioOpts) {
    const act = retroFilterPrio === p;
    h += `<button class="retro-filter-btn" onclick="setRetroPrio('${p}')" style="background:${act?'#051E50':'#F1F5F9'};color:${act?'#FFD700':'#374151'};border-color:${act?'#051E50':'#E2E8F0'}">${prioLbls[p]}</button>`;
  }
  h += `</div>`;
  const el = $('retro-filters-wrap'); if (el) el.innerHTML = h;
}

function setRetroResp(val) { retroFilterResp = val; renderRetroFilters(); applyRetroFilters(); }
function setRetroPrio(val) { retroFilterPrio = val; renderRetroFilters(); applyRetroFilters(); }

// ── Programme synthétique par option ──────────────────────────────────────
function renderProgrammeSynth() {
  const el = $('programme-synth'); if (!el) return;

  const commonItems = [
    'Ouverture compte OpenAI dédié + crédits',
    peSpan('prog_matrice','Réception nouvelle matrice (<strong>~02/03</strong>) + encodage et tests'),
    'Corrections bugs + fiabilisation',
    'Configuration des appels IA par lots (batch) pour gérer la charge',
    'Login individuel par utilisateur',
    peSpan('prog_qa','1 personne pour tester l\'app et vérifier les bugs avant les formations'),
    'Création canal Teams support',
    'Déploiement obligatoire via Vercel (proxy réseau Rubix bloque les outils de dev)',
  ];

  const options = [
    { id:'A', titre:'Attendre l\'IT', color:'#64748B', bg:'#F8FAFC', border:'#CBD5E1',
      steps:[
        { date:'25/02 → 14/03', label:'Préparation', desc:'Prête mais en attente' },
        { date:'Indéterminé', label:'Attente IT', desc:'Projet en pause — aucun déploiement, aucune formation', accent:true },
      ]
    },
    { id:'B', titre:'Progressif (5→10→15→25)', color:'#166534', bg:'#F0FDF4', border:'#86EFAC',
      steps:[
        { date:'25/02 → 14/03', label:'Préparation', desc:'Compte IA, matrice, corrections, tests' },
        { date:'17/03', label:'Session 1', desc:'Formation 22 pers. — 5 activés', accent:true },
        { date:'18/03 → 24/03', label:'Suivi', desc:'Retours + corrections' },
        { date:'25/03', label:'Session 2', desc:'Formation 22 pers. — 10 actifs', accent:true },
        { date:'08/04', label:'Session 3', desc:'Formation 22 pers. — 15 actifs', accent:true },
        { date:'Avril → Mai', label:'Ouverture', desc:'Montée graduelle → 25+ actifs' },
        { date:'30/04', label:'Bilan pilote', desc:'Résultats + décision suite', accent:true },
      ]
    },
    { id:'C', titre:'Tous en live (25+)', color:'#DC2626', bg:'#FEF2F2', border:'#FECACA',
      steps:[
        { date:'25/02 → 14/03', label:'Préparation', desc:'Compte IA, matrice, corrections, tests de charge' },
        { date:'17/03', label:'Session 1', desc:'22 pers. — tous actifs immédiatement', accent:true },
        { date:'25/03', label:'Session 2', desc:'22 pers. — charge cumulée', accent:true },
        { date:'08/04', label:'Session 3', desc:'22 pers. — corrections urgentes entre sessions', accent:true },
        { date:'30/04', label:'Bilan pilote', desc:'Résultats + décision suite', accent:true },
      ]
    },
    { id:'D', titre:'Hybride — test live + accès limité', color:'#92400E', bg:'#FFFBEB', border:'#FDE68A',
      steps:[
        { date:'25/02 → 14/03', label:'Préparation', desc:'Identique à C' },
        { date:'17/03', label:'Session 1', desc:'Tous testent — seuls 5 gardent l\'accès', accent:true },
        { date:'25/03', label:'Session 2', desc:'Idem — 10 actifs total', accent:true },
        { date:'08/04', label:'Session 3', desc:'Idem — 15 actifs + communication accès', accent:true },
        { date:'30/04', label:'Bilan pilote', desc:'Résultats + décision suite', accent:true },
      ]
    },
  ];

  let h = '<div style="font-size:18px;font-weight:800;color:#051E50;margin-bottom:20px">Programme par option de déploiement</div>';

  // Prerequisite block
  h += `<div style="background:#EFF6FF;border:1px solid #BFDBFE;border-radius:10px;padding:20px;margin-bottom:24px">
    <div style="font-size:15px;font-weight:700;color:#1D4ED8;margin-bottom:10px">📋 Prérequis communs — 25/02 → 14/03</div>
    <div style="display:flex;flex-wrap:wrap;gap:8px">`;
  for (const item of commonItems) {
    h += `<div style="background:#fff;border:1px solid #BFDBFE;border-radius:8px;padding:8px 14px;font-size:13px;color:#334155;line-height:1.5">${item}</div>`;
  }
  h += `</div></div>`;

  // Options — horizontal timeline
  for (const opt of options) {
    h += `<div style="background:${opt.bg};border:1px solid ${opt.border};border-radius:10px;margin-bottom:16px;overflow:hidden">`;
    h += `<div style="padding:14px 20px;border-bottom:1px solid ${opt.border};display:flex;align-items:center;gap:12px">
      <span style="background:${opt.color};color:#fff;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:15px">${opt.id}</span>
      <span style="font-size:16px;font-weight:700;color:${opt.color}">${opt.titre}</span>
    </div>`;

    // Horizontal scrollable timeline
    h += `<div style="padding:20px;overflow-x:auto">`;
    h += `<div style="display:flex;align-items:flex-start;gap:0;min-width:max-content">`;
    for (let i = 0; i < opt.steps.length; i++) {
      const s = opt.steps[i];
      const isLast = i === opt.steps.length - 1;
      const cardBg = s.accent ? '#fff' : 'rgba(255,255,255,0.6)';
      const cardBorder = s.accent ? opt.color : opt.border;
      const dateBg = s.accent ? opt.color : '#94A3B8';

      // Step card
      h += `<div style="display:flex;flex-direction:column;align-items:center;min-width:140px;max-width:180px;position:relative">`;
      // Date badge
      h += `<div style="background:${dateBg};color:#fff;padding:4px 12px;border-radius:20px;font-size:12px;font-weight:700;margin-bottom:10px;white-space:nowrap">${s.date}</div>`;
      // Dot + line
      h += `<div style="display:flex;align-items:center;width:100%;margin-bottom:10px">`;
      if (i > 0) h += `<div style="flex:1;height:3px;background:${opt.border}"></div>`;
      else h += `<div style="flex:1"></div>`;
      h += `<div style="width:14px;height:14px;border-radius:50%;background:${s.accent?opt.color:opt.border};border:3px solid ${cardBg};box-shadow:0 0 0 2px ${s.accent?opt.color:opt.border};flex-shrink:0"></div>`;
      if (!isLast) h += `<div style="flex:1;height:3px;background:${opt.border}"></div>`;
      else h += `<div style="flex:1"></div>`;
      h += `</div>`;
      // Card
      h += `<div style="background:${cardBg};border:2px solid ${cardBorder};border-radius:10px;padding:10px 14px;text-align:center;width:100%">
        <div style="font-size:13px;font-weight:800;color:${opt.color};margin-bottom:4px">${s.label}</div>
        <div style="font-size:12px;color:#475569;line-height:1.5">${s.desc}</div>
      </div>`;
      h += `</div>`;
    }
    h += `</div></div>`;
    h += `</div>`;
  }

  el.innerHTML = h;
}

function initRetro() {
  restoreRetroEdits();
  renderProgrammeSynth();
  _weeksCache = null;
  $('retro-calendar').innerHTML = buildRetroCalendar();
  renderRetroFilters();
  updateRetroProgress();
}

// Bootstrap
(async () => {
  try {
    const resp = await fetch('/api/data');
    if (!resp.ok) throw new Error(`Erreur API ${resp.status}`);
    const d = await resp.json();
    if (d.error) throw new Error(d.error);
    renderAll(d);
    $('loading').style.display = 'none';
    $('main').style.display    = 'block';
  } catch (err) {
    $('loading').innerHTML = `
      <div class="error-box">
        <strong>Erreur de chargement</strong><br><br>${err.message}<br><br>
        <button onclick="location.reload()" style="padding:7px 16px;border-radius:6px;border:none;background:#051E50;color:#FFD700;font-weight:700;cursor:pointer">
          Reessayer
        </button>
      </div>`;
  }
})();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rubix Monitoring</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html{font-size:14px}
body{font-family:'Segoe UI',system-ui,sans-serif;background:#EEF2FF;color:#0F172A;min-height:100vh}

/* Header */
.header{background:#051E50;padding:14px 32px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;box-shadow:0 2px 12px rgba(5,30,80,.3)}
.logo{display:flex;align-items:center;gap:10px}
.logo-icon{width:32px;height:32px;background:#FFD700;border-radius:7px;display:flex;align-items:center;justify-content:center;font-weight:900;color:#051E50;font-size:16px}
.header h1{font-size:17px;font-weight:700;color:#fff}
.header-meta{color:#93C5FD;font-size:11px;text-align:right;line-height:1.6}

/* Nav — Rubix navy + gold */
.nav{background:#051E50;border-bottom:2px solid rgba(255,215,0,.25);position:sticky;top:56px;z-index:99;padding:0 32px;display:flex;overflow-x:auto}
.nav a{padding:11px 16px;font-size:12px;font-weight:600;color:#93C5FD;text-decoration:none;border-bottom:3px solid transparent;white-space:nowrap;transition:all .2s;cursor:pointer;margin-bottom:-2px}
.nav a:hover{color:#fff;border-bottom-color:#FFD700}
.nav a.active{color:#FFD700;border-bottom-color:#FFD700;background:rgba(255,215,0,.1)}

/* Pages */
.page{display:none}
.page.active{display:block}

/* Loading */
.loading{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:80px 20px;gap:14px}
.spinner{width:38px;height:38px;border:3px solid #DBEAFE;border-top-color:#051E50;border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{color:#64748B;font-size:14px}
.error-box{background:#FEE2E2;border:1px solid #FECACA;border-radius:8px;padding:16px 20px;color:#DC2626;font-size:13px;margin:20px auto;max-width:520px;text-align:center}

/* Container */
.container{max-width:1280px;margin:0 auto;padding:20px 24px}

/* Section titles */
.section-title{font-size:15px;font-weight:800;color:#051E50;margin:24px 0 10px;display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.st-bar{width:4px;height:20px;border-radius:3px;flex-shrink:0}

/* Collapsible sections */
.section{background:#fff;border:1px solid #DBEAFE;border-radius:12px;margin-bottom:14px;overflow:hidden;box-shadow:0 1px 6px rgba(5,30,80,.07)}
.section-head{padding:14px 20px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;user-select:none;transition:background .15s}
.section-head:hover{background:#EFF6FF}
.section-head h2{font-size:14px;font-weight:700;color:#051E50;display:flex;align-items:center;gap:8px;margin:0;flex-wrap:wrap}
.chevron{font-size:18px;color:#93C5FD;transition:transform .25s;flex-shrink:0}
.chevron.open{transform:rotate(180deg)}
.section-body{padding:0 20px 16px;display:none}
.section-body.open{display:block}

/* Badges */
.badge{font-size:9px;padding:2px 8px;border-radius:20px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;display:inline-block}
.bv{background:#DBEAFE;color:#1D4ED8}
.bo{background:#ECFDF5;color:#059669}
.bg{background:#DBEAFE;color:#1D4ED8}
.bd{background:#FEE2E2;color:#DC2626}
.bw{background:#FEFCE8;color:#92400E}
.bi{background:#EFF6FF;color:#1D4ED8}

/* Alert grid */
.alert-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:6px}
.alert-block{border-radius:12px;border:1px solid #DBEAFE;overflow:hidden;background:#fff;box-shadow:0 1px 6px rgba(5,30,80,.07)}
.alert-block-head{padding:11px 16px;border-bottom:1px solid #EFF6FF;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.alert-block-head h3{font-size:13px;font-weight:700;color:#051E50;flex:1;white-space:nowrap}
.alert-block-body{padding:10px 14px 12px}
.alert-row{display:flex;align-items:flex-start;gap:8px;padding:6px 10px;border-radius:6px;margin-bottom:4px;font-size:11px;line-height:1.5}
.alert-row:last-of-type{margin-bottom:0}
.alert-icon{font-size:13px;flex-shrink:0;margin-top:1px}
.detail-link{display:block;text-align:right;font-size:11px;font-weight:600;color:#1D4ED8;text-decoration:none;padding:8px 0 0;border-top:1px solid #EFF6FF;margin-top:8px;cursor:pointer}
.detail-link:hover{text-decoration:underline}

/* Capacity cards */
.summary{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px}
.scard{background:#fff;border:1px solid #DBEAFE;border-radius:12px;padding:14px;position:relative;overflow:hidden;box-shadow:0 1px 6px rgba(5,30,80,.07)}
.stop{width:100%;height:4px;position:absolute;top:0;left:0}
.slabel{font-size:9px;text-transform:uppercase;letter-spacing:1.2px;color:#64748B;margin-bottom:2px;font-weight:600;margin-top:6px}
.sval{font-size:22px;font-weight:800;color:#051E50}
.sdetail{font-size:11px;color:#94A3B8;margin-top:1px}
.stop-gold{background:#FFD700}.stop-green{background:#00D26A}.stop-blue{background:#051E50}.stop-purple{background:#8B5CF6}

/* Limit bars */
.limits-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.limit-item{padding:12px;background:#F8FAFF;border-radius:8px;border:1px solid #DBEAFE}
.limit-label{font-size:12px;font-weight:600;color:#334155;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:4px}
.limit-bar{height:7px;background:#DBEAFE;border-radius:4px;overflow:hidden;margin-bottom:4px}
.limit-fill{height:100%;border-radius:4px;transition:width .5s ease}
.fill-ok{background:linear-gradient(90deg,#00D26A,#34D399)}
.fill-warn{background:linear-gradient(90deg,#FFD700,#FCD34D)}
.fill-danger{background:linear-gradient(90deg,#EF4444,#DC2626)}
.limit-detail{font-size:10px;color:#94A3B8}

/* Per-app breakdown */
.per-app-breakdown{margin-top:8px;border-top:1px dashed #DBEAFE;padding-top:6px}
.per-app-row{display:flex;align-items:center;gap:6px;padding:2px 0}
.per-app-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.per-app-name{width:110px;color:#334155;font-weight:600;flex-shrink:0;font-size:10px}
.per-app-bar-wrap{flex:1;height:5px;background:#DBEAFE;border-radius:3px;overflow:hidden}
.per-app-bar{height:100%;border-radius:3px;min-width:2px}
.per-app-val{font-size:10px;color:#64748B;white-space:nowrap;min-width:100px;text-align:right}

/* Projection badges */
.proj-badge{display:inline-block;font-size:9px;padding:2px 7px;border-radius:10px;font-weight:700}
.proj-ok{background:#ECFDF5;color:#059669}
.proj-warn{background:#FEFCE8;color:#92400E}
.proj-danger{background:#FEE2E2;color:#DC2626}

/* Tables */
table{width:100%;border-collapse:collapse}
th,td{text-align:left;padding:7px 12px;border-bottom:1px solid #EFF6FF;font-size:13px}
th{color:#1D4ED8;font-weight:600;font-size:10px;text-transform:uppercase;letter-spacing:.5px;background:#EFF6FF}

/* App meta */
.app-meta{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px}
.meta-card{padding:10px 14px;background:#F8FAFF;border-radius:8px;border:1px solid #DBEAFE}
.meta-label{font-size:10px;color:#94A3B8;text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px}
.meta-val{font-size:13px;font-weight:700;color:#051E50;display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.status-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;background:#94A3B8}

/* Mini metrics */
.mini-metrics{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:14px;padding-top:12px;border-top:1px solid #DBEAFE}
.mini-metric{text-align:center;padding:8px 4px;background:#EFF6FF;border-radius:8px}
.mini-val{font-size:16px;font-weight:800;color:#051E50}
.mini-label{font-size:9px;color:#64748B;text-transform:uppercase;letter-spacing:.5px;margin-top:2px}

/* Threshold blocks */
.thr-d{padding:10px;background:#FEE2E2;border-radius:8px;border:1px solid #FECACA;margin-top:10px}
.thr-w{padding:10px;background:#FEFCE8;border-radius:8px;border:1px solid #FFD700;margin-top:10px}
.thr-i{padding:10px;background:#EFF6FF;border-radius:8px;border:1px solid #BFDBFE;margin-top:10px}
.thr-d h4{font-size:12px;font-weight:700;color:#DC2626;margin-bottom:6px}
.thr-w h4{font-size:12px;font-weight:700;color:#92400E;margin-bottom:6px}
.thr-i h4{font-size:12px;font-weight:700;color:#1D4ED8;margin-bottom:6px}

/* Recommendations */
.reco{margin-top:10px;padding:10px;background:#EFF6FF;border-radius:8px;border:1px solid #BFDBFE}
.reco h4{font-size:11px;font-weight:700;color:#1D4ED8;margin-bottom:5px}
.reco p{font-size:11px;color:#334155;padding:2px 0}

/* Buttons */
.links{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
.btn{font-size:11px;padding:6px 12px;border-radius:6px;text-decoration:none;font-weight:600;display:inline-block;transition:all .2s}
.btn-g{background:#FEFCE8;color:#92400E;border:1px solid #FFD700}
.btn-g:hover{background:#FFD700;color:#051E50}
.btn-o{background:#ECFDF5;color:#059669;border:1px solid #A7F3D0}
.btn-o:hover{background:#059669;color:#fff}
.btn-v{background:#EFF6FF;color:#051E50;border:1px solid #BFDBFE}
.btn-v:hover{background:#051E50;color:#fff}

/* Footer */
.footer{text-align:center;padding:16px;color:#94A3B8;font-size:11px;margin-top:8px}

@media(max-width:900px){
  .alert-grid{grid-template-columns:1fr}
  .limits-grid{grid-template-columns:1fr}
  .summary{grid-template-columns:repeat(2,1fr)}
  .app-meta{grid-template-columns:1fr}
  .mini-metrics{grid-template-columns:repeat(2,1fr)}
  .nav{padding:0 12px}
  .header{padding:12px 16px}
  .container{padding:16px 12px}
}

/* ====================== RÉTROPLANNING ====================== */
.retro-prog-wrap{background:#F8FAFC;border:1px solid #DBEAFE;border-radius:10px;padding:14px 18px;margin-bottom:14px}
.retro-prog-bar-bg{background:#E2E8F0;border-radius:4px;height:8px;margin:8px 0}
.retro-prog-bar-fill{background:linear-gradient(90deg,#051E50,#3B82F6);border-radius:4px;height:8px;transition:width .5s}
.retro-prog-stats{display:flex;gap:16px;flex-wrap:wrap;font-size:11px;color:#64748B}
.retro-filter-btn{font-size:11px;font-weight:600;padding:4px 12px;border-radius:20px;border:1px solid #E2E8F0;cursor:pointer;transition:all .15s;white-space:nowrap}
.retro-filter-btn:hover{border-color:#051E50}
.retro-week{margin-bottom:24px}
.retro-week-label{font-size:11px;font-weight:700;color:#64748B;text-transform:uppercase;letter-spacing:.8px;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid #E2E8F0}
.retro-days{display:flex;gap:10px;overflow-x:auto;padding-bottom:10px}
.retro-day{min-width:200px;flex-shrink:0}
.retro-phase-header{font-size:13px;font-weight:800;padding:10px 18px;border-radius:8px;border:2px solid;text-align:center;margin:20px 0 6px;letter-spacing:.4px}
.retro-milestone-banner{font-size:10px;font-weight:700;padding:4px 8px;border-radius:6px 6px 0 0;text-align:center;border:1px solid;border-bottom:none}
.retro-day-header{background:#F8FAFC;border:1px solid #E2E8F0;border-bottom:none;padding:7px 10px;text-align:center;border-radius:7px 7px 0 0}
.retro-day.today .retro-day-header{border:2px solid #FFD700;border-bottom:none;background:#FFFBEB}
.retro-day.past-all .retro-day-header{opacity:.55}
.retro-day-date{font-size:12px;font-weight:700;color:#051E50}
.retro-day-name{font-size:10px;color:#94A3B8;text-transform:capitalize}
.retro-cards{border:1px solid #E2E8F0;border-top:none;border-radius:0 0 7px 7px;padding:8px;min-height:50px;background:#fff}
.retro-day.today .retro-cards{border:2px solid #FFD700;border-top:none}
.retro-day.past-all .retro-cards{opacity:.55}
.retro-card{background:#fff;border-radius:7px;border:1px solid #E5E7EB;border-left:4px solid;padding:9px 9px 7px;margin-bottom:6px;transition:opacity .2s}
.retro-card.hidden{display:none}
.retro-card.done-card{opacity:.55}
.retro-card-text{font-size:12px;color:#374151;line-height:1.4;margin-bottom:7px}
.retro-card-bottom{display:flex;align-items:center;justify-content:space-between;gap:4px}
.retro-tag{font-size:9px;font-weight:700;padding:2px 7px;border-radius:10px;white-space:nowrap}
.retro-status-btn{width:22px;height:22px;border:none;background:none;cursor:pointer;font-size:14px;line-height:1;padding:0;flex-shrink:0}
.retro-empty{color:#CBD5E1;font-size:11px;text-align:center;padding:14px 0}
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div class="logo">
    <div class="logo-icon">R</div>
    <h1>Rubix Monitoring</h1>
  </div>
  <div class="header-meta">
    <div id="period-label">Chargement...</div>
    <div id="generated-at"></div>
  </div>
</div>

<!-- NAV -->
<nav class="nav" id="nav">
  <a class="active" onclick="showTab('alertes')">Alertes</a>
  <a onclick="showTab('pole')">Pôle Acquisition</a>
  <a onclick="showTab('pitch')">Pitch Generator</a>
  <a onclick="showTab('smart')">Smart Content</a>
  <a onclick="showTab('vercel')">Capacité Vercel</a>
  <a onclick="showTab('couts')">Coûts</a>
  <a onclick="showTab('retro')">📆 Rétroplanning</a>
</nav>

<!-- LOADING -->
<div id="loading" class="loading">
  <div class="spinner"></div>
  <div class="loading-text">Chargement des donnees...</div>
</div>

<!-- MAIN -->
<div id="main" style="display:none">

  <!-- ONGLET ALERTES -->
  <div class="page active" id="page-alertes">
  <div class="container">
    <div class="section-title">
      <div class="st-bar" style="background:#EF4444"></div>
      Alertes et blockers
      <span class="badge bd" id="count-danger">0 CRITIQUE</span>
      <span class="badge bw" id="count-warn">0 ATTENTION</span>
    </div>

    <div class="alert-grid">

      <div class="alert-block" style="border-top:3px solid #FFD700">
        <div class="alert-block-head">
          <div style="width:10px;height:10px;border-radius:50%;background:#FFD700;flex-shrink:0"></div>
          <h3>Pôle Acquisition</h3>
          <span class="badge bg">GEMINI FREE TIER</span>
          <span class="badge bd">BLOCKER #1</span>
        </div>
        <div class="alert-block-body">
          <div class="alert-row" style="background:#FEE2E2">
            <span class="alert-icon" style="color:#DC2626">&#9888;</span>
            <span style="color:#DC2626">FREE TIER bloqué à 5+ users simultanées (15 appels/min). Migrer vers GCP billing pour scaler.</span>
          </div>
          <div class="alert-row" style="background:#F0F4FF">
            <span class="alert-icon" style="color:#3B82F6">&#9432;</span>
            <span style="color:#3B82F6">Quota jour : 1 500 appels/jour = max 150 users/jour (limite fixée à 10 appels/user/jour)</span>
          </div>
          <a class="detail-link" onclick="showTab('pole')">Voir détails Pôle Acquisition</a>
        </div>
      </div>

      <div class="alert-block" style="border-top:3px solid #8B5CF6">
        <div class="alert-block-head">
          <div style="width:10px;height:10px;border-radius:50%;background:#8B5CF6;flex-shrink:0"></div>
          <h3>Pitch Generator</h3>
          <span class="badge bo">OPENAI TIER 1</span>
        </div>
        <div class="alert-block-body">
          <div class="alert-row" style="background:#FEFCE8">
            <span class="alert-icon" style="color:#D97706">&#9888;</span>
            <span style="color:#D97706">6+ appels OpenAI par pitch (5 priorisations + 1 génération) paralléliser avec Promise.all</span>
          </div>
          <div class="alert-row" style="background:#FEFCE8">
            <span class="alert-icon" style="color:#D97706">&#9888;</span>
            <span style="color:#D97706">Polling Assistant API ~55s frôle le timeout 60s Vercel. Risque d'échec sur pitchs complexes.</span>
          </div>
          <a class="detail-link" onclick="showTab('pitch')">Voir détails Pitch Generator</a>
        </div>
      </div>

      <div class="alert-block" style="border-top:3px solid #00D26A">
        <div class="alert-block-head">
          <div style="width:10px;height:10px;border-radius:50%;background:#00D26A;flex-shrink:0"></div>
          <h3>Smart Content</h3>
          <span class="badge bg">GEMINI GCP</span>
        </div>
        <div class="alert-block-body">
          <div class="alert-row" style="background:#FEFCE8">
            <span class="alert-icon" style="color:#D97706">&#9888;</span>
            <span style="color:#D97706">Crédits promo GCP : ~50 contenus couverts. Surveiller la console GCP avant épuisement.</span>
          </div>
          <div class="alert-row" style="background:#ECFDF5">
            <span class="alert-icon" style="color:#059669">&#10003;</span>
            <span style="color:#059669">Streaming + retry/backoff 429 déjà en place pas de risque de timeout Vercel</span>
          </div>
          <a class="detail-link" onclick="showTab('smart')">Voir détails Smart Content</a>
        </div>
      </div>

      <div class="alert-block" style="border-top:3px solid #CBD5E1">
        <div class="alert-block-head">
          <div style="width:10px;height:10px;border-radius:50%;background:#94A3B8;flex-shrink:0"></div>
          <h3>Global Vercel &amp; Claude</h3>
          <span class="badge bv">PARTAGE</span>
        </div>
        <div class="alert-block-body">
          <div id="global-dyn-alerts"></div>
          <div class="alert-row" style="background:#F0F4FF">
            <span class="alert-icon" style="color:#3B82F6">&#9432;</span>
            <span style="color:#3B82F6">Concurrent Builds : 1 seul build à la fois, les 3 apps partagent la queue</span>
          </div>
          <div class="alert-row" style="background:#FEFCE8">
            <span class="alert-icon" style="color:#D97706">&#9432;</span>
            <span style="color:#D97706">Claude Code Max 5x : fenêtre glissante 5h + plafond hebdo non documenté, pas d'API quota</span>
          </div>
          <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
            <a href="https://claude.ai/settings/usage" target="_blank" class="btn btn-g">Vérifier quota Claude</a>
            <a href="https://claude.ai" target="_blank" class="btn btn-v">Claude en ligne (secours)</a>
          </div>
        </div>
      </div>

      <div class="alert-block" style="border-top:3px solid #EF4444;grid-column:1/-1">
        <div class="alert-block-head">
          <div style="width:10px;height:10px;border-radius:50%;background:#EF4444;flex-shrink:0"></div>
          <h3>Bug lié à l'environnement Rubix</h3>
          <span class="badge bd">PROXY ENTREPRISE</span>
          <span class="badge bd">RESEAU</span>
        </div>
        <div class="alert-block-body">
          <div class="alert-row" style="background:#FEE2E2">
            <span class="alert-icon" style="color:#DC2626">&#9888;</span>
            <span style="color:#DC2626"><strong>Claude Code bloqué sur réseau Rubix</strong> : proxy / pare-feu bloque les connexions API (ConnectionRefused, timeout). VS Code fonctionne, mais Claude Code ne peut pas contacter les serveurs Claude. Contournement : utiliser Claude dans le navigateur au bureau.</span>
          </div>
          <div class="alert-row" style="background:#FEE2E2">
            <span class="alert-icon" style="color:#DC2626">&#9888;</span>
            <span style="color:#DC2626"><strong>ERR_CERT_COMMON_NAME_INVALID</strong> : le proxy SSL d'entreprise (Zscaler) intercepte et re-scelle les connexions HTTPS. Le certificat recus ne correspond pas au site contacte.</span>
          </div>
          <div class="alert-row" style="background:#FEE2E2">
            <span class="alert-icon" style="color:#DC2626">&#9888;</span>
            <span style="color:#DC2626"><strong>ERR_NETWORK_CHANGED / ERR_INTERNET_DISCONNECTED</strong> : bascule VPN, changement de WiFi ou mise en veille coupe la connexion en cours de génération (90 a 180s). L'article reste bloqué en PROCESSING dans Google Sheets.</span>
          </div>
          <div class="alert-row" style="background:#FEFCE8">
            <span class="alert-icon" style="color:#D97706">&#9888;</span>
            <span style="color:#D97706">Solution : déplacer la génération côté serveur Vercel. Le navigateur ne fait qu'un seul appel court, Vercel gère les appels Gemini en interne (serveur à serveur, sans proxy).</span>
          </div>
          <a class="detail-link" onclick="showTab('smart')">Voir le plan d'action dans Smart Content</a>
        </div>
      </div>

    </div>
  </div>
  </div>

  <!-- ONGLET POLE ACQUISITION -->
  <div class="page" id="page-pole">
  <div class="container">
    <div class="section-title">
      <div class="st-bar" style="background:#FFD700"></div>
      Pôle Acquisition
      <span class="badge bg">GEMINI FREE TIER</span>
      <span class="badge bd">BLOCKER #1</span>
    </div>

    <div class="section">
      <div class="section-head" onclick="toggle(this)">
        <h2>
          <span class="status-dot" id="pole-dot"></span>
          rubix-pole-acquisition.vercel.app
        </h2>
        <span class="chevron open">&#9662;</span>
      </div>
      <div class="section-body open">
        <div class="app-meta">
          <div class="meta-card">
            <div class="meta-label">Dernier déploiement</div>
            <div class="meta-val" id="pole-last-deploy"></div>
          </div>
          <div class="meta-card">
            <div class="meta-label">Fournisseur IA</div>
            <div class="meta-val"><span class="badge bg">Gemini 2.0 Flash</span>&nbsp;Google AI Studio</div>
          </div>
        </div>

        <table>
          <thead><tr><th>Action utilisateur</th><th>Appels IA</th><th>Tokens estimes</th><th>Grounding</th></tr></thead>
          <tbody>
            <tr><td style="font-weight:600">Recherche infos entreprise</td><td>1 appel Gemini</td><td>1 500 a 4 000</td><td style="color:#D97706;font-weight:600">+ Google Search</td></tr>
            <tr><td style="font-weight:600">Matcher produits / services</td><td>1 appel Gemini</td><td>1 500 a 4 000</td><td style="color:#D97706;font-weight:600">+ Google Search</td></tr>
            <tr><td style="font-weight:600">Trouver fournisseurs</td><td>1 appel Gemini</td><td>1 500 a 4 000</td><td style="color:#D97706;font-weight:600">+ Google Search</td></tr>
            <tr><td style="font-weight:600">Rédiger email</td><td>1 appel Gemini</td><td>1 000 a 2 000</td><td>Non</td></tr>
            <tr><td style="font-weight:600">Orchestrateur (analyse)</td><td>1 appel Gemini</td><td>500 a 1 000</td><td>Non</td></tr>
          </tbody>
        </table>

        <div class="thr-d">
          <h4>Seuils de blocage Free tier AI Studio : 15 appels/min / 1 500 appels/jour</h4>
          <table>
            <thead><tr><th>Users simultanées</th><th>Appels IA/min</th><th>vs Limite 15 appels/min</th><th>Statut</th></tr></thead>
            <tbody>
              <tr><td>1 a 3 users</td><td>3 a 9 appels/min</td><td style="color:#059669">OK (60%)</td><td><span class="proj-badge proj-ok">OK</span></td></tr>
              <tr><td>5 users</td><td>10 a 15 appels/min</td><td style="color:#D97706">Limite (100%)</td><td><span class="proj-badge proj-warn">RISQUE</span></td></tr>
              <tr><td>10+ users</td><td>20 a 30+ appels/min</td><td style="color:#DC2626;font-weight:700">DÉPASSÉ (200%+)</td><td><span class="proj-badge proj-danger">BLOQUÉ</span></td></tr>
            </tbody>
          </table>
          <div style="font-size:11px;color:#DC2626;margin-top:6px">
            <strong>Quota jour :</strong> 1 500 appels/jour. Limite fixée à <strong>10 appels/user/jour</strong> = max 150 users/jour.
          </div>
        </div>

        <div style="margin-top:10px;padding:10px;background:#ECFDF5;border-radius:7px;border:1px solid #A7F3D0">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
            <span style="font-size:12px;font-weight:700;color:#059669">Sécurité timeout Vercel</span>
            <span class="proj-badge proj-ok">HAUTE</span>
          </div>
          <div style="font-size:11px;color:#334155">Chaque appel Gemini repond en 2 a 8s. Largement sous le timeout de 60s.<br>Marge de sécurité : 90%+ — aucune modification nécessaire.</div>
        </div>

        <div class="reco">
          <h4>Recommandations pour scaler</h4>
          <p>1. <strong>Batcher les appels grounding</strong> : combiner infos entreprise + matcher + fournisseur en 1 seul appel multi-tool (divise par 3)</p>
          <p>2. <strong>Cacher les resultats</strong> : même entreprise = meme recherche, cacher 24h (Redis / KV Vercel)</p>
          <p>3. <strong>Migrer vers GCP billing</strong> à partir de 5 users : 1 500 appels/min au lieu de 15 (x100)</p>
          <p>4. <strong>Queue + rate limiter côté serveur</strong> : limiter à 10 appels/min et mettre les requêtes en file d'attente</p>
        </div>

        <div class="mini-metrics">
          <div class="mini-metric"><div class="mini-val" id="pole-build"></div><div class="mini-label">Build min</div></div>
          <div class="mini-metric"><div class="mini-val" id="pole-bw"></div><div class="mini-label">Bandwidth</div></div>
          <div class="mini-metric"><div class="mini-val" id="pole-fninv"></div><div class="mini-label">Fn Invocations</div></div>
          <div class="mini-metric"><div class="mini-val" id="pole-fndur"></div><div class="mini-label">Fn Duration</div></div>
        </div>

        <div class="links">
          <a href="https://aistudio.google.com/app/apikey" target="_blank" class="btn btn-g">AI Studio usage</a>
          <a href="https://console.cloud.google.com/apis/dashboard?project=app-acquisition-487813" target="_blank" class="btn btn-g">GCP Console</a>
        </div>
      </div>
    </div>
  </div>
  </div>

  <!-- ONGLET PITCH GENERATOR -->
  <div class="page" id="page-pitch">
  <div class="container">
    <div class="section-title">
      <div class="st-bar" style="background:#8B5CF6"></div>
      Pitch Generator
      <span class="badge bo">OPENAI TIER 1</span>
    </div>

    <div class="section">
      <div class="section-head" onclick="toggle(this)">
        <h2>
          <span class="status-dot" id="pitch-dot"></span>
          rubix-pitch.vercel.app
        </h2>
        <span class="chevron open">&#9662;</span>
      </div>
      <div class="section-body open">
        <div class="app-meta">
          <div class="meta-card">
            <div class="meta-label">Dernier déploiement</div>
            <div class="meta-val" id="pitch-last-deploy"></div>
          </div>
          <div class="meta-card">
            <div class="meta-label">Coût / pitch complet (6 appels)</div>
            <div class="meta-val" id="pitch-cost-per-pitch"></div>
          </div>
        </div>

        <div style="margin-bottom:14px;padding:12px 14px;background:#FEFCE8;border-radius:8px;border:1px solid #FFD700">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
            <span style="font-size:13px;font-weight:700;color:#92400E">⚠️ Compte OpenAI partagé — aucun budget dédié</span>
            <span class="proj-badge proj-danger">RISQUE</span>
          </div>
          <div style="font-size:12px;color:#78350F;line-height:1.6">
            Rubix Pitch est rattaché au compte OpenAI de <strong>Smart Spec</strong> (pas de compte séparé).<br>
            Si Smart Spec consomme tous les crédits, <strong>Pitch Generator s'arrête immédiatement</strong> sans préavis.
          </div>
          <div style="margin-top:8px;padding:8px;background:#FEFCE8;border-radius:6px;font-size:11px;color:#334155">
            <strong style="color:#D97706">Action à faire :</strong> Créer un compte OpenAI dédié pour Rubix Pitch avec un budget séparé. Mettre à jour la variable d'environnement <code style="background:#F1F5F9;padding:1px 4px;border-radius:3px">OPENAI_API_KEY</code> dans Vercel.
          </div>
        </div>

        <table>
          <thead><tr><th>Action utilisateur</th><th>Appels IA</th><th>Modele</th><th>Detail pipeline</th></tr></thead>
          <tbody>
            <tr><td style="font-weight:600">Analyser contexte</td><td>1 appel</td><td>gpt-3.5-turbo</td><td>Identification enjeux metier</td></tr>
            <tr style="border-top:2px solid #E2E8F0">
              <td style="font-weight:600" rowspan="3">Générer pitch (3 versions)</td>
              <td style="font-weight:700;color:#D97706">6+ appels</td>
              <td>gpt-3.5-turbo + Assistant</td>
              <td style="font-size:10px;color:#D97706">Pipeline ci-dessous</td>
            </tr>
            <tr><td colspan="3" style="font-size:10px;color:#64748B;padding-left:20px">1. Prioriser solutions &nbsp; 2. Prioriser questions &nbsp; 3. Prioriser tendances &nbsp; 4. Prioriser credibilite &nbsp; 5. Prioriser pyramide &nbsp; 6. Génération finale (Assistant API)</td></tr>
            <tr><td colspan="3" style="font-size:10px;color:#059669;padding-left:20px">Les 5 priorisations peuvent etre parallélisées avec Promise.all()</td></tr>
            <tr><td style="font-weight:600">Générer one-pager</td><td>6+ appels</td><td>Assistant API</td><td>Meme pipeline priorisation + fusion</td></tr>
          </tbody>
        </table>

        <div class="thr-i">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;flex-wrap:wrap">
            <h4 style="margin:0">Capacité OpenAI — Tier actuel</h4>
            <span class="proj-badge proj-warn">TIER 1 — 500 appels/min</span>
          </div>
          <div style="font-size:11px;color:#334155;margin-bottom:8px">Un pitch complet = <strong>6 appels API</strong>. En pic (tout le monde génère en même temps le matin), le risque de blocage commence dès <strong>40-50 users simultanés</strong>.</div>
          <table>
            <thead><tr><th>Users simultanés</th><th>Appels/min</th><th>vs Limite 500</th><th>Statut</th></tr></thead>
            <tbody>
              <tr><td>1 à 10 users</td><td>6 à 60 appels/min</td><td style="color:#059669">OK (12%)</td><td><span class="proj-badge proj-ok">OK</span></td></tr>
              <tr><td>40-50 users (pic)</td><td>240-300 appels/min</td><td style="color:#D97706;font-weight:700">Risque en pic (60%)</td><td><span class="proj-badge proj-warn">ATTENTION</span></td></tr>
              <tr><td>80+ users</td><td>480+ appels/min</td><td style="color:#DC2626;font-weight:700">Limite dépassée (96%+)</td><td><span class="proj-badge proj-danger">BLOQUÉ</span></td></tr>
            </tbody>
          </table>
          <div style="margin-top:10px;padding:8px 12px;background:#DBEAFE;border-radius:7px;border-left:3px solid #051E50;font-size:11px;color:#1D4ED8">
            <strong>Pour scaler à 50 users en toute sécurité → Tier 2 OpenAI (5 000 appels/min)</strong><br>
            Condition : <strong>50$ de dépenses cumulées + 7 jours d'ancienneté</strong> sur le compte. Passage automatique, aucune action manuelle. Tier 2 = confortable jusqu'à 250+ users simultanés.
          </div>
          <div style="font-size:11px;color:#1D4ED8;margin-top:6px" id="pitch-cost-detail">Chargement des coûts...</div>
        </div>

        <div style="margin-top:10px;padding:10px;background:#FEE2E2;border-radius:7px;border:1px solid #FECACA">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
            <span style="font-size:12px;font-weight:700;color:#DC2626">Sécurité timeout Vercel</span>
            <span class="proj-badge proj-danger">FAIBLE</span>
            <span style="font-size:11px;color:#64748B">55s / 60s = 92% de la limite</span>
          </div>
          <table>
            <thead><tr><th>Situation</th><th>Temps</th><th>Limite</th><th>Marge</th><th>Sécurité</th></tr></thead>
            <tbody>
              <tr><td style="font-weight:600">Polling Assistant API (actuel)</td><td style="color:#DC2626;font-weight:700">~55s</td><td>60s</td><td style="color:#DC2626;font-weight:700">5s</td><td><span class="proj-badge proj-danger">FAIBLE</span></td></tr>
              <tr><td style="font-weight:600">Priorisations parallèles (Promise.all)</td><td style="color:#D97706;font-weight:700">~25-30s</td><td>60s</td><td style="color:#D97706">30s</td><td><span class="proj-badge proj-warn">MOYENNE</span></td></tr>
              <tr><td style="font-weight:600">Streaming natif OpenAI (cible)</td><td style="color:#059669;font-weight:700">connexion maintenue</td><td>N/A</td><td style="color:#059669">illimitee</td><td><span class="proj-badge proj-ok">HAUTE</span></td></tr>
            </tbody>
          </table>
          <div style="margin-top:10px;font-size:12px;font-weight:700;color:#051E50;margin-bottom:6px">Modifications a faire pour atteindre sécurité haute</div>
          <div style="padding:8px;background:#FEFCE8;border-radius:6px;margin-bottom:6px;font-size:11px;color:#334155">
            <strong style="color:#D97706">Étape 1 (rapide) :</strong> Paralléliser les 5 priorisations avec <code style="background:#F1F5F9;padding:1px 4px;border-radius:3px">Promise.all()</code> dans <strong>useContentGénération.js</strong>. Passe de 55s à 25-30s. Sécurité moyenne.</div>
          <div style="padding:8px;background:#ECFDF5;border-radius:6px;font-size:11px;color:#334155">
            <strong style="color:#059669">Étape 2 (sécurité haute) :</strong> Remplacer le polling <code style="background:#F1F5F9;padding:1px 4px;border-radius:3px">assistants.runs.retrieve()</code> par <code style="background:#F1F5F9;padding:1px 4px;border-radius:3px">stream()</code> de l'API OpenAI. Le streaming garde la connexion vivante, le timeout de 60s ne s'applique plus. Fichier à modifier : <strong>api/generate-pitch.js</strong> (ou équivalent backend).</div>
        </div>

        <div class="reco">
          <h4>Recommandations pour scaler</h4>
          <p>1. <strong>Paralléliser les 5 priorisations</strong> : Promise.all() au lieu de sequentiel (divise le temps par 5, même nombre d'appels)</p>
          <p>2. <strong>Remplacer polling par streaming</strong> : utiliser stream() de l'API OpenAI Assistants à la place de runs.retrieve() — sécurité haute</p>
          <p>3. <strong>Monter de tier OpenAI</strong> : Tier 2 = 5 000 appels/min (x10). Automatique apres 50$ dépenses + 7 jours</p>
          <p>4. <strong>Cacher la matrice enrichie</strong> : les priorisations pour un même secteur/fonction sont identiques, cacher 1h</p>
        </div>

        <!-- PLAN DE SCALING -->
        <div style="margin-top:16px">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;flex-wrap:wrap">
            <div style="font-size:14px;font-weight:800;color:#051E50">Plan de scaling — 8 chantiers</div>
            <span class="badge bd">2 CRITIQUES</span>
            <span class="badge bw">3 IMPORTANTS</span>
            <span class="badge bv">3 OPTIMISATIONS</span>
          </div>

          <!-- Tableau priorités -->
          <table style="margin-bottom:14px">
            <thead><tr><th>Priorité</th><th>Chantier</th><th>Impact</th><th>Effort</th><th>Statut</th></tr></thead>
            <tbody>
              <tr><td style="font-weight:700">1</td><td>Gestion d'erreur UX (messages + bouton réessayer)</td><td><span class="proj-badge proj-danger">CRITIQUE</span></td><td>Moyen</td><td><span class="proj-badge proj-warn">À FAIRE</span></td></tr>
              <tr><td style="font-weight:700">2</td><td>Retry automatique exponential backoff (429/500)</td><td><span class="proj-badge proj-danger">CRITIQUE</span></td><td>Faible</td><td><span class="proj-badge proj-warn">À FAIRE</span></td></tr>
              <tr><td style="font-weight:700">3</td><td>Compte OpenAI dédié Rubix Pitch</td><td><span class="proj-badge proj-danger">CRITIQUE</span></td><td>Faible</td><td><span class="proj-badge proj-warn">À FAIRE</span></td></tr>
              <tr><td style="font-weight:700">4</td><td>Timeout Vercel : paralléliser + streaming</td><td><span class="proj-badge proj-warn">IMPORTANT</span></td><td>Moyen</td><td><span class="proj-badge proj-warn">À FAIRE</span></td></tr>
              <tr><td style="font-weight:700">5</td><td>Logging structuré des erreurs et métriques</td><td><span class="proj-badge proj-warn">IMPORTANT</span></td><td>Faible</td><td><span class="proj-badge proj-warn">À FAIRE</span></td></tr>
              <tr><td style="font-weight:700">6</td><td>Endpoint health check /api/health</td><td><span class="proj-badge proj-warn">IMPORTANT</span></td><td>Moyen</td><td><span class="proj-badge proj-warn">À FAIRE</span></td></tr>
              <tr><td style="font-weight:700">7</td><td>Cache priorisations par secteur/fonction (1h)</td><td><span class="proj-badge proj-ok">OPTIMISATION</span></td><td>Moyen</td><td><span class="proj-badge proj-warn">À FAIRE</span></td></tr>
              <tr><td style="font-weight:700">8</td><td>Mode dégradé si OpenAI est down</td><td><span class="proj-badge proj-ok">OPTIMISATION</span></td><td>Moyen</td><td><span class="proj-badge proj-warn">À FAIRE</span></td></tr>
            </tbody>
          </table>

          <!-- Chantier 1 -->
          <div style="padding:12px;background:#FEE2E2;border-radius:8px;border-left:4px solid #DC2626;margin-bottom:8px">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;flex-wrap:wrap">
              <span style="font-size:12px;font-weight:800;color:#DC2626">Chantier 1 — Gestion d'erreur côté utilisateur</span>
              <span class="proj-badge proj-danger">CRITIQUE</span><span class="proj-badge proj-warn">À FAIRE</span>
            </div>
            <div style="font-size:11px;color:#334155;margin-bottom:8px">Quand OpenAI renvoie une erreur (timeout, 429, 500), le commercial voit un spinner infini ou un écran blanc. Pas de message d'erreur, pas de bouton réessayer. L'app semble cassée.</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:11px">
              <div style="padding:6px 8px;background:#fff;border-radius:5px;border:1px solid #FECACA"><strong style="color:#DC2626">Timeout</strong><br>→ "La génération prend plus de temps que prévu. Veuillez réessayer."</div>
              <div style="padding:6px 8px;background:#fff;border-radius:5px;border:1px solid #FECACA"><strong style="color:#DC2626">429 (trop de requêtes)</strong><br>→ "Forte affluence. Veuillez patienter quelques secondes puis réessayer."</div>
              <div style="padding:6px 8px;background:#fff;border-radius:5px;border:1px solid #FECACA"><strong style="color:#DC2626">500 (erreur serveur)</strong><br>→ "Service temporairement indisponible. Réessayez dans quelques instants."</div>
              <div style="padding:6px 8px;background:#fff;border-radius:5px;border:1px solid #FECACA"><strong style="color:#DC2626">Règle générale</strong><br>→ Spinner limité à 60s. Bouton "Réessayer" sans perdre les données saisies.</div>
            </div>
            <div style="font-size:10px;color:#64748B;margin-top:6px">Fichier : <code style="background:#F1F5F9;padding:1px 4px;border-radius:3px">useContentGeneration.js</code> (frontend) — Style : fond #FFF9E6, bouton réessayer bleu #051E50</div>
          </div>

          <!-- Chantier 2 -->
          <div style="padding:12px;background:#FEE2E2;border-radius:8px;border-left:4px solid #DC2626;margin-bottom:8px">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;flex-wrap:wrap">
              <span style="font-size:12px;font-weight:800;color:#DC2626">Chantier 2 — Retry automatique (exponential backoff)</span>
              <span class="proj-badge proj-danger">CRITIQUE</span><span class="proj-badge proj-warn">À FAIRE</span>
            </div>
            <div style="font-size:11px;color:#334155;margin-bottom:8px">Si OpenAI renvoie 429, l'app abandonne immédiatement. À 50 users, les 429 arrivent régulièrement en pic. Il faut réessayer automatiquement avant d'afficher une erreur.</div>
            <div style="padding:8px;background:#fff;border-radius:5px;border:1px solid #FECACA;font-size:11px;color:#334155">
              <strong>Logique :</strong> 429 ou 500/502/503 → attendre 1s → réessayer → 2s → réessayer → 4s → réessayer. Max 3 retries. Erreurs 400/401 = ne pas réessayer (problème de requête ou auth).<br>
              <code style="background:#F1F5F9;padding:2px 4px;border-radius:3px;font-size:10px">callOpenAIWithRetry(params, maxRetries=3) — sleep(2^i * 1000ms)</code>
            </div>
            <div style="font-size:10px;color:#64748B;margin-top:6px">Fichiers : <code style="background:#F1F5F9;padding:1px 4px;border-radius:3px">api/generate-pitch.js</code> + <code style="background:#F1F5F9;padding:1px 4px;border-radius:3px">api/generate-fusion.js</code></div>
          </div>

          <!-- Chantier 3 -->
          <div style="padding:12px;background:#FEFCE8;border-radius:8px;border-left:4px solid #FFD700;margin-bottom:8px">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;flex-wrap:wrap">
              <span style="font-size:12px;font-weight:800;color:#92400E">Chantier 3 — Compte OpenAI dédié Rubix Pitch</span>
              <span class="proj-badge proj-danger">CRITIQUE</span><span class="proj-badge proj-warn">À FAIRE</span>
            </div>
            <div style="font-size:11px;color:#334155;margin-bottom:6px">Compte partagé avec Smart Spec. Si Smart Spec consomme tous les crédits, Rubix Pitch s'arrête immédiatement sans préavis. Aucun commercial ne comprendra pourquoi l'app ne répond plus.</div>
            <div style="font-size:11px;color:#334155"><strong>Résolution (15 min) :</strong> 1. Créer un compte OpenAI dédié (email dédié Rubix Pitch) → 2. Ajouter moyen de paiement + budget mensuel → 3. Générer nouvelle clé API → 4. Mettre à jour <code style="background:#F1F5F9;padding:1px 4px;border-radius:3px">OPENAI_API_KEY</code> dans Vercel → 5. Redéployer</div>
          </div>

          <!-- Chantier 4 -->
          <div style="padding:12px;background:#FEFCE8;border-radius:8px;border-left:4px solid #FFD700;margin-bottom:8px">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;flex-wrap:wrap">
              <span style="font-size:12px;font-weight:800;color:#92400E">Chantier 4 — Timeout Vercel : paralléliser + streaming</span>
              <span class="proj-badge proj-warn">IMPORTANT</span><span class="proj-badge proj-warn">À FAIRE</span>
            </div>
            <div style="font-size:11px;color:#334155;margin-bottom:6px">Pipeline actuel = ~55s. Limite Vercel = 60s. Marge = 5s. Si OpenAI ralentit légèrement, le commercial voit un écran blanc.</div>
            <div style="font-size:11px;color:#334155">
              <strong style="color:#D97706">Étape 1 (rapide) :</strong> Paralléliser les 5 priorisations avec <code style="background:#F1F5F9;padding:1px 4px;border-radius:3px">Promise.all()</code> dans <strong>useContentGeneration.js</strong>. Passe de 55s à 25-30s. Marge 30s.<br>
              <strong style="color:#059669">Étape 2 (sécurité haute) :</strong> Remplacer le polling <code style="background:#F1F5F9;padding:1px 4px;border-radius:3px">runs.retrieve()</code> par <code style="background:#F1F5F9;padding:1px 4px;border-radius:3px">stream()</code> dans <strong>api/generate-pitch.js</strong>. Plus aucun timeout.
            </div>
          </div>

          <!-- Chantier 5 -->
          <div style="padding:12px;background:#EFF6FF;border-radius:8px;border-left:4px solid #1D4ED8;margin-bottom:8px">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;flex-wrap:wrap">
              <span style="font-size:12px;font-weight:800;color:#1D4ED8">Chantier 5 — Logging structuré des erreurs et métriques</span>
              <span class="proj-badge proj-warn">IMPORTANT</span><span class="proj-badge proj-warn">À FAIRE</span>
            </div>
            <div style="font-size:11px;color:#334155;margin-bottom:6px">Aujourd'hui on ne sait pas combien de pitchs sont générés, quels secteurs sont populaires, ni combien d'erreurs se produisent. Impossible de mesurer le ROI.</div>
            <div style="padding:6px 8px;background:#fff;border-radius:5px;border:1px solid #BFDBFE;font-size:10px;color:#334155;font-family:monospace">
              &#123; "event": "pitch_generated", "secteur": "agroalimentaire", "fonction": "resp-achats", "duree_ms": 34500, "status": "success", "appels_openai": 6 &#125;<br>
              &#123; "event": "pitch_error", "error_type": "timeout|rate_limit|openai_500", "retry_count": 2 &#125;
            </div>
            <div style="font-size:10px;color:#64748B;margin-top:6px">Lisible dans Vercel Dashboard → Functions → Logs. Aucune infrastructure supplémentaire. Fichiers : <code style="background:#F1F5F9;padding:1px 4px;border-radius:3px">api/generate-pitch.js</code> + <code style="background:#F1F5F9;padding:1px 4px;border-radius:3px">api/generate-fusion.js</code></div>
          </div>

          <!-- Chantier 6 -->
          <div style="padding:12px;background:#EFF6FF;border-radius:8px;border-left:4px solid #1D4ED8;margin-bottom:8px">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;flex-wrap:wrap">
              <span style="font-size:12px;font-weight:800;color:#1D4ED8">Chantier 6 — Endpoint health check /api/health</span>
              <span class="proj-badge proj-warn">IMPORTANT</span><span class="proj-badge proj-warn">À FAIRE</span>
            </div>
            <div style="font-size:11px;color:#334155;margin-bottom:6px">Aujourd'hui personne ne sait si l'app est up ou down avant qu'un commercial se plaigne.</div>
            <div style="font-size:11px;color:#334155;margin-bottom:6px">Créer <code style="background:#F1F5F9;padding:1px 4px;border-radius:3px">/api/health</code> qui teste : connectivité OpenAI (1 appel minimal) + accès Vercel Blob. Réponse JSON : <code style="background:#F1F5F9;padding:1px 4px;border-radius:3px">&#123; status: "ok"|"degraded", openai: "ok"|"ko", blob: "ok"|"ko", timestamp &#125;</code></div>
            <div style="font-size:10px;color:#64748B">Suggestion : brancher UptimeRobot (gratuit) → appelle <code style="background:#F1F5F9;padding:1px 4px;border-radius:3px">/api/health</code> toutes les 5 min → alerte email/Slack si KO</div>
          </div>

          <!-- Chantier 7 -->
          <div style="padding:12px;background:#ECFDF5;border-radius:8px;border-left:4px solid #059669;margin-bottom:8px">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;flex-wrap:wrap">
              <span style="font-size:12px;font-weight:800;color:#059669">Chantier 7 — Cache priorisations par secteur/fonction (1h)</span>
              <span class="proj-badge proj-ok">OPTIMISATION</span><span class="proj-badge proj-warn">À FAIRE</span>
            </div>
            <div style="font-size:11px;color:#334155;margin-bottom:6px">Les 5 priorisations (solutions, questions, tendances, crédibilité, pyramide) donnent le même résultat pour un même secteur + fonction. 10 commerciaux sur le même secteur = 50 appels inutiles.</div>
            <div style="font-size:11px;color:#334155">
              Clé de cache : <code style="background:#F1F5F9;padding:1px 4px;border-radius:3px">${secteur}_${fonction}_${langue}</code> (ex: "agroalimentaire_resp-achats_fr")<br>
              TTL : 1h. Stockage : Vercel KV (Redis, payant) ou Vercel Blob JSON (gratuit, moins rapide).<br>
              Le contexte libre saisi par le commercial n'est PAS inclus dans la clé (envoyé uniquement à la génération finale).<br>
              <strong>Gain estimé : divise les appels API par 3 à 5x en conditions réelles.</strong>
            </div>
          </div>

          <!-- Chantier 8 -->
          <div style="padding:12px;background:#ECFDF5;border-radius:8px;border-left:4px solid #059669;margin-bottom:8px">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;flex-wrap:wrap">
              <span style="font-size:12px;font-weight:800;color:#059669">Chantier 8 — Mode dégradé si OpenAI est down</span>
              <span class="proj-badge proj-ok">OPTIMISATION</span><span class="proj-badge proj-warn">À FAIRE</span>
            </div>
            <div style="font-size:11px;color:#334155;margin-bottom:6px">Si OpenAI tombe (pannes de quelques minutes à quelques heures), l'app est 100% inutilisable. Le commercial devant son client n'a rien.</div>
            <div style="font-size:11px;color:#334155">
              À chaque pitch généré avec succès → sauvegarder dans Vercel Blob : <code style="background:#F1F5F9;padding:1px 4px;border-radius:3px">cache_pitch_${secteur}_${fonction}_${langue}</code>.<br>
              Si OpenAI échoue après 3 retries → servir le pitch en cache avec bandeau : <strong>"⚠️ Service IA indisponible. Ce pitch est basé sur une génération récente."</strong><br>
              Si aucun cache disponible → message d'erreur standard (chantier 1).
            </div>
          </div>

        </div>

        <div class="mini-metrics">
          <div class="mini-metric"><div class="mini-val" id="pitch-build"></div><div class="mini-label">Build min</div></div>
          <div class="mini-metric"><div class="mini-val" id="pitch-bw"></div><div class="mini-label">Bandwidth</div></div>
          <div class="mini-metric"><div class="mini-val" id="pitch-fninv"></div><div class="mini-label">Fn Invocations</div></div>
          <div class="mini-metric"><div class="mini-val" id="pitch-fndur"></div><div class="mini-label">Fn Duration</div></div>
        </div>

        <div class="links">
          <a href="https://platform.openai.com/usage" target="_blank" class="btn btn-o">OpenAI Usage</a>
          <a href="https://platform.openai.com/settings/organization/limits" target="_blank" class="btn btn-o">Rate Limits</a>
        </div>
      </div>
    </div>
  </div>
  </div>

  <!-- ONGLET SMART CONTENT -->
  <div class="page" id="page-smart">
  <div class="container">
    <div class="section-title">
      <div class="st-bar" style="background:#00D26A"></div>
      Smart Content
      <span class="badge bg">GEMINI GCP</span>
    </div>

    <div class="section">
      <div class="section-head" onclick="toggle(this)">
        <h2>
          <span class="status-dot" id="smart-dot"></span>
          rubix-smart-content.vercel.app
        </h2>
        <span class="chevron open">&#9662;</span>
      </div>
      <div class="section-body open">
        <div class="app-meta">
          <div class="meta-card">
            <div class="meta-label">Dernier déploiement</div>
            <div class="meta-val" id="smart-last-deploy"></div>
          </div>
          <div class="meta-card">
            <div class="meta-label">Fournisseur IA</div>
            <div class="meta-val"><span class="badge bg">Gemini Flash</span>&nbsp;Google Cloud Platform</div>
          </div>
        </div>

        <table>
          <thead><tr><th>Action utilisateur</th><th>Appels IA</th><th>Modele</th><th>Streaming</th></tr></thead>
          <tbody>
            <tr><td style="font-weight:600">Planifier intentions (10 sujets)</td><td>2 appels</td><td>Gemini 2.0 Flash</td><td>Non (batch)</td></tr>
            <tr><td style="font-weight:600">Générer 1 article / landing page</td><td>1 appel</td><td>Gemini 2.5 Flash</td><td style="color:#059669;font-weight:600">Oui (stream)</td></tr>
            <tr><td style="font-weight:600">Validation sources / SEO</td><td>1 appel</td><td>Gemini 2.0 Flash</td><td>Non</td></tr>
          </tbody>
        </table>

        <div class="thr-w">
          <h4>Seuils de blocage GCP : 1 500 appels/min mais credits limites</h4>
          <table>
            <thead><tr><th>Users simultanées</th><th>Appels IA/min</th><th>Coût/mois estime</th><th>Statut</th></tr></thead>
            <tbody>
              <tr><td>1 a 5 users</td><td>2 a 10 appels/min</td><td>3 a 15 EUR</td><td><span class="proj-badge proj-ok">OK</span></td></tr>
              <tr><td>10 users</td><td>10 a 20 appels/min</td><td>30 EUR</td><td><span class="proj-badge proj-warn">CREDITS ?</span></td></tr>
              <tr><td>50+ users</td><td>50 a 100 appels/min</td><td>150+ EUR</td><td><span class="proj-badge proj-danger">PAYANT</span></td></tr>
            </tbody>
          </table>
          <div style="font-size:11px;color:#D97706;margin-top:6px">
            <strong>Blocker principal :</strong> pas le nombre d'appels/min (1 500 = large) mais le <strong>cout</strong> quand les credits promo GCP seront épuisés.
            Actuellement 2.98 EUR brut / 50 contenus = 0.06 EUR/contenu.
          </div>
        </div>

        <div class="reco">
          <h4>Recommandations pour scaler</h4>
          <p>1. <strong>Streaming déjà en place</strong> : evite les timeouts Vercel 60s sur contenus longs, ne pas toucher</p>
          <p>2. <strong>Retry + backoff 429 déjà en place</strong> : gestion des rate limits côté serveur, ne pas toucher</p>
          <p>3. <strong>Surveiller les credits GCP</strong> : quand épuisés, 0.06 EUR/contenu en production</p>
          <p>4. <strong>Batching intentions</strong> : générer les 10 intentions en 1 seul appel plutot que 2 (possible vu la taille du prompt)</p>
        </div>

        <div class="mini-metrics">
          <div class="mini-metric"><div class="mini-val" id="smart-build"></div><div class="mini-label">Build min</div></div>
          <div class="mini-metric"><div class="mini-val" id="smart-bw"></div><div class="mini-label">Bandwidth</div></div>
          <div class="mini-metric"><div class="mini-val" id="smart-fninv"></div><div class="mini-label">Fn Invocations</div></div>
          <div class="mini-metric"><div class="mini-val" id="smart-fndur"></div><div class="mini-label">Fn Duration</div></div>
        </div>

        <div class="links">
          <a href="https://console.cloud.google.com/billing?project=n8n-landing-pages" target="_blank" class="btn btn-g">Crédits GCP restants</a>
          <a href="https://console.cloud.google.com/apis/dashboard?project=n8n-landing-pages" target="_blank" class="btn btn-g">GCP Dashboard</a>
        </div>
      </div>
    </div>

    <!-- Section bugs lié à l'environnement Rubix -->
    <div class="section-title" style="margin-top:28px">
      <div class="st-bar" style="background:#EF4444"></div>
      Bug lié à l'environnement Rubix
      <span class="badge bd">EN COURS DE CORRECTION</span>
    </div>

    <div class="section">
      <div class="section-head" onclick="toggle(this)">
        <h2>Proxy SSL et bascules réseau (ERR_CERT / ERR_NETWORK_CHANGED)</h2>
        <span class="chevron open">&#9662;</span>
      </div>
      <div class="section-body open">

        <div class="thr-d">
          <h4>Le probleme : connexions longues cassees par le proxy d'entreprise</h4>
          <div style="font-size:11px;color:#334155;margin-bottom:8px">Générer un article nécessite 90 a 180 secondes de connexion continue. Le proxy entreprise coupe ou perturbe ces connexions longues.</div>
          <table>
            <thead><tr><th>Erreur</th><th>Cause</th><th>Impact</th></tr></thead>
            <tbody>
              <tr>
                <td style="font-weight:700;color:#DC2626">ERR_CERT_COMMON_NAME_INVALID</td>
                <td style="font-size:11px">Le proxy SSL (Zscaler) intercepte le trafic HTTPS et remplace le certificat Google par le sien. Le navigateur détecte que le nom du certificat ne correspond pas.</td>
                <td style="font-size:11px;color:#DC2626">Connexion refusee, génération impossible</td>
              </tr>
              <tr>
                <td style="font-weight:700;color:#DC2626">ERR_NETWORK_CHANGED</td>
                <td style="font-size:11px">La route réseau change en cours de génération : bascule VPN, changement de point WiFi, reconnexion automatique.</td>
                <td style="font-size:11px;color:#DC2626">Connexion coupee, article bloqué en PROCESSING</td>
              </tr>
              <tr>
                <td style="font-weight:700;color:#DC2626">ERR_INTERNET_DISCONNECTED</td>
                <td style="font-size:11px">Coupure réseau breve (mise en veille, instabilite WiFi) pendant les 90 a 180s de génération Gemini.</td>
                <td style="font-size:11px;color:#DC2626">Requete échouée, article bloqué en PROCESSING</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div style="margin-top:14px;padding:12px;background:#F8FAFC;border-radius:7px;border:1px solid #E2E8F0">
          <div style="font-size:12px;font-weight:700;color:#051E50;margin-bottom:8px">Situation actuelle vs situation cible</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;font-size:11px">
            <div style="padding:10px;background:#FEE2E2;border-radius:6px">
              <div style="font-weight:700;color:#DC2626;margin-bottom:6px">Maintenant (fragile)</div>
              <div style="color:#334155;line-height:1.8">Navigateur appelle Vercel (appel 1 : SEO, 30 a 60s)<br>Navigateur appelle Vercel (appel 2 : Article, 60 a 90s)<br>Navigateur appelle Vercel (appel 3 : Enrichissement, 30 a 60s)<br>Chaque appel passe par le proxy SSL d'entreprise</div>
            </div>
            <div style="padding:10px;background:#ECFDF5;border-radius:6px">
              <div style="font-weight:700;color:#059669;margin-bottom:6px">Apres correction (robuste)</div>
              <div style="color:#334155;line-height:1.8">Navigateur fait 1 seul appel court a Vercel<br>Vercel gere les 3 appels Gemini en interne (serveur vers serveur)<br>Le navigateur interroge le statut toutes les 5s<br>Même si le proxy coupe, Vercel continue et sauvegarde dans Sheets</div>
            </div>
          </div>
        </div>

        <div style="margin-top:14px">
          <div style="font-size:12px;font-weight:700;color:#051E50;margin-bottom:8px">Plan d'action (3 chantiers)</div>

          <div style="padding:10px;background:#ECFDF5;border-radius:7px;border:1px solid #A7F3D0;margin-bottom:8px">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
              <span class="badge bo">CHANTIER 1</span>
              <span style="font-size:12px;font-weight:700;color:#059669">Fix immédiat (5 min, zero code)</span>
              <span class="proj-badge proj-ok">FAISABLE MAINTENANT</span>
            </div>
            <div style="font-size:11px;color:#334155">Débloquer les articles coincés en PROCESSING.<br>Dans Google Sheets, onglet <strong>_meta</strong>, colonne L : chercher les cellules contenant <strong>PROCESSING:...</strong> et les remplacer par <strong>QUEUED</strong>. Ils seront re-générés à la prochaine tentative.</div>
          </div>

          <div style="padding:10px;background:#FEFCE8;border-radius:7px;border:1px solid #FFD700;margin-bottom:8px">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
              <span class="badge bw">CHANTIER 2</span>
              <span style="font-size:12px;font-weight:700;color:#D97706">Bouton Annuler dans l'UI (30 min de code)</span>
              <span class="proj-badge proj-warn">A FAIRE</span>
            </div>
            <div style="font-size:11px;color:#334155">La route backend <strong>/cancel-article/:rowId</strong> existe déjà mais n'a aucun bouton dans l'interface. Ajouter un bouton sur les cartes bloquées en PROCESSING pour débloquer sans aller dans Google Sheets.</div>
          </div>

          <div style="padding:10px;background:#F0F4FF;border-radius:7px;border:1px solid #BFDBFE">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
              <span class="badge bi">CHANTIER 3</span>
              <span style="font-size:12px;font-weight:700;color:#3B82F6">Génération côté serveur (2 à 3h de code)</span>
              <span class="proj-badge proj-warn">EN COURS</span>
            </div>
            <div style="font-size:11px;color:#334155">La vraie solution. Créer une nouvelle route dans <strong>api/index.js</strong> qui fait les 3 appels Gemini en interne, et simplifier <strong>useContentGénération.js</strong> côté frontend. Approche : batch 1 par 1 (lancer un article, attendre qu'il finisse, passer au suivant).<br><br><strong>Risque :</strong> Vercel Pro = timeout 300s par fonction. Un article prend 90 à 180s, ça passe normalement. Si Gemini est lent, le backend remet l'article en QUEUED automatiquement.</div>
          </div>
        </div>

      </div>
    </div>

  </div>
  </div>

  <!-- ONGLET CAPACITE VERCEL -->
  <div class="page" id="page-vercel">
  <div class="container">
    <div class="section-title">
      <div class="st-bar" style="background:#FFD700"></div>
      Capacité Vercel
      <span class="badge bv" id="vercel-period"></span>
    </div>

    <div class="summary">
      <div class="scard"><div class="stop stop-gold"></div>
        <div class="slabel">Build Minutes restantes</div>
        <div class="sval" id="build-rem"></div>
        <div class="sdetail" id="build-detail"></div>
      </div>
      <div class="scard"><div class="stop stop-green"></div>
        <div class="slabel">Bandwidth restante</div>
        <div class="sval" id="bw-rem"></div>
        <div class="sdetail" id="bw-detail"></div>
      </div>
      <div class="scard"><div class="stop stop-blue"></div>
        <div class="slabel">Fn Invocations restantes</div>
        <div class="sval" id="fninv-rem"></div>
        <div class="sdetail" id="fninv-detail"></div>
      </div>
      <div class="scard"><div class="stop stop-purple"></div>
        <div class="slabel">Fn Duration restante</div>
        <div class="sval" id="fndur-rem"></div>
        <div class="sdetail" id="fndur-detail"></div>
      </div>
    </div>

    <div class="section">
      <div class="section-head" onclick="toggle(this)">
        <h2>Quotas et projections <span class="badge bv" id="reset-badge"></span></h2>
        <span class="chevron open">&#9662;</span>
      </div>
      <div class="section-body open">
        <div class="limits-grid">
          <div class="limit-item">
            <div class="limit-label"><span>Build Minutes <span class="proj-badge" id="build-pbadge"></span></span><span id="build-used"></span></div>
            <div class="limit-bar"><div class="limit-fill fill-ok" id="build-bar" style="width:.5%"></div></div>
            <div class="limit-detail" id="build-proj"></div>
            <div style="font-size:10px;color:#64748B;margin-top:3px">Combien de minutes Vercel a passé à compiler et déployer les apps</div>
            <div id="build-perapp"></div>
          </div>
          <div class="limit-item">
            <div class="limit-label"><span>Bandwidth <span class="proj-badge" id="bw-pbadge"></span></span><span id="bw-used"></span></div>
            <div class="limit-bar"><div class="limit-fill fill-ok" id="bw-bar" style="width:.5%"></div></div>
            <div class="limit-detail" id="bw-proj"></div>
            <div style="font-size:10px;color:#64748B;margin-top:3px">Combien de données ont été envoyées aux utilisateurs (pages, images, réponses API)</div>
            <div id="bw-perapp"></div>
          </div>
          <div class="limit-item">
            <div class="limit-label"><span>Function Invocations <span class="proj-badge" id="fninv-pbadge"></span></span><span id="fninv-used"></span></div>
            <div class="limit-bar"><div class="limit-fill fill-ok" id="fninv-bar" style="width:.5%"></div></div>
            <div class="limit-detail" id="fninv-proj"></div>
            <div style="font-size:10px;color:#64748B;margin-top:3px">Combien de fois une fonction a été appelée — total tous projets confondus (Pôle + Pitch + Smart Content)</div>
            <div id="fninv-perapp"></div>
          </div>
          <div class="limit-item">
            <div class="limit-label"><span>Function Duration <span class="proj-badge" id="fndur-pbadge"></span></span><span id="fndur-used"></span></div>
            <div class="limit-bar"><div class="limit-fill fill-ok" id="fndur-bar" style="width:.5%"></div></div>
            <div class="limit-detail" id="fndur-proj"></div>
            <div style="font-size:10px;color:#64748B;margin-top:3px">Combien de temps ces fonctions ont tourné au total — <strong>non critique</strong> pour nos apps (limite 1 000 GB-h très difficile à atteindre)</div>
            <div id="fndur-perapp"></div>
          </div>
        </div>
        <div style="margin-top:12px;padding:10px;background:#FEFCE8;border-radius:7px;border:1px solid #FFD700">
          <div style="font-size:11px;font-weight:700;color:#D97706;margin-bottom:4px">Limites hard Vercel Pro (blocage direct, pas de surcharge)</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;font-size:11px;color:#64748B">
            <div><strong>Concurrent Builds :</strong> 1 seul (les autres en queue)</div>
            <div><strong>Serverless Timeout :</strong> 60s par defaut, 300s max (configurer maxDuration dans vercel.json)</div>
            <div><strong>Deployments :</strong> 100/jour (soft limit)</div>
          </div>
          <div style="margin-top:8px;font-size:11px;color:#64748B">
            <strong>Note :</strong> le streaming evite le timeout (Smart Content article). Les appels non-streaming longs (Pitch Generator ~55s, Gemini non-stream) sont limites a 60s par defaut. Pour le Chantier 3 (génération serveur), ajouter <code style="background:#F1F5F9;padding:1px 5px;border-radius:3px">maxDuration: 300</code> dans vercel.json.
          </div>
        </div>
      </div>
    </div>
  </div>
  </div>

  <!-- ONGLET COUTS -->
  <div class="page" id="page-couts">
  <div class="container">
    <div class="section-title">
      <div class="st-bar" style="background:#051E50"></div>
      Coûts (référence)
    </div>

    <div class="section">
      <div class="section-head" onclick="toggle(this)">
        <h2>Résumé coûts <span class="badge bv" id="total-badge"></span></h2>
        <span class="chevron open">&#9662;</span>
      </div>
      <div class="section-body open">
        <table>
          <thead><tr><th>Service</th><th>Coût</th><th>Detail</th></tr></thead>
          <tbody>
            <tr><td style="font-weight:600">Vercel Pro</td><td style="font-weight:700">$20.00/mois</td><td style="color:#64748B">Forfait fixe mutualise 3 apps</td></tr>
            <tr><td style="font-weight:600">OpenAI</td><td style="font-weight:700" id="openai-cost"></td><td style="color:#64748B" id="openai-detail"></td></tr>
            <tr><td style="font-weight:600">Gemini Smart Content</td><td style="font-weight:700">0 EUR</td><td style="color:#64748B">2.98 EUR brut couvert par credits promo GCP</td></tr>
            <tr><td style="font-weight:600">Gemini Pôle Acquisition</td><td style="font-weight:700;color:#00D26A">0 EUR</td><td style="color:#64748B">Free tier Google AI Studio</td></tr>
            <tr style="font-weight:700;border-top:2px solid #E2E8F0"><td>Total réel</td><td style="font-size:16px;color:#051E50" id="total-cost"></td><td style="color:#64748B">Vercel + OpenAI (Gemini = 0)</td></tr>
          </tbody>
        </table>

        <div style="margin-top:14px;padding:10px;background:#F0F4FF;border-radius:7px;border:1px solid #BFDBFE">
          <div style="font-size:11px;font-weight:700;color:#3B82F6;margin-bottom:6px">Enabler</div>
          <table>
            <thead><tr><th>Outil</th><th>Coût</th><th>Role</th></tr></thead>
            <tbody>
              <tr><td style="font-weight:600">Claude Code</td><td style="font-weight:700">$100/mois</td><td style="color:#64748B">Max 5x plan, inclus dans l'abonnement Claude, developpement et iteration rapide sur les 3 apps</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  </div>

  <!-- RETROPLANNING -->
  <div class="page" id="page-retro">
    <div class="container">
      <div class="section-title" style="margin-top:20px"><span class="st-bar" style="background:#051E50"></span>📆 Rétroplanning — Actions jour par jour</div>
      <div style="font-size:12px;color:#64748B;margin:6px 0 14px">Cliquez sur l'icône statut pour avancer : ⬜ À faire → 🔄 En cours → ✅ Fait → ❌ Bloqué. Sauvegardé automatiquement.</div>
      <div id="retro-prog-wrap" class="retro-prog-wrap"></div>
      <div id="retro-filters-wrap" style="margin-bottom:14px"></div>
      <div id="retro-calendar"></div>
    </div>
  </div>

</div><!-- /main -->

<div class="footer" id="footer">Rubix Monitoring</div>

<script>
// Tab switching
function showTab(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav a').forEach(a => a.classList.remove('active'));
  document.getElementById('page-' + id).classList.add('active');
  const tabs = ['alertes','pole','pitch','smart','vercel','couts','retro'];
  const idx = tabs.indexOf(id);
  if (idx >= 0) document.querySelectorAll('.nav a')[idx].classList.add('active');
  if (id === 'retro') {
    if (!retroInitialized) { retroInitialized = true; initRetro(); }
    else { updateRetroProgress(); }
    setTimeout(() => { const el = $('retro-today'); if (el) el.scrollIntoView({block:'nearest',inline:'center'}); }, 80);
  }
  window.scrollTo(0, 0);
}
let retroInitialized = false;

// Collapsible sections
function toggle(head) {
  head.nextElementSibling.classList.toggle('open');
  head.querySelector('.chevron').classList.toggle('open');
}

// Helpers
const APP_COLORS = {
  'rubix-pole-acquisition':    '#FFD700',
  'rubix-pitch-generator-dev': '#8B5CF6',
  'rubix-smart-content':       '#00D26A',
  '_other':                    '#94A3B8',
};
const APP_SHORT = {
  'rubix-pole-acquisition':    'pole-acq.',
  'rubix-pitch-generator-dev': 'pitch-gen.',
  'rubix-smart-content':       'smart-cont.',
};

const $ = id => document.getElementById(id);
const html = (id, v) => { const el = $(id); if (el) el.innerHTML  = v; };
const fmtN = n => (n >= 1000 ? n.toLocaleString('fr-FR') : String(n));

function fillBar(id, pct, risk) {
  const el = $(id);
  if (!el) return;
  el.className = `limit-fill fill-${risk}`;
  el.style.width = Math.max(pct, 0.5) + '%';
}

function perAppHtml(perApp, total) {
  const entries = Object.entries(perApp || {}).filter(([,v]) => v > 0).sort((a,b) => b[1]-a[1]);
  if (!entries.length) return '';
  let h = '<div class="per-app-breakdown">';
  for (const [name, qty] of entries) {
    const color = APP_COLORS[name] || '#94A3B8';
    const short = APP_SHORT[name]  || name;
    const pct   = total > 0 ? Math.round(qty / total * 1000) / 10 : 0;
    const qFmt  = qty >= 1000 ? fmtN(Math.round(qty)) : (Math.round(qty * 100) / 100).toLocaleString('fr-FR');
    h += `<div class="per-app-row">
      <span class="per-app-dot" style="background:${color}"></span>
      <span class="per-app-name">${short}</span>
      <span class="per-app-bar-wrap"><span class="per-app-bar" style="width:${Math.max(pct,2)}%;background:${color}"></span></span>
      <span class="per-app-val">${qFmt} (${pct}%)</span>
    </div>`;
  }
  return h + '</div>';
}

// Render
function renderAll(d) {
  const { period, vercel, openai } = d;

  html('period-label', `${period.from} au ${period.to}`);
  html('generated-at', `Mis a jour : ${new Date(d.generatedAt).toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})}`);

  renderDeploys(vercel.deploys);
  renderOpenAI(openai);
  renderVercelCapacity(vercel.proj, period);
  renderMiniMetrics(vercel.proj);
  renderGlobalAlerts(vercel.proj);

  html('footer', `Rubix Monitoring | Période : ${period.from} au ${period.to} | Reset le ${period.reset}`);
}

function renderDeploys(deploys) {
  const map = { pole: 'pole', pitch: 'pitch', smart: 'smart' };
  for (const [key, d] of Object.entries(deploys)) {
    const k = map[key] || key;
    const color = d.state === 'READY' ? '#00D26A' : d.state === 'N/A' ? '#94A3B8' : '#EF4444';
    const dot = $(`${k}-dot`); if (dot) dot.style.background = color;
    const badge = `<span class="badge" style="background:${d.state==='READY'?'#ECFDF5':'#FEE2E2'};color:${d.state==='READY'?'#059669':'#DC2626'}">${d.state}</span>`;
    html(`${k}-last-deploy`, `${badge} ${d.lastDate}`);
  }
}

function renderOpenAI(oa) {
  const cpp6 = Math.round(oa.costPerPrompt * 6 * 1000) / 1000;
  html('pitch-cost-per-pitch', `<strong>~$${cpp6}</strong> &nbsp;(6 x $${oa.costPerPrompt}/appel)`);
  html('pitch-cost-detail', `<strong>Coût/pitch complet :</strong> ~$${oa.costPerPrompt} x 6 appels = ~$${cpp6}/pitch &nbsp;|&nbsp; A $${oa.monthlyProjected}/mois (rythme actuel depuis jan. 2026)`);
  html('openai-cost',   `<strong>$${oa.totalCost}</strong>`);
  html('openai-detail', `${fmtN(oa.requests)} req. | $${oa.costPerPrompt}/prompt | OpenAI Rubix Pitch`);
  const total = Math.round((20 + oa.totalCost) * 100) / 100;
  html('total-cost',  `$${total}`);
  html('total-badge', `$${total} TOTAL`);
}

function renderVercelCapacity(proj, period) {
  const METRICS = [
    { svc:'Build Minutes',        id:'build', fmtV: v => Math.round(v)+' min',   fmtU: v => Math.round(v)+' / 6 000 min',   overage:'$0.02/min'  },
    { svc:'Fast Data Transfer',   id:'bw',    fmtV: v => v.toFixed(1)+' GB',     fmtU: v => v.toFixed(2)+' / 1 000 GB',     overage:'$0.15/GB'   },
    { svc:'Function Invocations', id:'fninv', fmtV: v => fmtN(Math.round(v)),    fmtU: v => fmtN(Math.round(v))+' / 1M',    overage:'$0.60/M'    },
    { svc:'Function Duration',    id:'fndur', fmtV: v => v.toFixed(1)+' GB-h',   fmtU: v => v.toFixed(2)+' / 1 000 GB-h',  overage:'$0.18/GB-h' },
  ];
  // Alertes statiques toujours présentes
  let dangerC = 1; // FREE TIER Pôle bloqué à 5+ users
  let warnC   = 3; // Pitch : 6+ appels + polling ~55s / Smart : crédits promo GCP
  for (const { svc, id, fmtV, fmtU, overage } of METRICS) {
    const p = proj[svc]; if (!p) continue;
    const pct = Math.round(p.used / p.limit * 1000) / 10;
    html(`${id}-rem`,    fmtV(p.remaining));
    html(`${id}-detail`, `${fmtU(p.used)} | ${fmtV(p.dailyRate)}/jour`);
    html(`${id}-used`,   fmtU(p.used));
    html(`${id}-pbadge`, `Proj. ${fmtV(p.projected)}`);
    const pb = $(`${id}-pbadge`); if (pb) pb.className = `proj-badge proj-${p.risk}`;
    html(`${id}-proj`,   `${pct}% | ${fmtV(p.dailyRate)}/jour | Limite dans ${p.daysUntil} j. | Surcharge : ${overage}`);
    fillBar(`${id}-bar`, pct, p.risk);
    html(`${id}-perapp`, perAppHtml(p.perApp, p.used));
    if (p.risk === 'danger') dangerC++;
    else if (p.risk === 'warn') warnC++;
  }
  html('vercel-period', `${period.from} au ${period.to}`);
  html('reset-badge',   `Reset ${period.reset} (dans ${Math.ceil(period.daysRemaining)} j.)`);
  html('count-danger',  `${dangerC} CRITIQUE`);
  html('count-warn',    `${warnC} ATTENTION`);
}

function renderMiniMetrics(proj) {
  const appsMap = { pole:'rubix-pole-acquisition', pitch:'rubix-pitch-generator-dev', smart:'rubix-smart-content' };
  const metMap  = [
    { svc:'Build Minutes',        suf:'build', fmt:v => Math.round(v)+' min'   },
    { svc:'Fast Data Transfer',   suf:'bw',    fmt:v => v.toFixed(2)+' GB'     },
    { svc:'Function Invocations', suf:'fninv', fmt:v => fmtN(Math.round(v))    },
    { svc:'Function Duration',    suf:'fndur', fmt:v => v.toFixed(3)+' GB-h'   },
  ];
  for (const [app, appKey] of Object.entries(appsMap)) {
    for (const { svc, suf, fmt } of metMap) {
      const val = proj[svc]?.perApp?.[appKey] ?? 0;
      html(`${app}-${suf}`, fmt(val));
    }
  }
}

function renderGlobalAlerts(proj) {
  let h = '';
  const build = proj['Build Minutes'];
  const fnInv = proj['Function Invocations'];
  if (build?.risk === 'danger') {
    h += `<div class="alert-row" style="background:#FEE2E2"><span class="alert-icon" style="color:#DC2626">&#9888;</span><span style="color:#DC2626">Build Minutes : projection ${Math.round(build.projected)} / 6 000 min (${build.projPct}%) risque de dépassement</span></div>`;
  } else if (build?.risk === 'warn') {
    h += `<div class="alert-row" style="background:#FEFCE8"><span class="alert-icon" style="color:#D97706">&#9888;</span><span style="color:#D97706">Build Minutes : projection ${Math.round(build.projected)} / 6 000 min (${build.projPct}%) a surveiller</span></div>`;
  }
  if (fnInv?.risk === 'danger') {
    h += `<div class="alert-row" style="background:#FEE2E2"><span class="alert-icon" style="color:#DC2626">&#9888;</span><span style="color:#DC2626">Function Invocations : projection ${fmtN(Math.round(fnInv.projected))} / 1M risque de dépassement</span></div>`;
  } else if (fnInv?.risk === 'warn') {
    h += `<div class="alert-row" style="background:#FEFCE8"><span class="alert-icon" style="color:#D97706">&#9888;</span><span style="color:#D97706">Function Invocations : projection ${fmtN(Math.round(fnInv.projected))} / 1M a surveiller</span></div>`;
  }
  html('global-dyn-alerts', h);
}

// ====================== RÉTROPLANNING ======================

const RETRO_DATA = [
  // ===== PHASE 1 — Prêt pour la formation (25/02 → 17/03) =====
  { date:'2026-02-25', phaseHeader:{ label:'⚡ Phase 1 — Prêt pour la formation  ·  25/02 → 17/03', color:'#1D4ED8', bg:'#DBEAFE' }, milestone:null, actions:[
    { id:'s1-1', text:'Créer compte OpenAI dédié Rubix Pitch', responsable:'CLAIRE', priority:'red' },
    { id:'s1-2', text:'Charger 50$ de crédits sur le nouveau compte', responsable:'CLAIRE', priority:'red' },
    { id:'s1-3', text:'Mettre à jour OPENAI_API_KEY dans Vercel', responsable:'CLAIRE', priority:'red' },
    { id:'s1-4', text:'Tester que l\'app fonctionne avec la nouvelle clé', responsable:'CLAIRE', priority:'red' },
    { id:'s1-5', text:'Créer canal Teams "Rubix Pitch — Retours & Support"', responsable:'CLAIRE', priority:'blue' },
  ]},
  { date:'2026-02-26', milestone:null, actions:[
    { id:'s1-6', text:'Corriger bug API Fusion (solutions_selectionnees = [])', responsable:'CLAUDE CODE', priority:'red' },
    { id:'s1-7', text:'Corriger bug API Fusion (tendances_selectionnees = [])', responsable:'CLAUDE CODE', priority:'red' },
    { id:'s1-8', text:'Corriger tendances disparues étape 3', responsable:'CLAUDE CODE', priority:'red' },
    { id:'s1-9', text:'Corriger crédibilité incomplète étape 3', responsable:'CLAUDE CODE', priority:'red' },
  ]},
  // 27/02 (Ven) — fusionné avec 28/02 (Samedi → déplacé)
  { date:'2026-02-27', milestone:null, actions:[
    { id:'s1-10', text:'Implémenter messages d\'erreur UX (timeout, 429, 500, JSON)', responsable:'CLAUDE CODE', priority:'red' },
    { id:'s1-11', text:'Implémenter bouton "Réessayer" sans perte de données saisies', responsable:'CLAUDE CODE', priority:'red' },
    { id:'s1-12', text:'Implémenter timeout frontend 58s (couper avant le 60s Vercel)', responsable:'CLAUDE CODE', priority:'red' },
    { id:'s1-13', text:'Implémenter retry exponential backoff (api/generate-pitch.js)', responsable:'CLAUDE CODE', priority:'red' },
    { id:'s1-14', text:'Implémenter retry exponential backoff (api/generate-fusion.js)', responsable:'CLAUDE CODE', priority:'red' },
    { id:'s1-15', text:'Ajouter bouton "Signaler un problème" → lien canal Teams', responsable:'CLAUDE CODE', priority:'orange' },
    { id:'s1-16', text:'Implémenter login individuel (identifiant + code) → remplacer le mot de passe unique', responsable:'CLAUDE CODE', priority:'orange' },
    { id:'s1-17', text:'Créer fichier users.json sur Vercel Blob (liste utilisateurs avec champ "actif")', responsable:'CLAUDE CODE', priority:'orange' },
    { id:'s1-18', text:'Tester parcours complet — vérifier corrections bugs', responsable:'CLAIRE', priority:'green' },
  ]},
  // Semaine 2 — Matrice + Stabilisation (02/03 → 06/03)
  { date:'2026-03-02', milestone:'📦 Réception nouvelle matrice', actions:[
    { id:'s2-1', text:'Réceptionner la nouvelle matrice', responsable:'CLAIRE', priority:'red' },
    { id:'s2-2', text:'Vérifier les 7 onglets (format, colonnes, données cohérentes)', responsable:'CLAIRE', priority:'red' },
    { id:'s2-3', text:'Uploader nouvelle matrice sur Vercel Blob', responsable:'CLAUDE CODE', priority:'red' },
    { id:'s2-4', text:'Garder ancienne matrice en backup (ne pas supprimer)', responsable:'CLAUDE CODE', priority:'red' },
    { id:'s2-5', text:'Si Tier 2 pas automatique → contacter support OpenAI', responsable:'CLAIRE', priority:'blue' },
  ]},
  { date:'2026-03-03', milestone:null, actions:[
    { id:'s2-6', text:'🧪 Simulation unitaire × 3 combos avec nouvelle matrice (Coût : $0.024)', responsable:'CLAIRE', priority:'green' },
    { id:'s2-7', text:'Corriger régressions si nouvelle matrice casse quelque chose', responsable:'CLAUDE CODE', priority:'red' },
    { id:'s2-8', text:'Implémenter sauvegarde historique multi-device (Vercel Blob par utilisateur)', responsable:'CLAUDE CODE', priority:'orange' },
  ]},
  { date:'2026-03-04', milestone:null, actions:[
    { id:'s2-9', text:'Implémenter parallélisation Promise.all() (useContentGeneration.js)', responsable:'CLAUDE CODE', priority:'orange' },
    { id:'s2-10', text:'🧪 Simulation petit groupe × 5 pitchs ($0.04) — vérifier Promise.all()', responsable:'CLAIRE', priority:'green' },
    { id:'s2-11', text:'Implémenter logging structuré des appels API (console.log JSON)', responsable:'CLAUDE CODE', priority:'orange' },
  ]},
  { date:'2026-03-05', milestone:'💜 Point manager', actions:[
    { id:'s2-12', text:'Point manager : présenter la page /monitoring', responsable:'CLAIRE', priority:'blue' },
    { id:'s2-13', text:'Demander 3-5 testeurs commerciaux volontaires (2 RVE + 1 DE + 1 non-tech)', responsable:'CLAIRE', priority:'blue' },
    { id:'s2-14', text:'Créer endpoint /api/health (test OpenAI + Blob)', responsable:'CLAUDE CODE', priority:'orange' },
  ]},
  { date:'2026-03-06', milestone:'📋 Point d\'étape', actions:[
    { id:'s2-15', text:'Point d\'étape : démo parcours complet sans bug', responsable:'CLAIRE', priority:'green' },
    { id:'s2-16', text:'Vérifier statut Tier 2 (automatique ? réponse support ?)', responsable:'CLAIRE', priority:'green' },
    { id:'s2-17', text:'Décision : plan 5+5+5 (Tier 1) ou ouverture totale (Tier 2)', responsable:'CLAIRE', priority:'green' },
    { id:'s2-18', text:'Confirmer liste testeurs (noms reçus du point manager)', responsable:'CLAIRE', priority:'blue' },
    { id:'s2-19', text:'Préparer users.json avec les 66 participants', responsable:'CLAIRE', priority:'blue' },
  ]},
  // Semaine 3 — Bêta test + Simulations (09/03 → 13/03)
  // 07/03 (Sam) + 08/03 (Dim) → déplacés semaine du 09/03
  { date:'2026-03-09', milestone:null, actions:[
    { id:'s3-1', text:'Envoyer accès app aux testeurs + consignes canal Teams', responsable:'CLAIRE', priority:'blue' },
    { id:'s3-2', text:'Corriger bugs remontés par testeurs (au fil de l\'eau)', responsable:'CLAUDE CODE', priority:'orange' },
    { id:'s3-6', text:'🧪 Simulation formation : 22 pitchs / 5 vagues / 3s — Coût : $0.18', responsable:'CLAIRE', priority:'green' },
  ]},
  { date:'2026-03-10', milestone:'🔒 Code freeze', actions:[
    { id:'s3-3', text:'Corrections bugs testeurs', responsable:'CLAUDE CODE', priority:'orange' },
    { id:'s3-4', text:'Vérifier logs Vercel + retours canal Teams', responsable:'CLAIRE', priority:'green' },
    { id:'s3-7', text:'🧪 Simulation stress : 35 pitchs / 7 vagues / 3s — Coût : $0.28', responsable:'CLAIRE', priority:'green' },
    { id:'s3-8', text:'Analyser résultats simulations : taux succès, temps moyen, erreurs', responsable:'CLAIRE', priority:'green' },
    { id:'s3-11', text:'DÉCISION : code freeze si tests OK (reporté 11/03 max si debug)', responsable:'CLAIRE', priority:'green' },
  ]},
  { date:'2026-03-11', milestone:null, actions:[
    { id:'s3-5', text:'Dernières corrections bugs testeurs', responsable:'CLAUDE CODE', priority:'orange' },
    { id:'s3-9', text:'Fix critique uniquement si simulation révèle un problème bloquant', responsable:'CLAUDE CODE', priority:'red' },
    { id:'s3-10', text:'🧪 Retest formation (22 pitchs) si debug effectué — Coût : $0.18', responsable:'CLAIRE', priority:'green' },
  ]},
  { date:'2026-03-12', milestone:null, actions:[
    { id:'s3-12', text:'Uploader fichier users.json final sur Vercel Blob', responsable:'CLAIRE', priority:'blue' },
    { id:'s3-13', text:'Générer 3 pitchs de démo PDF (Agro/Achats, Industrie/Maint, Élec/Prod)', responsable:'CLAIRE', priority:'green' },
    { id:'s3-14', text:'Préparer document "Guide formateur" pour le créneau app', responsable:'CLAIRE', priority:'blue' },
    { id:'s3-15', text:'Bilan testeurs : recueillir feedback final', responsable:'CLAIRE', priority:'green' },
  ]},
  // 13/03 (Ven) — fusionné avec 14/03 (Sam) + 15/03 (Dim)
  { date:'2026-03-13', milestone:null, actions:[
    { id:'s4-1', text:'Test quotidien : générer 1 pitch, vérifier résultat — Coût : $0.008', responsable:'CLAIRE', priority:'green' },
    { id:'s4-2', text:'Confirmer salle + matériel formation 17/03', responsable:'CLAIRE', priority:'blue' },
    { id:'s4-3', text:'Relire guide formateur, valider déroulé créneau app', responsable:'FORMATEUR', priority:'blue' },
    { id:'s4-4', text:'Test quotidien — Coût : $0.008', responsable:'CLAIRE', priority:'green' },
    { id:'s4-5', text:'Identifier les 5 ambassadeurs session 1 (parmi les 22 participants)', responsable:'CLAIRE', priority:'blue' },
    { id:'s4-6', text:'Activer les 5 ambassadeurs dans users.json (actif: true)', responsable:'CLAIRE', priority:'blue' },
  ]},
  { date:'2026-03-16', milestone:'📋 Veille formation', actions:[
    { id:'s4-7', text:'/api/health → tout vert', responsable:'CLAIRE', priority:'green' },
    { id:'s4-8', text:'Vérifier solde crédits OpenAI (platform.openai.com)', responsable:'CLAIRE', priority:'green' },
    { id:'s4-9', text:'Générer 1 pitch test complet → résultat cohérent — Coût : $0.008', responsable:'CLAIRE', priority:'green' },
    { id:'s4-10', text:'Tester depuis un téléphone en 4G (backup wifi)', responsable:'CLAIRE', priority:'green' },
    { id:'s4-11', text:'Vérifier pitchs PDF fallback prêts et accessibles', responsable:'CLAIRE', priority:'green' },
    { id:'s4-12', text:'Vérifier canal Teams accessible par les participants', responsable:'CLAIRE', priority:'green' },
    { id:'s4-13', text:'Vérifier page /monitoring → connaître les points orange/rouge restants', responsable:'CLAIRE', priority:'green' },
  ]},
  { date:'2026-03-17', milestone:'🎯 SESSION 1', actions:[
    { id:'s4-14', text:'8h00 : Ouvrir l\'app + générer 1 pitch pour chauffer', responsable:'CLAIRE', priority:'green' },
    { id:'s4-15', text:'8h00 : Ouvrir logs Vercel dans un onglet', responsable:'CLAIRE', priority:'green' },
    { id:'s4-16', text:'Créneau app (~1h) : guider les 22 participants', responsable:'FORMATEUR', priority:'blue' },
    { id:'s4-17', text:'Si bug en live → montrer le pitch PDF de fallback', responsable:'FORMATEUR', priority:'blue' },
    { id:'s4-18', text:'17h30 : Vérifier les logs — erreurs 429 ? Timeouts ?', responsable:'CLAIRE', priority:'green' },
    { id:'s4-19', text:'17h30 : Confirmer les 5 ambassadeurs → leur partager lien + canal Teams', responsable:'CLAIRE', priority:'blue' },
  ]},
  // ===== PHASE 2 — App solide pour 10 utilisateurs (18/03 → 25/03) =====
  { date:'2026-03-18', phaseHeader:{ label:'🌱 Phase 2 — App solide pour 10 utilisateurs  ·  18/03 → 25/03', color:'#166534', bg:'#DCFCE7' }, milestone:null, actions:[
    { id:'s5-1', text:'Vérifier logs Vercel : les ambassadeurs utilisent l\'app ?', responsable:'CLAIRE', priority:'green' },
    { id:'s5-2', text:'Vérifier canal Teams : bugs remontés ?', responsable:'CLAIRE', priority:'green' },
  ]},
  { date:'2026-03-19', milestone:null, actions:[
    { id:'s5-3', text:'Point rapide ambassadeurs : "Ça marche ? Des soucis ?"', responsable:'CLAIRE', priority:'green' },
    { id:'s5-4', text:'Corriger bugs remontés si besoin', responsable:'CLAUDE CODE', priority:'orange' },
  ]},
  // 20/03 (Ven) — fusionné avec 21/03 (Samedi → déplacé)
  { date:'2026-03-20', milestone:null, actions:[
    { id:'s5-5', text:'Bilan semaine pilote : logs, feedback ambassadeurs, décision suite', responsable:'CLAIRE', priority:'green' },
    { id:'s5-6', text:'Si KO → identifier et corriger avant le 25/03', responsable:'CLAIRE', priority:'green' },
  ]},
  { date:'2026-03-24', milestone:'📋 Veille formation 2', actions:[
    { id:'s6-1', text:'Checklist veille complète (même que 16/03)', responsable:'CLAIRE', priority:'green' },
    { id:'s6-2', text:'Vérifier corrections post-session 1 en place', responsable:'CLAIRE', priority:'green' },
    { id:'s6-3', text:'Activer 5 nouveaux ambassadeurs dans users.json', responsable:'CLAIRE', priority:'blue' },
  ]},
  { date:'2026-03-25', milestone:'🎯 SESSION 2', actions:[
    { id:'s6-4', text:'8h00 : Chauffer l\'app + logs ouverts', responsable:'CLAIRE', priority:'green' },
    { id:'s6-5', text:'Créneau app avec 22 participants', responsable:'FORMATEUR', priority:'blue' },
    { id:'s6-6', text:'17h30 : Vérifier logs', responsable:'CLAIRE', priority:'green' },
    { id:'s6-7', text:'17h30 : Confirmer 5 nouveaux ambassadeurs (total : 10 actifs)', responsable:'CLAIRE', priority:'blue' },
  ]},
  // ===== PHASE 3 — Robustesse + ouverture progressive (30/03 → 08/04+) =====
  { date:'2026-03-30', phaseHeader:{ label:'🚀 Phase 3 — Robustesse + ouverture progressive  ·  30/03 → 08/04+', color:'#92400E', bg:'#FEF9C3' }, milestone:null, actions:[
    { id:'s7-1', text:'Vérifier logs 2×/semaine (lundi + jeudi)', responsable:'CLAIRE', priority:'green' },
    { id:'s7-2', text:'Surveiller canal Teams', responsable:'CLAIRE', priority:'green' },
    { id:'s7-3', text:'Implémenter cache priorisations (préparer ouverture large)', responsable:'CLAUDE CODE', priority:'orange' },
  ]},
  { date:'2026-04-03', milestone:null, actions:[
    { id:'s7-4', text:'Bilan 10 users : stable ? erreurs ? temps de génération ?', responsable:'CLAIRE', priority:'green' },
    { id:'s7-5', text:'Vérifier statut Tier 2', responsable:'CLAIRE', priority:'green' },
    { id:'s7-6', text:'Si Tier 2 → planifier ouverture large après session 3', responsable:'CLAIRE', priority:'blue' },
    { id:'s7-7', text:'Si Tier 1 → rester sur +5 users après session 3', responsable:'CLAIRE', priority:'blue' },
  ]},
  { date:'2026-04-07', milestone:'📋 Veille formation 3', actions:[
    { id:'s9-1', text:'Checklist veille complète', responsable:'CLAIRE', priority:'green' },
    { id:'s9-2', text:'Activer 5 nouveaux ambassadeurs dans users.json', responsable:'CLAIRE', priority:'blue' },
  ]},
  { date:'2026-04-08', milestone:'🎯 SESSION 3', actions:[
    { id:'s9-3', text:'8h00 : Chauffer l\'app + logs', responsable:'CLAIRE', priority:'green' },
    { id:'s9-4', text:'Créneau app avec 22 participants', responsable:'FORMATEUR', priority:'blue' },
    { id:'s9-5', text:'17h30 : Vérifier logs + confirmer 5 ambassadeurs (total : 15 actifs)', responsable:'CLAIRE', priority:'green' },
    { id:'s9-6', text:'Bilan global : 15 users actifs, Tier 1 ou 2, erreurs cumulées', responsable:'CLAIRE', priority:'green' },
  ]},
  // Post-formation
  { date:'2026-04-14', milestone:null, actions:[
    { id:'s10-1', text:'Bilan 15 users → décision ouverture 30 users', responsable:'CLAIRE', priority:'green' },
  ]},
  { date:'2026-04-21', milestone:null, actions:[
    { id:'s10-2', text:'Si Tier 2 → ouverture 66 users', responsable:'CLAIRE', priority:'green' },
    { id:'s10-3', text:'Si Tier 1 → relancer support OpenAI', responsable:'CLAIRE', priority:'blue' },
    { id:'s10-4', text:'Implémenter mode dégradé, monitoring alertes, métriques d\'usage', responsable:'CLAUDE CODE', priority:'orange' },
  ]},
];

const PRIO_COLORS  = { red:'#EF4444', orange:'#F59E0B', blue:'#3B82F6', green:'#22C55E' };
const PRIO_LABELS  = { red:'🔴 Bloquant', orange:'🟠 Important', blue:'🔵 Préparation', green:'🟢 Validation' };
const RESP_STYLES  = {
  'CLAIRE':     { bg:'#FFF9E6', color:'#051E50' },
  'CLAUDE CODE':{ bg:'#EFF6FF', color:'#1E40AF' },
  'FORMATEUR':  { bg:'#F0FDF4', color:'#166534' },
};
const S_CYCLE  = ['', 'inprogress', 'done', 'blocked'];
const S_ICONS  = { '':'⬜', inprogress:'🔄', done:'✅', blocked:'❌' };
const S_LABELS = { '':'À faire', inprogress:'En cours', done:'Fait', blocked:'Bloqué' };

let retroFilterResp = 'all';
let retroFilterPrio = 'all';

function getRS(id)      { return localStorage.getItem('retro_' + id) || ''; }
function setRS(id, val) { val === '' ? localStorage.removeItem('retro_' + id) : localStorage.setItem('retro_' + id, val); }

function clickRetroStatus(id) {
  const cur  = getRS(id);
  const next = S_CYCLE[(S_CYCLE.indexOf(cur) + 1) % S_CYCLE.length];
  setRS(id, next);
  const btn  = $('rb-' + id); if (btn) { btn.textContent = S_ICONS[next]; btn.title = S_LABELS[next]; }
  const card = $('rc-' + id);
  if (card) { next === 'done' ? card.classList.add('done-card') : card.classList.remove('done-card'); }
  updateRetroProgress();
  // Re-check if day is all done (update grayout)
  recheckDayDone(id);
}

function recheckDayDone(actionId) {
  // Find which day contains this action
  for (const entry of RETRO_DATA) {
    if (entry.actions.some(a => a.id === actionId)) {
      const dayEl = $('rday-' + entry.date);
      if (!dayEl) return;
      const allDone = entry.actions.every(a => getRS(a.id) === 'done');
      const today0 = new Date(); today0.setHours(0,0,0,0);
      const entryDate = new Date(entry.date); entryDate.setHours(0,0,0,0);
      if (entryDate < today0) {
        allDone ? dayEl.classList.add('past-all') : dayEl.classList.remove('past-all');
      }
      return;
    }
  }
}

function getMilestoneStyle(m) {
  if (!m) return null;
  if (m.includes('SESSION'))  return { bg:'#FFF9E6', border:'#FFD500', color:'#92400E' };
  if (m.includes('freeze'))   return { bg:'#FEF2F2', border:'#EF4444', color:'#DC2626' };
  if (m.includes('manager'))  return { bg:'#F5F3FF', border:'#7C3AED', color:'#6D28D9' };
  if (m.includes('matrice'))  return { bg:'#F0FDF4', border:'#22C55E', color:'#166534' };
  return { bg:'#EFF6FF', border:'#3B82F6', color:'#1D4ED8' };
}

function getMonday(date) {
  const d = new Date(date); const day = d.getDay();
  d.setDate(d.getDate() + (day === 0 ? -6 : 1 - day)); d.setHours(0,0,0,0); return d;
}

function buildRetroCalendar() {
  // Build map dateStr → entry
  const dateMap = {};
  for (const entry of RETRO_DATA) dateMap[entry.date] = entry;

  // All weekday dates from startMonday to endMonday
  const allDates = RETRO_DATA.map(e => new Date(e.date));
  const startMon = getMonday(new Date(Math.min(...allDates)));
  const endMon   = getMonday(new Date(Math.max(...allDates)));
  const today0   = new Date(); today0.setHours(0,0,0,0);
  const todayStr = today0.toISOString().split('T')[0];

  let out = '';
  let cur = new Date(startMon);
  while (cur <= endMon) {
    // Build week's Mon-Fri
    const weekDays = [];
    for (let i = 0; i < 5; i++) { const d = new Date(cur); d.setDate(cur.getDate() + i); weekDays.push(d); }
    // Only show week if it has at least one entry
    const hasEntry = weekDays.some(d => dateMap[d.toISOString().split('T')[0]]);
    if (hasEntry) {
      // Phase header : check if any day in this week has a phaseHeader
      const phEntry = weekDays.map(d => dateMap[d.toISOString().split('T')[0]]).find(e => e?.phaseHeader);
      if (phEntry) {
        const ph = phEntry.phaseHeader;
        out += `<div class="retro-phase-header" style="background:${ph.bg};border-color:${ph.color};color:${ph.color}">${ph.label}</div>`;
      }
      const weekLabel = cur.toLocaleDateString('fr-FR', { day:'2-digit', month:'long' }) + ' — ' +
        weekDays[4].toLocaleDateString('fr-FR', { day:'2-digit', month:'long' });
      out += `<div class="retro-week"><div class="retro-week-label">Semaine du ${weekLabel}</div><div class="retro-days">`;
      for (const day of weekDays) {
        const ds    = day.toISOString().split('T')[0];
        const entry = dateMap[ds];
        if (!entry) { out += `<div class="retro-day" style="min-width:60px;flex-shrink:0"><div style="height:40px"></div></div>`; continue; }
        const isToday = ds === todayStr;
        const isPast  = day < today0;
        const allDone = isPast && entry.actions.every(a => getRS(a.id) === 'done');
        let cls = 'retro-day'; if (isToday) cls += ' today'; if (isPast && allDone) cls += ' past-all';
        const idAttr = isToday ? ' id="retro-today"' : '';
        out += `<div class="${cls}" id="rday-${ds}"${idAttr}>`;
        // Milestone
        if (entry.milestone) {
          const ms = getMilestoneStyle(entry.milestone);
          out += `<div class="retro-milestone-banner" style="background:${ms.bg};border-color:${ms.border};color:${ms.color}">${entry.milestone}</div>`;
        }
        // Header
        const dn = day.toLocaleDateString('fr-FR', { weekday:'short' });
        const dm = day.toLocaleDateString('fr-FR', { day:'2-digit', month:'2-digit' });
        out += `<div class="retro-day-header"><div class="retro-day-date">${dm}</div><div class="retro-day-name">${dn}</div></div>`;
        // Cards
        out += `<div class="retro-cards">`;
        for (const a of entry.actions) {
          const status  = getRS(a.id);
          const bc      = PRIO_COLORS[a.priority] || '#94A3B8';
          const rs      = RESP_STYLES[a.responsable] || { bg:'#F1F5F9', color:'#334155' };
          const hidden  = !isRetroVisible(a) ? ' hidden' : '';
          const doneCls = status === 'done' ? ' done-card' : '';
          out += `<div class="retro-card${hidden}${doneCls}" id="rc-${a.id}" style="border-left-color:${bc}" data-resp="${a.responsable}" data-prio="${a.priority}">`;
          out += `<div class="retro-card-text">${a.text}</div>`;
          out += `<div class="retro-card-bottom">`;
          out += `<span class="retro-tag" style="background:${rs.bg};color:${rs.color}">${a.responsable}</span>`;
          out += `<button class="retro-status-btn" id="rb-${a.id}" onclick="clickRetroStatus('${a.id}')" title="${S_LABELS[status]}">${S_ICONS[status]}</button>`;
          out += `</div></div>`;
        }
        out += `</div></div>`;
      }
      out += `</div></div>`;
    }
    cur.setDate(cur.getDate() + 7);
  }
  return out;
}

function isRetroVisible(a) {
  return (retroFilterResp === 'all' || a.responsable === retroFilterResp) &&
         (retroFilterPrio === 'all' || a.priority === retroFilterPrio);
}

function applyRetroFilters() {
  document.querySelectorAll('.retro-card').forEach(card => {
    const v = (retroFilterResp === 'all' || card.dataset.resp === retroFilterResp) &&
              (retroFilterPrio === 'all' || card.dataset.prio === retroFilterPrio);
    card.classList.toggle('hidden', !v);
  });
}

function updateRetroProgress() {
  let total = 0, done = 0, redRem = 0, orangeRem = 0;
  let nextMilestone = null;
  const today0 = new Date(); today0.setHours(0,0,0,0);
  for (const entry of RETRO_DATA) {
    for (const a of entry.actions) {
      total++;
      if (getRS(a.id) === 'done') done++;
      else { if (a.priority === 'red') redRem++; if (a.priority === 'orange') orangeRem++; }
    }
    if (entry.milestone && !nextMilestone && new Date(entry.date) >= today0)
      nextMilestone = { label: entry.milestone, date: entry.date };
  }
  const pct  = total > 0 ? Math.round(done / total * 100) : 0;
  const nxt  = nextMilestone
    ? `Prochain jalon : <strong>${nextMilestone.label}</strong> (${new Date(nextMilestone.date).toLocaleDateString('fr-FR',{day:'2-digit',month:'short'})})`
    : 'Tous les jalons passés';
  const el = $('retro-prog-wrap'); if (!el) return;
  el.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:6px;margin-bottom:6px">
      <span style="font-weight:700;color:#051E50;font-size:13px">Progression : ${done} / ${total} actions terminées (${pct}%)</span>
      <span style="font-size:11px;color:#64748B">${nxt}</span>
    </div>
    <div class="retro-prog-bar-bg"><div class="retro-prog-bar-fill" style="width:${pct}%"></div></div>
    <div class="retro-prog-stats">
      <span>🔴 Bloquants restants : <strong>${redRem}</strong></span>
      <span>🟠 Importants restants : <strong>${orangeRem}</strong></span>
      <span>✅ Terminés : <strong>${done}</strong></span>
    </div>`;
}

function renderRetroFilters() {
  const respOpts = ['all','CLAIRE','CLAUDE CODE','FORMATEUR'];
  const respLbls = { all:'Tous', 'CLAIRE':'Claire', 'CLAUDE CODE':'Claude Code', 'FORMATEUR':'Formateur' };
  const prioOpts = ['all','red','orange','blue','green'];
  const prioLbls = { all:'Toutes priorités', red:'🔴 Bloquant', orange:'🟠 Important', blue:'🔵 Préparation', green:'🟢 Validation' };

  let h = `<div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center;margin-bottom:8px">
    <span style="font-size:10px;font-weight:700;color:#94A3B8;text-transform:uppercase;letter-spacing:.5px;min-width:80px">Responsable</span>`;
  for (const r of respOpts) {
    const act = retroFilterResp === r;
    h += `<button class="retro-filter-btn" onclick="setRetroResp('${r}')" style="background:${act?'#051E50':'#F1F5F9'};color:${act?'#FFD700':'#374151'};border-color:${act?'#051E50':'#E2E8F0'}">${respLbls[r]}</button>`;
  }
  h += `</div><div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center">
    <span style="font-size:10px;font-weight:700;color:#94A3B8;text-transform:uppercase;letter-spacing:.5px;min-width:80px">Priorité</span>`;
  for (const p of prioOpts) {
    const act = retroFilterPrio === p;
    h += `<button class="retro-filter-btn" onclick="setRetroPrio('${p}')" style="background:${act?'#051E50':'#F1F5F9'};color:${act?'#FFD700':'#374151'};border-color:${act?'#051E50':'#E2E8F0'}">${prioLbls[p]}</button>`;
  }
  h += `</div>`;
  const el = $('retro-filters-wrap'); if (el) el.innerHTML = h;
}

function setRetroResp(val) { retroFilterResp = val; renderRetroFilters(); applyRetroFilters(); }
function setRetroPrio(val) { retroFilterPrio = val; renderRetroFilters(); applyRetroFilters(); }

function initRetro() {
  $('retro-calendar').innerHTML = buildRetroCalendar();
  renderRetroFilters();
  updateRetroProgress();
}

// Bootstrap
(async () => {
  try {
    const resp = await fetch('/api/data');
    if (!resp.ok) throw new Error(`Erreur API ${resp.status}`);
    const d = await resp.json();
    if (d.error) throw new Error(d.error);
    renderAll(d);
    $('loading').style.display = 'none';
    $('main').style.display    = 'block';
  } catch (err) {
    $('loading').innerHTML = `
      <div class="error-box">
        <strong>Erreur de chargement</strong><br><br>${err.message}<br><br>
        <button onclick="location.reload()" style="padding:7px 16px;border-radius:6px;border:none;background:#051E50;color:#FFD700;font-weight:700;cursor:pointer">
          Reessayer
        </button>
      </div>`;
  }
})();
</script>
</body>
</html>
